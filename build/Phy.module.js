import*as e from"three";import{Quaternion as t,Matrix3 as s,Vector3 as i,LineSegments as n,BufferGeometry as r,BufferAttribute as a,Float32BufferAttribute as o,LineBasicMaterial as l,SphereGeometry as h,CylinderGeometry as c,BoxGeometry as u,PlaneGeometry as p,CanvasTexture as d,RepeatWrapping as f,SRGBColorSpace as g,MeshPhysicalMaterial as y,Color as v,ShaderChunk as w,ShaderMaterial as x,BackSide as b,Vector2 as M,MeshStandardMaterial as A,ShadowMaterial as T,MeshToonMaterial as S,MeshBasicMaterial as R,MeshLambertMaterial as k,MeshPhongMaterial as C,DoubleSide as I,NoBlending as E,NormalBlending as P,AdditiveBlending as _,SubtractiveBlending as L,MultiplyBlending as D,AddEquation as z,SubtractEquation as O,ReverseSubtractEquation as F,MinEquation as N,MaxEquation as B,ZeroFactor as U,OneFactor as V,SrcColorFactor as H,OneMinusSrcColorFactor as j,SrcAlphaFactor as G,OneMinusSrcAlphaFactor as W,DstAlphaFactor as q,OneMinusDstAlphaFactor as X,DstColorFactor as K,OneMinusDstColorFactor as Z,SrcAlphaSaturateFactor as Y,FrontSide as Q,Line as J,EventDispatcher as $,MathUtils as ee,Matrix4 as te,Euler as se,Layers as ie,Mesh as ne,InstancedMesh as re,InstancedBufferAttribute as ae,TrianglesDrawMode as oe,TriangleFanDrawMode as le,TriangleStripDrawMode as he,CircleGeometry as ce,Box3 as ue,Line3 as pe,Plane as de,Triangle as me,Object3D as fe,Loader as ge,FileLoader as ye,ShapeUtils as ve,Box2 as we,Shape as xe,Path as be,ShapePath as Me,ShapeGeometry as Ae,Uniform as Te,PerspectiveCamera as Se,Scene as Re,WebGLRenderer as ke,PropertyBinding as Ce,InterpolateLinear as Ie,CompressedTexture as Ee,Source as Pe,NoColorSpace as _e,RGBAFormat as Le,InterpolateDiscrete as De,NearestFilter as ze,NearestMipmapNearestFilter as Oe,NearestMipmapLinearFilter as Fe,LinearFilter as Ne,LinearMipmapNearestFilter as Be,LinearMipmapLinearFilter as Ue,ClampToEdgeWrapping as Ve,MirroredRepeatWrapping as He,LoaderUtils as je,LinearSRGBColorSpace as Ge,SpotLight as We,PointLight as qe,DirectionalLight as Xe,TextureLoader as Ke,ImageBitmapLoader as Ze,InterleavedBuffer as Ye,InterleavedBufferAttribute as Qe,PointsMaterial as Je,Material as $e,SkinnedMesh as et,LineLoop as tt,Points as st,Group as it,OrthographicCamera as nt,Skeleton as rt,AnimationClip as at,Bone as ot,ColorManagement as lt,Texture as ht,VectorKeyframeTrack as ct,NumberKeyframeTrack as ut,QuaternionKeyframeTrack as pt,Sphere as dt,Interpolant as mt,Vector4 as ft,Curve as gt,EquirectangularReflectionMapping as yt,AmbientLight as vt,Uint16BufferAttribute as wt,DataTextureLoader as xt,HalfFloatType as bt,FloatType as Mt,DataUtils as At,RedFormat as Tt,ObjectSpaceNormalMap as St,AnimationMixer as Rt,CustomBlending as kt,SkeletonHelper as Ct,AnimationUtils as It,AdditiveAnimationBlendMode as Et,NormalAnimationBlendMode as Pt,Raycaster as _t}from"three";const Lt=Math.PI,Dt=Lt/180,zt=180/Lt,Ot=Number.EPSILON,Ft=.5*Lt,Nt={todeg:zt,torad:Dt,toFixed:(e,t=3)=>1*e.toFixed(t),toRound:(e,t=3)=>Math.trunc(e),clamp:(e,t,s)=>e=(e=e<t?t:e)>s?s:e,clampA:(e,t,s)=>Math.max(t,Math.min(s,e)),lerp:(e,t,s)=>(1-s)*e+s*t,damp:(e,t,s,i)=>Nt.lerp(e,t,1-Math.exp(-s*i)),nearAngle:(e,t,s=!1)=>t+Math.atan2(Math.sin(e-t),Math.cos(e-t))*(s?zt:1),unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),nearEquals:(e,t,s)=>Math.abs(e-t)<=s,autoSize:(e=[1,1,1],t="box")=>{1===e.length&&(e[1]=e[0]);let s=e[0],i=e[1];return"sphere"===t&&(e=[s,s,s]),"cylinder"!==t&&"wheel"!==t&&"capsule"!==t||(e=[s,i,s]),"cone"!==t&&"pyramid"!==t||(e=[s,i,s]),2===e.length&&(e[2]=e[0]),e},randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),composeMatrixArray:(e,t,s=[1,1,1])=>{const i=t[0],n=t[1],r=t[2],a=t[3],o=i+i,l=n+n,h=r+r,c=i*o,u=i*l,p=i*h,d=n*l,m=n*h,f=r*h,g=a*o,y=a*l,v=a*h,w=s[0],x=s[1],b=s[2];return[(1-(d+f))*w,(u+v)*w,(p-y)*w,0,(u-v)*x,(1-(c+f))*x,(m+g)*x,0,(p+y)*b,(m-g)*b,(1-(c+d))*b,0,e[0],e[1],e[2],1]},decomposeMatrixArray:e=>[e[12],e[13],e[14]],applyTransformArray:(e,t,s,i=[1,1,1])=>{const n=Nt.composeMatrixArray(t,s,i),r=e[0],a=e[1],o=e[2],l=1/(n[3]*r+n[7]*a+n[11]*o+n[15]);return[(n[0]*r+n[4]*a+n[8]*o+n[12])*l,(n[1]*r+n[5]*a+n[9]*o+n[13])*l,(n[2]*r+n[6]*a+n[10]*o+n[14])*l]},slerpQuatArray:(e,t,s)=>{if(0===s)return e;if(1===s)return t;let i=[...e];const n=e[0],r=e[1],a=e[2],o=e[3],l=t[0],h=t[1],c=t[2],u=t[3];let p=o*u+n*l+r*h+a*c;if(p<0?(i=[-l,-h,-c,-u],p=-p):i=[...t],p>=1)return e;const d=1-p*p;if(d<=Ot){const e=1-s;return i[3]=e*o+s*i[3],i[0]=e*n+s*i[0],i[1]=e*r+s*i[1],i[2]=e*a+s*i[2],Nt.quatNomalize(i)}const m=Math.sqrt(d),f=Math.atan2(m,p),g=Math.sin((1-s)*f)/m,y=Math.sin(s*f)/m;return i[3]=o*g+i[3]*y,i[0]=n*g+i[0]*y,i[1]=r*g+i[1]*y,i[2]=a*g+i[2]*y,i},toLocalQuatArray:(e=[0,0,0],t)=>{let s=Nt.quatFromEuler(e),i=Nt.quatInvert(t.quaternion.toArray());return Nt.quatMultiply(i,s)},quatFromEuler:(e=[0,0,0],t=!0)=>{const s=Math.cos,i=Math.sin,n=t?Dt:1,r=e[0]*n*.5,a=e[1]*n*.5,o=e[2]*n*.5,l=s(r),h=s(a),c=s(o),u=i(r),p=i(a),d=i(o);return[u*h*c+l*p*d,l*p*c-u*h*d,l*h*d+u*p*c,l*h*c-u*p*d]},quatFromAxis:(e=[0,0,0],t,s=!0)=>{const i=.5*t*(s?Dt:1),n=Math.sin(i);return[e[0]*n,e[1]*n,e[2]*n,Math.cos(i)]},quatNomalize:e=>{let t=Nt.lengthArray(e);return 0===t?[0,0,0,1]:(t=1/t,Nt.scaleArray(e,t,4))},quatInvert:e=>[-e[0],-e[1],-e[2],e[3]],quatMultiply:(e,t)=>{const s=e[0],i=e[1],n=e[2],r=e[3],a=t[0],o=t[1],l=t[2],h=t[3];return[s*h+r*a+i*l-n*o,i*h+r*o+n*a-s*l,n*h+r*l+s*o-i*a,r*h-s*a-i*o-n*l]},quatToAxis:e=>{let t=2*Math.acos(e[3]);const s=Math.sqrt(1-e[3]*e[3]);return s<1e-4?[1,0,0]:[e[0]/s,e[1]/s,e[2]/s,t]},eulerFromMatrix:e=>{const t=e[0],s=e[4],i=e[8];e[1];const n=e[5],r=e[9];e[2];const a=e[6],o=e[10];let l=[0,0,0];return l[1]=Math.asin(Nt.clamp(i,-1,1)),Math.abs(i)<.9999999?(l[0]=Math.atan2(-r,o),l[2]=Math.atan2(-s,t)):(l[0]=Math.atan2(a,n),l[2]=0),l},angleTo:(e,t)=>2*Math.acos(Math.abs(Nt.clamp(Nt.dotArray(e,t),-1,1))),getSize:e=>.001*e.byteLength+"kb",perpendicularArray:e=>{const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);let s=Math.acos(e[1]/t);const i=Math.atan2(e[2],e[0]);s>Ft?s-=Ft:s+=Ft;return[t*Math.sin(s)*Math.cos(i),t*Math.cos(s),t*Math.sin(s)*Math.sin(i)]},crossArray:(e,t)=>{const s=e[0],i=e[1],n=e[2],r=t[0],a=t[1],o=t[2];return[i*o-n*a,n*r-s*o,s*a-i*r]},applyQuaternion:(e,t)=>{const s=e[0],i=e[1],n=e[2],r=t[0],a=t[1],o=t[2],l=t[3],h=2*(a*n-o*i),c=2*(o*s-r*n),u=2*(r*i-a*s);return[s+l*h+a*u-o*c,i+l*c+o*h-r*u,n+l*u+r*c-a*h]},nullArray:(e,t,s)=>{let i=0;for(;s--;)i+=e[t+s];return i},equalArray:(e,t)=>{let s=e.length;for(;s--;)if(e[s]!==t[s])return!1;return!0},lerpArray:(e,t,s)=>{if(0===s)return e;if(1===s)return t;let i=e.length,n=[];for(;i--;)n[i]=e[i],n[i]+=(t[i]-n[i])*s;return n},zeroArray:(e,t=0,s)=>{for(s=s??e.length;s--;)e[t+s]=0;return e},lengthArray:e=>{let t=e.length,s=0;for(;t--;)s+=e[t]*e[t];return Math.sqrt(s)},dotArray:(e,t)=>{let s=e.length,i=0;for(;s--;)i+=e[s]*t[s];return i},addArray:(e,t,s)=>{s=s??e.length;let i=[];for(;s--;)i[s]=e[s]+t[s];return i},subArray:(e,t,s)=>{s=s??e.length;let i=[];for(;s--;)i[s]=e[s]-t[s];return i},mulArray:(e,t,s)=>{if(t instanceof Array){let i=[];for(s=s??e.length;s--;)i[s]=e[s]*t[s];return i}return e.map((e=>e*t))},divArray:(e,t,s)=>Nt.mulArray(e,1/t,s),scaleArray:(e,t,s)=>Nt.mulArray(e,t,s),fillArray:(e,t,s=0,i)=>{for(i=i??e.length;i--;)t[s+i]=e[i]},copyArray:(e,t)=>{},cloneArray:e=>[...e],distanceArray:(e,t=[0,0,0])=>Nt.lengthArray(Nt.subArray(e,t)),normalizeArray:e=>Nt.divArray(e,Nt.lengthArray(e)||1),normalArray:(e,t=[0,0,0])=>Nt.normalizeArray(Nt.subArray(t,e)),getVolume:(e,t,s=null)=>{let i=1,n=t;switch(e){case"sphere":i=4*Math.PI*n[0]*n[0]*n[0]/3;break;case"cone":i=Math.PI*n[0]*(.5*n[1])*2;break;case"box":i=.5*n[0]*8*(.5*n[1])*(.5*n[2]);break;case"cylinder":i=Math.PI*n[0]*n[0]*(.5*n[1])*2;break;case"capsule":i=4*Math.PI*n[0]*n[0]*n[0]/3+Math.PI*n[0]*n[0]*(.5*n[1])*2;break;case"convex":case"mesh":i=Nt.getConvexVolume(s)}return i},getConvexVolume:e=>{let t,s=e.length/3,i=[0,0,0],n=[0,0,0];for(;s--;)t=3*s,e[t]<i[0]?i[0]=e[t]:e[t]>n[0]&&(n[0]=e[t]),e[t+1]<i[1]?i[1]=e[t+1]:e[t+1]>n[1]&&(n[1]=e[t+1]),e[t+2]<i[2]?i[2]=e[t+2]:e[t+2]>n[2]&&(n[2]=e[t+2]);let r=[n[0]-i[0],n[1]-i[1],n[2]-i[2]];return.5*r[0]*8*(.5*r[1])*(.5*r[2])},massFromDensity:(e,t)=>e*t,densityFromMass:(e,t)=>e/t,toNonIndexed:e=>e.index?e.clone().toNonIndexed():e,getIndex:(e,t)=>!e.index||t?null:e.index.array||null,getVertex:(e,t)=>{let s=e.attributes.position.array;return t&&e.index&&(s=(e=e.clone().toNonIndexed()).attributes.position.array),s},getNormal:e=>e.attributes.normal.array,getFaces:e=>{let t=[];if(e.index){let s=e.getIndex();for(let e=0;e<s.count;e+=3)t.push([s.getX(e),s.getX(e+1),s.getX(e+2)])}else{let s=e.getAttribute("position").count;for(let e=0;e<s;e+=3)t.push([e,e+1,e+2])}return t},reduce:e=>{},barycentric:(e,t)=>{},solve:(e,t)=>{}},Bt=Nt,Ut=4e3,Vt=1e3,Ht=4e3,jt=100,Gt=100,Wt=50,qt=20,Xt={bodyFull:14,body:8,joint:16,contact:1,ray:11,character:16,vehicle:72,solver:128},Kt=new Map,Zt={debug:!1,Ar:null,ArPos:{},viewSize:null,engine:"OIMO",motor:null,scene:null,scenePlus:null,post:null,jointVisible:!1,delta:0,add:null,remove:null,items:null,tmpMesh:[],instanceMesh:{},tmpTex:[],mouseDown:!1,flow:{stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},reflow:{ray:[],stat:{fps:0},point:{}},extraMaterial:()=>{},disposeTmp:()=>{let e,t,s;for(e in Zt.tmpMesh){if(s=Zt.tmpMesh[e],s.children)for(t in s.children)Zt.disposeMesh(s.children[t]);Zt.disposeMesh(s),s.parent&&s.parent.remove(s)}for(e in Zt.tmpMesh=[],Zt.tmpTex)Zt.tmpTex[e].dispose()},disposeMesh:e=>{e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()}},Yt={byName:e=>Kt.has(e)?Kt.get(e):null,add:(e,t)=>{if("contact"!==e.type&&!e.isInstance&&e.isObject3D)if(t)t.add(e);else if(e.isButton)Zt.scene.add(e);else switch(e.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":Zt.scenePlus.add(e);break;default:Zt.scene.add(e)}e.isInstance&&e.refName!==e.name&&Kt.set(e.refName,e),Kt.set(e.name,e)},remove:e=>{e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.instance&&(e.refName!==e.name&&Kt.delete(e.refName),e.instance.remove(e.id)),Kt.delete(e.name)},noRay:e=>{e.isObject3D&&(e.raycast=()=>{},e.traverse((e=>{e.isObject3D&&(e.raycast=()=>{})})))},morph:(e,t,s)=>{e.morphTargetInfluences&&void 0!==e.morphTargetDictionary[t]&&(e.morphTargetInfluences[e.morphTargetDictionary[t]]=s)},toLocal:(e,t,s=!1)=>{s||e.sub(t.position);let i=t.quaternion;return e.applyQuaternion({x:-i._x,y:-i._y,z:-i._z,w:i._w}),e},quatLocal:(e,s)=>{s.isObject3D&&s.updateWorldMatrix(!0,!1);let i=(new t).fromArray(e),n=s.quaternion.clone().invert();return i.premultiply(n),i.normalize().toArray()},axisLocal:(e,t)=>{t.isObject3D&&t.updateWorldMatrix(!0,!1);let n=(new s).setFromMatrix4(t.matrixWorld);return(new i).fromArray(e).applyMatrix3(n).toArray()},quatToAngular:(e,t)=>{t[0]*=-1,t[1]*=-1,t[2]*=-1;let s,n=t[0]*e[3]+t[3]*e[0]+t[1]*e[2]-t[2]*e[1],r=t[1]*e[3]+t[3]*e[1]+t[2]*e[0]-t[0]*e[2],a=t[2]*e[3]+t[3]*e[2]+t[0]*e[1]-t[1]*e[0],o=t[3]*e[3]-t[0]*e[0]-t[1]*e[1]-t[2]*e[2],l=2*Math.acos(o),h=Math.sqrt(1-o*o);s=h<.001?[0,0,0]:[n/h,r/h,a/h];(new i).fromArray(s).multiplyScalar(l/1)},refAxis:(e,t)=>{let s=(new i).fromArray(t),n=new i(1,0,0),r=new i(0,1,0);Math.abs(t[1])>.9999||n.copy(s).cross(r).normalize(),r.copy(n).cross(s).normalize(),e.makeBasis(n,r,s)}};class Qt extends n{constructor(e,t=16776960){const s=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),i=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],n=new r;n.setIndex(new a(s,1)),n.setAttribute("position",new o(i,3)),n.setAttribute("color",new o([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(n,new l({color:t,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=e,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}let Jt=0,$t={};const es=e=>{$t["geo"+Jt++]=e},ts=e=>{$t[e.name]=e},ss=(e,t={})=>{if(!$t[e]){let t;switch(e){case"plane":t=new p(1,1),t.rotateX(.5*-Math.PI);break;case"box":t=new u(1,1,1);break;case"sphere":t=new h(1,16,12);break;case"cylinder":t=new c(1,1,1,16);break;case"cone":t=new c(.001,1,1,16);break;case"particle":t=new h(1,8,6);break;case"joint":t=(new Qt).geometry;break;default:return null}$t[e]=t}return $t[e]},is=()=>{for(let e in $t)$t[e].dispose();$t={},Jt=0};class ns{constructor(e,t="rgb(69,69,69)",s="rgb(39,39,39)"){const i=document.createElement("canvas");i.width=i.height=128;const n=i.getContext("2d");if(n.fillStyle=t,n.fillRect(0,0,128,128),e){let i,r,a,o,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=e?"rgb(128,128,255)":t,u=e?"rgb(160,100,255)":s,p=e?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(n.strokeStyle=p,n.lineWidth=1,i=0;i<5;i++){o=n.createLinearGradient(0,h[i][0],0,h[i][1]),o.addColorStop(0,u),o.addColorStop(1,c),n.beginPath(),n.fillStyle=o,n.rect(l[i][0],l[i][1],32,64),n.fill();for(let e=0;e<8;e++)a=2*(Math.random()-.5),n.beginPath(),n.moveTo(l[i][0]+a+2+4*e,l[i][1]),n.lineTo(l[i][0]+a+2+4*e,l[i][1]+64),n.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],i=0;i<5;i++)for(o=n.createLinearGradient(h[i][0],0,h[i][1],0),o.addColorStop(0,c),o.addColorStop(1,u),n.beginPath(),n.fillStyle=o,n.rect(l[i][0],l[i][1],64,32),n.fill(),r=0;r<8;r++)a=2*(Math.random()-.5),n.beginPath(),n.moveTo(l[i][0],l[i][1]+a+2+4*r),n.lineTo(l[i][0]+64,l[i][1]+a+2+4*r),n.stroke()}else n.beginPath(),n.fillStyle=s,n.rect(0,0,32,64),n.rect(32,32,32,64),n.rect(64,64,32,64),n.rect(96,96,32,64),n.rect(96,-32,32,64),n.fill();const r=new d(i);return r.wrapS=r.wrapT=f,r.repeat.x=r.repeat.y=60,e||(r.colorSpace=g),r}}class rs extends y{constructor(e){super(),this.defines={STANDARD:"",PHYSICAL:"",SUBSURFACE:"",USE_UV:""},this.extra={},this.addParametre("sssMap",null),this.addParametre("sssColor",new v(0,0,0)),this.addParametre("sssAmbient",.5),this.addParametre("sssDistortion",.6),this.addParametre("sssAttenuation",.1),this.addParametre("sssPower",1),this.addParametre("sssScale",6),this.setValues(e);let t=this;t.onBeforeCompile=function(e){for(let s in t.extra)e.uniforms[s]={value:t.extra[s]};e.fragmentShader=e.fragmentShader.replace("#include <common>",as.common),e.fragmentShader=e.fragmentShader.replace("#include <lights_fragment_begin>",t.replaceAll(w.lights_fragment_begin,"RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );",as.light)),t.userData.shader=e}}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.userData.shader&&(this.userData.shader.uniforms[e].value=this.extra[e])}})}replaceAll(e,t,s){return e.split(t).join(s)}}const as={common:"\n\t#include <common>\n\tuniform sampler2D sssMap;\n\tuniform float sssPower;\n\tuniform float sssScale;\n\tuniform float sssDistortion;\n\tuniform float sssAmbient;\n\tuniform float sssAttenuation;\n\tuniform vec3 sssColor;\n\n\tvoid RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n\t\tvec3 thickness = sssColor * texture2D(sssMap, uv).r;\n\t\tvec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * sssDistortion));\n\t\tfloat scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), sssPower) * sssScale;\n\t\tvec3 scatteringIllu = (scatteringDot + sssAmbient) * thickness;\n\t\treflectedLight.directDiffuse += scatteringIllu * sssAttenuation * directLight.color;\n\t}\n\t",light:"\n\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t#if defined( SUBSURFACE ) && defined( USE_UV )\n\t\tRE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n\t#endif\n\t"},os="\nfloat aoMapClr = 1.;\n\n#ifdef USE_AOMAP\n    aoMapClr = (texture2D(aoMap, vAoMapUv).r - 1.0) * aoMapIntensity + 1.0;\n#else\n    #ifdef USE_LIGHTMAP\n\n        float lightMapIntensityCorrect = lightMapIntensity;\n        if(useLegacyLights) lightMapIntensityCorrect = lightMapIntensity / PI;\n        vec3 lightMapVec = (texture2D(lightMap, vLightMapUv).rgb - vec3(1.)) * (lightMapIntensityCorrect) + vec3(1.);\n        \n        const vec3 luminanceWeight = vec3(0.2126, 0.7152, 0.0722);\n\n        // grayscale the lightmap\n        aoMapClr = dot(lightMapVec.rgb, luminanceWeight);\n    #endif\n#endif\n\nif(aoMapGamma != 1.) aoMapClr = pow(aoMapClr, 1. / aoMapGamma);\n\n// clamp\naoMapClr = min(1., aoMapClr);\n",ls="\nenvMapColor.rgb *= aoMapClr;\n\nvec3 origEnvMapColor = vec3(envMapColor.rgb);\n\nfloat origAoMapClr = aoMapClr;\n\n#ifndef DISABLE_SMOOTHING\n    // calculate smoothing\n    float smoothingRoughnessInfluence = max(0.75 - roughness, 0.);\n    float smoothingAoInfluence = (1. - aoMapClr) * 0.75;\n\n    float totalSmoothing = 0.3 + smoothingPower + (1. - smoothingPower) * smoothingRoughnessInfluence - smoothingAoInfluence;\n    vec3 smoothing = vec3(max(totalSmoothing, 0.));\n\n    envMapColor.rgb = pow(envMapColor.rgb, smoothing);\n#endif\n\nenvMapColor.rgb += pow(envMapColor.rgb, vec3(envPower)) * (aoPower * 0.2);\n\nfloat aoMapPower = pow(aoMapClr + aoSmoothing * (0.5 - aoMapClr), aoPower);\nif(aoMapPower > 1.) aoMapPower = 1.;\n",hs=`\n\nif(enableESL){\n    ${ls}\n\n    envMapColor.rgb *= irradianceColor;\n\n    #ifndef DISABLE_SMOOTHING\n        envMapColor.rgb = pow(envMapColor.rgb, smoothing);\n    #endif\n\n    float origAoMapClrPow = origAoMapClr * origAoMapClr;\n\n    vec3 hemisphereInfluence = aoMapClr * mix(\n        irradianceColor,\n        hemisphereColor,\n        1. - origAoMapClrPow\n    ) * envMapColor.rgb * envMapIntensity * 0.125;\n\n    envMapColor.rgb = mix(envMapColor.rgb, hemisphereColor, 1. - origAoMapClrPow);\n\n    vec3 env = irradianceIntensity * envMapColor.rgb * envMapIntensity * aoMapPower + hemisphereInfluence;\n\n    if(sunIntensity != 0.){\n        env += irradianceIntensity * sunIntensity * irradianceColor * origEnvMapColor * envMapIntensity * pow(aoMapClr, 16.);\n    }\n\n     return env;\n} else {\n    return PI * envMapColor.rgb * envMapIntensity;\n}\n`,cs=`\n\nif(enableESL) {\n    ${ls}\n\n    #ifndef DISABLE_SMOOTHING\n\n        envMapColor.rgb *= radianceColor;\n        envMapColor.rgb = pow(envMapColor.rgb, smoothing);\n\n    #endif\n\n    vec3 env = envMapColor.rgb * envMapIntensity * 0.125 * (aoMapPower * radianceIntensity + aoMapClr * radianceColor);\n\n    if(sunIntensity != 0.){\n        env += radianceIntensity * sunIntensity * irradianceColor * origEnvMapColor * envMapIntensity * pow(aoMapClr, 16.);\n    }\n\n    return env;\n\n} else {\n    return envMapColor.rgb * envMapIntensity;\n}\n`,us="\nif(enableESL) {\n    #ifdef USE_LIGHTMAP\n        float lightMapIntensityCorrect = lightMapIntensity;\n        if(useLegacyLights) lightMapIntensityCorrect = lightMapIntensity / PI;\n        vec3 lightMapClr = (texture2D(lightMap, vLightMapUv).rgb - vec3(1.)) * (lightMapIntensityCorrect) + vec3(1.);\n    #else\n        vec3 lightMapClr = vec3(1.);\n    #endif\n\n    if(lightMapGamma != 1.) lightMapClr = pow(lightMapClr, vec3(1. / lightMapGamma));\n\n    if(lightMapContrast != 1.) lightMapClr = adjustContrast(lightMapClr, lightMapContrast);\n\n    // clamp\n    lightMapClr = min(lightMapClr, vec3(1.));\n\n    // source: Chapter 16 of OpenGL Shading Language\n    const vec3 W = vec3(0.2125, 0.7154, 0.0721);\n    vec3 intensity = vec3(dot(lightMapClr, W));\n    lightMapClr = mix(intensity, lightMapClr, lightMapSaturation);\n\n    if(mapContrast != 1.) sampledDiffuseColor = vec4(adjustContrast(sampledDiffuseColor.rgb, mapContrast), 1.);\n\n    vec3 lightMapHsv = rgb2hsv(lightMapClr);\n    float saturation = lightMapHsv.y;\n\n    float mixVal = saturation;\n    \n    float value = pow(lightMapHsv.z, 0.05);\n    float darkness = 1. - value;\n\n    // lightMapHsv.y = mix(lightMapHsv.y, lightMapHsv.y * 5., darkness * 1.75);\n    \n    lightMapHsv = hsv2rgb(lightMapHsv);\n\n    // blend the lightmap color towards the diffuse color the more light this spot receives\n    lightMapHsv = mix(lightMapHsv, lightMapHsv * normalize(sampledDiffuseColor.rgb) * length(sampledDiffuseColor.rgb), value);\n\n    mixVal += darkness * 0.2;\n    \n    lightMapClr = pow(\n        mix(lightMapClr, lightMapHsv, mixVal),\n        vec3(1.25)\n    );\n\n    float lightnessFactor = pow(lightMapHsv.z, 0.1);\n\n    diffuseColor *= lightnessFactor * sampledDiffuseColor * vec4(lightMapClr, 1.0);\n    diffuseColor.a = 1.0;\n\n} else {\n    diffuseColor *= sampledDiffuseColor;\n}\n\n";e.ShaderChunk.map_fragment.replace("diffuseColor *= sampledDiffuseColor;",us);const ps=e.ShaderChunk.lights_pars_begin.replace("vec3 irradiance = ambientLightColor;",`\n    vec3 irradiance = vec3(0.0);\n    if(enableESL) {\n        ${os}\n        aoMapClr *= aoMapClr;\n        irradiance = mix( ambientLightColor, aoColor * 15.0 * ((aoMapClr - 1.0) * 0.28 + 1.0), 1.0 - aoMapClr );\n    } else {\n        irradiance = ambientLightColor;\n    }\n    `),ds=e.ShaderChunk.lights_fragment_maps.replace("irradiance += lightMapIrradiance;","if(!enableESL) irradiance += lightMapIrradiance;"),ms=e.ShaderChunk.lightmap_fragment.replace("reflectedLight.indirectDiffuse += lightMapIrradiance;","if(!enableESL) reflectedLight.indirectDiffuse += lightMapIrradiance;"),fs=e=>{let t=Math.fround(e).toString();return t.includes(".")||(t+="."),t},gs=e=>"vec3("+fs(e.r)+", "+fs(e.g)+", "+fs(e.b)+")";function ys(t,{enableESL:s=!0,useLegacyLights:i=!1,aoColor:n=new e.Color(0),hemisphereColor:r=new e.Color(16777215),irradianceColor:a=new e.Color(16777215),radianceColor:o=new e.Color(16777215),aoPower:l=1,aoSmoothing:h=0,aoMapGamma:c=1,lightMapGamma:u=1,lightMapSaturation:p=1,envPower:d=1,roughnessPower:m=1,sunIntensity:f=0,mapContrast:g=1,lightMapContrast:y=1,smoothingPower:v=.25,irradianceIntensity:w=Math.PI,radianceIntensity:x=1,hardcodeValues:b=!1}={}){t.defines&&t.fragmentShader.includes("#define ENHANCE_SHADER_LIGHTING")||(void 0===t.defines&&(t.defines={}),t.defines.ENHANCE_SHADER_LIGHTING="",b?t.fragmentShader=t.fragmentShader.replace("uniform float opacity;",`\n            uniform float opacity;\n            \n            const vec3 aoColor = ${gs(n)};\n            const vec3 hemisphereColor = ${gs(r)};\n            const vec3 irradianceColor = ${gs(a)};\n            const vec3 radianceColor = ${gs(o)};\n\n            const float aoPower = ${fs(l)};\n            const float aoSmoothing = ${fs(h)};\n            const float aoMapGamma = ${fs(c)};\n            const float lightMapGamma = ${fs(u)};\n            const float lightMapSaturation = ${fs(p)};\n            const float envPower = ${fs(d)};\n            const float roughnessPower = ${fs(m)};\n            const float sunIntensity = ${fs(f)};\n            const float mapContrast = ${fs(g)};\n            const float lightMapContrast = ${fs(y)};\n            const float smoothingPower = ${fs(v)};\n            const float irradianceIntensity = ${fs(w)};\n            const float radianceIntensity = ${fs(x)};\n            `):(t.uniforms.aoColor={value:n},t.uniforms.hemisphereColor={value:r},t.uniforms.irradianceColor={value:a},t.uniforms.radianceColor={value:o},t.uniforms.enableESL={value:s},t.uniforms.useLegacyLights={value:i},t.uniforms.aoPower={value:l},t.uniforms.aoSmoothing={value:h},t.uniforms.lightMapGamma={value:u},t.uniforms.lightMapSaturation={value:p},t.uniforms.aoMapGamma={value:c},t.uniforms.envPower={value:d},t.uniforms.smoothingPower={value:v},t.uniforms.roughnessPower={value:m},t.uniforms.sunIntensity={value:f},t.uniforms.mapContrast={value:g},t.uniforms.lightMapContrast={value:y},t.uniforms.irradianceIntensity={value:w},t.uniforms.radianceIntensity={value:x},t.fragmentShader=t.fragmentShader.replace("uniform float opacity;","\n            uniform float opacity;\n            \n            uniform vec3 aoColor;\n            uniform vec3 hemisphereColor;\n            uniform vec3 irradianceColor;\n            uniform vec3 radianceColor;\n\n            uniform bool enableESL;\n            uniform bool useLegacyLights;\n\n            uniform float aoPower;\n            uniform float aoSmoothing;\n            uniform float aoMapGamma;\n            uniform float lightMapGamma;\n            uniform float lightMapSaturation;\n            uniform float envPower;\n            uniform float roughnessPower;\n            uniform float sunIntensity;\n            uniform float mapContrast;\n            uniform float lightMapContrast;\n            uniform float smoothingPower;\n            uniform float irradianceIntensity;\n            uniform float radianceIntensity;\n\n            #define ENHANCE_SHADER_LIGHTING\n            \n// source: https://timseverien.com/posts/2020-06-19-colour-correction-with-webgl/\nvec3 adjustContrast(vec3 color, float value) {\n    const vec3 zero = vec3(0.);\n    return max(zero, 0.5 + value * (color - 0.5));\n}\n\n// source: https://gist.github.com/yiwenl/745bfea7f04c456e0101\nvec3 hsv2rgb(vec3 c){\n    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\n\n// source: https://gist.github.com/yiwenl/745bfea7f04c456e0101\nvec3 rgb2hsv(vec3 rgb) {\n    float Cmax = max(rgb.r, max(rgb.g, rgb.b));\n    float Cmin = min(rgb.r, min(rgb.g, rgb.b));\n    float delta = Cmax - Cmin;\n    vec3 hsv = vec3(0., 0., Cmax);\n    if (Cmax > Cmin) {\n        hsv.y = delta / Cmax;\n        if (rgb.r == Cmax)\n            hsv.x = (rgb.g - rgb.b) / delta;\n        else {\n            if (rgb.g == Cmax)\n                hsv.x = 2. + (rgb.b - rgb.r) / delta;\n            else\n                hsv.x = 4. + (rgb.r - rgb.g) / delta;\n        }\n        hsv.x = fract(hsv.x / 6.);\n    }\n    return hsv;\n}\n\n            ")),t.fragmentShader=t.fragmentShader.replace("main() {",`\n            main() {\n            ${os}\n            `).replace("#include <aomap_fragment>","\n#ifdef USE_AOMAP\n\n    // reads channel R, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n    if(!enableESL) {\n\n        float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n        reflectedLight.indirectDiffuse *= ambientOcclusion;\n\n        #if defined( USE_CLEARCOAT ) \n            clearcoatSpecularIndirect *= ambientOcclusion;\n        #endif\n\n        #if defined( USE_SHEEN ) \n            sheenSpecularIndirect *= ambientOcclusion;\n        #endif\n\n        #if defined( USE_ENVMAP ) && defined( STANDARD )\n\n            float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\n            reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\n        #endif\n    }\n\n#endif\n").replace("#include <lights_pars_begin>",ps).replace("#include <lights_fragment_maps>",ds).replace("#include <lightmap_fragment>",ms).replace("diffuseColor *= sampledDiffuseColor;",us).replace("#include <envmap_physical_pars_fragment>",e.ShaderChunk.envmap_physical_pars_fragment).replace("getIBLIrradiance( const in vec3 normal )","getIBLIrradiance( const in vec3 normal, float aoMapClr )").replace("getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness )","getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, float aoMapClr )").replace("return PI * envMapColor.rgb * envMapIntensity;",hs).replace("return envMapColor.rgb * envMapIntensity;",cs).replace("#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","\n            //#include <aomap_fragment>\n            #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n            ").replace("iblIrradiance += getIBLIrradiance( geometryNormal );","iblIrradiance += getIBLIrradiance( geometryNormal, aoMapClr );").replace("radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );","radiance += getIBLRadiance( geometryViewDir, geometryNormal, pow(material.roughness, enableESL ? roughnessPower : 1.0), aoMapClr );").replace("clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );","clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, pow(material.clearcoatRoughness, enableESL ? roughnessPower : 1.0), aoMapClr );"))}let vs={},ws=[];const xs={metalness:0,roughness:.2},bs={enableESL:!0,exposure:1,envMapIntensity:1,aoColor:new v(0),hemisphereColor:new v(16777215),irradianceColor:new v(16777215),radianceColor:new v(16777215),aoPower:9.7,aoSmoothing:.26,aoMapGamma:.89,lightMapGamma:.9,lightMapSaturation:1,envPower:1,roughnessPower:1,sunIntensity:0,mapContrast:1,lightMapContrast:1.03,smoothingPower:.76,irradianceIntensity:6.59,radianceIntensity:4.62,hardcodeValues:!1},Ms={body:new v(15724500),sleep:new v(10469309),solid:new v(7105128),base:new v(13224135),black:new v(2236962),gold:new v(.944,.776,.373),gold2:new v(.998,.981,.751),copper:new v(.96467984,.37626296,.25818297),carPaint:new v(.1037792,.59212029,.85064936),clay:new v(.604,.584,.497),concrete:new v(11119017)},As={No:E,Normal:P,Additive:_,Subtractive:L,Multiply:D,Eadd:z,Esub:O,Erev:F,Emin:N,Emaw:B,Fzero:U,Fone:V,Fcolor:H,Fcolorm:j,Falpha:G,Falpham:W,Fdstalpha:q,Fdstalpham:X,Fdstcolor:K,Fdstcolorm:Z,Falphasaturate:Y,Front:Q,Back:b,Double:I},Ts={isRealism:!1,realismOption:{},envMapIntensity:1,useRealLight:e=>{Ts.isRealism=!0;for(let t in e)-1!==t.search("Color")&&(e[t].isColor||(bs[t].set(e[t]),delete e[t]));Ts.realismOption={...bs,...e}},setColor:e=>{Ts.isRealism&&(bs.aoColor.set(e.minLuma).convertLinearToSRGB(),bs.hemisphereColor.set(e.maxLuma).convertLinearToSRGB(),bs.irradianceColor.set(e.sun).convertLinearToSRGB(),bs.radianceColor.set(e.vibrant).convertLinearToSRGB())},set:(e,t,s=null)=>{s||(s=e.onBeforeCompile),t||Ts.extendShader(e,s),vs[e.name]=e},extendShader:(e,t=null)=>{Ts.isRealism?e.onBeforeCompile=function(s){ys(s,Ts.realismOption),e.userData.isRealism=!0,e.userData.shader=s,t&&t(s)}:t&&(e.onBeforeCompile=function(e){t(e)})},addToTmp:e=>{ws.push(e)},create:e=>{let t,s=null;if(e.isMaterial)t=e;else{let i=void 0!==e.type?e.type:"Standard";switch(e.type&&delete e.type,e.shadowSide||(e.shadowSide="double"),s=e.beforeCompile||null,e.beforeCompile&&delete e.beforeCompile,(e.thickness||e.sheen||e.clearcoat||e.transmission||e.specularColor)&&(i="Physical"),e.normalScale&&(e.normalScale.isVector2||(e.normalScale=(new M).fromArray(e.normalScale))),e.side&&(e.side=Ts.findValue(e.side)),e.shadowSide&&(e.shadowSide=Ts.findValue(e.shadowSide)),e.blending&&(e.blending=Ts.findValue(e.blending)),e.blendEquation&&(e.blendEquation=Ts.findValue(e.blendEquation)),e.blendEquationAlpha&&(e.blendEquationAlpha=Ts.findValue(e.blendEquationAlpha)),e.blendSrc&&(e.blendSrc=Ts.findValue(e.blendSrc)),e.blendDst&&(e.blendDst=Ts.findValue(e.blendDst)),e.blendDstAlpha&&(e.blendDstAlpha=Ts.findValue(e.blendDstAlpha)),e.blendSrcAlpha&&(e.blendSrcAlpha=Ts.findValue(e.blendSrcAlpha)),e.clearcoatNormalScale&&(e.clearcoatNormalScale.isVector2||(e.clearcoatNormalScale=(new M).fromArray(e.clearcoatNormalScale))),i=i.toLowerCase(),i){case"physical":t=new y(e),t.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":t=new C(e);break;case"lambert":t=new k(e);break;case"basic":t=new R(e);break;case"line":t=new l(e);break;case"toon":t=new S(e);break;case"shadow":t=new T(e);break;case"sss":t=new rs(e);break;default:t=new A(e)}Ts.upEnvmapIntensity(t)}return vs[t.name]?null:(Ts.set(t,!1,s),t)},findValue:e=>"string"===e?As[e.charAt(0).toUpperCase()+e.slice(1)]:e,addToMat:e=>{if(Ts.isRealism)for(let t in e)e[t].shadowSide=I,e[t].onBeforeCompile=function(s){ys(s,Ts.realismOption),e[t].userData.isRealism=!0,e[t].userData.shader=s};vs={...vs,...e}},changeType:()=>{},setEnvmapIntensity:e=>{if(e!==Ts.envMapIntensity){Ts.envMapIntensity=e;for(let e in vs)Ts.upEnvmapIntensity(vs[e])}},upEnvmapIntensity:e=>{e.userData.envp||(e.userData.envp=e.envMapIntensity),e.envMapIntensity=e.userData.envp*Ts.envMapIntensity},getList:()=>{let e={...vs};const t=["line","debug","hide","svg"];let s=t.length;for(;s--;)delete e[t[s]];return e},get:e=>{if(!vs[e])switch(e){case"body":Ts.create({name:"body",color:Ms.body,...xs});break;case"sleep":Ts.create({name:"sleep",color:Ms.sleep,...xs});break;case"solid":Ts.create({name:"solid",color:Ms.solid,metalness:.1,roughness:.8});break;case"clay":Ts.create({name:"clay",color:Ms.clay,metalness:0,roughness:.9});break;case"base":Ts.create({name:"base",color:Ms.base,...xs});break;case"concrete":Ts.create({name:"concrete",color:Ms.concrete,metalness:0,roughness:.9});break;case"black":Ts.create({name:"black",color:Ms.black,metalness:0,roughness:.25});break;case"chrome":Ts.create({name:"chrome",color:13421772,metalness:1,roughness:.075});break;case"gold":Ts.create({name:"gold",color:Ms.gold,specularColor:Ms.gold2,metalness:1,roughness:.02});break;case"copper":Ts.create({name:"copper",color:Ms.copper,metalness:1,roughness:.25,clearcoat:1,clearcoatRoughness:.2});break;case"carPaint":Ts.create({name:"carPaint",color:Ms.carPaint,metalness:0,anisotropy:new M(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":Ts.create({name:"carbon",map:new ns,normalMap:new ns(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":Ts.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":Ts.create({name:"skinny",color:14724201,...xs});break;case"glass":Ts.create({name:"glass",color:16777215,transparent:!0,opacity:.8,depthTest:!0,depthWrite:!0,roughness:.02,metalness:0,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.02});break;case"glassX":Ts.create({name:"glassX",color:15658734,transparent:!1,opacity:1,roughness:.03,metalness:0,side:I,transmission:1,clearcoat:1,clearcoatRoughness:0,thickness:.6,ior:1.52,envMapIntensity:1,shadowSide:1,reflectivity:.5,iridescence:0});break;case"plexi":Ts.create({name:"plexi",color:16777215,transparent:!0,opacity:.4,metalness:0,roughness:0,clearcoat:1,side:I});break;case"glass2":Ts.create({name:"glass2",color:15658734,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.3});break;case"glass3":Ts.create({name:"glass3",color:0,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.4});break;case"glass_red":Ts.create({name:"glass_red",color:16711680,transparent:!0,roughness:0,alphaToCoverage:!0,opacity:.8});break;case"car":Ts.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":Ts.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"outline":vs.outline||(vs.outline=Ss),vs.outline;break;case"debug":Ts.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.5});break;case"shadow":Ts.create({name:"shadow",type:"shadow",color:0,opacity:.5});break;case"bones":Ts.create({name:"bones",color:16639958,wireframe:!0});break;case"bones2":Ts.create({name:"bones2",type:"basic",color:14664872,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!1,alphaToCoverage:!0});break;case"button":Ts.create({name:"button",color:16728139,...xs});break;case"line":Ts.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"hide":Ts.create({name:"hide",type:"basic",visible:!1});break;case"particle":Ts.create({name:"particle",type:"basic",toneMapped:!1,color:65280});break;case"svg":Ts.create({name:"svg",type:"basic",toneMapped:!1,vertexColors:!0,transparent:!1,side:I})}return vs[e]},dispose:()=>{Ts.isRealism=!1;for(let e in vs)vs[e].dispose(),delete vs[e];let e=ws.length;for(;e--;)ws[e].dispose();ws=[]},upShader:()=>{let e=Ts.realismOption;for(let t in vs){const s=vs[t],i=s.userData.shader;for(let t in e)i&&i.uniforms[t]&&(i.uniforms[t].value=e[t]),s[t]&&(s[t]=e[t])}}},Ss=new x({uniforms:{color:{type:"c",value:new v(16777215)},power:{type:"f",value:.01}},vertexShader:"\n        uniform float power;\n        void main(){\n            //vec3 pos = position + normal * power;\n            vec3 pos = position + normalize( normal ) * power;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( pos, 1.0 );\n        }\n    ",fragmentShader:"\n        uniform vec3 color;\n        void main(){\n           gl_FragColor = vec4( color, 1.0 );\n        }\n    ",side:b,toneMapped:!1});class Rs{constructor(e=-1){this.perf=window.performance,this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(e),this.force=!1}up(e){let t=this.time;return this.unlimited&&(this.force=!0),t.now=void 0!==e?e:this.now(),t.delta=t.now-t.then,this.force&&(t.delta=t.interval,this.force=!1),!!(t.delta>=t.interval||this.unlimited)&&(t.then=this.unlimited?t.now:t.now-t.delta%t.interval,this.delta=.001*t.interval,this.elapsedTime+=this.delta,!0)}setFramerate(e){this.elapsedTime=0,this.framerate=e,this.unlimited=this.framerate<0,this.time.interval=1e3/e,60===e&&(this.time.interval=16.67)}static now(){return this.perf?this.perf.now():Date.now()}static format_time(e){return e>1e3?e/1e3+" sec":e+" ms"}}class ks{constructor(e){this.values=[],this.ready=0,this.key=e}update(){var e,t,s,i,n,r,a=this.fix,o=navigator.getGamepads();for(e=0;e<o.length;e++)if(r=o[e])if(s=r.axes.length,i=r.buttons.length){for(this.values[e]||(this.values[e]=[]),t=0;t<s;t++)n=a(r.axes[t],.08),0==this.ready&&0!==n&&(this.ready=1),this.values[e][t]=n;for(t=0;t<i;t++)n=a(r.buttons[t].value),0==this.ready&&0!==n&&(this.ready=1),this.values[e][s+t]=n}else this.values[e]&&(this.values[e]=null)}getValue(e){for(var t,s=19;s--;)t=this.values[e][s],0==this.ready&&0!==t&&(this.ready=1),this.key[s]=t}reset(){this.ready=0}fix(e,t){let s=Number(e.toString().substring(0,5));return t&&s<t&&s>-t&&(s=0),s}}class Cs{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let e=this.list.length;for(;e--;)this.dispose(this.list[e]);this.list=[],this.id=0}byName(e){return this.Utils.byName(e)}setName(e={}){let t=void 0!==e.name?e.name:this.type+this.id++;return e.id=this.remove(t,!0),e.name=t,t}addToWorld(e,t=-1){this.Utils.add(e),-1!==t?this.list[t]=e:this.list.push(e)}remove(e,t){let s=this.byName(e);return s?this.clear(s,t):-1}clear(e,t){let s=this.list.indexOf(e);return-1===s||t?this.list[s]=null:this.list.splice(s,1),this.dispose(e),s}dispose(e){null!==e&&this.Utils.remove(e)}add(e={}){}set(e={}){}step(e,t){}}class Is extends Cs{constructor(){super(),this.Utils=Yt,this.type="ray",this.iType="ray"}step(){const e=Zt.Ar,t=Zt.ArPos[this.type];let s,i,n=this.list.length;for(;n--;)s=this.list[n],i=t+n*Xt.ray,s.update(e,i,Zt.reflow.ray[n]||null)}add(e={}){this.setName(e);let t=new Es(e);return t.visible=void 0===e.visible||e.visible,this.addToWorld(t,e.id),e.parent&&"string"!=typeof e.parent&&(e.parent=e.parent.name),e.callback&&delete e.callback,Zt.post({m:"add",o:e}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.setRay(e)}}class Es extends J{constructor(e={}){super(new r,Ts.get("line")),this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0,parent:null},this.type="ray",this.name=e.name,this.parentMesh=null,e.parent&&(this.parentMesh="string"==typeof e.parent?Yt.byName(e.parent):e.parent,this.data.parent=this.parentMesh),this.callback=e.callback||function(){},this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new i,this.end=new i(0,1,0),this.tmp=new i,this.vnormal=new i,this.vv1=new i,this.vv2=new i,this.fullDistance=0,this.setRay(e);this.geometry.setAttribute("position",new o([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new o([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(e){e.begin&&this.begin.fromArray(e.begin),e.end&&this.end.fromArray(e.end),this.fullDistance=this.begin.distanceTo(this.end)}update(e,t=0,s=null){if(this.data.hit=0!==e[t],this.data.body=s||"",this.data.distance=e[t+1],this.data.hit)this.local[0]=e[t+2],this.local[1]=e[t+3],this.local[2]=e[t+4],this.tmp.fromArray(e,t+5),this.vnormal.fromArray(e,t+8),this.data.point=this.tmp.toArray(),this.data.normal=this.vnormal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.vnormal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(Bt.angleTo(this.vv1.toArray(),this.data.normal)*zt);else if(this.parentMesh){const e=this.parentMesh.matrixWorld;this.tmp.copy(this.begin).applyMatrix4(e).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(e),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.updateMatrix(),this.callback(this.data)}dispose(){this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let e=this.vertices.array,t=this.colors.array,s=this.local,i=this.data.hit,n=i?this.c2:this.c1,r=i?this.c3:this.c1;t[3]=n[0],t[4]=n[1],t[5]=n[2],t[6]=r[0],t[7]=r[1],t[8]=r[2],e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}Es.prototype.isRay=!0;let Ps=0;const _s=new i,Ls=new t,Ds=new te,zs=new i,Os=new i,Fs=new i,Ns=new t,Bs=new i(1,0,0),Us=new i(0,1,0),Vs=new i(0,0,1),Hs={type:"added"},js={type:"removed"};class Gs extends ${constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Ps++}),this.uuid=ee.generateUUID(),this.isRay=!0,this.matrix=new te,this.matrixWorld=new te,this.name="",this.type="Object3D",this.children=[],this.parent=null,this.position=new i,this.quaternion=new t,this.tmpRotation=new se,this.scale=new i(1,1,1),this.isKinematic=!1,this.matrixAutoUpdate=!1,this.matrixWorldNeedsUpdate=!1,this.layers=new ie,this.visible=!0,this.isVisible=!0,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.mass=0,this.density=0,this.inertia=new i(1,1,1),this.shapetype="box",this.size=[1,1,1],this.velocity=new i,this.angular=new i,this.defMat=!1,this.actif=!1,this.auto=!1,this.sleep=!1,this.mesh=null,this.meshSize=1,this.linked=[],this.isOver=!1,this.overMaterial=null}clearOutLine(){this.overMaterial&&this.outline&&(this.remove(this.outline),this.outline=null)}addOutLine(){this.overMaterial&&this.children[0].isMesh&&(this.outline=(new ne).copy(this.children[0]),this.outline.geometry.normalizeNormals(),this.outline.name="outline",this.outline.material=this.overMaterial,this.overMaterial.uniforms.power.value=.01/this.meshSize,this.outline.matrixAutoUpdate=!1,this.outline.receiveShadow=!1,this.outline.castShadow=!1,this.outline.raycast=()=>null,this.add(this.outline))}over(e){e&&!this.isOver&&(this.isOver=!0,this.addOutLine()),!e&&this.isOver&&(this.isOver=!1,this.clearOutLine())}select(e){}dispose(){this.clearOutLine(),this.traverse((function(e){e.isMesh&&e.unic&&e.geometry.dispose()})),this.children=[]}set receiveShadow(e){this.traverse((function(t){t.isMesh&&(t.receiveShadow=e)}))}get receiveShadow(){return!!this.children[0]&&this.children[0].receiveShadow}set castShadow(e){this.traverse((function(t){t.isMesh&&(t.castShadow=e)}))}get castShadow(){return!!this.children[0]&&this.children[0].castShadow}set material(e){this.traverse((function(t){t.isMesh&&"outline"!==t.name&&(t.material=e)}))}get material(){return this.children,this.children[0]?this.children[0].material:null}set rotation(e){this.tmpRotation=e,quaternion.setFromEuler(this.tmpRotation,!1)}get rotation(){return this.tmpRotation.setFromQuaternion(this.quaternion,void 0,!1)}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return Ls.setFromAxisAngle(e,t),this.quaternion.multiply(Ls),this}rotateOnWorldAxis(e,t){return Ls.setFromAxisAngle(e,t),this.quaternion.premultiply(Ls),this}rotateX(e){return this.rotateOnAxis(Bs,e)}rotateY(e){return this.rotateOnAxis(Us,e)}rotateZ(e){return this.rotateOnAxis(Vs,e)}translateOnAxis(e,t){return _s.copy(e).applyQuaternion(this.quaternion),this.position.add(_s.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Bs,e)}translateY(e){return this.translateOnAxis(Us,e)}translateZ(e){return this.translateOnAxis(Vs,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(Ds.copy(this.matrixWorld).invert())}lookAt(e,t,s){e.isVector3?zs.copy(e):zs.set(e,t,s);const i=this.parent;this.updateWorldMatrix(!0,!1),Os.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Ds.lookAt(Os,zs,this.up):Ds.lookAt(zs,Os,this.up),this.quaternion.setFromRotationMatrix(Ds),i&&(Ds.extractRotation(i.matrixWorld),Ls.setFromRotationMatrix(Ds),this.quaternion.premultiply(Ls.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(Hs)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(js)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){const e=this.children;let t=e.length;for(;t--;){const s=e[t];s.parent=null,s.dispatchEvent(js)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),Ds.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Ds.multiply(e.parent.matrixWorld)),e.applyMatrix4(Ds),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;const s=this.children;let i=s.length;for(;i--;){const n=s[i].getObjectByProperty(e,t);if(void 0!==n)return n}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Os,e,Fs),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Os,Ns,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}setRaycast(e){if(void 0!==e&&(this.isRay=e),!this.isRay){let e=this.children.length;for(;e--;)this.children[e].raycast=()=>{}}}raycast(e,t){if(!this.isRay)return;const s=this.children;let i=s.length;for(;i--;)s[i].layers.test(e.layers)&&s[i].raycast(e,t)}traverse(e){e(this);const t=this.children;let s=t.length;for(;s--;)t[s].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;let s=t.length;for(;s--;)t[s].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;let s=t.length;for(;s--;)t[s].updateMatrixWorld(e)}updateWorldMatrix(e,t){const s=this.parent;if(!0===e&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;let t=e.length;for(;t--;)e[t].updateWorldMatrix(!1,!0)}}}class Ws extends re{constructor(e,s,i=0){super(e,s,i),this.matrixAutoUpdate=!1,this.tmpMatrix=new te,this.tmpQuat=new t,this.instanceUv=null,this.instanceColor=null,this.needSphereUp=!1,this.isRay=!0,this.overMaterial=null,this.currentOver=-1,this.isOver=!1}clearOutLine(){this.overMaterial&&this.outline&&(this.parent.remove(this.outline),this.outline=null,this.currentOver=-1)}addOutLine(e){this.overMaterial&&(this.outline=new ne(this.geometry,this.overMaterial),this.overMaterial.uniforms.power.value=.01,this.outline.matrixAutoUpdate=!1,this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e.id),this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0,this.parent.add(this.outline),this.currentOver=e.id)}over(e){e&&!this.instance.isOver&&(this.instance.isOver=!0,this.instance.addOutLine(this)),!e&&this.instance.isOver&&(this.instance.isOver=!1,this.instance.clearOutLine())}getInfo(e){this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e);let t={x:0,y:0,z:0},s={x:0,y:0,z:0};return this.tmpMatrix.decompose(t,this.tmpQuat,s),{pos:[t.x,t.y,t.z],quat:this.tmpQuat.toArray(),scale:[s.x,s.y,s.z]}}add(e=[0,0,0],t=[0,0,0,1],s=[1,1,1],i=null,n=null){3===t.length&&(t=this.tmpQuat.setFromEuler({_x:t[0],_y:t[1],_z:t[2],_order:"XYZ"},!1).toArray()),i&&(i.isColor&&(i=i.toArray()),null===this.instanceColor&&(this.instanceColor=new ae(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(e,t,s,i,n)}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new ae(new Float32Array(3*this.instanceMatrix.count),3)),t.isColor&&(t=t.toArray());let s=3*e;this.instanceColor.array[s]=t[0],this.instanceColor.array[s+1]=t[1],this.instanceColor.array[s+2]=t[2]}remove(e){if(!this.count)return;let t=[...this.instanceMatrix.array];t.splice(16*e,16),this.instanceMatrix=new ae(new Float32Array(t),16),null!==this.instanceColor&&(t=[...this.instanceColor.array],t.splice(3*e,3),this.instanceColor=new ae(new Float32Array(t),3)),null!==this.instanceUv&&(t=[...this.instanceUv.array],t.splice(2*e,2),this.instanceUv=new ae(new Float32Array(t),2)),this.count--}expand(e,t,s,i=[1,1,1],n){let r=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:t[0],_y:t[1],_z:t[2],_w:t[3]},{x:s[0],y:s[1],z:s[2]}),this.instanceMatrix=new ae(new Float32Array([...r,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(r=this.instanceColor.array,this.instanceColor=new ae(new Float32Array([...r,...i]),3)),this.count++}setTransformAt(e,t,s,i){this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:s[0],_y:s[1],_z:s[2],_w:s[3]},{x:i[0],y:i[1],z:i[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*e),this.needSphereUp=!0,this.outline&&this.currentOver===e&&(this.outline.matrix.copy(this.tmpMatrix),this.outline.matrixWorldNeedsUpdate=!0)}dispose(){this.clearOutLine(),this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.dispatchEvent({type:"dispose"})}setRaycast(e){void 0!==e&&(this.isRay=e)}raycast(e,t){this.isRay&&super.raycast(e,t)}update(){this.needSphereUp&&this.computeBoundingSphere(),this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp=!1}}function qs(e,t=!1){const s=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),n=new Set(Object.keys(e[0].morphAttributes)),a={},o={},l=e[0].morphTargetsRelative,h=new r;let c=0;for(let r=0;r<e.length;++r){const u=e[r];let p=0;if(s!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const e in u.attributes){if(!i.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.'),null;void 0===a[e]&&(a[e]=[]),a[e].push(u.attributes[e]),p++}if(p!==i.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". Make sure all geometries have the same number of attributes."),null;if(l!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const e in u.morphAttributes){if(!n.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[e]&&(o[e]=[]),o[e].push(u.morphAttributes[e])}if(t){let e;if(s)e=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+r+". The geometry must have either an index or a position attribute"),null;e=u.attributes.position.count}h.addGroup(c,e,r),c+=e}}if(s){let t=0;const s=[];for(let i=0;i<e.length;++i){const n=e[i].index;for(let e=0;e<n.count;++e)s.push(n.getX(e)+t);t+=e[i].attributes.position.count}h.setIndex(s)}for(const e in a){const t=Xs(a[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" attribute."),null;h.setAttribute(e,t)}for(const e in o){const t=o[e][0].length;if(0===t)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[e]=[];for(let s=0;s<t;++s){const t=[];for(let i=0;i<o[e].length;++i)t.push(o[e][i][s]);const i=Xs(t);if(!i)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" morphAttribute."),null;h.morphAttributes[e].push(i)}}return h}function Xs(e){let t,s,i,n=-1,r=0;for(let a=0;a<e.length;++a){const o=e[a];if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=o.itemSize),s!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===i&&(i=o.normalized),i!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===n&&(n=o.gpuType),n!==o.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;r+=o.count*s}const o=new t(r),l=new a(o,s,i);let h=0;for(let t=0;t<e.length;++t){const i=e[t];if(i.isInterleavedBufferAttribute){const e=h/s;for(let t=0,n=i.count;t<n;t++)for(let n=0;n<s;n++){const s=i.getComponent(t,n);l.setComponent(t+e,n,s)}}else o.set(i.array,h);h+=i.count*s}return void 0!==n&&(l.gpuType=n),l}function Ks(e,t=1e-4){t=Math.max(t,Number.EPSILON);const s={},i=e.getIndex(),n=e.getAttribute("position"),r=i?i.count:n.count;let o=0;const l=Object.keys(e.attributes),h={},c={},u=[],p=["getX","getY","getZ","getW"],d=["setX","setY","setZ","setW"];for(let t=0,s=l.length;t<s;t++){const s=l[t],i=e.attributes[s];h[s]=new a(new i.array.constructor(i.count*i.itemSize),i.itemSize,i.normalized);const n=e.morphAttributes[s];n&&(c[s]=new a(new n.array.constructor(n.count*n.itemSize),n.itemSize,n.normalized))}const m=.5*t,f=Math.log10(1/t),g=Math.pow(10,f),y=m*g;for(let t=0;t<r;t++){const n=i?i.getX(t):t;let r="";for(let t=0,s=l.length;t<s;t++){const s=l[t],i=e.getAttribute(s),a=i.itemSize;for(let e=0;e<a;e++)r+=~~(i[p[e]](n)*g+y)+","}if(r in s)u.push(s[r]);else{for(let t=0,s=l.length;t<s;t++){const s=l[t],i=e.getAttribute(s),r=e.morphAttributes[s],a=i.itemSize,u=h[s],m=c[s];for(let e=0;e<a;e++){const t=p[e],s=d[e];if(u[s](o,i[t](n)),r)for(let e=0,i=r.length;e<i;e++)m[e][s](o,r[e][t](n))}}s[r]=o,u.push(o),o++}}const v=e.clone();for(const t in e.attributes){const e=h[t];if(v.setAttribute(t,new a(e.array.slice(0,o*e.itemSize),e.itemSize,e.normalized)),t in c)for(let e=0;e<c[t].length;e++){const s=c[t][e];v.morphAttributes[t][e]=new a(s.array.slice(0,o*s.itemSize),s.itemSize,s.normalized)}}return v.setIndex(u),v}function Zs(e,t){if(t===oe)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===le||t===he){let s=e.getIndex();if(null===s){const t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,n=[];if(t===le)for(let e=1;e<=i;e++)n.push(s.getX(0)),n.push(s.getX(e)),n.push(s.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(n.push(s.getX(e)),n.push(s.getX(e+1)),n.push(s.getX(e+2))):(n.push(s.getX(e+2)),n.push(s.getX(e+1)),n.push(s.getX(e)));n.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=e.clone();return r.setIndex(n),r.clearGroups(),r}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class Ys extends r{constructor(e=1,t=10,s=10,n=10,r=1){super(),this.type="SphereBox",this.name="SphereBox_"+e+"_"+t+"_"+s+"_"+n+"_"+r,e=e||1,t=Math.floor(t),s=Math.floor(s),n=Math.floor(n);let a,o=new u(1,1,1,t,s,n),l=new i,h=new i,c=o.attributes.position.array,p=o.attributes.normal.array;for(let t=0,s=o.attributes.position.count;t<s;t++)a=3*t,l.set(c[a],c[a+1],c[a+2]),h.copy(l).normalize(),l.lerp(h,r).multiplyScalar(e),c[a]=l.x,c[a+1]=l.y,c[a+2]=l.z,l.normalize(),p[a]=l.x,p[a+1]=l.y,p[a+2]=l.z;this.copy(o)}}class Qs extends r{constructor(e=1,t=1,s=12,i=1){super(),this.type="CapsuleGeometry";let n=Math.PI,r=e/(2*e+t),a=1-2*r;s=Math.floor(s),i=Math.floor(i);let o=Math.floor(.5*s),l=2*Math.PI,u=.5*Math.PI,p=new c(e,e,t,s,i,!0);si(p,0,r,1,a);let d=new h(e,s,o,0,l,0,u);si(d,0,1-r,1,r);let m=new h(e,s,o,0,l,u,u);si(m,0,0,1,r);let f=(new te).makeRotationY(.5*-n),g=(new te).makeTranslation(0,.5*t,0),y=(new te).makeTranslation(0,.5*-t,0);p.applyMatrix4(f),d.applyMatrix4(g),m.applyMatrix4(y);let v=Ks(qs([p,d,m]));this.copy(v)}}class Js extends r{constructor(e=1,t=.4,s=8,n=6,r=2*Math.PI,a=0,l=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:e,tube:t,radialSegments:s,tubularSegments:n,arc:r},s=Math.floor(s),n=Math.floor(n);const h=[],c=[],u=[],p=[],d=new i,m=new i,f=new i;let g,y;for(g=0;g<=s;g++)for(y=0;y<=n;y++){const i=y/n*r,o=g/s*l+a;m.x=(e+t*Math.cos(o))*Math.cos(i),m.y=(e+t*Math.cos(o))*Math.sin(i),m.z=t*Math.sin(o),c.push(m.x,m.y,m.z),d.x=e*Math.cos(i),d.y=e*Math.sin(i),f.subVectors(m,d).normalize(),u.push(f.x,f.y,f.z),p.push(y/n),p.push(g/s)}for(g=1;g<=s;g++)for(y=1;y<=n;y++){const e=(n+1)*g+y-1,t=(n+1)*(g-1)+y-1,s=(n+1)*(g-1)+y,i=(n+1)*g+y;h.push(e,t,i),h.push(t,s,i)}this.setIndex(h),this.setAttribute("position",new o(c,3)),this.setAttribute("normal",new o(u,3)),this.setAttribute("uv",new o(p,2))}}class $s extends r{constructor(e=1,t=1,s=1,i=.01,n=12,r=1,a=2){super(),this.type="ChamferCyl",n=Math.floor(n),r=Math.floor(r),a=Math.floor(a);let o=new te,l=new te,h=Math.PI,u=.5*h,p=2*h,d=i/s,m=1-2*d,f=new c(e,t,s-2*i,n,r,!0,0);o.makeRotationY(u),f.applyMatrix4(o),si(f,0,d,1,m);let g=new Js(e-i,i,a,n,p,0,u),y=new ce(e-i,n);l.makeTranslation(0,0,i),y.applyMatrix4(l),si(g,0,1-d,1,d);let v=qs([g,y]);o.makeTranslation(0,0,.5*s-i),l.makeRotationX(-u),v.applyMatrix4(l.multiply(o)),g=new Js(t-i,i,a,n,p,0,u),y=new ce(t-i,n),l.makeTranslation(0,0,i),y.applyMatrix4(l),si(g,0,1-d,1,d,!0);let w=qs([g,y]);o.makeTranslation(0,0,.5*s-i),l.makeRotationX(u),w.applyMatrix4(l.multiply(o));let x=Ks(qs([v,f,w]));this.copy(x)}}class ei extends r{constructor(e=1,t=1,s=1,i=.01,n=1,r=1,a=1,o=2){super(),this.type="ChamferBox",n=Math.floor(n),r=Math.floor(r),a=Math.floor(a),o=Math.floor(o);let l=Math.PI,h=.5*l,u=2*i,d=.5*e,m=.5*t,f=.5*s,g=new te,y=new te,v=new te,w=i/e,x=1-2*w,b=i/t,M=1-2*w,A=i/s,T=1-2*A,S=new p(e-u,t-u,n,r),R=new c(i,i,e-u,o,n,!0,0,h),k=new c(i,i,t-u,o,r,!0,0,h),C=new ti(i,o,o,0,h,0,-h),I=new ti(i,o,o,0,h,0,-h);si(S,-w,b,x,M),si(R,0,w,b,x),y.makeTranslation(0,m-i,0),g.makeRotationX(h),C.applyMatrix4(y.multiply(g)),y.makeTranslation(0,-m+i,0),g.makeRotationX(h),v.makeRotationY(-h),I.applyMatrix4(y.multiply(g).multiply(v));let E=qs([k,C,I]),P=E.clone();y.makeTranslation(d-i,0,-i),E.applyMatrix4(y),y.makeTranslation(-d+i,0,-i),g.makeRotationZ(l),P.applyMatrix4(y.multiply(g));let _=R.clone();g.makeRotationZ(h),y.makeTranslation(0,m-i,-i),R.applyMatrix4(y.multiply(g)),y.makeTranslation(0,-m+i,-i),g.makeRotationZ(-h),_.applyMatrix4(y.multiply(g));let L=qs([R,_,S,E,P]),D=L.clone();y.makeTranslation(0,0,f),L.applyMatrix4(y),y.makeTranslation(0,0,-f),g.makeRotationY(l),D.applyMatrix4(y.multiply(g)),S=new p(s-u,t-u,a,r),R=new c(i,i,s-u,o,a,!0,0,h),_=R.clone(),si(S,-A,b,T,M),y.makeTranslation(0,-(m-i),-i,0),g.makeRotationZ(-h),R.applyMatrix4(y.multiply(g)),y.makeTranslation(0,m-i,-i,0),g.makeRotationZ(h),_.applyMatrix4(y.multiply(g));let z=qs([R,_,S]),O=z.clone();y.makeTranslation(-d,0,0),g.makeRotationY(-h),z.applyMatrix4(y.multiply(g)),y.makeTranslation(d,0,0),g.makeRotationY(h),O.applyMatrix4(y.multiply(g)),S=new p(e-u,s-u,n,a),si(S,-w,A,x,T);let F=S.clone();y.makeTranslation(0,m,0),g.makeRotationX(-h),S.applyMatrix4(y.multiply(g)),y.makeTranslation(0,-m,0),g.makeRotationX(h),F.applyMatrix4(y.multiply(g));let N=Ks(qs([L,D,z,O,S,F]));ii(N,"box"),this.copy(N)}}class ti extends r{constructor(e=1,t=8,s=6,n=0,r=2*Math.PI,a=0,l=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:e,widthSegments:t,heightSegments:s,phiStart:n,phiLength:r,thetaStart:a,thetaLength:l},t=Math.floor(t),s=Math.floor(s);const h=Math.min(a+l,Math.PI);let c=0;const u=[],p=new i,d=new i,m=[],f=[],g=[],y=[];for(let i=0;i<=s;i++){const o=[],m=i/s;let v=0;0==i&&0==a?v=.5/t:i==s&&h==Math.PI&&(v=-.5/t);for(let s=0;s<=t;s++){const i=s/t;p.x=-e*Math.cos(n+i*r)*Math.sin(a+m*l),p.y=e*Math.cos(a+m*l),p.z=e*Math.sin(n+i*r)*Math.sin(a+m*l),f.push(p.x,p.y,p.z),d.copy(p).normalize(),g.push(d.x,d.y,d.z),y.push(i+v,1-m),o.push(c++)}u.push(o)}for(let e=0;e<s;e++)for(let i=0;i<t;i++){const t=u[e][i+1],n=u[e][i],r=u[e+1][i],o=u[e+1][i+1];(0!==e||a>0)&&m.push(t,n,o),(e!==s-1||h<Math.PI)&&m.push(n,r,o)}this.setIndex(m),this.setAttribute("position",new o(f,3)),this.setAttribute("normal",new o(g,3)),this.setAttribute("uv",new o(y,2))}}function si(e,t=0,s=0,i=1,n=1,r){let a=e.attributes.uv,o=a.array,l=a.count,h=0;for(;l--;)h=2*l,o[h]=o[h]*i-t,o[h+1]=o[h+1]*n+s,r&&(o[h]=1-o[h],o[h+1]=1-o[h+1])}function ii(e,t="sphere",s,n=[0,0,0],r=[0,0,0,1],a){if(void 0===a&&(a=new te),a.compose({x:n[0],y:n[1],z:n[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:1,y:1,z:1}),void 0===s){e.boundingBox||e.computeBoundingBox();let t=e.boundingBox;s=Math.max(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z)}let l=new ue(new i(-s/2,-s/2,-s/2),new i(s/2,s/2,s/2)),h=[];h.length=2*e.attributes.position.count,void 0===e.attributes.uv&&e.setAttribute("uv",new o(h,2));let c,u,p,d,m,f=function(e,t,s){e.applyMatrix4(a),t.applyMatrix4(a),s.applyMatrix4(a);let i=1/(2*Math.PI),n=1/Math.PI;return e.normalize(),t.normalize(),s.normalize(),{uv0:new M(.5-Math.atan(e.z,-e.x)*i,.5-Math.asin(e.y)*n),uv1:new M(.5-Math.atan(t.z,-t.x)*i,.5-Math.asin(t.y)*n),uv2:new M(.5-Math.atan(s.z,-s.x)*i,.5-Math.asin(s.y)*n)}},g=function(e,t,n){e.applyMatrix4(a),t.applyMatrix4(a),n.applyMatrix4(a);let r=new i;r.crossVectors(t.clone().sub(e),t.clone().sub(n)).normalize(),r.x<0||r.y<0||r.z,r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z);let o=new M,h=new M,c=new M,u=1/s;return r.y>r.x&&r.y>r.z?(o.set(e.x-l.min.x,l.max.z-e.z).multiplyScalar(u),h.set(t.x-l.min.x,l.max.z-t.z).multiplyScalar(u),c.set(n.x-l.min.x,l.max.z-n.z).multiplyScalar(u)):r.x>r.y&&r.x>r.z?(o.set(e.z-l.min.z,e.y-l.min.y).multiplyScalar(u),h.set(t.z-l.min.z,t.y-l.min.y).multiplyScalar(u),c.set(n.z-l.min.z,n.y-l.min.y).multiplyScalar(u)):r.z>r.y&&r.z>r.x&&(o.set(e.x-l.min.x,e.y-l.min.y).multiplyScalar(u),h.set(t.x-l.min.x,t.y-l.min.y).multiplyScalar(u),c.set(n.x-l.min.x,n.y-l.min.y).multiplyScalar(u)),{uv0:o,uv1:h,uv2:c}},y=new i,v=new i,w=new i;new i,new i,new i;const x=e.getAttribute("position");if(e.getAttribute("normal"),e.index)for(c=0;c<e.index.count;c+=3)u=e.index.getX(c+0),p=e.index.getX(c+1),d=e.index.getX(c+2),y.fromBufferAttribute(x,u),v.fromBufferAttribute(x,p),w.fromBufferAttribute(x,d),m="sphere"===t?f(y,v,w):g(y,v,w),h[2*u]=m.uv0.x,h[2*u+1]=m.uv0.y,h[2*p]=m.uv1.x,h[2*p+1]=m.uv1.y,h[2*d]=m.uv2.x,h[2*d+1]=m.uv2.y;else for(c=0;c<x.count;c+=3){y.fromBufferAttribute(x,c+0),v.fromBufferAttribute(x,c+1),w.fromBufferAttribute(x,c+2),m="sphere"===t?f(y,v,w):g(y,v,w);let e=c,s=c+1,i=c+2;h[2*e]=m.uv0.x,h[2*e+1]=m.uv0.y,h[2*s]=m.uv1.x,h[2*s+1]=m.uv1.y,h[2*i]=m.uv2.x,h[2*i+1]=m.uv2.y}e.attributes.uv.array=new Float32Array(h),e.attributes.uv.needsUpdate=!0}const ni=new i,ri=new pe,ai=new de,oi=new i,li=new me;class hi{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new di,this.unassigned=new di,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,s=e.length;t<s;t++)this.vertices.push(new pi(e[t]));this.compute()}return this}setFromObject(e){const t=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const s=e.geometry;if(void 0!==s){const n=s.attributes.position;if(void 0!==n)for(let s=0,r=n.count;s<r;s++){const r=new i;r.fromBufferAttribute(n,s).applyMatrix4(e.matrixWorld),t.push(r)}}})),this.setFromPoints(t)}containsPoint(e){const t=this.faces;for(let s=0,i=t.length;s<i;s++){if(t[s].distanceToPoint(e)>this.tolerance)return!1}return!0}intersectRay(e,t){const s=this.faces;let i=-1/0,n=1/0;for(let t=0,r=s.length;t<r;t++){const r=s[t],a=r.distanceToPoint(e.origin),o=r.normal.dot(e.direction);if(a>0&&o>=0)return null;const l=0!==o?-a/o:0;if(!(l<=0)&&(o>0?n=Math.min(l,n):i=Math.max(l,i),i>n))return null}return i!==-1/0?e.at(i,t):e.at(n,t),t}intersectsRay(e){return null!==this.intersectRay(e,ni)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let s=e.outside;for(;null!==s.next&&s.next.face===e;)s=s.next;return this.assigned.removeSubList(t,s),t.prev=s.next=null,e.outside=null,t}}deleteFaceVertices(e,t){const s=this.removeAllVerticesFromFace(e);if(void 0!==s)if(void 0===t)this.unassigned.appendChain(s);else{let e=s;do{const s=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=s}while(null!==e)}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const s=t.next;let i=this.tolerance,n=null;for(let s=0;s<e.length;s++){const r=e[s];if(0===r.mark){const e=r.distanceToPoint(t.point);if(e>i&&(i=e,n=r),i>1e3*this.tolerance)break}}null!==n&&this.addVertexToFace(t,n),t=s}while(null!==t)}return this}computeExtremes(){const e=new i,t=new i,s=[],n=[];for(let e=0;e<3;e++)s[e]=n[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let i=0,r=this.vertices.length;i<r;i++){const r=this.vertices[i],a=r.point;for(let t=0;t<3;t++)a.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,a.getComponent(t)),s[t]=r);for(let e=0;e<3;e++)a.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,a.getComponent(e)),n[e]=r)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:s,max:n}}computeInitialHull(){const e=this.vertices,t=this.computeExtremes(),s=t.min,i=t.max;let n=0,r=0;for(let e=0;e<3;e++){const t=i[e].point.getComponent(e)-s[e].point.getComponent(e);t>n&&(n=t,r=e)}const a=s[r],o=i[r];let l,h;n=0,ri.set(a.point,o.point);for(let t=0,s=this.vertices.length;t<s;t++){const s=e[t];if(s!==a&&s!==o){ri.closestPointToPoint(s.point,!0,oi);const e=oi.distanceToSquared(s.point);e>n&&(n=e,l=s)}}n=-1,ai.setFromCoplanarPoints(a.point,o.point,l.point);for(let t=0,s=this.vertices.length;t<s;t++){const s=e[t];if(s!==a&&s!==o&&s!==l){const e=Math.abs(ai.distanceToPoint(s.point));e>n&&(n=e,h=s)}}const c=[];if(ai.distanceToPoint(h.point)<0){c.push(ci.create(a,o,l),ci.create(h,o,a),ci.create(h,l,o),ci.create(h,a,l));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge(t)),c[e+1].getEdge(1).setTwin(c[t+1].getEdge(0))}}else{c.push(ci.create(a,l,o),ci.create(h,a,o),ci.create(h,o,l),ci.create(h,l,a));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge((3-e)%3)),c[e+1].getEdge(0).setTwin(c[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(c[e]);for(let t=0,s=e.length;t<s;t++){const s=e[t];if(s!==a&&s!==o&&s!==l&&s!==h){n=this.tolerance;let e=null;for(let t=0;t<4;t++){const i=this.faces[t].distanceToPoint(s.point);i>n&&(n=i,e=this.faces[t])}null!==e&&this.addVertexToFace(s,e)}}return this}reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const s=this.faces[t];0===s.mark&&e.push(s)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const s=this.assigned.first().face;let i=s.outside;do{const n=s.distanceToPoint(i.point);n>t&&(t=n,e=i),i=i.next}while(null!==i&&i.face===s);return e}}computeHorizon(e,t,s,i){let n;this.deleteFaceVertices(s),s.mark=1,n=null===t?t=s.getEdge(0):t.next;do{const t=n.twin,s=t.face;0===s.mark&&(s.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,s,i):i.push(n)),n=n.next}while(n!==t);return this}addAdjoiningFace(e,t){const s=ci.create(e,t.tail(),t.head());return this.faces.push(s),s.getEdge(-1).setTwin(t.twin),s.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let s=null,i=null;for(let n=0;n<t.length;n++){const r=t[n],a=this.addAdjoiningFace(e,r);null===s?s=a:a.next.setTwin(i),this.newFaces.push(a.face),i=a}return s.next.setTwin(i),this}addVertexToHull(e){const t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}class ci{constructor(){this.normal=new i,this.midpoint=new i,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,s){const i=new ci,n=new ui(e,i),r=new ui(t,i),a=new ui(s,i);return n.next=a.prev=r,r.next=n.prev=a,a.next=r.prev=n,i.edge=n,i.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),s=this.edge.next.head();return li.set(e.point,t.point,s.point),li.getNormal(this.normal),li.getMidpoint(this.midpoint),this.area=li.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class ui{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class pi{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class di{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class mi extends r{constructor(e=[]){super();const t=[],s=[],i=(new hi).setFromPoints(e).faces;for(let e=0;e<i.length;e++){const n=i[e];let r=n.edge;do{const e=r.head().point;t.push(e.x,e.y,e.z),s.push(n.normal.x,n.normal.y,n.normal.z),r=r.next}while(r!==n.edge)}this.setAttribute("position",new o(t,3)),this.setAttribute("normal",new o(s,3))}}class fi extends fe{constructor(e,t,s,i,a=[0,1,0],l=[0,.5,0],h=!1){super(),this.matrixAutoUpdate=!1,this.type="CapsuleHelper";const c=new r;let u=.5*t-e,p=32,d=.2*e,m=[];const f=[e,u,0,e,-u,0,-e,u,0,-e,-u,0,0,u,e-d,0,u,e+d];m.push(...a,...l,...a,...l,...l,...l),h&&(f.push(0,u,e,0,-u,e,0,u,-e,0,-u,-e),m.push(...a,...l,...a,...l));for(let t=0,s=1;t<p;t++,s++){const i=t/p*Math.PI*2,n=s/p*Math.PI*2;f.push(e*Math.cos(i),u,e*Math.sin(i),e*Math.cos(n),u,e*Math.sin(n),e*Math.cos(i),-u,e*Math.sin(i),e*Math.cos(n),-u,e*Math.sin(n)),m.push(...a,...a,...l,...l)}for(let t=0,s=1;t<p;t++,s++){const i=t/p*Math.PI*2,n=s/p*Math.PI*2;let r=s<=16?1:-1;f.push(e*Math.cos(i),u*r+e*Math.sin(i),0,e*Math.cos(n),u*r+e*Math.sin(n),0),1===r?m.push(...a,...a):m.push(...l,...l),h&&(f.push(0,u*r+e*Math.sin(i),e*Math.cos(i),0,u*r+e*Math.sin(n),e*Math.cos(n)),1===r?m.push(...a,...a):m.push(...l,...l))}if(c.setAttribute("position",new o(f,3)),c.setAttribute("color",new o(m,3)),this.cone=new n(c,i),this.cone.raycast=function(){},this.add(this.cone),!s)return;const g=new r,y=[.5*d,-u,e-d,.5*d,-u,e+d,.5*-d,-u,e-d,.5*-d,-u,e+d,.5*d,-u,e-d,.5*-d,-u,e-d,.5*-d,-u,e+d,-d,-u,e+d,.5*d,-u,e+d,d,-u,e+d,-d,-u,e+d,0,-u,e+2*d,d,-u,e+d,0,-u,e+2*d];m=[];let v=y.length/3;for(;v--;)m.push(1,0,0);g.setAttribute("position",new o(y,3)),g.setAttribute("color",new o(m,3)),this.direction=new n(g,i),this.direction.raycast=function(){},this.add(this.direction)}setDirection(e){this.direction&&(this.direction.rotation.y=e)}dispose(){this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){}update(){}}class gi extends Cs{constructor(){super(),this.Utils=Yt,this.type="body",this.num=Xt[this.type],this.full=!1,this.extraConvex=!1,this.needMatrix="RAPIER"===Zt.engine||"HAVOK"===Zt.engine}setFull(e){this.num=Xt[e?"bodyFull":"body"],this.full=e}step(){const e=Zt.Ar,t=Zt.ArPos[this.type],s=this.list;let i,n,r=s.length;for(;r--;)if(i=s[r],null!==i){if(n=t+r*this.num,!i.actif){if(0===Bt.nullArray(e,n,this.num))continue;i.actif=!0}i.sleep=!(e[n]>0),i.defMat&&(i.isInstance?i.instance.setColorAt(i.id,i.sleep?Ms.sleep:Ms.body):(i.sleep||"sleep"!==i.material.name||(i.material=Ts.get("body")),i.sleep&&"body"===i.material.name&&(i.material=Ts.get("sleep")))),i.sleep&&!i.isKinematic||(i.isInstance?(i.speedMat&&i.instance.setColorAt(i.id,[.5*Math.abs(e[n+8]),.5*Math.abs(e[n+9]),.5*Math.abs(e[n+10])]),i.instance.setTransformAt(i.id,[e[n+1],e[n+2],e[n+3]],[e[n+4],e[n+5],e[n+6],e[n+7]],i.noScale?[1,1,1]:i.size),i.position={x:e[n+1],y:e[n+2],z:e[n+3]},i.quaternion={_x:e[n+4],_y:e[n+5],_z:e[n+6],_w:e[n+7]},this.needMatrix&&i.matrixWorld.compose(i.position,i.quaternion,{x:1,y:1,z:1}),this.full&&(i.velocity={x:e[n+8],y:e[n+9],z:e[n+10]},i.angular={x:e[n+11],y:e[n+12],z:e[n+13]})):(i.position.fromArray(e,n+1),i.quaternion.fromArray(e,n+4),this.full&&(i.velocity.fromArray(e,n+8),i.angular.fromArray(e,n+11)),i.auto||i.updateMatrix()))}}geometry(e={},t=null,s=null){let n,a,o,l=e.size,h="",u=e.type,p=!1,d=!1,m=e.seg||16;const f="OIMO"===Zt.engine||"JOLT"===Zt.engine||"CANNON"===Zt.engine;if(e.instance&&"compound"===u&&(u=e.shapes[0].type,l=e.shapes[0].size,e.translate=e.shapes[0].pos),"mesh"!==u&&"convex"!==u||(e.shape?e.shape.isMesh&&(e.shape=e.shape.geometry):e.mesh&&!e.v&&(e.shape=e.mesh.geometry)),e.radius&&(e.breakable||("box"===u&&(u="ChamferBox"),"cylinder"===u&&(u="ChamferCyl"))),e.geometry&&("convex"===u?e.shape=e.geometry:u="direct"),"PHYSX"===Zt.engine&&"cylinder"===e.type){let t=new c(e.size[0],e.size[0],e.size[1],m,1);e.isWheel&&t.rotateZ(-Ft),e.v=Bt.getVertex(t),e.type="convex"}if(("PHYSX"===Zt.engine||"HAVOK"===Zt.engine||"JOLT"===Zt.engine)&&"cone"===e.type){let t=new c(0,e.size[0],e.size[1],m,1);e.v=Bt.getVertex(t),e.type="convex"}switch("stair"===e.type&&(e.type="box",u="box"),u){case"direct":n=e.geometry.clone(),e.size&&n.scale(e.size[0],e.size[1],e.size[2]),d=!0,p=!0;break;case"convex":if(e.v){if(e.nogeo)n=new r;else{let t=[];for(a=Math.floor(e.v.length/3);a--;)o=3*a,t.push(new i(e.v[o],e.v[o+1],e.v[o+2]));n=new mi(t)}d=!0,p=!0}if(e.shape){n=e.shape.clone(),e.size&&n.scale(e.size[0],e.size[0],e.size[0]),e.shapeScale&&n.scale(e.shapeScale[0],e.shapeScale[1],e.shapeScale[2]);let t=f?Bt.toNonIndexed(n):null;e.v=Bt.getVertex(t||n,f),e.index=Bt.getIndex(t||n,f),Zt.engine,d=!0,p=!0}n.boundingBox||n.computeBoundingBox();let t=n.boundingBox;e.boxSize=[-t.min.x+t.max.x,-t.min.y+t.max.y,-t.min.z+t.max.z];break;case"mesh":n=e.shape.clone(),e.size&&n.scale(e.size[0],e.size[0],e.size[0]),e.v=Bt.getVertex(n,f),e.index=Bt.getIndex(n,f),d=!0,p=!0;break;case"highSphere":h="highSphere_"+l[0],n=ss(h),n?h="":(n=new Ys(l[0]),n.name=h),p=!0,e.type="sphere";break;case"capsule":h="capsule_"+l[0]+"_"+l[1]+"_"+m,n=ss(h),n?h="":(n=new Qs(l[0],l[1],m),n.name=h),p=!0;break;case"ChamferBox":h="ChamferBox_"+l[0]+"_"+l[1]+"_"+l[2]+"_"+e.radius,n=ss(h),n?h="":(n=new ei(l[0],l[1],l[2],e.radius),n.name=h),p=!0;break;case"ChamferCyl":h="ChamferCyl_"+l[0]+"_"+l[1]+"_"+l[2]+"_"+e.radius+"_"+m,n=ss(h),n?h="":(n=new $s(l[0],l[0],l[1],e.radius,m),n.name=h),p=!0;break;default:e.breakable?(n=ss(u).clone(),n.scale(l[0],l[1],l[2]),d=!0,p=!0):n=ss(u)}if(e.translate&&n.translate(e.translate[0],e.translate[1],e.translate[2]),e.shape&&delete e.shape,e.geometry&&delete e.geometry,(void 0===n.attributes.uv||e.autoUV)&&ii(n,"box",5,e.pos,e.quat),""!==h&&ts(n),e.isWheel&&(n=n.clone(),n.rotateZ(-Ft),d=!0),d&&es(n),null===t&&null===s)return n.noScale=p,n;e.meshRemplace&&e.debug&&(s=Ts.get("debug"));let g=new ne(n,s);if(e.button&&(g.isButton=!0),e.helper){let t=e.hcolor||[.3,.1,0],s=e.hcolor2||[.8,.2,0];g.add(new fi(l[0],l[1]+2*l[0],!1,Ts.get("line"),t,s,!0))}e.localRot&&(e.localQuat=Bt.quatFromEuler(e.localRot)),e.localPos&&g.position.fromArray(e.localPos),e.localQuat&&g.quaternion.fromArray(e.localQuat),p||g.scale.fromArray(e.size),void 0!==e.ray&&(e.ray||(g.raycast=()=>{})),e.meshRemplace&&!e.debug||t.add(g)}add(e={}){let t,s,n,r=0;if(e.instance||(n=this.setName(e)),e.type=void 0===e.type?"box":e.type,"plane"!==e.type||e.visible||(e.visible=!1),"stair"===e.type){let t=new i(0,0,e.size[2]),s=new i(0,.5*e.size[1],.5*e.size[2]),n=t.angleTo(s),r=t.distanceTo(s);e.rot=[n*zt,0,0],e.size[1]*=e.div||.2,e.size[2]=2*r;let a=new i(0,.5*-e.size[1],0);a.applyAxisAngle({x:1,y:0,z:0},n),e.pos[1]+=a.y,e.pos[2]+=a.z}if(e.massCenter&&"PHYSX"!==Zt.engine)if("compound"!==e.type)e.shapes=[{type:e.type,pos:e.massCenter,size:e.size}],e.seg&&(e.shapes[0].seg=e.seg),e.radius&&(e.shapes[0].radius=e.radius),delete e.size,e.type="compound";else for(t=0;t<e.shapes.length;t++)s=e.shapes[t],s.pos?s.pos=Yt.vecAdd(s.pos,e.massCenter):s.pos=e.massCenter,es(s);e.pos=void 0===e.pos?[0,0,0]:e.pos,e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=Bt.quatFromEuler(e.rot)),void 0!==e.meshRot&&(e.meshQuat=Bt.quatFromEuler(e.meshRot)),e.size=Bt.autoSize(e.size,e.type),e.meshScale&&(e.meshScale=Bt.autoSize(e.meshScale));let a,o=!1;!1===e.visible&&(e.material="hide"),void 0!==e.material?a=e.material.constructor===String?Ts.get(e.material):e.material:(o=!0,a=Ts.get(this.type),e.instance&&(a=Ts.get("base"))),e.unicMat&&(a=a.clone(),Ts.addToTmp(a));let l=e.instance?{}:new Gs;if(e.mesh&&!e.instance){"terrain"===e.mesh.type&&(e.noClone=!0);let t=e.noClone?e.mesh:e.mesh.clone();t.position.fromArray(e.meshPos||[0,0,0]),e.meshQuat&&t.quaternion.fromArray(e.meshQuat),e.meshSize&&t.scale.set(1,1,1).multiplyScalar(e.meshSize),e.meshScale&&t.scale.fromArray(e.meshScale),o||(t.material=a),Zt.tmpMesh.push(t),e.meshRemplace=!0,l.add(t)}switch(e.type){case"null":break;case"compound":for(t=0;t<e.shapes.length;t++)s=e.shapes[t],s.type=void 0===s.type?"box":s.type,s.size=Bt.autoSize(s.size,s.type),s.pos&&(s.localPos=s.pos),void 0!==s.rot&&(s.quat=Bt.quatFromEuler(s.rot)),s.quat&&(s.localQuat=s.quat),s.debug=e.debug||Zt.debug,s.meshRemplace=e.meshRemplace||!1,e.instance?"convex"===s.type&&(s.v=Bt.getVertex(s.shape,!1)):this.geometry(s,l,a),r+=Bt.getVolume(s.type,s.size,s.v);break;default:e.instance?"convex"===e.type&&(e.v=Bt.getVertex(e.shape,!1)):this.geometry(e,l,a),r=Bt.getVolume(e.type,e.size,e.v)}if(l.type=this.type,l.size=e.size,l.shapetype=e.type,l.isKinematic=e.kinematic||!1,l.link=0,l.meshSize=e.meshSize?e.meshSize:1,e.button&&(l.isButton=!0),l.isRay=!0,void 0!==e.ray&&(l.isRay=e.ray),e.instance||l.setRaycast(),l.defMat=!1,l.material&&o&&(l.defMat="body"===l.material.name),e.instance){l.isInstance=!0,l.instance=this.getInstance(e,a),l.instance.isRay=l.isRay,l.over=l.instance.over,l.isOver=!1,l.defMat="base"===l.instance.material.name,l.id=l.instance.count,l.refName=l.instance.name+l.id,l.name=l.instance.name+l.id,e.name&&(l.name=e.name),e.name=l.name,l.noScale=l.instance.noScale,e.sizeByInstance&&(l.noScale=!1);let t=e.color;l.defMat&&(t=e.sleep?Ms.sleep:Ms.body),l.instance.add(e.pos,e.quat,l.noScale?[1,1,1]:l.size,t),l.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]},l.quaternion={_x:e.quat[0],_y:e.quat[1],_z:e.quat[2],_w:e.quat[3]},l.velocity={x:0,y:0,z:0},l.angular={x:0,y:0,z:0},l.link=0,this.needMatrix&&(l.matrixWorld=new te),l.instance.v&&(e.v=l.instance.v),l.instance.index&&(e.index=l.instance.index),e.type=l.instance.type}else l.name=n,e.renderOrder&&(l.renderOrder=e.renderOrder),void 0===e.visible&&(e.visible=!0),void 0===e.shadow&&(e.shadow=e.visible),l.visible=void 0===e.visible||e.visible,l.receiveShadow=e.shadow,l.castShadow=e.shadow,l.overMaterial=Ts.get("outline"),this.set(e,l);if(e.breakable){Zt.motor.addBreaker();let t=l.children[0];l.remove(t),l=t,l.name=n,l.type=this.type,l.breakable=!0,l.breakOption=void 0!==e.breakOption?e.breakOption:[250,1,2,1]}return l.mass=e.mass||0,l.density=e.density||0,l.density&&!l.mass?l.mass=Bt.massFromDensity(l.density,r):l.mass&&!l.density&&(l.density=Bt.densityFromMass(l.mass,r),"RAPIER"!==Zt.engine&&"OIMO"!==Zt.engine||(e.density=l.density)),this.addToWorld(l,e.id),e.onlyMakeMesh||(e.phySize&&(e.size=e.phySize),e.phyPos&&(e.pos=e.phyPos),e.rot&&delete e.rot,e.meshRot&&delete e.meshRot,e.instance&&delete e.instance,e.material&&delete e.material,e.mesh&&delete e.mesh,e.parent&&delete e.parent,Zt.post({m:"add",o:e})),l}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),t.auto=e.auto||!1,t.auto?t.matrixAutoUpdate=!0:(t.matrixAutoUpdate=!1,t.updateMatrix()))}getInstance(e,t){if(Zt.instanceMesh[e.instance])return Zt.instanceMesh[e.instance];(e={...e}).sizeByInstance&&(e.size=[1,1,1]);let s=this.geometry(e);e.mesh&&(t=e.mesh.material,s=e.mesh.isObject3D?e.mesh.geometry.clone():e.mesh.clone(),e.meshSize&&s.scale(e.meshSize,e.meshSize,e.meshSize),e.meshScale&&s.scale(e.meshScale[0],e.meshScale[1],e.meshScale[2]),s.noScale=!0);let i=new Ws(s,t,0);return i.type=e.type,i.noScale=s.noScale,"convex"===i.type&&(i.v=e.v),e.index&&(i.index=e.index),i.receiveShadow=void 0===e.shadow||e.shadow,i.castShadow=void 0===e.shadow||e.shadow,i.overMaterial=Ts.get("outline"),i.name=e.instance,Zt.scene.add(i),Zt.instanceMesh[e.instance]=i,i}}const yi=g;class vi extends ge{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,s,i){const n=this,r=new ye(n.manager);r.setPath(n.path),r.setRequestHeader(n.requestHeader),r.setWithCredentials(n.withCredentials),r.load(e,(function(s){try{t(n.parse(s))}catch(t){i?i(t):console.error(t),n.manager.itemError(e)}}),s,i)}parse(e){const t=this;function n(e,t,s,i,n,a,o,l){if(0==t||0==s)return void e.lineTo(l.x,l.y);i=i*Math.PI/180,t=Math.abs(t),s=Math.abs(s);const h=(o.x-l.x)/2,c=(o.y-l.y)/2,u=Math.cos(i)*h+Math.sin(i)*c,p=-Math.sin(i)*h+Math.cos(i)*c;let d=t*t,m=s*s;const f=u*u,g=p*p,y=f/d+g/m;if(y>1){const e=Math.sqrt(y);d=(t*=e)*t,m=(s*=e)*s}const v=d*g+m*f,w=(d*m-v)/v;let x=Math.sqrt(Math.max(0,w));n===a&&(x=-x);const b=x*t*p/s,M=-x*s*u/t,A=Math.cos(i)*b-Math.sin(i)*M+(o.x+l.x)/2,T=Math.sin(i)*b+Math.cos(i)*M+(o.y+l.y)/2,S=r(1,0,(u-b)/t,(p-M)/s),R=r((u-b)/t,(p-M)/s,(-u-b)/t,(-p-M)/s)%(2*Math.PI);e.currentPath.absellipse(A,T,t,s,S,S+R,0===a,i)}function r(e,t,s,i){const n=e*s+t*i,r=Math.sqrt(e*e+t*t)*Math.sqrt(s*s+i*i);let a=Math.acos(Math.max(-1,Math.min(1,n/r)));return e*i-t*s<0&&(a=-a),a}function a(e,t){t=Object.assign({},t);let s={};if(e.hasAttribute("class")){const t=e.getAttribute("class").split(/\s/).filter(Boolean).map((e=>e.trim()));for(let e=0;e<t.length;e++)s=Object.assign(s,y["."+t[e]])}function i(i,n,r){void 0===r&&(r=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(i)&&(t[n]=r(e.getAttribute(i))),s[i]&&(t[n]=r(s[i])),e.style&&""!==e.style[i]&&(t[n]=r(e.style[i]))}function n(e){return Math.max(0,Math.min(1,u(e)))}function r(e){return Math.max(0,u(e))}return e.hasAttribute("id")&&(s=Object.assign(s,y["#"+e.getAttribute("id")])),i("fill","fill"),i("fill-opacity","fillOpacity",n),i("fill-rule","fillRule"),i("opacity","opacity",n),i("stroke","stroke"),i("stroke-opacity","strokeOpacity",n),i("stroke-width","strokeWidth",r),i("stroke-linejoin","strokeLineJoin"),i("stroke-linecap","strokeLineCap"),i("stroke-miterlimit","strokeMiterLimit",r),i("visibility","visibility"),t}function o(e,t){return e-(t-e)}function l(e,t,s){if("string"!=typeof e)throw new TypeError("Invalid input: "+typeof e);const i={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/};let n=0,r=!0,a="",o="";const l=[];function h(e,t,s){const i=new SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw i.partial=s,i}function c(){""!==a&&(""===o?l.push(Number(a)):l.push(Number(a)*Math.pow(10,Number(o)))),a="",o=""}let u;const p=e.length;for(let d=0;d<p;d++)if(u=e[d],Array.isArray(t)&&t.includes(l.length%s)&&i.FLAGS.test(u))n=1,a=u,c();else{if(0===n){if(i.WHITESPACE.test(u))continue;if(i.DIGIT.test(u)||i.SIGN.test(u)){n=1,a=u;continue}if(i.POINT.test(u)){n=2,a=u;continue}i.COMMA.test(u)&&(r&&h(u,d,l),r=!0)}if(1===n){if(i.DIGIT.test(u)){a+=u;continue}if(i.POINT.test(u)){a+=u,n=2;continue}if(i.EXP.test(u)){n=3;continue}i.SIGN.test(u)&&1===a.length&&i.SIGN.test(a[0])&&h(u,d,l)}if(2===n){if(i.DIGIT.test(u)){a+=u;continue}if(i.EXP.test(u)){n=3;continue}i.POINT.test(u)&&"."===a[a.length-1]&&h(u,d,l)}if(3===n){if(i.DIGIT.test(u)){o+=u;continue}if(i.SIGN.test(u)){if(""===o){o+=u;continue}1===o.length&&i.SIGN.test(o)&&h(u,d,l)}}i.WHITESPACE.test(u)?(c(),n=0,r=!1):i.COMMA.test(u)?(c(),n=0,r=!0):i.SIGN.test(u)?(c(),n=1,a=u):i.POINT.test(u)?(c(),n=2,a=u):h(u,d,l)}return c(),l}const h=["mm","cm","in","pt","pc","px"],c={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function u(e){let s,i="px";if("string"==typeof e||e instanceof String)for(let t=0,s=h.length;t<s;t++){const s=h[t];if(e.endsWith(s)){i=s,e=e.substring(0,e.length-s.length);break}}return"px"===i&&"px"!==t.defaultUnit?s=c.in[t.defaultUnit]/t.defaultDPI:(s=c[i][t.defaultUnit],s<0&&(s=c[i].in*t.defaultDPI)),s*parseFloat(e)}function p(e){const t=e.elements;return t[0]*t[4]-t[1]*t[3]<0}function d(e){const t=e.elements,s=t[0]*t[3]+t[1]*t[4];if(0===s)return!1;const i=m(e),n=f(e);return Math.abs(s/(i*n))>Number.EPSILON}function m(e){const t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function f(e){const t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}const g=[],y={},v=[],w=new s,x=new s,b=new s,A=new s,T=new M,S=new i,R=new s,k=(new DOMParser).parseFromString(e,"image/svg+xml");!function e(t,r){if(1!==t.nodeType)return;const h=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;const t=function(e){const t=new s,i=w;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){const s=u(e.getAttribute("x")),i=u(e.getAttribute("y"));t.translate(s,i)}if(e.hasAttribute("transform")){const s=e.getAttribute("transform").split(")");for(let e=s.length-1;e>=0;e--){const n=s[e].trim();if(""===n)continue;const r=n.indexOf("("),a=n.length;if(r>0&&r<a){const e=n.slice(0,r),t=l(n.slice(r+1));switch(i.identity(),e){case"translate":if(t.length>=1){const e=t[0];let s=0;t.length>=2&&(s=t[1]),i.translate(e,s)}break;case"rotate":if(t.length>=1){let e=0,s=0,n=0;e=t[0]*Math.PI/180,t.length>=3&&(s=t[1],n=t[2]),x.makeTranslation(-s,-n),b.makeRotation(e),A.multiplyMatrices(b,x),x.makeTranslation(s,n),i.multiplyMatrices(x,A)}break;case"scale":if(t.length>=1){const e=t[0];let s=e;t.length>=2&&(s=t[1]),i.scale(e,s)}break;case"skewX":1===t.length&&i.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&i.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&i.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(i)}}return t}(e);v.length>0&&t.premultiply(v[v.length-1]);return R.copy(t),v.push(t),t}(t);let c=!1,k=null;switch(t.nodeName){case"svg":r=a(t,r);break;case"style":!function(e){if(!e.sheet||!e.sheet.cssRules||!e.sheet.cssRules.length)return;for(let t=0;t<e.sheet.cssRules.length;t++){const s=e.sheet.cssRules[t];if(1!==s.type)continue;const i=s.selectorText.split(/,/gm).filter(Boolean).map((e=>e.trim()));for(let e=0;e<i.length;e++){const t=Object.fromEntries(Object.entries(s.style).filter((([,e])=>""!==e)));y[i[e]]=Object.assign(y[i[e]]||{},t)}}}(t);break;case"g":r=a(t,r);break;case"path":r=a(t,r),t.hasAttribute("d")&&(k=function(e){const t=new Me,s=new M,i=new M,r=new M;let a=!0,h=!1;const c=e.getAttribute("d");if(""===c||"none"===c)return null;const u=c.match(/[a-df-z][^a-df-z]*/gi);for(let e=0,c=u.length;e<c;e++){const c=u[e],p=c.charAt(0),d=c.slice(1).trim();let m;switch(!0===a&&(h=!0,a=!1),p){case"M":m=l(d);for(let e=0,n=m.length;e<n;e+=2)s.x=m[e+0],s.y=m[e+1],i.x=s.x,i.y=s.y,0===e?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y),0===e&&r.copy(s);break;case"H":m=l(d);for(let e=0,n=m.length;e<n;e++)s.x=m[e],i.x=s.x,i.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&r.copy(s);break;case"V":m=l(d);for(let e=0,n=m.length;e<n;e++)s.y=m[e],i.x=s.x,i.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&r.copy(s);break;case"L":m=l(d);for(let e=0,n=m.length;e<n;e+=2)s.x=m[e+0],s.y=m[e+1],i.x=s.x,i.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&r.copy(s);break;case"C":m=l(d);for(let e=0,n=m.length;e<n;e+=6)t.bezierCurveTo(m[e+0],m[e+1],m[e+2],m[e+3],m[e+4],m[e+5]),i.x=m[e+2],i.y=m[e+3],s.x=m[e+4],s.y=m[e+5],0===e&&!0===h&&r.copy(s);break;case"S":m=l(d);for(let e=0,n=m.length;e<n;e+=4)t.bezierCurveTo(o(s.x,i.x),o(s.y,i.y),m[e+0],m[e+1],m[e+2],m[e+3]),i.x=m[e+0],i.y=m[e+1],s.x=m[e+2],s.y=m[e+3],0===e&&!0===h&&r.copy(s);break;case"Q":m=l(d);for(let e=0,n=m.length;e<n;e+=4)t.quadraticCurveTo(m[e+0],m[e+1],m[e+2],m[e+3]),i.x=m[e+0],i.y=m[e+1],s.x=m[e+2],s.y=m[e+3],0===e&&!0===h&&r.copy(s);break;case"T":m=l(d);for(let e=0,n=m.length;e<n;e+=2){const n=o(s.x,i.x),a=o(s.y,i.y);t.quadraticCurveTo(n,a,m[e+0],m[e+1]),i.x=n,i.y=a,s.x=m[e+0],s.y=m[e+1],0===e&&!0===h&&r.copy(s)}break;case"A":m=l(d,[3,4],7);for(let e=0,a=m.length;e<a;e+=7){if(m[e+5]==s.x&&m[e+6]==s.y)continue;const a=s.clone();s.x=m[e+5],s.y=m[e+6],i.x=s.x,i.y=s.y,n(t,m[e],m[e+1],m[e+2],m[e+3],m[e+4],a,s),0===e&&!0===h&&r.copy(s)}break;case"m":m=l(d);for(let e=0,n=m.length;e<n;e+=2)s.x+=m[e+0],s.y+=m[e+1],i.x=s.x,i.y=s.y,0===e?t.moveTo(s.x,s.y):t.lineTo(s.x,s.y),0===e&&r.copy(s);break;case"h":m=l(d);for(let e=0,n=m.length;e<n;e++)s.x+=m[e],i.x=s.x,i.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&r.copy(s);break;case"v":m=l(d);for(let e=0,n=m.length;e<n;e++)s.y+=m[e],i.x=s.x,i.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&r.copy(s);break;case"l":m=l(d);for(let e=0,n=m.length;e<n;e+=2)s.x+=m[e+0],s.y+=m[e+1],i.x=s.x,i.y=s.y,t.lineTo(s.x,s.y),0===e&&!0===h&&r.copy(s);break;case"c":m=l(d);for(let e=0,n=m.length;e<n;e+=6)t.bezierCurveTo(s.x+m[e+0],s.y+m[e+1],s.x+m[e+2],s.y+m[e+3],s.x+m[e+4],s.y+m[e+5]),i.x=s.x+m[e+2],i.y=s.y+m[e+3],s.x+=m[e+4],s.y+=m[e+5],0===e&&!0===h&&r.copy(s);break;case"s":m=l(d);for(let e=0,n=m.length;e<n;e+=4)t.bezierCurveTo(o(s.x,i.x),o(s.y,i.y),s.x+m[e+0],s.y+m[e+1],s.x+m[e+2],s.y+m[e+3]),i.x=s.x+m[e+0],i.y=s.y+m[e+1],s.x+=m[e+2],s.y+=m[e+3],0===e&&!0===h&&r.copy(s);break;case"q":m=l(d);for(let e=0,n=m.length;e<n;e+=4)t.quadraticCurveTo(s.x+m[e+0],s.y+m[e+1],s.x+m[e+2],s.y+m[e+3]),i.x=s.x+m[e+0],i.y=s.y+m[e+1],s.x+=m[e+2],s.y+=m[e+3],0===e&&!0===h&&r.copy(s);break;case"t":m=l(d);for(let e=0,n=m.length;e<n;e+=2){const n=o(s.x,i.x),a=o(s.y,i.y);t.quadraticCurveTo(n,a,s.x+m[e+0],s.y+m[e+1]),i.x=n,i.y=a,s.x=s.x+m[e+0],s.y=s.y+m[e+1],0===e&&!0===h&&r.copy(s)}break;case"a":m=l(d,[3,4],7);for(let e=0,a=m.length;e<a;e+=7){if(0==m[e+5]&&0==m[e+6])continue;const a=s.clone();s.x+=m[e+5],s.y+=m[e+6],i.x=s.x,i.y=s.y,n(t,m[e],m[e+1],m[e+2],m[e+3],m[e+4],a,s),0===e&&!0===h&&r.copy(s)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(s.copy(r),t.currentPath.currentPoint.copy(s),a=!0);break;default:console.warn(c)}h=!1}return t}(t));break;case"rect":r=a(t,r),k=function(e){const t=u(e.getAttribute("x")||0),s=u(e.getAttribute("y")||0),i=u(e.getAttribute("rx")||e.getAttribute("ry")||0),n=u(e.getAttribute("ry")||e.getAttribute("rx")||0),r=u(e.getAttribute("width")),a=u(e.getAttribute("height")),o=.448084975506,l=new Me;l.moveTo(t+i,s),l.lineTo(t+r-i,s),(0!==i||0!==n)&&l.bezierCurveTo(t+r-i*o,s,t+r,s+n*o,t+r,s+n);l.lineTo(t+r,s+a-n),(0!==i||0!==n)&&l.bezierCurveTo(t+r,s+a-n*o,t+r-i*o,s+a,t+r-i,s+a);l.lineTo(t+i,s+a),(0!==i||0!==n)&&l.bezierCurveTo(t+i*o,s+a,t,s+a-n*o,t,s+a-n);l.lineTo(t,s+n),(0!==i||0!==n)&&l.bezierCurveTo(t,s+n*o,t+i*o,s,t+i,s);return l}(t);break;case"polygon":r=a(t,r),k=function(e){function t(e,t,s){const r=u(t),a=u(s);0===n?i.moveTo(r,a):i.lineTo(r,a),n++}const s=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,i=new Me;let n=0;return e.getAttribute("points").replace(s,t),i.currentPath.autoClose=!0,i}(t);break;case"polyline":r=a(t,r),k=function(e){function t(e,t,s){const r=u(t),a=u(s);0===n?i.moveTo(r,a):i.lineTo(r,a),n++}const s=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,i=new Me;let n=0;return e.getAttribute("points").replace(s,t),i.currentPath.autoClose=!1,i}(t);break;case"circle":r=a(t,r),k=function(e){const t=u(e.getAttribute("cx")||0),s=u(e.getAttribute("cy")||0),i=u(e.getAttribute("r")||0),n=new be;n.absarc(t,s,i,0,2*Math.PI);const r=new Me;return r.subPaths.push(n),r}(t);break;case"ellipse":r=a(t,r),k=function(e){const t=u(e.getAttribute("cx")||0),s=u(e.getAttribute("cy")||0),i=u(e.getAttribute("rx")||0),n=u(e.getAttribute("ry")||0),r=new be;r.absellipse(t,s,i,n,0,2*Math.PI);const a=new Me;return a.subPaths.push(r),a}(t);break;case"line":r=a(t,r),k=function(e){const t=u(e.getAttribute("x1")||0),s=u(e.getAttribute("y1")||0),i=u(e.getAttribute("x2")||0),n=u(e.getAttribute("y2")||0),r=new Me;return r.moveTo(t,s),r.lineTo(i,n),r.currentPath.autoClose=!1,r}(t);break;case"defs":c=!0;break;case"use":r=a(t,r);const s=(t.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),i=t.viewportElement.getElementById(s);i?e(i,r):console.warn("SVGLoader: 'use node' references non-existent node id: "+s)}k&&(void 0!==r.fill&&"none"!==r.fill&&k.color.setStyle(r.fill,yi),function(e,t){function s(e){S.set(e.x,e.y,1).applyMatrix3(t),e.set(S.x,S.y)}function n(e){const s=e.xRadius,n=e.yRadius,r=Math.cos(e.aRotation),a=Math.sin(e.aRotation),o=new i(s*r,s*a,0),l=new i(-n*a,n*r,0),h=o.applyMatrix3(t),c=l.applyMatrix3(t),u=w.set(h.x,c.x,0,h.y,c.y,0,0,0,1),d=x.copy(u).invert(),m=b.copy(d).transpose().multiply(d).elements,f=function(e,t,s){let i,n,r,a,o;const l=e+s,h=e-s,c=Math.sqrt(h*h+4*t*t);l>0?(i=.5*(l+c),o=1/i,n=e*o*s-t*o*t):l<0?n=.5*(l-c):(i=.5*c,n=-.5*c);r=h>0?h+c:h-c;Math.abs(r)>2*Math.abs(t)?(o=-2*t/r,a=1/Math.sqrt(1+o*o),r=o*a):0===Math.abs(t)?(r=1,a=0):(o=-.5*r/t,r=1/Math.sqrt(1+o*o),a=o*r);h>0&&(o=r,r=-a,a=o);return{rt1:i,rt2:n,cs:r,sn:a}}(m[0],m[1],m[4]),g=Math.sqrt(f.rt1),y=Math.sqrt(f.rt2);e.xRadius=1/g,e.yRadius=1/y,e.aRotation=Math.atan2(f.sn,f.cs);if(!((e.aEndAngle-e.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const s=x.set(g,0,0,0,y,0,0,0,1),n=b.set(f.cs,f.sn,0,-f.sn,f.cs,0,0,0,1),r=s.multiply(n).multiply(u),a=e=>{const{x:t,y:s}=new i(Math.cos(e),Math.sin(e),0).applyMatrix3(r);return Math.atan2(s,t)};e.aStartAngle=a(e.aStartAngle),e.aEndAngle=a(e.aEndAngle),p(t)&&(e.aClockwise=!e.aClockwise)}}function r(e){const s=m(t),i=f(t);e.xRadius*=s,e.yRadius*=i;const n=s>Number.EPSILON?Math.atan2(t.elements[1],t.elements[0]):Math.atan2(-t.elements[3],t.elements[4]);e.aRotation+=n,p(t)&&(e.aStartAngle*=-1,e.aEndAngle*=-1,e.aClockwise=!e.aClockwise)}const a=e.subPaths;for(let e=0,i=a.length;e<i;e++){const i=a[e].curves;for(let e=0;e<i.length;e++){const a=i[e];a.isLineCurve?(s(a.v1),s(a.v2)):a.isCubicBezierCurve?(s(a.v0),s(a.v1),s(a.v2),s(a.v3)):a.isQuadraticBezierCurve?(s(a.v0),s(a.v1),s(a.v2)):a.isEllipseCurve&&(T.set(a.aX,a.aY),s(T),a.aX=T.x,a.aY=T.y,d(t)?n(a):r(a))}}}(k,R),g.push(k),k.userData={node:t,style:r});const C=t.childNodes;for(let t=0;t<C.length;t++){const s=C[t];c&&"style"!==s.nodeName&&"defs"!==s.nodeName||e(s,r)}h&&(v.pop(),v.length>0?R.copy(v[v.length-1]):R.identity())}(k.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});return{paths:g,xml:k.documentElement}}static createShapes(e){const t=999999999,s=0,i=1,n=2,r=3,a=4,o=5,l=6,h={loc:s,t:0};function c(e,t,i,r){const a=e.x,o=t.x,l=i.x,c=r.x,p=e.y,d=t.y,m=i.y,f=r.y,g=(c-l)*(p-m)-(f-m)*(a-l),y=(f-m)*(o-a)-(c-l)*(d-p),v=g/y,w=((o-a)*(p-m)-(d-p)*(a-l))/y;if(0===y&&0!==g||v<=0||v>=1||w<0||w>1)return null;if(0===g&&0===y){for(let l=0;l<2;l++){if(u(0===l?i:r,e,t),h.loc==s){const e=0===l?i:r;return{x:e.x,y:e.y,t:h.t}}if(h.loc==n){return{x:+(a+h.t*(o-a)).toPrecision(10),y:+(p+h.t*(d-p)).toPrecision(10),t:h.t}}}return null}for(let n=0;n<2;n++)if(u(0===n?i:r,e,t),h.loc==s){const e=0===n?i:r;return{x:e.x,y:e.y,t:h.t}}return{x:+(a+v*(o-a)).toPrecision(10),y:+(p+v*(d-p)).toPrecision(10),t:v}}function u(e,t,c){const u=c.x-t.x,p=c.y-t.y,d=e.x-t.x,m=e.y-t.y,f=u*m-d*p;if(e.x===t.x&&e.y===t.y)return h.loc=s,void(h.t=0);if(e.x===c.x&&e.y===c.y)return h.loc=i,void(h.t=1);if(f<-Number.EPSILON)return void(h.loc=r);if(f>Number.EPSILON)return void(h.loc=a);if(u*d<0||p*m<0)return void(h.loc=o);if(Math.sqrt(u*u+p*p)<Math.sqrt(d*d+m*m))return void(h.loc=l);let g;g=0!==u?d/u:m/p,h.loc=n,h.t=g}function p(e,t,s){const i=new M;t.getCenter(i);const n=[];return s.forEach((t=>{if(t.boundingBox.containsPoint(i)){(function(e,t){const s=[],i=[];for(let n=1;n<e.length;n++){const r=e[n-1],a=e[n];for(let e=1;e<t.length;e++){const n=c(r,a,t[e-1],t[e]);null!==n&&void 0===s.find((e=>e.t<=n.t+Number.EPSILON&&e.t>=n.t-Number.EPSILON))&&(s.push(n),i.push(new M(n.x,n.y)))}}return i})(e,t.points).forEach((e=>{n.push({identifier:t.identifier,isCW:t.isCW,point:e})}))}})),n.sort(((e,t)=>e.point.x-t.point.x)),n}let d=t,m=-999999999,f=e.subPaths.map((e=>{const s=e.getPoints();let i=-999999999,n=t,r=-999999999,a=t;for(let e=0;e<s.length;e++){const t=s[e];t.y>i&&(i=t.y),t.y<n&&(n=t.y),t.x>r&&(r=t.x),t.x<a&&(a=t.x)}return m<=r&&(m=r+1),d>=a&&(d=a-1),{curves:e.curves,points:s,isCW:ve.isClockWise(s),identifier:-1,boundingBox:new we(new M(a,n),new M(r,i))}}));f=f.filter((e=>e.points.length>1));for(let e=0;e<f.length;e++)f[e].identifier=e;const g=f.map((t=>function(e,t,s,i,n){null!=n&&""!==n||(n="nonzero");const r=new M;e.boundingBox.getCenter(r);const a=p([new M(s,r.y),new M(i,r.y)],e.boundingBox,t);a.sort(((e,t)=>e.point.x-t.point.x));const o=[],l=[];a.forEach((t=>{t.identifier===e.identifier?o.push(t):l.push(t)}));const h=o[0].point.x,c=[];let u=0;for(;u<l.length&&l[u].point.x<h;)c.length>0&&c[c.length-1]===l[u].identifier?c.pop():c.push(l[u].identifier),u++;if(c.push(e.identifier),"evenodd"===n){const t=c.length%2==0,s=c[c.length-2];return{identifier:e.identifier,isHole:t,for:s}}if("nonzero"===n){let s=!0,i=null,n=null;for(let e=0;e<c.length;e++){const r=c[e];s?(n=t[r].isCW,s=!1,i=r):n!==t[r].isCW&&(n=t[r].isCW,s=!0)}return{identifier:e.identifier,isHole:s,for:i}}console.warn('fill-rule: "'+n+'" is currently not implemented.')}(t,f,d,m,e.userData?e.userData.style.fillRule:void 0))),y=[];return f.forEach((e=>{if(!g[e.identifier].isHole){const t=new xe;t.curves=e.curves;g.filter((t=>t.isHole&&t.for===e.identifier)).forEach((e=>{const s=f[e.identifier],i=new be;i.curves=s.curves,t.holes.push(i)})),y.push(t)}})),y}static getStrokeStyle(e,t,s,i,n){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:s=void 0!==s?s:"miter",strokeLineCap:i=void 0!==i?i:"butt",strokeMiterLimit:n=void 0!==n?n:4}}static pointsToStroke(e,t,s,i){const n=[],a=[],l=[];if(0===vi.pointsToStrokeWithBuffers(e,t,s,i,n,a,l))return null;const h=new r;return h.setAttribute("position",new o(n,3)),h.setAttribute("normal",new o(a,3)),h.setAttribute("uv",new o(l,2)),h}static pointsToStrokeWithBuffers(e,t,s,i,n,r,a,o){const l=new M,h=new M,c=new M,u=new M,p=new M,d=new M,m=new M,f=new M,g=new M,y=new M,v=new M,w=new M,x=new M,b=new M,A=new M,T=new M,S=new M;s=void 0!==s?s:12,i=void 0!==i?i:.001,o=void 0!==o?o:0;const R=(e=function(e){let t=!1;for(let s=1,n=e.length-1;s<n;s++)if(e[s].distanceTo(e[s+1])<i){t=!0;break}if(!t)return e;const s=[];s.push(e[0]);for(let t=1,n=e.length-1;t<n;t++)e[t].distanceTo(e[t+1])>=i&&s.push(e[t]);return s.push(e[e.length-1]),s}(e)).length;if(R<2)return 0;const k=e[0].equals(e[R-1]);let C,I,E=e[0];const P=t.strokeWidth/2,_=1/(R-1);let L,D,z,O,F=0,N=!1,B=0,U=3*o,V=2*o;H(e[0],e[1],l).multiplyScalar(P),f.copy(e[0]).sub(l),g.copy(e[0]).add(l),y.copy(f),v.copy(g);for(let s=1;s<R;s++){C=e[s],I=s===R-1?k?e[1]:void 0:e[s+1];const i=l;if(H(E,C,i),c.copy(i).multiplyScalar(P),w.copy(C).sub(c),x.copy(C).add(c),L=F+_,D=!1,void 0!==I){H(C,I,h),c.copy(h).multiplyScalar(P),b.copy(C).sub(c),A.copy(C).add(c),z=!0,c.subVectors(I,E),i.dot(c)<0&&(z=!1),1===s&&(N=z),c.subVectors(I,C),c.normalize();const e=Math.abs(i.dot(c));if(e>Number.EPSILON){const s=P/e;c.multiplyScalar(-s),u.subVectors(C,E),p.copy(u).setLength(s).add(c),T.copy(p).negate();const i=p.length(),n=u.length();u.divideScalar(n),d.subVectors(I,C);const r=d.length();switch(d.divideScalar(r),u.dot(T)<n&&d.dot(T)<r&&(D=!0),S.copy(p).add(C),T.add(C),O=!1,D?z?(A.copy(T),x.copy(T)):(b.copy(T),w.copy(T)):W(),t.strokeLineJoin){case"bevel":q(z,D,L);break;case"round":X(z,D),z?G(C,w,b,L,0):G(C,A,x,L,1);break;case"miter":case"miter-clip":default:const e=P*t.strokeMiterLimit/i;if(e<1){if("miter-clip"!==t.strokeLineJoin){q(z,D,L);break}X(z,D),z?(d.subVectors(S,w).multiplyScalar(e).add(w),m.subVectors(S,b).multiplyScalar(e).add(b),j(w,L,0),j(d,L,0),j(C,L,.5),j(C,L,.5),j(d,L,0),j(m,L,0),j(C,L,.5),j(m,L,0),j(b,L,0)):(d.subVectors(S,x).multiplyScalar(e).add(x),m.subVectors(S,A).multiplyScalar(e).add(A),j(x,L,1),j(d,L,1),j(C,L,.5),j(C,L,.5),j(d,L,1),j(m,L,1),j(C,L,.5),j(m,L,1),j(A,L,1))}else D?(z?(j(g,F,1),j(f,F,0),j(S,L,0),j(g,F,1),j(S,L,0),j(T,L,1)):(j(g,F,1),j(f,F,0),j(S,L,1),j(f,F,0),j(T,L,0),j(S,L,1)),z?b.copy(S):A.copy(S)):z?(j(w,L,0),j(S,L,0),j(C,L,.5),j(C,L,.5),j(S,L,0),j(b,L,0)):(j(x,L,1),j(S,L,1),j(C,L,.5),j(C,L,.5),j(S,L,1),j(A,L,1)),O=!0}}else W()}else W();k||s!==R-1||K(e[0],y,v,z,!0,F),F=L,E=C,f.copy(b),g.copy(A)}if(k){if(D&&n){let e=S,t=T;N!==z&&(e=T,t=S),z?(O||N)&&(t.toArray(n,0),t.toArray(n,9),O&&e.toArray(n,3)):!O&&N||(t.toArray(n,3),t.toArray(n,9),O&&e.toArray(n,0))}}else K(C,w,x,z,!1,L);return B;function H(e,t,s){return s.subVectors(t,e),s.set(-s.y,s.x).normalize()}function j(e,t,s){n&&(n[U]=e.x,n[U+1]=e.y,n[U+2]=0,r&&(r[U]=0,r[U+1]=0,r[U+2]=1),U+=3,a&&(a[V]=t,a[V+1]=s,V+=2)),B+=3}function G(e,t,i,n,r){l.copy(t).sub(e).normalize(),h.copy(i).sub(e).normalize();let a=Math.PI;const o=l.dot(h);Math.abs(o)<1&&(a=Math.abs(Math.acos(o))),a/=s,c.copy(t);for(let t=0,i=s-1;t<i;t++)u.copy(c).rotateAround(e,a),j(c,n,r),j(u,n,r),j(e,n,.5),c.copy(u);j(u,n,r),j(i,n,r),j(e,n,.5)}function W(){j(g,F,1),j(f,F,0),j(w,L,0),j(g,F,1),j(w,L,1),j(x,L,0)}function q(e,t,s){t?e?(j(g,F,1),j(f,F,0),j(w,L,0),j(g,F,1),j(w,L,0),j(T,L,1),j(w,s,0),j(b,s,0),j(T,s,.5)):(j(g,F,1),j(f,F,0),j(x,L,1),j(f,F,0),j(T,L,0),j(x,L,1),j(x,s,1),j(A,s,0),j(T,s,.5)):e?(j(w,s,0),j(b,s,0),j(C,s,.5)):(j(x,s,1),j(A,s,0),j(C,s,.5))}function X(e,t){t&&(e?(j(g,F,1),j(f,F,0),j(w,L,0),j(g,F,1),j(w,L,0),j(T,L,1),j(w,F,0),j(C,L,.5),j(T,L,1),j(C,L,.5),j(b,F,0),j(T,L,1)):(j(g,F,1),j(f,F,0),j(x,L,1),j(f,F,0),j(T,L,0),j(x,L,1),j(x,F,1),j(T,L,0),j(C,L,.5),j(C,L,.5),j(T,L,0),j(A,F,1)))}function K(e,s,i,r,a,o){switch(t.strokeLineCap){case"round":a?G(e,i,s,o,.5):G(e,s,i,o,.5);break;case"square":if(a)l.subVectors(s,e),h.set(l.y,-l.x),c.addVectors(l,h).add(e),u.subVectors(h,l).add(e),r?(c.toArray(n,3),u.toArray(n,0),u.toArray(n,9)):(c.toArray(n,3),c.toArray(n,9),u.toArray(n,0));else{l.subVectors(i,e),h.set(l.y,-l.x),c.addVectors(l,h).add(e),u.subVectors(h,l).add(e);const t=n.length;r?(c.toArray(n,t-3),u.toArray(n,t-6),u.toArray(n,t-12)):(c.toArray(n,t-6),u.toArray(n,t-3),u.toArray(n,t-12))}}}}}class wi extends ne{constructor(e,t={},s=null){if(super(),this.model=e,this.material=s,this.outMaterial=!!s,this.XML=new XMLSerializer,this.color=new v,this.opacity=1,this.svgLoader=new vi,this.base="http://www.w3.org/2000/svg",this.svg=document.createElementNS(this.base,"svg"),this.layerUp=1e-4,this.fill=!0,this.stroke=!0,this.size=t.size||1,!this.model)return;let i={};switch(this.model){case"angle":i={radius:5,min:90,max:90,strokeSize:.25,...t},this.fill=void 0===i.fill||i.fill,this.stroke=void 0===i.stroke||i.stroke;let e=Math.abs(i.min);this.add("path",{d:this.circle(0,0,i.radius,180,180+i.max,!0),stroke:"none",fill:"#FF0000","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,i.radius,180,180+i.max,!1,!1,.3),stroke:"#FF0000","stroke-opacity":1,"stroke-width":i.strokeSize,fill:"none","stroke-linecap":"round"}),this.add("path",{d:this.circle(0,0,i.radius,180-e,180,!0),stroke:"none",fill:"#0050FF","fill-opacity":.1}),this.add("path",{d:this.circle(0,0,i.radius,180-e,180,!1,!1,.3,!0),stroke:"#0050FF","stroke-opacity":1,"stroke-width":i.strokeSize,fill:"none","stroke-linecap":"round"});break;case"needle":i={radius:5,min:90,max:90,strokeSize:.25,...t},this.fill=void 0===i.fill||i.fill,this.stroke=void 0===i.stroke||i.stroke,this.add("path",{d:this.circle(0,0,.7,0,360,!1,!0,0),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":i.strokeSize,fill:"none","stroke-linecap":"butt"}),this.add("path",{d:this.segment({x:0,y:0},{x:0,y:4.4}),stroke:"#FFFFFF","stroke-opacity":1,"stroke-width":i.strokeSize,fill:"none","stroke-linecap":"round"})}this.toMesh()}raycast(){}update(e={}){let t={};switch(this.model){case"angle":t={radius:5,min:-90,max:90,...e};let s=Math.abs(t.min);this.change("d",this.circle(0,0,t.radius,180,180+t.max,!0),0),this.change("d",this.circle(0,0,t.radius,180,180+t.max,!1,!1,.3),1),this.change("d",this.circle(0,0,t.radius,180-s,180,!0),2),this.change("d",this.circle(0,0,t.radius,180-s,180,!1,!1,.3,!0),3)}void 0!==e.wireframe&&(this.material.wireframe=e.wireframe),this.fill=void 0===t.fill||t.fill,this.stroke=void 0===t.stroke||t.stroke,this.toMesh()}set(e={},t){for(let s in e)t?t.setAttributeNS(null,s,e[s]):this.svg.setAttributeNS(null,s,e[s])}add(e,t={}){let s=document.createElementNS(this.base,e);this.set(t,s),this.svg.appendChild(s)}change(e,t,s){this.svg.childNodes[s].setAttributeNS(null,e,t)}getString(){return this.XML.serializeToString(this.svg)}polarToCartesian(e,t,s,i){var n=(i-90)*Math.PI/180;return{x:e+s*Math.cos(n),y:t+s*Math.sin(n)}}circle(e,t,s,i=0,n=360,r=!1,a=!1,o=0,l=!1){0===i&&360===n&&(i=1e-4,a=!0);let h=this.polarToCartesian(e,t,s,n),c=this.polarToCartesian(e,t,s,i),u=n-i<=180?"0":"1",p=["M",h.x,h.y,"A",s,s,0,u,0,c.x,c.y];if(r&&p.push("L",e,t,"L",h.x,h.y),a&&p.push("Z"),0!==o){let r=this.polarToCartesian(e,t,s-o,l?i:n),a=this.polarToCartesian(e,t,s+o,l?i:n);p.push("M",r.x,r.y,"L",a.x,a.y)}return p.join(" ")}segment(e,t){return["M",e.x,e.y,"L",t.x,t.y].join(" ")}geomColor(e,t,s=1){let i=e.attributes.position.count,n=[];for(;i--;)n.push(t.r,t.g,t.b,s);e.setAttribute("color",new o(n,4))}toGeometry(){if(!this.fill&&!this.stroke)return null;let e=[],t=0,s=1,i=this.svgLoader.parse(this.getString());for(const n of i.paths){const i=n.userData.style.fill;if(this.fill&&void 0!==i&&"none"!==i){this.color.setStyle(i),s=n.userData.style.fillOpacity,s<this.opacity&&(this.opacity=s);const a=vi.createShapes(n);for(const i of a){const n=new Ae(i);if(n){this.geomColor(n,this.color,s);let i=(new r).copy(n).toNonIndexed();i.translate(0,0,-t*this.layerUp),e.push(i),t++}}}const a=n.userData.style.stroke;if(this.stroke&&void 0!==a&&"none"!==a){this.color.setStyle(a),s=n.userData.style.strokeOpacity,s<this.opacity&&(this.opacity=s);for(const i of n.subPaths){const r=vi.pointsToStroke(i.getPoints(),n.userData.style,6);r&&(this.geomColor(r,this.color,s),r.translate(0,0,-t*this.layerUp),e.push(r),t++)}}}return e}toMesh(){let e=this.size;this.geometry&&this.geometry.dispose();let t=this.toGeometry();t?(this.geometry=qs(t),this.geometry.scale(e,-e,e),this.geometry.rotateY(Math.PI),this.geometry.rotateZ(.5*-Math.PI),this.geometry.rotateY(.5*Math.PI),this.geometry.computeBoundingSphere()):this.geometry=new r,null===this.material&&(this.material=new R({vertexColors:!0,transparent:1!==this.opacity,side:I}),this.material.defines={USE_COLOR_ALPHA:""})}dispose(){this.material&&!this.outMaterial&&this.material.dispose(),this.geometry&&this.geometry.dispose()}}class xi extends Gs{constructor(e={}){super(),this.type="joint",this.mode=e.mode||"hinge",this.isJoint=!0,this.mtx=new te,this.size=e.helperSize||.1;let s=Ts.get("line");switch(this.mode){case"hinge":case"cylindrical":let t=Ts.get("svg"),i={min:-180,max:180,fill:!1,stroke:!0,wireframe:!1,size:.05};e.lm&&(i.min=e.lm[0],i.max=e.lm[1]),e.lmr&&(i.min=e.lmr[0],i.max=e.lmr[1]),this.m1=new wi("angle",i,t),this.m2=new wi("needle",i,t),this.add(this.m1),this.add(this.m2);break;default:const r=ss("joint");let a=r.clone();a.scale(this.size,this.size,this.size),this.m1=new n(a,s),this.add(this.m1),a=r.clone(),a.scale(.8*this.size,.8*this.size,.8*this.size),this.m2=new n(a,s),this.add(this.m2)}this.m1.matrixAutoUpdate=!1,this.m2.matrixAutoUpdate=!1,this.body1=null,this.body2=null,this.mat1=new te,this.mat2=new te,this.end=new i;let a=new t;e.quat1&&this.mat1.makeRotationFromQuaternion(a.fromArray(e.quat1)),e.quat2&&this.mat2.makeRotationFromQuaternion(a.fromArray(e.quat2)),this.mat1.setPosition(e.pos1[0],e.pos1[1],e.pos1[2]),this.mat2.setPosition(e.pos2[0],e.pos2[1],e.pos2[2]);const l=new r;l.setAttribute("position",new o([0,0,0,0,0,0],3)),l.setAttribute("color",new o([1,0,0,1,0,0],3)),l.computeBoundingSphere(),this.m3=new n(l,s),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.end),this.m1.updateMatrix()),this.visible||(this.visible=!0))}updateFromPhy(e,t=0){this.visible&&(this.position.fromArray(e,t),this.quaternion.fromArray(e,t+3),this.updateMatrix(),this.m2.position.fromArray(e,t+7),this.m2.quaternion.fromArray(e,t+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,"cylindrical"===this.mode&&(this.m1.position.copy(this.m2.position),this.m1.updateMatrix()),this.visible||(this.visible=!0))}dispose(){this.body1&&this.body1.link--,this.body2&&this.body2.link--,this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class bi extends Cs{constructor(){super(),this.Utils=Yt,this.type="joint",this.v1=new i,this.v2=new i}step(){const e=Zt.Ar,t=Zt.ArPos[this.type];let s,i,n=this.list.length;for(;n--;)s=this.list[n],i=t+n*Xt.joint,16===Xt.joint?s.updateFromPhy(e,i):s.update()}add(e={}){let s,n=this.setName(e),r=null,a=null;e.axis1||(e.axis1=[1,0,0]),e.axis2||(e.axis2=[1,0,0]),e.pos1||(e.pos1=[0,0,0]),e.pos2||(e.pos2=[0,0,0]),e.limit?e.lm=e.limit:e.lm&&(e.limit=e.lm),"universal"!==e.mode&&"dof"!==e.mode&&"d6"!==e.mode||(e.mode="generic"),"revolute"===e.mode&&(e.mode="hinge"),"slider"===e.mode&&(e.mode="cylindrical"),e.b1&&(s="string"==typeof e.b1,r=s?Yt.byName(e.b1):e.b1,s||(e.b1=e.b1.name),r&&r.link++),e.b2&&(s="string"==typeof e.b2,a=s?Yt.byName(e.b2):e.b2,s||(e.b2=e.b2.name),a&&a.link++),e.worldPos&&(e.worldAnchor=e.worldPos),e.worldAnchor&&(e.pos1=r?Yt.toLocal(this.v1.fromArray(e.worldAnchor),r).toArray():e.worldAnchor,e.pos2=a?Yt.toLocal(this.v2.fromArray(e.worldAnchor),a).toArray():e.worldAnchor,delete e.worldAnchor),e.worldAxis&&(e.axis1=r?Yt.toLocal(this.v1.fromArray(e.worldAxis),r,!0).toArray():e.worldAxis,e.axis2=a?Yt.toLocal(this.v2.fromArray(e.worldAxis),a,!0).toArray():e.worldAxis,delete e.worldAxis),e.worldQuat&&(e.quat1=Yt.quatLocal(e.worldQuat,r),e.quat2=Yt.quatLocal(e.worldQuat,a),"OIMO"!==Zt.engine&&"HAVOK"!==Zt.engine&&"JOLT"!==Zt.engine||(e.axis1=Yt.axisLocal(Bt.quatToAxis(e.worldQuat),r),e.axis2=Yt.axisLocal(Bt.quatToAxis(e.worldQuat),a)),delete e.worldQuat),void 0!==e.rot1&&(e.quat1=Bt.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=Bt.quatFromEuler(e.rot2),delete e.rot2),e.quat1||(e.quat1=(new t).setFromUnitVectors(new i(1,0,0),(new i).fromArray(e.axis1).normalize()).toArray()),e.quat2||(e.quat2=(new t).setFromUnitVectors(new i(1,0,0),(new i).fromArray(e.axis2).normalize()).toArray()),e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=Bt.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot);let o=new xi(e);return o.name=n,o.body1=r,o.body2=a,void 0===e.visible&&(e.visible=Zt.jointVisible||!1),this.set(e,o),this.addToWorld(o,e.id),Zt.post({m:"add",o:e}),o}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&void 0!==e.visible&&(t.visible=e.visible)}}class Mi extends Cs{constructor(){super(),this.Utils=Yt,this.type="contact"}step(){const e=Zt.Ar,t=Zt.ArPos[this.type];let s,i,n=this.list.length;for(;n--;)s=this.list[n],i=t+n*Xt.contact,s.update(e,i)}add(e={}){this.setName(e);let t=new Ai(e);return e.callback&&delete e.callback,this.addToWorld(t,e.id),Zt.post({m:"add",o:e}),t}}class Ai{constructor(e={}){this.type="contact",this.name=e.name,this.callback=e.callback||function(){},this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.always=void 0===e.always||e.always,this.simple=e.simple||!1,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}update(e,t=0){this.data.hit=e[t]>0,this.simple||(this.data.point=[e[t+1],e[t+2],e[t+3]],this.data.normal=[e[t+4],e[t+5],e[t+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}class Ti extends Cs{constructor(){super(),this.Utils=Yt,this.type="vehicle",this.num=Xt[this.type]}step(){const e=Zt.Ar,t=Zt.ArPos[this.type];let s,i,n=this.list.length;for(;n--;)i=this.list[n],s=t+n*this.num,i.step(e,s)}add(e={}){this.setName(e);const t=new Si(e);return this.addToWorld(t,e.id),Zt.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}}class Si extends Gs{constructor(e){super(),e.extra&&(this.extra=e.extra,delete e.extra),this.type="vehicle",this.name=e.name||"car",this.isRay=e.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(e)}drive(){}raycast(){}init(e){this.mass=e.mass||2e3,this.model=null,this.size=e.size||[1.7,1,5],this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.maxSteering=e.maxSteering||24,this.incSteering=e.incSteering||2,this.s_travel=e.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===Zt.engine?.5*this.s_travel:0,this.numWheel=e.numWheel||4,this.radius=e.radius||.35,this.radiusBack=e.radiusBack||this.radius,this.deep=e.deep||.3,this.deepBack=e.deepBack||this.deep;let t=this.numWheel<4?1:2;if(e.wPos||(e.wPos=[.8,.1,1.4]),e.wPos){this.wPos=e.wPos;var s,i,n,r,a,o,l=e.wPos,h=[],c=1,u=0;l.length,l.length;for(let e=0;e<this.numWheel;e++)c=e%2==0?-1:1,i=Math.floor(.5*e),u=e>=t,0===(n=l[1])&&(n=u?this.radiusBack:this.radius),(r=l[0])instanceof Array&&(r=l[0][i]),a=u?-l[2]:l[2],l[2]instanceof Array&&(a=l[2][i]),s=[r*c,n,a],h.push(s);this.wheelsPosition=h,delete e.wPos}e.wheelsPosition&&(this.wheelsPosition=e.wheelsPosition);const p=e.meshScale||1,d=[];e.chassisShape?d.push({type:"convex",shape:e.chassisShape,size:[p],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):d.push({type:"box",size:this.size,pos:this.chassisPos});for(let s=0;s<this.numWheel;s++)s<t?d.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1}):d.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1});var m=Ts.get(e.debug?"debug":void 0===e.chassisMesh?"body":"hide");let f,g;for(let e=0;e<d.length;e++)f=d[e],f.pos&&(f.localPos=f.pos),f.size=Bt.autoSize(f.size,f.type),Zt.items.body.geometry(f,this,m);if(e.chassisMesh&&(g=e.noClone?e.chassisMesh:e.chassisMesh.clone(),g.position.set(0,0,0),Yt.noRay(g),g.scale.set(p,p,p),this.children[0].add(g),this.model=g,delete e.chassisMesh),e.wheelMesh){for(let s=1;s<this.numWheel+1;s++)u=s>=t+1,g=e.wheelMeshBack&&u?e.wheelMeshBack.clone():e.wheelMesh.clone(),Yt.noRay(g),g.position.set(0,0,0),2==s||4==s?g.scale.set(-p,p,p):g.scale.set(p,p,p),this.children[s].add(g);delete e.wheelMesh}if(e.suspensionMesh){this.suspensionMesh=[];for(let t=1;t<this.numWheel+1;t++)g=e.suspensionMesh.clone(),Yt.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[t-1]),g.position.x=0,2==t||4==t?g.scale.set(p,p,p):g.scale.set(-p,p,p),this.children[0].add(g),this.suspensionMesh.push(g);delete e.suspensionMesh}if(e.brakeMesh){this.brake=[];for(let t=1;t<this.numWheel+1;t++)u=t>2,g=e.brakeMeshBack&&u?e.brakeMeshBack.clone():e.brakeMesh.clone(),Yt.noRay(g),g.position.set(0,0,0),g.position.fromArray(this.wheelsPosition[t-1]),o=e.brakeMeshBack||u?p:-p,2==t||4==t?g.scale.set(-p,p,o):g.scale.set(p,p,o),this.children[0].add(g),this.brake.push(g);delete e.brakeMesh}e.mass=this.mass,e.size=e.chassisShape?d[0].boxSize:this.size,e.numWheel=this.numWheel,e.wheelsPosition=this.wheelsPosition,e.radius=this.radius,e.radiusBack=this.radiusBack,e.deep=this.deep,e.deepBack=this.deepBack,e.chassisShape=d[0],e.maxSteering=this.maxSteering,e.incSteering=this.incSteering,e.s_travel=this.s_travel,e.massCenter=this.massCenter,e.chassisPos=this.chassisPos,this.o=e}respawn(e){(e=e||{}).respawn=!0,e.name=this.name,e.keepRotation&&(e.quat=this.quaternion.toArray()),Zt.motor.change(e)}move(){}dispose(){}step(e,t){if(!this.actif){if(0===e[t+0]+e[t+1]+e[t+2]+e[t+3]+e[t+4]+e[t+5]+e[t+6]+e[t+7])return;this.actif=!0}this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.updateMatrix();let s,i=this.numWheel+1,n=0,r=0,a=[],o=0;for(let l=0;l<i;l++)o=8*l+t,0===l&&(e[o],this.circum),1===l&&(n=e[o]),2===l&&(r=e[o]),s=this.children[l],s&&l>0&&(a[l-1]=this.wheelsPosition[l-1][1]-this.decaly-e[o+2],s.position.fromArray(e,o+1),s.quaternion.fromArray(e,o+4),this.rolling[l-1]=s.rotation.x,this.brake&&(this.brake[l-1].position.copy(s.position),1!=l&&2!=l||(this.brake[l-1].rotation.y=e[o])));for(o=4;o--;)this.suspension[o]=Bt.clamp(a[o]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[o]>0?(Yt.morph(this.suspensionMesh[o].children[0],"low",this.suspension[o]),Yt.morph(this.suspensionMesh[o].children[0],"top",0)):(Yt.morph(this.suspensionMesh[o].children[0],"low",0),Yt.morph(this.suspensionMesh[o].children[0],"top",-this.suspension[o])));this.steering=Math.round(.5*(n+r)*zt)/this.maxSteering}}let Ri,ki,Ci,Ii;function Ei(e,t=1/0,s=null){ki||(ki=new p(2,2,1,1)),Ci||(Ci=new x({uniforms:{blitTexture:new Te(e)},vertexShader:"\n\t\t\tvarying vec2 vUv;\n\t\t\tvoid main(){\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = vec4(position.xy * 1.0,0.,.999999);\n\t\t\t}",fragmentShader:"\n\t\t\tuniform sampler2D blitTexture; \n\t\t\tvarying vec2 vUv;\n\n\t\t\tvoid main(){ \n\t\t\t\tgl_FragColor = vec4(vUv.xy, 0, 1);\n\t\t\t\t\n\t\t\t\t#ifdef IS_SRGB\n\t\t\t\tgl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );\n\t\t\t\t#else\n\t\t\t\tgl_FragColor = texture2D( blitTexture, vUv);\n\t\t\t\t#endif\n\t\t\t}"})),Ci.uniforms.blitTexture.value=e,Ci.defines.IS_SRGB=e.colorSpace==g,Ci.needsUpdate=!0,Ii||(Ii=new ne(ki,Ci),Ii.frustrumCulled=!1);const i=new Se,n=new Re;n.add(Ii),null===s&&(s=Ri=new ke({antialias:!1}));const r=Math.min(e.image.width,t),a=Math.min(e.image.height,t);s.setSize(r,a),s.clear(),s.render(n,i);const o=document.createElement("canvas"),l=o.getContext("2d");o.width=r,o.height=a,l.drawImage(s.domElement,0,0,r,a);const h=new d(o);return h.minFilter=e.minFilter,h.magFilter=e.magFilter,h.wrapS=e.wrapS,h.wrapT=e.wrapT,h.name=e.name,Ri&&(Ri.forceContextLoss(),Ri.dispose(),Ri=null),h}const Pi={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class _i{constructor(){this.pluginCallbacks=[],this.register((function(e){return new pn(e)})),this.register((function(e){return new dn(e)})),this.register((function(e){return new gn(e)})),this.register((function(e){return new yn(e)})),this.register((function(e){return new vn(e)})),this.register((function(e){return new wn(e)})),this.register((function(e){return new mn(e)})),this.register((function(e){return new fn(e)})),this.register((function(e){return new xn(e)})),this.register((function(e){return new bn(e)})),this.register((function(e){return new Mn(e)})),this.register((function(e){return new An(e)})),this.register((function(e){return new Tn(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){const n=new un,r=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)r.push(this.pluginCallbacks[e](n));n.setPlugins(r),n.write(e,t,i).catch(s)}parseAsync(e,t){const s=this;return new Promise((function(i,n){s.parse(e,i,n,t)}))}}const Li=0,Di=1,zi=2,Oi=3,Fi=4,Ni=5120,Bi=5121,Ui=5122,Vi=5123,Hi=5124,ji=5125,Gi=5126,Wi=34962,qi=34963,Xi=9728,Ki=9729,Zi=9984,Yi=9985,Qi=9986,Ji=9987,$i=33071,en=33648,tn=10497,sn={};sn[ze]=Xi,sn[Oe]=Zi,sn[Fe]=Qi,sn[Ne]=Ki,sn[Be]=Yi,sn[Ue]=Ji,sn[Ve]=$i,sn[f]=tn,sn[He]=en;const nn={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},rn=new v;function an(e,t){return e.length===t.length&&e.every((function(e,s){return e===t[s]}))}function on(e){return 4*Math.ceil(e/4)}function ln(e,t=0){const s=on(e.byteLength);if(s!==e.byteLength){const i=new Uint8Array(s);if(i.set(new Uint8Array(e)),0!==t)for(let n=e.byteLength;n<s;n++)i[n]=t;return i.buffer}return e}function hn(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function cn(e,t){if(void 0!==e.toBlob)return new Promise((s=>e.toBlob(s,t)));let s;return"image/jpeg"===t?s=.92:"image/webp"===t&&(s=.8),e.convertToBlob({type:t,quality:s})}class un{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const i=this,n=i.buffers,r=i.json;s=i.options;const a=i.extensionsUsed,o=i.extensionsRequired,l=new Blob(n,{type:"application/octet-stream"}),h=Object.keys(a),c=Object.keys(o);if(h.length>0&&(r.extensionsUsed=h),c.length>0&&(r.extensionsRequired=c),r.buffers&&r.buffers.length>0&&(r.buffers[0].byteLength=l.size),!0===s.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const s=ln(e.result),i=new DataView(new ArrayBuffer(8));i.setUint32(0,s.byteLength,!0),i.setUint32(4,5130562,!0);const n=ln((a=JSON.stringify(r),(new TextEncoder).encode(a).buffer),32);var a;const o=new DataView(new ArrayBuffer(8));o.setUint32(0,n.byteLength,!0),o.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),h=new DataView(l);h.setUint32(0,1179937895,!0),h.setUint32(4,2,!0);const c=12+o.byteLength+n.byteLength+i.byteLength+s.byteLength;h.setUint32(8,c,!0);const u=new Blob([l,o,n,i,s],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(u),p.onloadend=function(){t(p.result)}}}else if(r.buffers&&r.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const s=e.result;r.buffers[0].uri=s,t(r)}}else t(r)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const s=this.options,i=this.extensionsUsed;try{const n=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&n.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in n.gltfExtensions)t.extensions[e]=n.gltfExtensions[e],i[e]=!0;delete n.gltfExtensions}Object.keys(n).length>0&&(t.extras=n)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new i;for(let s=0,i=e.count;s<i;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const s=e.clone(),n=new i;for(let e=0,t=s.count;e<t;e++)n.fromBufferAttribute(s,e),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),s.setXYZ(e,n.x,n.y,n.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1;const i={};0===t.offset.x&&0===t.offset.y||(i.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(i.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(i.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function s(e){return e.colorSpace===g?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof Ee&&(e=Ei(e)),t instanceof Ee&&(t=Ei(t));const i=e?e.image:null,n=t?t.image:null,r=Math.max(i?i.width:0,n?n.width:0),a=Math.max(i?i.height:0,n?n.height:0),o=hn();o.width=r,o.height=a;const l=o.getContext("2d");l.fillStyle="#00ffff",l.fillRect(0,0,r,a);const h=l.getImageData(0,0,r,a);if(i){l.drawImage(i,0,0,r,a);const t=s(e),n=l.getImageData(0,0,r,a).data;for(let e=2;e<n.length;e+=4)h.data[e]=256*t(n[e]/256)}if(n){l.drawImage(n,0,0,r,a);const e=s(t),i=l.getImageData(0,0,r,a).data;for(let t=1;t<i.length;t+=4)h.data[t]=256*e(i[t]/256)}l.putImageData(h,0,0);const c=(e||t).clone();return c.source=new Pe(o),c.colorSpace=_e,c.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),c}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,i,n){const r=this.json;let a;switch(r.bufferViews||(r.bufferViews=[]),t){case Ni:case Bi:a=1;break;case Ui:case Vi:a=2;break;default:a=4}const o=on(i*e.itemSize*a),l=new DataView(new ArrayBuffer(o));let h=0;for(let n=s;n<s+i;n++)for(let s=0;s<e.itemSize;s++){let i;e.itemSize>4?i=e.array[n*e.itemSize+s]:(0===s?i=e.getX(n):1===s?i=e.getY(n):2===s?i=e.getZ(n):3===s&&(i=e.getW(n)),!0===e.normalized&&(i=ee.normalize(i,e.array))),t===Gi?l.setFloat32(h,i,!0):t===Hi?l.setInt32(h,i,!0):t===ji?l.setUint32(h,i,!0):t===Ui?l.setInt16(h,i,!0):t===Vi?l.setUint16(h,i,!0):t===Ni?l.setInt8(h,i):t===Bi&&l.setUint8(h,i),h+=a}const c={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:o};void 0!==n&&(c.target=n),n===Wi&&(c.byteStride=e.itemSize*a),this.byteOffset+=o,r.bufferViews.push(c);return{id:r.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise((function(i){const n=new FileReader;n.readAsArrayBuffer(e),n.onloadend=function(){const e=ln(n.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,i(s.bufferViews.push(r)-1)}}))}processAccessor(e,t,s,i){const n=this.json;let r;if(e.array.constructor===Float32Array)r=Gi;else if(e.array.constructor===Int32Array)r=Hi;else if(e.array.constructor===Uint32Array)r=ji;else if(e.array.constructor===Int16Array)r=Ui;else if(e.array.constructor===Uint16Array)r=Vi;else if(e.array.constructor===Int8Array)r=Ni;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);r=Bi}if(void 0===s&&(s=0),void 0!==i&&i!==1/0||(i=e.count),0===i)return null;const a=function(e,t,s){const i={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let n=t;n<t+s;n++)for(let t=0;t<e.itemSize;t++){let s;e.itemSize>4?s=e.array[n*e.itemSize+t]:(0===t?s=e.getX(n):1===t?s=e.getY(n):2===t?s=e.getZ(n):3===t&&(s=e.getW(n)),!0===e.normalized&&(s=ee.normalize(s,e.array))),i.min[t]=Math.min(i.min[t],s),i.max[t]=Math.max(i.max[t],s)}return i}(e,s,i);let o;void 0!==t&&(o=e===t.index?qi:Wi);const l=this.processBufferView(e,r,s,i,o),h={bufferView:l.id,byteOffset:l.byteOffset,componentType:r,count:i,max:a.max,min:a.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(h.normalized=!0),n.accessors||(n.accessors=[]),n.accessors.push(h)-1}processImage(e,t,s,i="image/png"){if(null!==e){const n=this,r=n.cache,a=n.json,o=n.options,l=n.pending;r.images.has(e)||r.images.set(e,{});const h=r.images.get(e),c=i+":flipY/"+s.toString();if(void 0!==h[c])return h[c];a.images||(a.images=[]);const u={mimeType:i},p=hn();p.width=Math.min(e.width,o.maxTextureSize),p.height=Math.min(e.height,o.maxTextureSize);const d=p.getContext("2d");if(!0===s&&(d.translate(0,p.height),d.scale(1,-1)),void 0!==e.data){t!==Le&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const s=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<s.length;t+=4)s[t+0]=e.data[t+0],s[t+1]=e.data[t+1],s[t+2]=e.data[t+2],s[t+3]=e.data[t+3];d.putImageData(new ImageData(s,e.width,e.height),0,0)}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement or ImageBitmap.");d.drawImage(e,0,0,p.width,p.height)}!0===o.binary?l.push(cn(p,i).then((e=>n.processBufferViewImage(e))).then((e=>{u.bufferView=e}))):void 0!==p.toDataURL?u.uri=p.toDataURL(i):l.push(cn(p,i).then((e=>(new FileReader).readAsDataURL(e))).then((e=>{u.uri=e})));const m=a.images.push(u)-1;return h[c]=m,m}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:sn[e.magFilter],minFilter:sn[e.minFilter],wrapS:sn[e.wrapS],wrapT:sn[e.wrapT]};return t.samplers.push(s)-1}processTexture(e){const t=this.options,s=this.cache,i=this.json;if(s.textures.has(e))return s.textures.get(e);i.textures||(i.textures=[]),e instanceof Ee&&(e=Ei(e,t.maxTextureSize));let n=e.userData.mimeType;"image/webp"===n&&(n="image/png");const r={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,n)};e.name&&(r.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,r)}));const a=i.textures.push(r)-1;return s.textures.set(e,a),a}processMaterial(e){const t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);const i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const n=e.color.toArray().concat([e.opacity]);if(an(n,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=n),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),s={index:this.processTexture(t),channel:t.channel};this.applyTextureTransform(s,t),i.pbrMetallicRoughness.metallicRoughnessTexture=s}if(e.map){const t={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===I&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,i)}));const r=s.materials.push(i)-1;return t.materials.set(e,r),r}processMesh(e){const t=this.cache,s=this.json,i=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,s=e.material.length;t<s;t++)i.push(e.material[t].uuid);else i.push(e.material.uuid);const n=i.join(":");if(t.meshes.has(n))return t.meshes.get(n);const r=e.geometry;let o;o=e.isLineSegments?Di:e.isLineLoop?zi:e.isLine?Oi:e.isPoints?Li:e.material.wireframe?Di:Fi;const l={},h={},c=[],u=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=r.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),r.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let m=null;for(let e in r.attributes){if("morph"===e.slice(0,5))continue;const s=r.attributes[e];e=p[e]||e.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(s))){h[e]=t.attributes.get(this.getUID(s));continue}m=null;const i=s.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new a(new Uint16Array(i),s.itemSize,s.normalized));const n=this.processAccessor(m||s,r);null!==n&&(e.startsWith("_")||this.detectMeshQuantization(e,s),h[e]=n,t.attributes.set(this.getUID(s),n))}if(void 0!==d&&r.setAttribute("normal",d),0===Object.keys(h).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const s=[],i=[],n={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)n[e.morphTargetDictionary[t]]=t;for(let a=0;a<e.morphTargetInfluences.length;++a){const o={};let l=!1;for(const e in r.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const s=r.morphAttributes[e][a],i=e.toUpperCase(),n=r.attributes[e];if(t.attributes.has(this.getUID(s,!0))){o[i]=t.attributes.get(this.getUID(s,!0));continue}const h=s.clone();if(!r.morphTargetsRelative)for(let e=0,t=s.count;e<t;e++)for(let t=0;t<s.itemSize;t++)0===t&&h.setX(e,s.getX(e)-n.getX(e)),1===t&&h.setY(e,s.getY(e)-n.getY(e)),2===t&&h.setZ(e,s.getZ(e)-n.getZ(e)),3===t&&h.setW(e,s.getW(e)-n.getW(e));o[i]=this.processAccessor(h,r),t.attributes.set(this.getUID(n,!0),o[i])}u.push(o),s.push(e.morphTargetInfluences[a]),void 0!==e.morphTargetDictionary&&i.push(n[a])}l.weights=s,i.length>0&&(l.extras={},l.extras.targetNames=i)}const f=Array.isArray(e.material);if(f&&0===r.groups.length)return null;let g=!1;if(f&&null===r.index){const e=[];for(let t=0,s=r.attributes.position.count;t<s;t++)e[t]=t;r.setIndex(e),g=!0}const y=f?e.material:[e.material],v=f?r.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,s=v.length;e<s;e++){const s={mode:o,attributes:h};if(this.serializeUserData(r,s),u.length>0&&(s.targets=u),null!==r.index){let i=this.getUID(r.index);void 0===v[e].start&&void 0===v[e].count||(i+=":"+v[e].start+":"+v[e].count),t.attributes.has(i)?s.indices=t.attributes.get(i):(s.indices=this.processAccessor(r.index,r,v[e].start,v[e].count),t.attributes.set(i,s.indices)),null===s.indices&&delete s.indices}const i=this.processMaterial(y[v[e].materialIndex]);null!==i&&(s.material=i),c.push(s)}!0===g&&r.setIndex(null),l.primitives=c,s.meshes||(s.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,l)}));const w=s.meshes.push(l)-1;return t.meshes.set(n,w),w}detectMeshQuantization(e,t){if(this.extensionsUsed.KHR_mesh_quantization)return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");const i=e.split("_",1)[0];Pi[i]&&Pi[i].includes(s)&&(this.extensionsUsed.KHR_mesh_quantization=!0,this.extensionsRequired.KHR_mesh_quantization=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const s=e.isOrthographicCamera,i={type:s?"orthographic":"perspective"};return s?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:ee.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){const s=this.json,i=this.nodeMap;s.animations||(s.animations=[]);const n=(e=_i.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,r=[],o=[];for(let e=0;e<n.length;++e){const s=n[e],l=Ce.parseTrackName(s.name);let h=Ce.findNode(t,l.nodeName);const c=nn[l.propertyName];if("bones"===l.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(l.objectIndex):void 0),!h||!c)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',s.name),null;const u=1;let p,d=s.values.length/s.times.length;c===nn.morphTargetInfluences&&(d/=h.morphTargetInfluences.length),!0===s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(p="CUBICSPLINE",d/=3):p=s.getInterpolation()===De?"STEP":"LINEAR",o.push({input:this.processAccessor(new a(s.times,u)),output:this.processAccessor(new a(s.values,d)),interpolation:p}),r.push({sampler:o.length-1,target:{node:i.get(h),path:c}})}return s.animations.push({name:e.name||"clip_"+s.animations.length,samplers:o,channels:r}),s.animations.length-1}processSkin(e){const t=this.json,s=this.nodeMap,i=t.nodes[s.get(e)],n=e.skeleton;if(void 0===n)return null;const r=e.skeleton.bones[0];if(void 0===r)return null;const o=[],l=new Float32Array(16*n.bones.length),h=new te;for(let t=0;t<n.bones.length;++t)o.push(s.get(n.bones[t])),h.copy(n.boneInverses[t]),h.multiply(e.bindMatrix).toArray(l,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new a(l,16)),joints:o,skeleton:s.get(r)});return i.skin=t.skins.length-1}processNode(e){const t=this.json,s=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);const n={};if(s.trs){const t=e.quaternion.toArray(),s=e.position.toArray(),i=e.scale.toArray();an(t,[0,0,0,1])||(n.rotation=t),an(s,[0,0,0])||(n.translation=s),an(i,[1,1,1])||(n.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===an(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(n.matrix=e.matrix.elements);if(""!==e.name&&(n.name=String(e.name)),this.serializeUserData(e,n),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(n.mesh=t)}else e.isCamera&&(n.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let i=0,n=e.children.length;i<n;i++){const n=e.children[i];if(n.visible||!1===s.onlyVisible){const e=this.processNode(n);null!==e&&t.push(e)}}t.length>0&&(n.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,n)}));const r=t.nodes.push(n)-1;return i.set(e,r),r}processScene(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);const n=[];for(let t=0,i=e.children.length;t<i;t++){const i=e.children[t];if(i.visible||!1===s.onlyVisible){const e=this.processNode(i);null!==e&&n.push(e)}}n.length>0&&(i.nodes=n),this.serializeUserData(e,i)}processObjects(e){const t=new Re;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const s=[];for(let t=0;t<e.length;t++)e[t]instanceof Re?this.processScene(e[t]):s.push(e[t]);s.length>0&&this.processObjects(s);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let s=0;s<t.animations.length;++s)this.processAnimation(t.animations[s],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,s=this.plugins.length;t<s;t++)e(this.plugins[t])}}class pn{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const s=this.writer,i=s.json,n=s.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(1-e.penumbra)*e.angle,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),n[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},n[this.name]=!0);const a=i.extensions[this.name].lights;a.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class dn{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class mn{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const s=this.writer,i=s.extensionsUsed,n={};if(n.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:s.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};s.applyTextureTransform(t,e.clearcoatMap),n.clearcoatTexture=t}if(n.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:s.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};s.applyTextureTransform(t,e.clearcoatRoughnessMap),n.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:s.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};s.applyTextureTransform(t,e.clearcoatNormalMap),n.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class fn{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const s=this.writer,i=s.extensionsUsed,n={};if(n.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:s.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};s.applyTextureTransform(t,e.iridescenceMap),n.iridescenceTexture=t}if(n.iridescenceIor=e.iridescenceIOR,n.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],n.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:s.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};s.applyTextureTransform(t,e.iridescenceThicknessMap),n.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class gn{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,i=s.extensionsUsed,n={};if(n.transmissionFactor=e.transmission,e.transmissionMap){const t={index:s.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};s.applyTextureTransform(t,e.transmissionMap),n.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class yn{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,i=s.extensionsUsed,n={};if(n.thicknessFactor=e.thickness,e.thicknessMap){const t={index:s.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};s.applyTextureTransform(t,e.thicknessMap),n.thicknessTexture=t}n.attenuationDistance=e.attenuationDistance,n.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class vn{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const s=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}class wn{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(rn)&&!e.specularIntensityMap&&!e.specularColorMap)return;const s=this.writer,i=s.extensionsUsed,n={};if(e.specularIntensityMap){const t={index:s.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};s.applyTextureTransform(t,e.specularIntensityMap),n.specularTexture=t}if(e.specularColorMap){const t={index:s.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};s.applyTextureTransform(t,e.specularColorMap),n.specularColorTexture=t}n.specularFactor=e.specularIntensity,n.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class xn{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const s=this.writer,i=s.extensionsUsed,n={};if(e.sheenRoughnessMap){const t={index:s.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};s.applyTextureTransform(t,e.sheenRoughnessMap),n.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:s.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};s.applyTextureTransform(t,e.sheenColorMap),n.sheenColorTexture=t}n.sheenRoughnessFactor=e.sheenRoughness,n.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class bn{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const s=this.writer,i=s.extensionsUsed,n={};if(e.anisotropyMap){const t={index:s.processTexture(e.anisotropyMap)};s.applyTextureTransform(t,e.anisotropyMap),n.anisotropyTexture=t}n.anisotropyStrength=e.anisotropy,n.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class Mn{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const s=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,s[this.name]=!0}}class An{constructor(e){this.writer=e,this.name="EXT_materials_bump"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;const s=this.writer,i=s.extensionsUsed,n={};if(e.bumpMap){const t={index:s.processTexture(e.bumpMap),texCoord:e.bumpMap.channel};s.applyTextureTransform(t,e.bumpMap),n.bumpTexture=t}n.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}}class Tn{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,s){if(!e.isInstancedMesh)return;const n=this.writer,r=e,o=new Float32Array(3*r.count),l=new Float32Array(4*r.count),h=new Float32Array(3*r.count),c=new te,u=new i,p=new t,d=new i;for(let e=0;e<r.count;e++)r.getMatrixAt(e,c),c.decompose(u,p,d),u.toArray(o,3*e),p.toArray(l,4*e),d.toArray(h,3*e);const m={TRANSLATION:n.processAccessor(new a(o,3)),ROTATION:n.processAccessor(new a(l,4)),SCALE:n.processAccessor(new a(h,3))};r.instanceColor&&(m._COLOR_0=n.processAccessor(r.instanceColor)),s.extensions=s.extensions||{},s.extensions[this.name]={attributes:m},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function Sn(e){const t=new Map,s=new Map,i=e.clone();return Rn(e,i,(function(e,i){t.set(i,e),s.set(e,i)})),i.traverse((function(e){if(!e.isSkinnedMesh)return;const i=e,n=t.get(e),r=n.skeleton.bones;i.skeleton=n.skeleton.clone(),i.bindMatrix.copy(n.bindMatrix),i.skeleton.bones=r.map((function(e){return s.get(e)})),i.bind(i.skeleton,i.bindMatrix)})),i}function Rn(e,t,s){s(e,t);for(let i=0;i<e.children.length;i++)Rn(e.children[i],t.children[i],s)}_i.Utils={insertKeyframe:function(e,t){const s=.001,i=e.getValueSize(),n=new e.TimeBufferType(e.times.length+1),r=new e.ValueBufferType(e.values.length+i),a=e.createInterpolant(new e.ValueBufferType(i));let o;if(0===e.times.length){n[0]=t;for(let e=0;e<i;e++)r[e]=0;o=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;n[0]=t,n.set(e.times,1),r.set(a.evaluate(t),0),r.set(e.values,i),o=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;n[n.length-1]=t,n.set(e.times,0),r.set(e.values,0),r.set(a.evaluate(t),e.values.length),o=n.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<s)return l;if(e.times[l]<t&&e.times[l+1]>t){n.set(e.times.slice(0,l+1),0),n[l+1]=t,n.set(e.times.slice(l+1),l+2),r.set(e.values.slice(0,(l+1)*i),0),r.set(a.evaluate(t),(l+1)*i),r.set(e.values.slice((l+1)*i),(l+2)*i),o=l+1;break}}return e.times=n,e.values=r,o},mergeMorphTargetTracks:function(e,t){const s=[],i={},n=e.tracks;for(let e=0;e<n.length;++e){let r=n[e];const a=Ce.parseTrackName(r.name),o=Ce.findNode(t,a.nodeName);if("morphTargetInfluences"!==a.propertyName||void 0===a.propertyIndex){s.push(r);continue}if(r.createInterpolant!==r.InterpolantFactoryMethodDiscrete&&r.createInterpolant!==r.InterpolantFactoryMethodLinear){if(r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),r=r.clone(),r.setInterpolation(Ie)}const l=o.morphTargetInfluences.length,h=o.morphTargetDictionary[a.propertyIndex];if(void 0===h)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let c;if(void 0===i[o.uuid]){c=r.clone();const e=new c.ValueBufferType(l*c.times.length);for(let t=0;t<c.times.length;t++)e[t*l+h]=c.values[t];c.name=(a.nodeName||"")+".morphTargetInfluences",c.values=e,i[o.uuid]=c,s.push(c);continue}const u=r.createInterpolant(new r.ValueBufferType(1));c=i[o.uuid];for(let e=0;e<c.times.length;e++)c.values[e*l+h]=u.evaluate(c.times[e]);for(let e=0;e<r.times.length;e++){const t=this.insertKeyframe(c,r.times[e]);c.values[t*l+h]=r.values[e]}}return e.tracks=s,e}};class kn extends ge{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Ln(e)})),this.register((function(e){return new Hn(e)})),this.register((function(e){return new jn(e)})),this.register((function(e){return new Gn(e)})),this.register((function(e){return new zn(e)})),this.register((function(e){return new On(e)})),this.register((function(e){return new Fn(e)})),this.register((function(e){return new Nn(e)})),this.register((function(e){return new _n(e)})),this.register((function(e){return new Bn(e)})),this.register((function(e){return new Dn(e)})),this.register((function(e){return new Vn(e)})),this.register((function(e){return new Un(e)})),this.register((function(e){return new En(e)})),this.register((function(e){return new Wn(e)})),this.register((function(e){return new qn(e)}))}load(e,t,s,i){const n=this;let r;if(""!==this.resourcePath)r=this.resourcePath;else if(""!==this.path){const t=je.extractUrlBase(e);r=je.resolveURL(t,this.path)}else r=je.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){i?i(t):console.error(t),n.manager.itemError(e),n.manager.itemEnd(e)},o=new ye(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(s){try{n.parse(s,r,(function(s){t(s),n.manager.itemEnd(e)}),a)}catch(e){a(e)}}),s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let n;const r={},a={},o=new TextDecoder;if("string"==typeof e)n=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===Xn){try{r[In.KHR_BINARY_GLTF]=new Yn(e)}catch(e){return void(i&&i(e))}n=JSON.parse(r[In.KHR_BINARY_GLTF].content)}else n=JSON.parse(o.decode(e))}else n=e;if(void 0===n.asset||n.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new br(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[t.name]=t,r[t.name]=!0}if(n.extensionsUsed)for(let e=0;e<n.extensionsUsed.length;++e){const t=n.extensionsUsed[e],s=n.extensionsRequired||[];switch(t){case In.KHR_MATERIALS_UNLIT:r[t]=new Pn;break;case In.KHR_DRACO_MESH_COMPRESSION:r[t]=new Qn(n,this.dracoLoader);break;case In.KHR_TEXTURE_TRANSFORM:r[t]=new Jn;break;case In.KHR_MESH_QUANTIZATION:r[t]=new $n;break;default:s.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(r),l.setPlugins(a),l.parse(s,i)}parseAsync(e,t){const s=this;return new Promise((function(i,n){s.parse(e,t,i,n)}))}}function Cn(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const In={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class En{constructor(e){this.parser=e,this.name=In.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const n=t.json,r=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let a;const o=new v(16777215);void 0!==r.color&&o.setRGB(r.color[0],r.color[1],r.color[2],Ge);const l=void 0!==r.range?r.range:0;switch(r.type){case"directional":a=new Xe(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new qe(o),a.distance=l;break;case"spot":a=new We(o),a.distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,a.angle=r.spot.outerConeAngle,a.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return a.position.set(0,0,0),a.decay=2,fr(a,r),void 0!==r.intensity&&(a.intensity=r.intensity),a.name=t.createUniqueName(r.name||"light_"+e),i=Promise.resolve(a),t.cache.add(s,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],n=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then((function(e){return s._getNodeRef(t.cache,n,e)}))}}class Pn{constructor(){this.name=In.KHR_MATERIALS_UNLIT}getMaterialType(){return R}extendParams(e,t,s){const i=[];e.color=new v(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const t=n.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],Ge),e.opacity=t[3]}void 0!==n.baseColorTexture&&i.push(s.assignTexture(e,"map",n.baseColorTexture,g))}return Promise.all(i)}}class _n{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class Ln{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];if(void 0!==r.clearcoatFactor&&(t.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&n.push(s.assignTexture(t,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(t.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&n.push(s.assignTexture(t,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(n.push(s.assignTexture(t,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){const e=r.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new M(e,e)}return Promise.all(n)}}class Dn{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return void 0!==r.iridescenceFactor&&(t.iridescence=r.iridescenceFactor),void 0!==r.iridescenceTexture&&n.push(s.assignTexture(t,"iridescenceMap",r.iridescenceTexture)),void 0!==r.iridescenceIor&&(t.iridescenceIOR=r.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==r.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=r.iridescenceThicknessMinimum),void 0!==r.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=r.iridescenceThicknessMaximum),void 0!==r.iridescenceThicknessTexture&&n.push(s.assignTexture(t,"iridescenceThicknessMap",r.iridescenceThicknessTexture)),Promise.all(n)}}class zn{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new v(0,0,0),t.sheenRoughness=0,t.sheen=1;const r=i.extensions[this.name];if(void 0!==r.sheenColorFactor){const e=r.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],Ge)}return void 0!==r.sheenRoughnessFactor&&(t.sheenRoughness=r.sheenRoughnessFactor),void 0!==r.sheenColorTexture&&n.push(s.assignTexture(t,"sheenColorMap",r.sheenColorTexture,g)),void 0!==r.sheenRoughnessTexture&&n.push(s.assignTexture(t,"sheenRoughnessMap",r.sheenRoughnessTexture)),Promise.all(n)}}class On{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&n.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(n)}}class Fn{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.thickness=void 0!==r.thicknessFactor?r.thicknessFactor:0,void 0!==r.thicknessTexture&&n.push(s.assignTexture(t,"thicknessMap",r.thicknessTexture)),t.attenuationDistance=r.attenuationDistance||1/0;const a=r.attenuationColor||[1,1,1];return t.attenuationColor=(new v).setRGB(a[0],a[1],a[2],Ge),Promise.all(n)}}class Nn{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class Bn{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];t.specularIntensity=void 0!==r.specularFactor?r.specularFactor:1,void 0!==r.specularTexture&&n.push(s.assignTexture(t,"specularIntensityMap",r.specularTexture));const a=r.specularColorFactor||[1,1,1];return t.specularColor=(new v).setRGB(a[0],a[1],a[2],Ge),void 0!==r.specularColorTexture&&n.push(s.assignTexture(t,"specularColorMap",r.specularColorTexture,g)),Promise.all(n)}}class Un{constructor(e){this.parser=e,this.name=In.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return t.bumpScale=void 0!==r.bumpFactor?r.bumpFactor:1,void 0!==r.bumpTexture&&n.push(s.assignTexture(t,"bumpMap",r.bumpTexture)),Promise.all(n)}}class Vn{constructor(e){this.parser=e,this.name=In.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?y:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],r=i.extensions[this.name];return void 0!==r.anisotropyStrength&&(t.anisotropy=r.anisotropyStrength),void 0!==r.anisotropyRotation&&(t.anisotropyRotation=r.anisotropyRotation),void 0!==r.anisotropyTexture&&n.push(s.assignTexture(t,"anisotropyMap",r.anisotropyTexture)),Promise.all(n)}}class Hn{constructor(e){this.parser=e,this.name=In.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const n=i.extensions[this.name],r=t.options.ktx2Loader;if(!r){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,r)}}class jn{constructor(e){this.parser=e,this.name=In.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],a=i.images[r.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return s.loadTextureImage(e,r.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Gn{constructor(e){this.parser=e,this.name=In.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;const r=n.extensions[t],a=i.images[r.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return s.loadTextureImage(e,r.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Wn{constructor(e){this.name=In.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const s=e.byteOffset||0,i=e.byteLength||0,r=e.count,a=e.byteStride,o=new Uint8Array(t,s,i);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(r,a,o,e.mode,e.filter).then((function(e){return e.buffer})):n.ready.then((function(){const t=new ArrayBuffer(r*a);return n.decodeGltfBuffer(new Uint8Array(t),r,a,o,e.mode,e.filter),t}))}))}return null}}class qn{constructor(e){this.name=In.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const s=this.parser.json,n=s.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const r=s.meshes[n.mesh];for(const e of r.primitives)if(e.mode!==ir.TRIANGLES&&e.mode!==ir.TRIANGLE_STRIP&&e.mode!==ir.TRIANGLE_FAN&&void 0!==e.mode)return null;const a=n.extensions[this.name].attributes,o=[],l={};for(const e in a)o.push(this.parser.getDependency("accessor",a[e]).then((t=>(l[e]=t,l[e]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const s=e.pop(),n=s.isGroup?s.children:[s],r=e[0].count,a=[];for(const e of n){const s=new te,n=new i,o=new t,h=new i(1,1,1),c=new re(e.geometry,e.material,r);for(let e=0;e<r;e++)l.TRANSLATION&&n.fromBufferAttribute(l.TRANSLATION,e),l.ROTATION&&o.fromBufferAttribute(l.ROTATION,e),l.SCALE&&h.fromBufferAttribute(l.SCALE,e),c.setMatrixAt(e,s.compose(n,o,h));for(const t in l)if("_COLOR_0"===t){const e=l[t];c.instanceColor=new ae(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,l[t]);fe.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),a.push(c)}return s.isGroup?(s.clear(),s.add(...a),s):a[0]})))}}const Xn="glTF",Kn=1313821514,Zn=5130562;class Yn{constructor(e){this.name=In.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Xn)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,n=new DataView(e,12);let r=0;for(;r<i;){const t=n.getUint32(r,!0);r+=4;const i=n.getUint32(r,!0);if(r+=4,i===Kn){const i=new Uint8Array(e,12+r,t);this.content=s.decode(i)}else if(i===Zn){const s=12+r;this.body=e.slice(s,s+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Qn{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=In.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,n=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,a={},o={},l={};for(const e in r){const t=lr[e]||e.toLowerCase();a[t]=r[e]}for(const t in e.attributes){const i=lr[t]||t.toLowerCase();if(void 0!==r[t]){const n=s.accessors[e.attributes[t]],r=nr[n.componentType];l[i]=r.name,o[i]=!0===n.normalized}}return t.getDependency("bufferView",n).then((function(e){return new Promise((function(t,s){i.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],i=o[t];void 0!==i&&(s.normalized=i)}t(e)}),a,l,Ge,s)}))}))}}class Jn{constructor(){this.name=In.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class $n{constructor(){this.name=In.KHR_MESH_QUANTIZATION}}class er extends mt{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,n=e*i*3+i;for(let e=0;e!==i;e++)t[e]=s[n+e];return t}interpolate_(e,t,s,i){const n=this.resultBuffer,r=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,h=i-t,c=(s-t)/h,u=c*c,p=u*c,d=e*l,m=d-l,f=-2*p+3*u,g=p-u,y=1-f,v=g-u+c;for(let e=0;e!==a;e++){const t=r[m+e+a],s=r[m+e+o]*h,i=r[d+e+a],l=r[d+e]*h;n[e]=y*t+v*s+f*i+g*l}return n}}const tr=new t;class sr extends er{interpolate_(e,t,s,i){const n=super.interpolate_(e,t,s,i);return tr.fromArray(n).normalize().toArray(n),n}}const ir={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},nr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},rr={9728:ze,9729:Ne,9984:Oe,9985:Be,9986:Fe,9987:Ue},ar={33071:Ve,33648:He,10497:f},or={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},lr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},hr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},cr={CUBICSPLINE:void 0,LINEAR:Ie,STEP:De},ur="OPAQUE",pr="MASK",dr="BLEND";function mr(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function fr(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function gr(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,i=t.weights.length;s<i;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,i=s.length;t<i;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function yr(e){let t;const s=e.extensions&&e.extensions[In.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+vr(s.attributes):e.indices+":"+vr(e.attributes)+":"+e.mode,void 0!==e.targets)for(let s=0,i=e.targets.length;s<i;s++)t+=":"+vr(e.targets[s]);return t}function vr(e){let t="";const s=Object.keys(e).sort();for(let i=0,n=s.length;i<n;i++)t+=s[i]+":"+e[s[i]]+";";return t}function wr(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const xr=new te;class br{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Cn,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=!1,n=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=navigator.userAgent.indexOf("Firefox")>-1,n=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||i&&n<98?this.textureLoader=new Ke(this.options.manager):this.textureLoader=new Ze(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ye(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const r={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};return mr(n,r,i),fr(r,i),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){for(const e of r.scenes)e.updateMatrixWorld();e(r)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s].joints;for(let t=0,s=i.length;t<s;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(s[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),n=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[s,i]of e.children.entries())n(i,t.children[s])};return n(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const n=e(t[i]);n&&s.push(n)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return s.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[In.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(e,n){s.load(je.resolveURL(t.uri,i.path),e,void 0,(function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+s)}))}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=or[i.type],t=nr[i.componentType],s=!0===i.normalized,n=new t(i.count*e);return Promise.resolve(new a(n,e,s))}const n=[];return void 0!==i.bufferView?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),void 0!==i.sparse&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then((function(e){const n=e[0],r=or[i.type],o=nr[i.componentType],l=o.BYTES_PER_ELEMENT,h=l*r,c=i.byteOffset||0,u=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,p=!0===i.normalized;let d,m;if(u&&u!==h){const e=Math.floor(c/u),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let a=t.cache.get(s);a||(d=new o(n,e*u,i.count*u/l),a=new Ye(d,u/l),t.cache.add(s,a)),m=new Qe(a,r,c%u/l,p)}else d=null===n?new o(i.count*r):new o(n,c,i.count*r),m=new a(d,r,p);if(void 0!==i.sparse){const t=or.SCALAR,s=nr[i.sparse.indices.componentType],l=i.sparse.indices.byteOffset||0,h=i.sparse.values.byteOffset||0,c=new s(e[1],l,i.sparse.count*t),u=new o(e[2],h,i.sparse.count*r);null!==n&&(m=new a(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(m.setX(t,u[e*r]),r>=2&&m.setY(t,u[e*r+1]),r>=3&&m.setZ(t,u[e*r+2]),r>=4&&m.setW(t,u[e*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,n=t.images[i];let r=this.textureLoader;if(n.uri){const e=s.manager.getHandler(n.uri);null!==e&&(r=e)}return this.loadTextureImage(e,i,r)}loadTextureImage(e,t,s){const i=this,n=this.json,r=n.textures[e],a=n.images[t],o=(a.uri||a.bufferView)+":"+r.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,s).then((function(t){t.flipY=!1,t.name=r.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const s=(n.samplers||{})[r.sampler]||{};return t.magFilter=rr[s.magFilter]||Ne,t.minFilter=rr[s.minFilter]||Ue,t.wrapS=ar[s.wrapS]||f,t.wrapT=ar[s.wrapT]||f,i.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[o]=l,l}loadImageSource(e,t){const s=this,i=this.json,n=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const r=i.images[e],a=self.URL||self.webkitURL;let o=r.uri||"",l=!1;if(void 0!==r.bufferView)o=s.getDependency("bufferView",r.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:r.mimeType});return o=a.createObjectURL(t),o}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(o).then((function(e){return new Promise((function(s,i){let r=s;!0===t.isImageBitmapLoader&&(r=function(e){const t=new ht(e);t.needsUpdate=!0,s(t)}),t.load(je.resolveURL(e,n.path),r,void 0,i)}))})).then((function(e){var t;return!0===l&&a.revokeObjectURL(o),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),e}));return this.sourceCache[e]=h,h}assignTexture(e,t,s,i){const n=this;return this.getDependency("texture",s.index).then((function(r){if(!r)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((r=r.clone()).channel=s.texCoord),n.extensions[In.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[In.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(r);r=n.extensions[In.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),n.associations.set(r,t)}}return void 0!==i&&(r.colorSpace=i),e[t]=r,r}))}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=void 0===t.attributes.tangent,n=void 0!==t.attributes.color,r=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Je,$e.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new l,$e.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(i||n||r){let e="ClonedMaterial:"+s.uuid+":";i&&(e+="derivative-tangents:"),n&&(e+="vertex-colors:"),r&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),n&&(t.vertexColors=!0),r&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return A}loadMaterial(e){const t=this,s=this.json,i=this.extensions,n=s.materials[e];let r;const a={},o=[];if((n.extensions||{})[In.KHR_MATERIALS_UNLIT]){const e=i[In.KHR_MATERIALS_UNLIT];r=e.getMaterialType(),o.push(e.extendParams(a,n,t))}else{const s=n.pbrMetallicRoughness||{};if(a.color=new v(1,1,1),a.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],Ge),a.opacity=e[3]}void 0!==s.baseColorTexture&&o.push(t.assignTexture(a,"map",s.baseColorTexture,g)),a.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,a.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(o.push(t.assignTexture(a,"metalnessMap",s.metallicRoughnessTexture)),o.push(t.assignTexture(a,"roughnessMap",s.metallicRoughnessTexture))),r=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),o.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)}))))}!0===n.doubleSided&&(a.side=I);const l=n.alphaMode||ur;if(l===dr?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===pr&&(a.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&r!==R&&(o.push(t.assignTexture(a,"normalMap",n.normalTexture)),a.normalScale=new M(1,1),void 0!==n.normalTexture.scale)){const e=n.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==n.occlusionTexture&&r!==R&&(o.push(t.assignTexture(a,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(a.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&r!==R){const e=n.emissiveFactor;a.emissive=(new v).setRGB(e[0],e[1],e[2],Ge)}return void 0!==n.emissiveTexture&&r!==R&&o.push(t.assignTexture(a,"emissiveMap",n.emissiveTexture,g)),Promise.all(o).then((function(){const s=new r(a);return n.name&&(s.name=n.name),fr(s,n),t.associations.set(s,{materials:e}),n.extensions&&mr(i,s,n),s}))}createUniqueName(e){const t=Ce.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function n(e){return s[In.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return Mr(s,e,t)}))}const a=[];for(let s=0,o=e.length;s<o;s++){const o=e[s],l=yr(o),h=i[l];if(h)a.push(h.promise);else{let e;e=o.extensions&&o.extensions[In.KHR_DRACO_MESH_COMPRESSION]?n(o):Mr(new r,o,t),i[l]={primitive:o,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){const t=this,s=this.json,i=this.extensions,r=s.meshes[e],a=r.primitives,o=[];for(let e=0,t=a.length;e<t;e++){const t=void 0===a[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new A({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Q})),l.DefaultMaterial):this.getDependency("material",a[e].material);o.push(t)}var l;return o.push(t.loadGeometries(a)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),l=s[s.length-1],h=[];for(let s=0,c=l.length;s<c;s++){const c=l[s],u=a[s];let p;const d=o[s];if(u.mode===ir.TRIANGLES||u.mode===ir.TRIANGLE_STRIP||u.mode===ir.TRIANGLE_FAN||void 0===u.mode)p=!0===r.isSkinnedMesh?new et(c,d):new ne(c,d),!0===p.isSkinnedMesh&&p.normalizeSkinWeights(),u.mode===ir.TRIANGLE_STRIP?p.geometry=Zs(p.geometry,he):u.mode===ir.TRIANGLE_FAN&&(p.geometry=Zs(p.geometry,le));else if(u.mode===ir.LINES)p=new n(c,d);else if(u.mode===ir.LINE_STRIP)p=new J(c,d);else if(u.mode===ir.LINE_LOOP)p=new tt(c,d);else{if(u.mode!==ir.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);p=new st(c,d)}Object.keys(p.geometry.morphAttributes).length>0&&gr(p,r),p.name=t.createUniqueName(r.name||"mesh_"+e),fr(p,r),u.extensions&&mr(i,p,u),t.assignFinalMaterial(p),h.push(p)}for(let s=0,i=h.length;s<i;s++)t.associations.set(h[s],{meshes:e,primitives:s});if(1===h.length)return r.extensions&&mr(i,h[0],r),h[0];const c=new it;r.extensions&&mr(i,c,r),t.associations.set(c,{meshes:e});for(let e=0,t=h.length;e<t;e++)c.add(h[e]);return c}))}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(i)return"perspective"===s.type?t=new Se(ee.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===s.type&&(t=new nt(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),fr(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],s=[];for(let e=0,i=t.joints.length;e<i;e++)s.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then((function(e){const s=e.pop(),i=e,n=[],r=[];for(let e=0,a=i.length;e<a;e++){const a=i[e];if(a){n.push(a);const t=new te;null!==s&&t.fromArray(s.array,16*e),r.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new rt(n,r)}))}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],n=i.name?i.name:"animation_"+e,r=[],a=[],o=[],l=[],h=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],s=i.samplers[t.sampler],n=t.target,c=n.node,u=void 0!==i.parameters?i.parameters[s.input]:s.input,p=void 0!==i.parameters?i.parameters[s.output]:s.output;void 0!==n.node&&(r.push(this.getDependency("node",c)),a.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",p)),l.push(s),h.push(n))}return Promise.all([Promise.all(r),Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(h)]).then((function(e){const t=e[0],i=e[1],r=e[2],a=e[3],o=e[4],l=[];for(let e=0,n=t.length;e<n;e++){const n=t[e],h=i[e],c=r[e],u=a[e],p=o[e];if(void 0===n)continue;n.updateMatrix&&n.updateMatrix();const d=s._createAnimationTracks(n,h,c,u,p);if(d)for(let e=0;e<d.length;e++)l.push(d[e])}return new at(n,void 0,l)}))}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,s=this.json.nodes[e],i=t._loadNodeShallow(e),n=[],r=s.children||[];for(let e=0,s=r.length;e<s;e++)n.push(t.getDependency("node",r[e]));const a=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([i,Promise.all(n),a]).then((function(e){const t=e[0],s=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,xr)}));for(let e=0,i=s.length;e<i;e++)t.add(s[e]);return t}))}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const n=t.nodes[e],r=n.name?i.createUniqueName(n.name):"",a=[],o=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return o&&a.push(o),void 0!==n.camera&&a.push(i.getDependency("camera",n.camera).then((function(e){return i._getNodeRef(i.cameraCache,n.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){a.push(e)})),this.nodeCache[e]=Promise.all(a).then((function(t){let a;if(a=!0===n.isBone?new ot:t.length>1?new it:1===t.length?t[0]:new fe,a!==t[0])for(let e=0,s=t.length;e<s;e++)a.add(t[e]);if(n.name&&(a.userData.name=n.name,a.name=r),fr(a,n),n.extensions&&mr(s,a,n),void 0!==n.matrix){const e=new te;e.fromArray(n.matrix),a.applyMatrix4(e)}else void 0!==n.translation&&a.position.fromArray(n.translation),void 0!==n.rotation&&a.quaternion.fromArray(n.rotation),void 0!==n.scale&&a.scale.fromArray(n.scale);return i.associations.has(a)||i.associations.set(a,{}),i.associations.get(a).nodes=e,a})),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,n=new it;s.name&&(n.name=i.createUniqueName(s.name)),fr(n,s),s.extensions&&mr(t,n,s);const r=s.nodes||[],a=[];for(let e=0,t=r.length;e<t;e++)a.push(i.getDependency("node",r[e]));return Promise.all(a).then((function(e){for(let t=0,s=e.length;t<s;t++)n.add(e[t]);return i.associations=(e=>{const t=new Map;for(const[e,s]of i.associations)(e instanceof $e||e instanceof ht)&&t.set(e,s);return e.traverse((e=>{const s=i.associations.get(e);null!=s&&t.set(e,s)})),t})(n),n}))}_createAnimationTracks(e,t,s,i,n){const r=[],a=e.name?e.name:e.uuid,o=[];let l;switch(hr[n.path]===hr.weights?e.traverse((function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)})):o.push(a),hr[n.path]){case hr.weights:l=ut;break;case hr.rotation:l=pt;break;case hr.position:case hr.scale:l=ct;break;default:switch(s.itemSize){case 1:l=ut;break;case 2:case 3:default:l=ct}}const h=void 0!==i.interpolation?cr[i.interpolation]:Ie,c=this._getArrayFromAccessor(s);for(let e=0,s=o.length;e<s;e++){const s=new l(o[e]+"."+hr[n.path],t.array,c,h);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(s),r.push(s)}return r}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=wr(t.constructor),s=new Float32Array(t.length);for(let i=0,n=t.length;i<n;i++)s[i]=t[i]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof pt?sr:er)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Mr(e,t,s){const n=t.attributes,r=[];function a(t,i){return s.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const t in n){const s=lr[t]||t.toLowerCase();s in e.attributes||r.push(a(n[t],s))}if(void 0!==t.indices&&!e.index){const i=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(i)}return lt.workingColorSpace!==Ge&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${lt.workingColorSpace}" not supported.`),fr(e,t),function(e,t,s){const n=t.attributes,r=new ue;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],t=e.min,a=e.max;if(void 0===t||void 0===a)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new i(t[0],t[1],t[2]),new i(a[0],a[1],a[2])),e.normalized){const t=wr(nr[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const a=t.targets;if(void 0!==a){const e=new i,t=new i;for(let i=0,n=a.length;i<n;i++){const n=a[i];if(void 0!==n.POSITION){const i=s.json.accessors[n.POSITION],r=i.min,a=i.max;if(void 0!==r&&void 0!==a){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(a[2]))),i.normalized){const e=wr(nr[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const o=new dt;r.getCenter(o.center),o.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=o}(e,t,s),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,s){let i=!1,n=!1,r=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(i=!0),void 0!==s.NORMAL&&(n=!0),void 0!==s.COLOR_0&&(r=!0),i&&n&&r)break}if(!i&&!n&&!r)return Promise.resolve(e);const a=[],o=[],l=[];for(let h=0,c=t.length;h<c;h++){const c=t[h];if(i){const t=void 0!==c.POSITION?s.getDependency("accessor",c.POSITION):e.attributes.position;a.push(t)}if(n){const t=void 0!==c.NORMAL?s.getDependency("accessor",c.NORMAL):e.attributes.normal;o.push(t)}if(r){const t=void 0!==c.COLOR_0?s.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const s=t[0],a=t[1],o=t[2];return i&&(e.morphAttributes.position=s),n&&(e.morphAttributes.normal=a),r&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e}))}const Ar=new WeakMap;class Tr extends ge{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,i){const n=new ye(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,(e=>{this.parse(e,t,i)}),s,i)}parse(e,t,s){this.decodeDracoFile(e,t,null,null,g).catch(s)}decodeDracoFile(e,t,s,i,n=Ge){const r={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s,vertexColorSpace:n};return this.decodeGeometry(e,r).then(t)}decodeGeometry(e,t){const s=JSON.stringify(t);if(Ar.has(e)){const t=Ar.get(e);if(t.key===s)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const n=this.workerNextTaskID++,r=e.byteLength,a=this._getWorker(n,r).then((s=>(i=s,new Promise(((s,r)=>{i._callbacks[n]={resolve:s,reject:r},i.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return a.catch((()=>!0)).then((()=>{i&&n&&this._releaseTask(i,n)})),Ar.set(e,{key:s,promise:a}),a}_createGeometry(e){const t=new r;e.index&&t.setIndex(new a(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s],n=i.name,r=i.array,o=i.itemSize,l=new a(r,o);"color"===n&&(this._assignVertexColorSpace(l,i.vertexColorSpace),l.normalized=r instanceof Float32Array==!1),t.setAttribute(n,l)}return t}_assignVertexColorSpace(e,t){if(t!==g)return;const s=new v;for(let t=0,i=e.count;t<i;t++)s.fromBufferAttribute(e,t).convertSRGBToLinear(),e.setXYZ(t,s.r,s.g,s.b)}_loadLibrary(e,t){const s=new ye(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise(((t,i)=>{s.load(e,t,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const s=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const i=Sr.toString(),n=["/* draco decoder */",s,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([n]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const s=t.data;switch(s.type){case"decode":e._callbacks[s.id].resolve(s);break;case"error":e._callbacks[s.id].reject(s);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+s.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function Sr(){let e,t;function s(e,t,s,i,n,r){const a=r.num_components(),o=s.num_points()*a,l=o*n.BYTES_PER_ELEMENT,h=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,n),c=e._malloc(l);t.GetAttributeDataArrayForAllPoints(s,r,h,l,c);const u=new n(e.HEAPF32.buffer,c,o).slice();return e._free(c),{name:i,array:u,itemSize:a}}onmessage=function(i){const n=i.data;switch(n.type){case"init":e=n.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const i=n.buffer,r=n.taskConfig;t.then((e=>{const t=e.draco,a=new t.Decoder;try{const e=function(e,t,i,n){const r=n.attributeIDs,a=n.attributeTypes;let o,l;const h=t.GetEncodedGeometryType(i);if(h===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeArrayToMesh(i,i.byteLength,o);else{if(h!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeArrayToPointCloud(i,i.byteLength,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const i in r){const l=self[a[i]];let h,u;if(n.useUniqueIDs)u=r[i],h=t.GetAttributeByUniqueId(o,u);else{if(u=t.GetAttributeId(o,e[r[i]]),-1===u)continue;h=t.GetAttribute(o,u)}const p=s(e,t,o,i,l,h);"color"===i&&(p.vertexColorSpace=n.vertexColorSpace),c.attributes.push(p)}h===e.TRIANGULAR_MESH&&(c.index=function(e,t,s){const i=3*s.num_faces(),n=4*i,r=e._malloc(n);t.GetTrianglesUInt32Array(s,n,r);const a=new Uint32Array(e.HEAPF32.buffer,r,i).slice();return e._free(r),{array:a,itemSize:1}}(e,t,o));return e.destroy(o),c}(t,a,new Int8Array(i),r),o=e.attributes.map((e=>e.array.buffer));e.index&&o.push(e.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:e},o)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{t.destroy(a)}}))}}}
/*!
fflate - fast JavaScript compression/decompression
<https://101arrowz.github.io/fflate>
Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
version 0.6.9
*/var Rr=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))};try{URL.revokeObjectURL(Rr(""))}catch(e){Rr=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var kr=Uint8Array,Cr=Uint16Array,Ir=Uint32Array,Er=new kr([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Pr=new kr([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),_r=new kr([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Lr=function(e,t){for(var s=new Cr(31),i=0;i<31;++i)s[i]=t+=1<<e[i-1];var n=new Ir(s[30]);for(i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)n[r]=r-s[i]<<5|i;return[s,n]},Dr=Lr(Er,2),zr=Dr[0],Or=Dr[1];zr[28]=258,Or[258]=28;for(var Fr=Lr(Pr,0)[0],Nr=new Cr(32768),Br=0;Br<32768;++Br){var Ur=(43690&Br)>>>1|(21845&Br)<<1;Ur=(61680&(Ur=(52428&Ur)>>>2|(13107&Ur)<<2))>>>4|(3855&Ur)<<4,Nr[Br]=((65280&Ur)>>>8|(255&Ur)<<8)>>>1}var Vr=function(e,t,s){for(var i=e.length,n=0,r=new Cr(t);n<i;++n)++r[e[n]-1];var a,o=new Cr(t);for(n=0;n<t;++n)o[n]=o[n-1]+r[n-1]<<1;if(s){a=new Cr(1<<t);var l=15-t;for(n=0;n<i;++n)if(e[n])for(var h=n<<4|e[n],c=t-e[n],u=o[e[n]-1]++<<c,p=u|(1<<c)-1;u<=p;++u)a[Nr[u]>>>l]=h}else for(a=new Cr(i),n=0;n<i;++n)e[n]&&(a[n]=Nr[o[e[n]-1]++]>>>15-e[n]);return a},Hr=new kr(288);for(Br=0;Br<144;++Br)Hr[Br]=8;for(Br=144;Br<256;++Br)Hr[Br]=9;for(Br=256;Br<280;++Br)Hr[Br]=7;for(Br=280;Br<288;++Br)Hr[Br]=8;var jr=new kr(32);for(Br=0;Br<32;++Br)jr[Br]=5;var Gr=Vr(Hr,9,1),Wr=Vr(jr,5,1),qr=function(e){for(var t=e[0],s=1;s<e.length;++s)e[s]>t&&(t=e[s]);return t},Xr=function(e,t,s){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&s},Kr=function(e,t){var s=t/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&t)},Zr=function(e,t,s){var i=e.length;if(!i||s&&!s.l&&i<5)return t||new kr(0);var n=!t||s,r=!s||s.i;s||(s={}),t||(t=new kr(3*i));var a,o=function(e){var s=t.length;if(e>s){var i=new kr(Math.max(2*s,e));i.set(t),t=i}},l=s.f||0,h=s.p||0,c=s.b||0,u=s.l,p=s.d,d=s.m,m=s.n,f=8*i;do{if(!u){s.f=l=Xr(e,h,1);var g=Xr(e,h+1,3);if(h+=3,!g){var y=e[(C=((a=h)/8|0)+(7&a&&1)+4)-4]|e[C-3]<<8,v=C+y;if(v>i){if(r)throw"unexpected EOF";break}n&&o(c+y),t.set(e.subarray(C,v),c),s.b=c+=y,s.p=h=8*v;continue}if(1==g)u=Gr,p=Wr,d=9,m=5;else{if(2!=g)throw"invalid block type";var w=Xr(e,h,31)+257,x=Xr(e,h+10,15)+4,b=w+Xr(e,h+5,31)+1;h+=14;for(var M=new kr(b),A=new kr(19),T=0;T<x;++T)A[_r[T]]=Xr(e,h+3*T,7);h+=3*x;var S=qr(A),R=(1<<S)-1,k=Vr(A,S,1);for(T=0;T<b;){var C,I=k[Xr(e,h,R)];if(h+=15&I,(C=I>>>4)<16)M[T++]=C;else{var E=0,P=0;for(16==C?(P=3+Xr(e,h,3),h+=2,E=M[T-1]):17==C?(P=3+Xr(e,h,7),h+=3):18==C&&(P=11+Xr(e,h,127),h+=7);P--;)M[T++]=E}}var _=M.subarray(0,w),L=M.subarray(w);d=qr(_),m=qr(L),u=Vr(_,d,1),p=Vr(L,m,1)}if(h>f){if(r)throw"unexpected EOF";break}}n&&o(c+131072);for(var D=(1<<d)-1,z=(1<<m)-1,O=h;;O=h){var F=(E=u[Kr(e,h)&D])>>>4;if((h+=15&E)>f){if(r)throw"unexpected EOF";break}if(!E)throw"invalid length/literal";if(F<256)t[c++]=F;else{if(256==F){O=h,u=null;break}var N=F-254;if(F>264){var B=Er[T=F-257];N=Xr(e,h,(1<<B)-1)+zr[T],h+=B}var U=p[Kr(e,h)&z],V=U>>>4;if(!U)throw"invalid distance";h+=15&U;L=Fr[V];if(V>3){B=Pr[V];L+=Kr(e,h)&(1<<B)-1,h+=B}if(h>f){if(r)throw"unexpected EOF";break}n&&o(c+131072);for(var H=c+N;c<H;c+=4)t[c]=t[c-L],t[c+1]=t[c+1-L],t[c+2]=t[c+2-L],t[c+3]=t[c+3-L];c=H}}s.l=u,s.p=O,s.b=c,u&&(l=1,s.m=d,s.d=p,s.n=m)}while(!l);return c==t.length?t:function(e,t,s){(null==t||t<0)&&(t=0),(null==s||s>e.length)&&(s=e.length);var i=new(e instanceof Cr?Cr:e instanceof Ir?Ir:kr)(s-t);return i.set(e.subarray(t,s)),i}(t,0,c)},Yr=new kr(0);function Qr(e,t){return Zr((function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"}(e),e.subarray(2,-4)),t)}var Jr="undefined"!=typeof TextDecoder&&new TextDecoder;try{Jr.decode(Yr,{stream:!0}),1}catch(e){}function $r(e,t,s){const i=s.length-e-1;if(t>=s[i])return i-1;if(t<=s[e])return e;let n=e,r=i,a=Math.floor((n+r)/2);for(;t<s[a]||t>=s[a+1];)t<s[a]?r=a:n=a,a=Math.floor((n+r)/2);return a}function ea(e,t){let s=1;for(let t=2;t<=e;++t)s*=t;let i=1;for(let e=2;e<=t;++e)i*=e;for(let s=2;s<=e-t;++s)i*=s;return s/i}function ta(e,t,s,n,r){return function(e){const t=e.length,s=[],n=[];for(let r=0;r<t;++r){const t=e[r];s[r]=new i(t.x,t.y,t.z),n[r]=t.w}const r=[];for(let e=0;e<t;++e){const t=s[e].clone();for(let s=1;s<=e;++s)t.sub(r[e-s].clone().multiplyScalar(ea(e,s)*n[s]));r[e]=t.divideScalar(n[0])}return r}(function(e,t,s,i,n){const r=n<e?n:e,a=[],o=$r(e,i,t),l=function(e,t,s,i,n){const r=[];for(let e=0;e<=s;++e)r[e]=0;const a=[];for(let e=0;e<=i;++e)a[e]=r.slice(0);const o=[];for(let e=0;e<=s;++e)o[e]=r.slice(0);o[0][0]=1;const l=r.slice(0),h=r.slice(0);for(let i=1;i<=s;++i){l[i]=t-n[e+1-i],h[i]=n[e+i]-t;let s=0;for(let e=0;e<i;++e){const t=h[e+1],n=l[i-e];o[i][e]=t+n;const r=o[e][i-1]/o[i][e];o[e][i]=s+t*r,s=n*r}o[i][i]=s}for(let e=0;e<=s;++e)a[0][e]=o[e][s];for(let e=0;e<=s;++e){let t=0,n=1;const l=[];for(let e=0;e<=s;++e)l[e]=r.slice(0);l[0][0]=1;for(let r=1;r<=i;++r){let i=0;const h=e-r,c=s-r;e>=r&&(l[n][0]=l[t][0]/o[c+1][h],i=l[n][0]*o[h][c]);const u=e-1<=c?r-1:s-e;for(let e=h>=-1?1:-h;e<=u;++e)l[n][e]=(l[t][e]-l[t][e-1])/o[c+1][h+e],i+=l[n][e]*o[h+e][c];e<=c&&(l[n][r]=-l[t][r-1]/o[c+1][e],i+=l[n][r]*o[e][c]),a[r][e]=i;const p=t;t=n,n=p}}let c=s;for(let e=1;e<=i;++e){for(let t=0;t<=s;++t)a[e][t]*=c;c*=s-e}return a}(o,i,e,r,t),h=[];for(let e=0;e<s.length;++e){const t=s[e].clone(),i=t.w;t.x*=i,t.y*=i,t.z*=i,h[e]=t}for(let t=0;t<=r;++t){const s=h[o-e].clone().multiplyScalar(l[t][0]);for(let i=1;i<=e;++i)s.add(h[o-e+i].clone().multiplyScalar(l[t][i]));a[t]=s}for(let e=r+1;e<=n+1;++e)a[e]=new ft(0,0,0);return a}(e,t,s,n,r))}class sa extends gt{constructor(e,t,s,i,n){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=n||this.knots.length-1;for(let e=0;e<s.length;++e){const t=s[e];this.controlPoints[e]=new ft(t.x,t.y,t.z,t.w)}}getPoint(e,t=new i){const s=t,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=function(e,t,s,i){const n=$r(e,i,t),r=function(e,t,s,i){const n=[],r=[],a=[];n[0]=1;for(let o=1;o<=s;++o){r[o]=t-i[e+1-o],a[o]=i[e+o]-t;let s=0;for(let e=0;e<o;++e){const t=a[e+1],i=r[o-e],l=n[e]/(t+i);n[e]=s+t*l,s=i*l}n[o]=s}return n}(n,i,e,t),a=new ft(0,0,0,0);for(let t=0;t<=e;++t){const i=s[n-e+t],o=r[t],l=i.w*o;a.x+=i.x*l,a.y+=i.y*l,a.z+=i.z*l,a.w+=i.w*o}return a}(this.degree,this.knots,this.controlPoints,n);return 1!==r.w&&r.divideScalar(r.w),s.set(r.x,r.y,r.z)}getTangent(e,t=new i){const s=t,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=ta(this.degree,this.knots,this.controlPoints,n,1);return s.copy(r[1]).normalize(),s}}let ia,na,ra;class aa extends ge{constructor(e){super(e)}load(e,t,s,i){const n=this,r=""===n.path?je.extractUrlBase(e):n.path,a=new ye(this.manager);a.setPath(n.path),a.setResponseType("arraybuffer"),a.setRequestHeader(n.requestHeader),a.setWithCredentials(n.withCredentials),a.load(e,(function(s){try{t(n.parse(s,r))}catch(t){i?i(t):console.error(t),n.manager.itemError(e)}}),s,i)}parse(e,t){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===Aa(e,0,t.length)}(e))ia=(new ua).parse(e);else{const t=Aa(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let s=0;function i(t){const i=e[t-1];return e=e.slice(s+t),s++,i}for(let e=0;e<t.length;++e){if(i(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(ma(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+ma(t));ia=(new ca).parse(t)}const s=new Ke(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new oa(s,this.manager).parse(ia)}}class oa{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){na=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),s=this.parseMaterials(t),i=this.parseDeformers(),n=(new la).parse(i);return this.parseScene(i,n,s),ra}parseConnections(){const e=new Map;if("Connections"in ia){ia.Connections.connections.forEach((function(t){const s=t[0],i=t[1],n=t[2];e.has(s)||e.set(s,{parents:[],children:[]});const r={ID:i,relationship:n};e.get(s).parents.push(r),e.has(i)||e.set(i,{parents:[],children:[]});const a={ID:s,relationship:n};e.get(i).children.push(a)}))}return e}parseImages(){const e={},t={};if("Video"in ia.Objects){const s=ia.Objects.Video;for(const i in s){const n=s[i];if(e[parseInt(i)]=n.RelativeFilename||n.Filename,"Content"in n){const e=n.Content instanceof ArrayBuffer&&n.Content.byteLength>0,r="string"==typeof n.Content&&""!==n.Content;if(e||r){const e=this.parseImage(s[i]);t[n.RelativeFilename||n.Filename]=e}}}}for(const s in e){const i=e[s];void 0!==t[i]?e[s]=t[i]:e[s]=e[s].split("\\").pop()}return e}parseImage(e){const t=e.Content,s=e.RelativeFilename||e.Filename,i=s.slice(s.lastIndexOf(".")+1).toLowerCase();let n;switch(i){case"bmp":n="image/bmp";break;case"jpg":case"jpeg":n="image/jpeg";break;case"png":n="image/png";break;case"tif":n="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",s),n="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+i+'" is not supported.')}if("string"==typeof t)return"data:"+n+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:n}))}}parseTextures(e){const t=new Map;if("Texture"in ia.Objects){const s=ia.Objects.Texture;for(const i in s){const n=this.parseTexture(s[i],e);t.set(parseInt(i),n)}}return t}parseTexture(e,t){const s=this.loadTexture(e,t);s.ID=e.id,s.name=e.attrName;const i=e.WrapModeU,n=e.WrapModeV,r=void 0!==i?i.value:0,a=void 0!==n?n.value:0;if(s.wrapS=0===r?f:Ve,s.wrapT=0===a?f:Ve,"Scaling"in e){const t=e.Scaling.value;s.repeat.x=t[0],s.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;s.offset.x=t[0],s.offset.y=t[1]}return s}loadTexture(e,t){let s;const i=this.textureLoader.path,n=na.get(e.id).children;let r;void 0!==n&&n.length>0&&void 0!==t[n[0].ID]&&(s=t[n[0].ID],0!==s.indexOf("blob:")&&0!==s.indexOf("data:")||this.textureLoader.setPath(void 0));const a=e.FileName.slice(-3).toLowerCase();if("tga"===a){const t=this.manager.getHandler(".tga");null===t?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),r=new ht):(t.setPath(this.textureLoader.path),r=t.load(s))}else"psd"===a?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),r=new ht):r=this.textureLoader.load(s);return this.textureLoader.setPath(i),r}parseMaterials(e){const t=new Map;if("Material"in ia.Objects){const s=ia.Objects.Material;for(const i in s){const n=this.parseMaterial(s[i],e);null!==n&&t.set(parseInt(i),n)}}return t}parseMaterial(e,t){const s=e.id,i=e.attrName;let n=e.ShadingModel;if("object"==typeof n&&(n=n.value),!na.has(s))return null;const r=this.parseParameters(e,t,s);let a;switch(n.toLowerCase()){case"phong":a=new C;break;case"lambert":a=new k;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',n),a=new C}return a.setValues(r),a.name=i,a}parseParameters(e,t,s){const i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=(new v).fromArray(e.Diffuse.value).convertSRGBToLinear():!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(i.color=(new v).fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=(new v).fromArray(e.Emissive.value).convertSRGBToLinear():!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(i.emissive=(new v).fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=(new v).fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new v).fromArray(e.SpecularColor.value).convertSRGBToLinear());const n=this;return na.get(s).children.forEach((function(e){const s=e.relationship;switch(s){case"Bump":i.bumpMap=n.getTexture(t,e.ID);break;case"Maya|TEX_ao_map":i.aoMap=n.getTexture(t,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=n.getTexture(t,e.ID),void 0!==i.map&&(i.map.colorSpace=g);break;case"DisplacementColor":i.displacementMap=n.getTexture(t,e.ID);break;case"EmissiveColor":i.emissiveMap=n.getTexture(t,e.ID),void 0!==i.emissiveMap&&(i.emissiveMap.colorSpace=g);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=n.getTexture(t,e.ID);break;case"ReflectionColor":i.envMap=n.getTexture(t,e.ID),void 0!==i.envMap&&(i.envMap.mapping=yt,i.envMap.colorSpace=g);break;case"SpecularColor":i.specularMap=n.getTexture(t,e.ID),void 0!==i.specularMap&&(i.specularMap.colorSpace=g);break;case"TransparentColor":case"TransparencyFactor":i.alphaMap=n.getTexture(t,e.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",s)}})),i}getTexture(e,t){return"LayeredTexture"in ia.Objects&&t in ia.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=na.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in ia.Objects){const s=ia.Objects.Deformer;for(const i in s){const n=s[i],r=na.get(parseInt(i));if("Skin"===n.attrType){const t=this.parseSkeleton(r,s);t.ID=i,r.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=r.parents[0].ID,e[i]=t}else if("BlendShape"===n.attrType){const e={id:i};e.rawTargets=this.parseMorphTargets(r,s),e.id=i,r.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[i]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const s=[];return e.children.forEach((function(e){const i=t[e.ID];if("Cluster"!==i.attrType)return;const n={ID:e.ID,indices:[],weights:[],transformLink:(new te).fromArray(i.TransformLink.a)};"Indexes"in i&&(n.indices=i.Indexes.a,n.weights=i.Weights.a),s.push(n)})),{rawBones:s,bones:[]}}parseMorphTargets(e,t){const s=[];for(let i=0;i<e.children.length;i++){const n=e.children[i],r=t[n.ID],a={name:r.attrName,initialWeight:r.DeformPercent,id:r.id,fullWeights:r.FullWeights.a};if("BlendShapeChannel"!==r.attrType)return;a.geoID=na.get(parseInt(n.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,s.push(a)}return s}parseScene(e,t,s){ra=new it;const i=this.parseModels(e.skeletons,t,s),n=ia.Objects.Model,r=this;i.forEach((function(e){const t=n[e.ID];r.setLookAtProperties(e,t);na.get(e.ID).parents.forEach((function(t){const s=i.get(t.ID);void 0!==s&&s.add(e)})),null===e.parent&&ra.add(e)})),this.bindSkeleton(e.skeletons,t,i),this.createAmbientLight(),ra.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=xa(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const a=(new ha).parse();1===ra.children.length&&ra.children[0].isGroup&&(ra.children[0].animations=a,ra=ra.children[0]),ra.animations=a}parseModels(e,t,s){const i=new Map,n=ia.Objects.Model;for(const r in n){const a=parseInt(r),o=n[r],l=na.get(a);let h=this.buildSkeleton(l,e,a,o.attrName);if(!h){switch(o.attrType){case"Camera":h=this.createCamera(l);break;case"Light":h=this.createLight(l);break;case"Mesh":h=this.createMesh(l,t,s);break;case"NurbsCurve":h=this.createCurve(l,t);break;case"LimbNode":case"Root":h=new ot;break;case"Null":default:h=new it}h.name=o.attrName?Ce.sanitizeNodeName(o.attrName):"",h.ID=a}this.getTransformData(h,o),i.set(a,h)}return i}buildSkeleton(e,t,s,i){let n=null;return e.parents.forEach((function(e){for(const r in t){const a=t[r];a.rawBones.forEach((function(t,r){if(t.ID===e.ID){const e=n;n=new ot,n.matrixWorld.copy(t.transformLink),n.name=i?Ce.sanitizeNodeName(i):"",n.ID=s,a.bones[r]=n,null!==e&&n.add(e)}}))}})),n}createCamera(e){let t,s;if(e.children.forEach((function(e){const t=ia.Objects.NodeAttribute[e.ID];void 0!==t&&(s=t)})),void 0===s)t=new fe;else{let e=0;void 0!==s.CameraProjectionType&&1===s.CameraProjectionType.value&&(e=1);let i=1;void 0!==s.NearPlane&&(i=s.NearPlane.value/1e3);let n=1e3;void 0!==s.FarPlane&&(n=s.FarPlane.value/1e3);let r=window.innerWidth,a=window.innerHeight;void 0!==s.AspectWidth&&void 0!==s.AspectHeight&&(r=s.AspectWidth.value,a=s.AspectHeight.value);const o=r/a;let l=45;void 0!==s.FieldOfView&&(l=s.FieldOfView.value);const h=s.FocalLength?s.FocalLength.value:null;switch(e){case 0:t=new Se(l,o,i,n),null!==h&&t.setFocalLength(h);break;case 1:t=new nt(-r/2,r/2,a/2,-a/2,i,n);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),t=new fe}}return t}createLight(e){let t,s;if(e.children.forEach((function(e){const t=ia.Objects.NodeAttribute[e.ID];void 0!==t&&(s=t)})),void 0===s)t=new fe;else{let e;e=void 0===s.LightType?0:s.LightType.value;let i=16777215;void 0!==s.Color&&(i=(new v).fromArray(s.Color.value).convertSRGBToLinear());let n=void 0===s.Intensity?1:s.Intensity.value/100;void 0!==s.CastLightOnObject&&0===s.CastLightOnObject.value&&(n=0);let r=0;void 0!==s.FarAttenuationEnd&&(r=void 0!==s.EnableFarAttenuation&&0===s.EnableFarAttenuation.value?0:s.FarAttenuationEnd.value);const a=1;switch(e){case 0:t=new qe(i,n,r,a);break;case 1:t=new Xe(i,n);break;case 2:let e=Math.PI/3;void 0!==s.InnerAngle&&(e=ee.degToRad(s.InnerAngle.value));let o=0;void 0!==s.OuterAngle&&(o=ee.degToRad(s.OuterAngle.value),o=Math.max(o,1)),t=new We(i,n,r,e,o,a);break;default:console.warn("THREE.FBXLoader: Unknown light type "+s.LightType.value+", defaulting to a PointLight."),t=new qe(i,n)}void 0!==s.CastShadows&&1===s.CastShadows.value&&(t.castShadow=!0)}return t}createMesh(e,t,s){let i,n=null,r=null;const a=[];return e.children.forEach((function(e){t.has(e.ID)&&(n=t.get(e.ID)),s.has(e.ID)&&a.push(s.get(e.ID))})),a.length>1?r=a:a.length>0?r=a[0]:(r=new C({name:ge.DEFAULT_MATERIAL_NAME,color:13421772}),a.push(r)),"color"in n.attributes&&a.forEach((function(e){e.vertexColors=!0})),n.FBX_Deformer?(i=new et(n,r),i.normalizeSkinWeights()):i=new ne(n,r),i}createCurve(e,t){const s=e.children.reduce((function(e,s){return t.has(s.ID)&&(e=t.get(s.ID)),e}),null),i=new l({name:ge.DEFAULT_MATERIAL_NAME,color:3342591,linewidth:1});return new J(s,i)}getTransformData(e,t){const s={};"InheritType"in t&&(s.inheritType=parseInt(t.InheritType.value)),s.eulerOrder="RotationOrder"in t?ba(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(s.translation=t.Lcl_Translation.value),"PreRotation"in t&&(s.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(s.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(s.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(s.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(s.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(s.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(s.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(s.rotationPivot=t.RotationPivot.value),e.userData.transformData=s}setLookAtProperties(e,t){if("LookAtProperty"in t){na.get(e.ID).children.forEach((function(t){if("LookAtProperty"===t.relationship){const s=ia.Objects.Model[t.ID];if("Lcl_Translation"in s){const t=s.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(t),ra.add(e.target)):e.lookAt((new i).fromArray(t))}}}))}}bindSkeleton(e,t,s){const i=this.parsePoseNodes();for(const n in e){const r=e[n];na.get(parseInt(r.ID)).parents.forEach((function(e){if(t.has(e.ID)){const t=e.ID;na.get(t).parents.forEach((function(e){if(s.has(e.ID)){s.get(e.ID).bind(new rt(r.bones),i[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in ia.Objects){const t=ia.Objects.Pose;for(const s in t)if("BindPose"===t[s].attrType&&t[s].NbPoseNodes>0){const i=t[s].PoseNode;Array.isArray(i)?i.forEach((function(t){e[t.Node]=(new te).fromArray(t.Matrix.a)})):e[i.Node]=(new te).fromArray(i.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in ia&&"AmbientColor"in ia.GlobalSettings){const e=ia.GlobalSettings.AmbientColor.value,t=e[0],s=e[1],i=e[2];if(0!==t||0!==s||0!==i){const e=new v(t,s,i).convertSRGBToLinear();ra.add(new vt(e,1))}}}}class la{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in ia.Objects){const s=ia.Objects.Geometry;for(const i in s){const n=na.get(parseInt(i)),r=this.parseGeometry(n,s[i],e);t.set(parseInt(i),r)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,s){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,s);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,s){const i=s.skeletons,n=[],r=e.parents.map((function(e){return ia.Objects.Model[e.ID]}));if(0===r.length)return;const a=e.children.reduce((function(e,t){return void 0!==i[t.ID]&&(e=i[t.ID]),e}),null);e.children.forEach((function(e){void 0!==s.morphTargets[e.ID]&&n.push(s.morphTargets[e.ID])}));const o=r[0],l={};"RotationOrder"in o&&(l.eulerOrder=ba(o.RotationOrder.value)),"InheritType"in o&&(l.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(l.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(l.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(l.scale=o.GeometricScaling.value);const h=xa(l);return this.genGeometry(t,a,n,h)}genGeometry(e,t,i,n){const a=new r;e.attrName&&(a.name=e.attrName);const l=this.parseGeoNode(e,t),h=this.genBuffers(l),c=new o(h.vertex,3);if(c.applyMatrix4(n),a.setAttribute("position",c),h.colors.length>0&&a.setAttribute("color",new o(h.colors,3)),t&&(a.setAttribute("skinIndex",new wt(h.weightsIndices,4)),a.setAttribute("skinWeight",new o(h.vertexWeights,4)),a.FBX_Deformer=t),h.normal.length>0){const e=(new s).getNormalMatrix(n),t=new o(h.normal,3);t.applyNormalMatrix(e),a.setAttribute("normal",t)}if(h.uvs.forEach((function(e,t){const s=0===t?"uv":`uv${t}`;a.setAttribute(s,new o(h.uvs[t],2))})),l.material&&"AllSame"!==l.material.mappingType){let e=h.materialIndex[0],t=0;if(h.materialIndex.forEach((function(s,i){s!==e&&(a.addGroup(t,i-t,e),e=s,t=i)})),a.groups.length>0){const t=a.groups[a.groups.length-1],s=t.start+t.count;s!==h.materialIndex.length&&a.addGroup(s,h.materialIndex.length-s,e)}0===a.groups.length&&a.addGroup(0,h.materialIndex.length,h.materialIndex[0])}return this.addMorphTargets(a,e,i,n),a}parseGeoNode(e,t){const s={};if(s.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],s.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(s.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(s.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(s.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){s.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&s.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return s.weightTable={},null!==t&&(s.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(i,n){void 0===s.weightTable[i]&&(s.weightTable[i]=[]),s.weightTable[i].push({id:t,weight:e.weights[n]})}))}))),s}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let s=0,i=0,n=!1,r=[],a=[],o=[],l=[],h=[],c=[];const u=this;return e.vertexIndices.forEach((function(p,d){let m,f=!1;p<0&&(p^=-1,f=!0);let g=[],y=[];if(r.push(3*p,3*p+1,3*p+2),e.color){const t=ya(d,s,p,e.color);o.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[p]&&e.weightTable[p].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){n||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),n=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(s,i){let n=s,r=g[i];t.forEach((function(t,s,i){if(n>t){i[s]=n,n=t;const a=e[s];e[s]=r,r=a}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)h.push(y[e]),c.push(g[e])}if(e.normal){const t=ya(d,s,p,e.normal);a.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=ya(d,s,p,e.material)[0],m<0&&(u.negativeMaterialIndices=!0,m=0)),e.uv&&e.uv.forEach((function(e,t){const i=ya(d,s,p,e);void 0===l[t]&&(l[t]=[]),l[t].push(i[0]),l[t].push(i[1])})),i++,f&&(i>4&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),u.genFace(t,e,r,m,a,o,l,h,c,i),s++,i=0,r=[],a=[],o=[],l=[],h=[],c=[])})),t}genFace(e,t,s,i,n,r,a,o,l,h){for(let c=2;c<h;c++)e.vertex.push(t.vertexPositions[s[0]]),e.vertex.push(t.vertexPositions[s[1]]),e.vertex.push(t.vertexPositions[s[2]]),e.vertex.push(t.vertexPositions[s[3*(c-1)]]),e.vertex.push(t.vertexPositions[s[3*(c-1)+1]]),e.vertex.push(t.vertexPositions[s[3*(c-1)+2]]),e.vertex.push(t.vertexPositions[s[3*c]]),e.vertex.push(t.vertexPositions[s[3*c+1]]),e.vertex.push(t.vertexPositions[s[3*c+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[4*(c-1)]),e.vertexWeights.push(o[4*(c-1)+1]),e.vertexWeights.push(o[4*(c-1)+2]),e.vertexWeights.push(o[4*(c-1)+3]),e.vertexWeights.push(o[4*c]),e.vertexWeights.push(o[4*c+1]),e.vertexWeights.push(o[4*c+2]),e.vertexWeights.push(o[4*c+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(c-1)]),e.weightsIndices.push(l[4*(c-1)+1]),e.weightsIndices.push(l[4*(c-1)+2]),e.weightsIndices.push(l[4*(c-1)+3]),e.weightsIndices.push(l[4*c]),e.weightsIndices.push(l[4*c+1]),e.weightsIndices.push(l[4*c+2]),e.weightsIndices.push(l[4*c+3])),t.color&&(e.colors.push(r[0]),e.colors.push(r[1]),e.colors.push(r[2]),e.colors.push(r[3*(c-1)]),e.colors.push(r[3*(c-1)+1]),e.colors.push(r[3*(c-1)+2]),e.colors.push(r[3*c]),e.colors.push(r[3*c+1]),e.colors.push(r[3*c+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(i),e.materialIndex.push(i),e.materialIndex.push(i)),t.normal&&(e.normal.push(n[0]),e.normal.push(n[1]),e.normal.push(n[2]),e.normal.push(n[3*(c-1)]),e.normal.push(n[3*(c-1)+1]),e.normal.push(n[3*(c-1)+2]),e.normal.push(n[3*c]),e.normal.push(n[3*c+1]),e.normal.push(n[3*c+2])),t.uv&&t.uv.forEach((function(t,s){void 0===e.uvs[s]&&(e.uvs[s]=[]),e.uvs[s].push(a[s][0]),e.uvs[s].push(a[s][1]),e.uvs[s].push(a[s][2*(c-1)]),e.uvs[s].push(a[s][2*(c-1)+1]),e.uvs[s].push(a[s][2*c]),e.uvs[s].push(a[s][2*c+1])}))}addMorphTargets(e,t,s,i){if(0===s.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const n=this;s.forEach((function(s){s.rawTargets.forEach((function(s){const r=ia.Objects.Geometry[s.geoID];void 0!==r&&n.genMorphGeometry(e,t,r,i,s.name)}))}))}genMorphGeometry(e,t,s,i,n){const r=void 0!==t.PolygonVertexIndex?t.PolygonVertexIndex.a:[],a=void 0!==s.Vertices?s.Vertices.a:[],l=void 0!==s.Indexes?s.Indexes.a:[],h=3*e.attributes.position.count,c=new Float32Array(h);for(let e=0;e<l.length;e++){const t=3*l[e];c[t]=a[3*e],c[t+1]=a[3*e+1],c[t+2]=a[3*e+2]}const u={vertexIndices:r,vertexPositions:c},p=this.genBuffers(u),d=new o(p.vertex,3);d.name=n||s.attrName,d.applyMatrix4(i),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,i=e.Normals.a;let n=[];return"IndexToDirect"===s&&("NormalIndex"in e?n=e.NormalIndex.a:"NormalsIndex"in e&&(n=e.NormalsIndex.a)),{dataSize:3,buffer:i,indices:n,mappingType:t,referenceType:s}}parseUVs(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,i=e.UV.a;let n=[];return"IndexToDirect"===s&&(n=e.UVIndex.a),{dataSize:2,buffer:i,indices:n,mappingType:t,referenceType:s}}parseVertexColors(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,i=e.Colors.a;let n=[];"IndexToDirect"===s&&(n=e.ColorIndex.a);for(let e=0,t=new v;e<i.length;e+=4)t.fromArray(i,e).convertSRGBToLinear().toArray(i,e);return{dataSize:4,buffer:i,indices:n,mappingType:t,referenceType:s}}parseMaterialIndices(e){const t=e.MappingInformationType,s=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:s};const i=e.Materials.a,n=[];for(let e=0;e<i.length;++e)n.push(e);return{dataSize:1,buffer:i,indices:n,mappingType:t,referenceType:s}}parseNurbsGeometry(e){const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new r;const s=t-1,i=e.KnotVector.a,n=[],a=e.Points.a;for(let e=0,t=a.length;e<t;e+=4)n.push((new ft).fromArray(a,e));let o,l;if("Closed"===e.Form)n.push(n[0]);else if("Periodic"===e.Form){o=s,l=i.length-1-o;for(let e=0;e<s;++e)n.push(n[e])}const h=new sa(s,i,n,o,l).getPoints(12*n.length);return(new r).setFromPoints(h)}}class ha{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const s in t){const i=t[s],n=this.addClip(i);e.push(n)}return e}parseClips(){if(void 0===ia.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=ia.Objects.AnimationCurveNode,t=new Map;for(const s in e){const i=e[s];if(null!==i.attrName.match(/S|R|T|DeformPercent/)){const e={id:i.id,attr:i.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=ia.Objects.AnimationCurve;for(const s in t){const i={id:t[s].id,times:t[s].KeyTime.a.map(fa),values:t[s].KeyValueFloat.a},n=na.get(i.id);if(void 0!==n){const t=n.parents[0].ID,s=n.parents[0].relationship;s.match(/X/)?e.get(t).curves.x=i:s.match(/Y/)?e.get(t).curves.y=i:s.match(/Z/)?e.get(t).curves.z=i:s.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=i)}}}parseAnimationLayers(e){const t=ia.Objects.AnimationLayer,s=new Map;for(const i in t){const t=[],n=na.get(parseInt(i));if(void 0!==n){n.children.forEach((function(s,i){if(e.has(s.ID)){const n=e.get(s.ID);if(void 0!==n.curves.x||void 0!==n.curves.y||void 0!==n.curves.z){if(void 0===t[i]){const e=na.get(s.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const n=ia.Objects.Model[e.toString()];if(void 0===n)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",s);const r={modelName:n.attrName?Ce.sanitizeNodeName(n.attrName):"",ID:n.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};ra.traverse((function(e){e.ID===n.id&&(r.transform=e.matrix,e.userData.transformData&&(r.eulerOrder=e.userData.transformData.eulerOrder))})),r.transform||(r.transform=new te),"PreRotation"in n&&(r.preRotation=n.PreRotation.value),"PostRotation"in n&&(r.postRotation=n.PostRotation.value),t[i]=r}}t[i]&&(t[i][n.attr]=n)}else if(void 0!==n.curves.morph){if(void 0===t[i]){const e=na.get(s.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,n=na.get(e).parents[0].ID,r=na.get(n).parents[0].ID,a=na.get(r).parents[0].ID,o=ia.Objects.Model[a],l={modelName:o.attrName?Ce.sanitizeNodeName(o.attrName):"",morphName:ia.Objects.Deformer[e].attrName};t[i]=l}t[i][n.attr]=n}}})),s.set(parseInt(i),t)}}return s}parseAnimStacks(e){const t=ia.Objects.AnimationStack,s={};for(const i in t){const n=na.get(parseInt(i)).children;n.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const r=e.get(n[0].ID);s[i]={name:t[i].attrName,layer:r}}return s}addClip(e){let t=[];const s=this;return e.layer.forEach((function(e){t=t.concat(s.generateTracks(e))})),new at(e.name,-1,t)}generateTracks(e){const s=[];let n=new i,r=new t,a=new i;if(e.transform&&e.transform.decompose(n,r,a),n=n.toArray(),r=(new se).setFromQuaternion(r,e.eulerOrder).toArray(),a=a.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.T.curves,n,"position");void 0!==t&&s.push(t)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const t=this.generateRotationTrack(e.modelName,e.R.curves,r,e.preRotation,e.postRotation,e.eulerOrder);void 0!==t&&s.push(t)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.S.curves,a,"scale");void 0!==t&&s.push(t)}if(void 0!==e.DeformPercent){const t=this.generateMorphTrack(e);void 0!==t&&s.push(t)}return s}generateVectorTrack(e,t,s,i){const n=this.getTimesForAllAxes(t),r=this.getKeyframeTrackValues(n,t,s);return new ct(e+"."+i,n,r)}generateRotationTrack(e,s,i,n,r,a){void 0!==s.x&&(this.interpolateRotations(s.x),s.x.values=s.x.values.map(ee.degToRad)),void 0!==s.y&&(this.interpolateRotations(s.y),s.y.values=s.y.values.map(ee.degToRad)),void 0!==s.z&&(this.interpolateRotations(s.z),s.z.values=s.z.values.map(ee.degToRad));const o=this.getTimesForAllAxes(s),l=this.getKeyframeTrackValues(o,s,i);void 0!==n&&((n=n.map(ee.degToRad)).push(a),n=(new se).fromArray(n),n=(new t).setFromEuler(n)),void 0!==r&&((r=r.map(ee.degToRad)).push(a),r=(new se).fromArray(r),r=(new t).setFromEuler(r).invert());const h=new t,c=new se,u=[];for(let e=0;e<l.length;e+=3)c.set(l[e],l[e+1],l[e+2],a),h.setFromEuler(c),void 0!==n&&h.premultiply(n),void 0!==r&&h.multiply(r),h.toArray(u,e/3*4);return new pt(e+".quaternion",o,u)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,s=t.values.map((function(e){return e/100})),i=ra.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new ut(e.modelName+".morphTargetInfluences["+i+"]",t.times,s)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,s=t[0];for(let i=1;i<t.length;i++){const n=t[i];n!==s&&(t[e]=n,s=n,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,s){const i=s,n=[];let r=-1,a=-1,o=-1;return e.forEach((function(e){if(t.x&&(r=t.x.times.indexOf(e)),t.y&&(a=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==r){const e=t.x.values[r];n.push(e),i[0]=e}else n.push(i[0]);if(-1!==a){const e=t.y.values[a];n.push(e),i[1]=e}else n.push(i[1]);if(-1!==o){const e=t.z.values[o];n.push(e),i[2]=e}else n.push(i[2])})),n}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const s=e.values[t-1],i=e.values[t]-s,n=Math.abs(i);if(n>=180){const r=n/180,a=i/r;let o=s+a;const l=e.times[t-1],h=(e.times[t]-l)/r;let c=l+h;const u=[],p=[];for(;c<e.times[t];)u.push(c),c+=h,p.push(o),o+=a;e.times=Ta(e.times,t,u),e.values=Ta(e.values,t,p)}}}}class ca{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new da,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,s=e.split(/[\r\n]+/);return s.forEach((function(e,i){const n=e.match(/^[\s\t]*;/),r=e.match(/^[\s\t]*$/);if(n||r)return;const a=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");a?t.parseNodeBegin(e,a):o?t.parseNodeProperty(e,o,s[++i]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const s=t[1].trim().replace(/^"/,"").replace(/"$/,""),i=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),n={name:s},r=this.parseNodeAttr(i),a=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(s,n):s in a?("PoseNode"===s?a.PoseNode.push(n):void 0!==a[s].id&&(a[s]={},a[s][a[s].id]=a[s]),""!==r.id&&(a[s][r.id]=n)):"number"==typeof r.id?(a[s]={},a[s][r.id]=n):"Properties70"!==s&&(a[s]="PoseNode"===s?[n]:n),"number"==typeof r.id&&(n.id=r.id),""!==r.name&&(n.attrName=r.name),""!==r.type&&(n.attrType=r.type),this.pushStack(n)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let s="",i="";return e.length>1&&(s=e[1].replace(/^(\w+)::/,""),i=e[2]),{id:t,name:s,type:i}}parseNodeProperty(e,t,s){let i=t[1].replace(/^"/,"").replace(/"$/,"").trim(),n=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===i&&","===n&&(n=s.replace(/"/g,"").replace(/,$/,"").trim());const r=this.getCurrentNode();if("Properties70"!==r.name){if("C"===i){const e=n.split(",").slice(1),t=parseInt(e[0]),s=parseInt(e[1]);let a=n.split(",").slice(3);a=a.map((function(e){return e.trim().replace(/^"/,"")})),i="connections",n=[t,s],function(e,t){for(let s=0,i=e.length,n=t.length;s<n;s++,i++)e[i]=t[s]}(n,a),void 0===r[i]&&(r[i]=[])}"Node"===i&&(r.id=n),i in r&&Array.isArray(r[i])?r[i].push(n):"a"!==i?r[i]=n:r.a=n,this.setCurrentProp(r,i),"a"===i&&","!==n.slice(-1)&&(r.a=Ma(n))}else this.parseNodeSpecialProperty(e,i,n)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=Ma(t.a))}parseNodeSpecialProperty(e,t,s){const i=s.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),n=i[0],r=i[1],a=i[2],o=i[3];let l=i[4];switch(r){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=Ma(l)}this.getPrevNode()[n]={type:r,type2:a,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),n)}}class ua{parse(e){const t=new pa(e);t.skip(23);const s=t.getUint32();if(s<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+s);const i=new da;for(;!this.endOfContent(t);){const e=this.parseNode(t,s);null!==e&&i.add(e.name,e)}return i}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const s={},i=t>=7500?e.getUint64():e.getUint32(),n=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const r=e.getUint8(),a=e.getString(r);if(0===i)return null;const o=[];for(let t=0;t<n;t++)o.push(this.parseProperty(e));const l=o.length>0?o[0]:"",h=o.length>1?o[1]:"",c=o.length>2?o[2]:"";for(s.singleProperty=1===n&&e.getOffset()===i;i>e.getOffset();){const i=this.parseNode(e,t);null!==i&&this.parseSubNode(a,s,i)}return s.propertyList=o,"number"==typeof l&&(s.id=l),""!==h&&(s.attrName=h),""!==c&&(s.attrType=c),""!==a&&(s.name=a),s}parseSubNode(e,t,s){if(!0===s.singleProperty){const e=s.propertyList[0];Array.isArray(e)?(t[s.name]=s,s.a=e):t[s.name]=e}else if("Connections"===e&&"C"===s.name){const e=[];s.propertyList.forEach((function(t,s){0!==s&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===s.name){Object.keys(s).forEach((function(e){t[e]=s[e]}))}else if("Properties70"===e&&"P"===s.name){let e=s.propertyList[0],i=s.propertyList[1];const n=s.propertyList[2],r=s.propertyList[3];let a;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===i.indexOf("Lcl ")&&(i=i.replace("Lcl ","Lcl_")),a="Color"===i||"ColorRGB"===i||"Vector"===i||"Vector3D"===i||0===i.indexOf("Lcl_")?[s.propertyList[4],s.propertyList[5],s.propertyList[6]]:s.propertyList[4],t[e]={type:i,type2:n,flag:r,value:a}}else void 0===t[s.name]?"number"==typeof s.id?(t[s.name]={},t[s.name][s.id]=s):t[s.name]=s:"PoseNode"===s.name?(Array.isArray(t[s.name])||(t[s.name]=[t[s.name]]),t[s.name].push(s)):void 0===t[s.name][s.id]&&(t[s.name][s.id]=s)}parseProperty(e){const t=e.getString(1);let s;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return s=e.getUint32(),e.getArrayBuffer(s);case"S":return s=e.getUint32(),e.getString(s);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const i=e.getUint32(),n=e.getUint32(),r=e.getUint32();if(0===n)switch(t){case"b":case"c":return e.getBooleanArray(i);case"d":return e.getFloat64Array(i);case"f":return e.getFloat32Array(i);case"i":return e.getInt32Array(i);case"l":return e.getInt64Array(i)}const a=Qr(new Uint8Array(e.getArrayBuffer(r))),o=new pa(a.buffer);switch(t){case"b":case"c":return o.getBooleanArray(i);case"d":return o.getFloat64Array(i);case"f":return o.getFloat32Array(i);case"i":return o.getInt32Array(i);case"l":return o.getInt64Array(i)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class pa{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let s=0;s<e;s++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let s=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const i=s.indexOf(0);return i>=0&&(s=new Uint8Array(this.dv.buffer,t,i)),this._textDecoder.decode(s)}}class da{add(e,t){this[e]=t}}function ma(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function fa(e){return e/46186158e3}const ga=[];function ya(e,t,s,i){let n;switch(i.mappingType){case"ByPolygonVertex":n=e;break;case"ByPolygon":n=t;break;case"ByVertice":n=s;break;case"AllSame":n=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}"IndexToDirect"===i.referenceType&&(n=i.indices[n]);const r=n*i.dataSize,a=r+i.dataSize;return function(e,t,s,i){for(let n=s,r=0;n<i;n++,r++)e[r]=t[n];return e}(ga,i.buffer,r,a)}const va=new se,wa=new i;function xa(e){const t=new te,s=new te,n=new te,r=new te,a=new te,o=new te,l=new te,h=new te,c=new te,u=new te,p=new te,d=new te,m=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(wa.fromArray(e.translation)),e.preRotation){const t=e.preRotation.map(ee.degToRad);t.push(e.eulerOrder||se.DEFAULT_ORDER),s.makeRotationFromEuler(va.fromArray(t))}if(e.rotation){const t=e.rotation.map(ee.degToRad);t.push(e.eulerOrder||se.DEFAULT_ORDER),n.makeRotationFromEuler(va.fromArray(t))}if(e.postRotation){const t=e.postRotation.map(ee.degToRad);t.push(e.eulerOrder||se.DEFAULT_ORDER),r.makeRotationFromEuler(va.fromArray(t)),r.invert()}e.scale&&a.scale(wa.fromArray(e.scale)),e.scalingOffset&&l.setPosition(wa.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(wa.fromArray(e.scalingPivot)),e.rotationOffset&&h.setPosition(wa.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(wa.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(p.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const f=s.clone().multiply(n).multiply(r),g=new te;g.extractRotation(u);const y=new te;y.copyPosition(u);const v=y.clone().invert().multiply(u),w=g.clone().invert().multiply(v),x=a,b=new te;if(0===m)b.copy(g).multiply(f).multiply(w).multiply(x);else if(1===m)b.copy(g).multiply(w).multiply(f).multiply(x);else{const e=(new te).scale((new i).setFromMatrixScale(p)).clone().invert(),t=w.clone().multiply(e);b.copy(g).multiply(f).multiply(t).multiply(x)}const M=c.clone().invert(),A=o.clone().invert();let T=t.clone().multiply(h).multiply(c).multiply(s).multiply(n).multiply(r).multiply(M).multiply(l).multiply(o).multiply(a).multiply(A);const S=(new te).copyPosition(T),R=u.clone().multiply(S);return d.copyPosition(R),T=d.clone().multiply(b),T.premultiply(u.invert()),T}function ba(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function Ma(e){return e.split(",").map((function(e){return parseFloat(e)}))}function Aa(e,t,s){return void 0===t&&(t=0),void 0===s&&(s=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,s))}function Ta(e,t,s){return e.slice(0,t).concat(s).concat(e.slice(t))}class Sa extends xt{constructor(e){super(e),this.type=bt}parse(e){const t=function(e,t){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(t||""))}},s=function(e,t,s){t=t||1024;let i=e.pos,n=-1,r=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));for(;0>(n=o.indexOf("\n"))&&r<t&&i<e.byteLength;)a+=o,r+=o.length,i+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(i,i+128)));return-1<n&&(!1!==s&&(e.pos+=r+n+1),a+o.slice(0,n))},i=function(e,t,s,i){const n=e[t+3],r=Math.pow(2,n-128)/255;s[i+0]=e[t+0]*r,s[i+1]=e[t+1]*r,s[i+2]=e[t+2]*r,s[i+3]=1},n=function(e,t,s,i){const n=e[t+3],r=Math.pow(2,n-128)/255;s[i+0]=At.toHalfFloat(Math.min(e[t+0]*r,65504)),s[i+1]=At.toHalfFloat(Math.min(e[t+1]*r,65504)),s[i+2]=At.toHalfFloat(Math.min(e[t+2]*r,65504)),s[i+3]=At.toHalfFloat(1)},r=new Uint8Array(e);r.pos=0;const a=function(e){const i=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,r=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;for((e.pos>=e.byteLength||!(l=s(e)))&&t(1,"no header found"),(h=l.match(/^#\?(\S+)/))||t(3,"bad initial token"),o.valid|=1,o.programtype=h[1],o.string+=l+"\n";l=s(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(i))&&(o.gamma=parseFloat(h[1])),(h=l.match(n))&&(o.exposure=parseFloat(h[1])),(h=l.match(r))&&(o.valid|=2,o.format=h[1]),(h=l.match(a))&&(o.valid|=4,o.height=parseInt(h[1],10),o.width=parseInt(h[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid||t(3,"missing format specifier"),4&o.valid||t(3,"missing image size specifier"),o}(r),o=a.width,l=a.height,h=function(e,s,i){const n=s;if(n<8||n>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);n!==(e[2]<<8|e[3])&&t(3,"wrong scanline width");const r=new Uint8Array(4*s*i);r.length||t(4,"unable to allocate buffer space");let a=0,o=0;const l=4*n,h=new Uint8Array(4),c=new Uint8Array(l);let u=i;for(;u>0&&o<e.byteLength;){o+4>e.byteLength&&t(1),h[0]=e[o++],h[1]=e[o++],h[2]=e[o++],h[3]=e[o++],2==h[0]&&2==h[1]&&(h[2]<<8|h[3])==n||t(3,"bad rgbe scanline format");let s,i=0;for(;i<l&&o<e.byteLength;){s=e[o++];const n=s>128;if(n&&(s-=128),(0===s||i+s>l)&&t(3,"bad scanline data"),n){const t=e[o++];for(let e=0;e<s;e++)c[i++]=t}else c.set(e.subarray(o,o+s),i),i+=s,o+=s}const p=n;for(let e=0;e<p;e++){let t=0;r[a]=c[e+t],t+=n,r[a+1]=c[e+t],t+=n,r[a+2]=c[e+t],t+=n,r[a+3]=c[e+t],a+=4}u--}return r}(r.subarray(r.pos),o,l);let c,u,p;switch(this.type){case Mt:p=h.length/4;const e=new Float32Array(4*p);for(let t=0;t<p;t++)i(h,4*t,e,4*t);c=e,u=Mt;break;case bt:p=h.length/4;const t=new Uint16Array(4*p);for(let e=0;e<p;e++)n(h,4*e,t,4*e);c=t,u=bt;break;default:throw new Error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:o,height:l,data:c,header:a.string,gamma:a.gamma,exposure:a.exposure,type:u}}setDataType(e){return this.type=e,this}load(e,t,s,i){return super.load(e,(function(e,s){switch(e.type){case Mt:case bt:e.colorSpace=Ge,e.minFilter=Ne,e.magFilter=Ne,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,s)}),s,i)}}class Ra extends xt{constructor(e){super(e),this.type=bt}parse(e){const t=65536,s=14,i=65537,n=16384,r=Math.pow(2.7182818,2.2);const a={l:0,c:0,lc:0};function o(e,t,s,i,n){for(;s<e;)t=t<<8|V(i,n),s+=8;s-=e,a.l=t>>s&(1<<e)-1,a.c=t,a.lc=s}const l=new Array(59);function h(e,t,s,n,r,h){const c=t;let u=0,p=0;for(;n<=r;n++){if(c.value-t.value>s)return!1;o(6,u,p,e,c);const i=a.l;if(u=a.c,p=a.lc,h[n]=i,63==i){if(c.value-t.value>s)throw new Error("Something wrong with hufUnpackEncTable");o(8,u,p,e,c);let i=a.l+6;if(u=a.c,p=a.lc,n+i>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;i--;)h[n++]=0;n--}else if(i>=59){let e=i-59+2;if(n+e>r+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)h[n++]=0;n--}}!function(e){for(let e=0;e<=58;++e)l[e]=0;for(let t=0;t<i;++t)l[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const s=t+l[e]>>1;l[e]=t,t=s}for(let t=0;t<i;++t){const s=e[t];s>0&&(e[t]=s|l[s]++<<6)}}(h)}function c(e){return 63&e}function u(e){return e>>6}const p={c:0,lc:0};function d(e,t,s,i){e=e<<8|V(s,i),t+=8,p.c=e,p.lc=t}const m={c:0,lc:0};function f(e,t,s,i,n,r,a,o,l){if(e==t){i<8&&(d(s,i,n,r),s=p.c,i=p.lc);let e=s>>(i-=8);if(e=new Uint8Array([e])[0],o.value+e>l)return!1;const t=a[o.value-1];for(;e-- >0;)a[o.value++]=t}else{if(!(o.value<l))return!1;a[o.value++]=e}m.c=s,m.lc=i}function g(e){return 65535&e}function y(e){const t=g(e);return t>32767?t-65536:t}const v={a:0,b:0};function w(e,t){const s=y(e),i=y(t),n=s+(1&i)+(i>>1),r=n,a=n-i;v.a=r,v.b=a}function x(e,t){const s=g(e),i=g(t),n=s-(i>>1)&65535,r=i+n-32768&65535;v.a=r,v.b=n}function b(e,t,s,i,n,r,a){const o=a<16384,l=s>n?n:s;let h,c,u=1;for(;u<=l;)u<<=1;for(u>>=1,h=u,u>>=1;u>=1;){c=0;const a=c+r*(n-h),l=r*u,p=r*h,d=i*u,m=i*h;let f,g,y,b;for(;c<=a;c+=p){let n=c;const r=c+i*(s-h);for(;n<=r;n+=m){const s=n+d,i=n+l,r=i+d;o?(w(e[n+t],e[i+t]),f=v.a,y=v.b,w(e[s+t],e[r+t]),g=v.a,b=v.b,w(f,g),e[n+t]=v.a,e[s+t]=v.b,w(y,b),e[i+t]=v.a,e[r+t]=v.b):(x(e[n+t],e[i+t]),f=v.a,y=v.b,x(e[s+t],e[r+t]),g=v.a,b=v.b,x(f,g),e[n+t]=v.a,e[s+t]=v.b,x(y,b),e[i+t]=v.a,e[r+t]=v.b)}if(s&u){const s=n+l;o?w(e[n+t],e[s+t]):x(e[n+t],e[s+t]),f=v.a,e[s+t]=v.b,e[n+t]=f}}if(n&u){let n=c;const r=c+i*(s-h);for(;n<=r;n+=m){const s=n+d;o?w(e[n+t],e[s+t]):x(e[n+t],e[s+t]),f=v.a,e[s+t]=v.b,e[n+t]=f}}h=u,u>>=1}return c}function M(e,t,r,a,o,l){const g=r.value,y=U(t,r),v=U(t,r);r.value+=4;const w=U(t,r);if(r.value+=4,y<0||y>=i||v<0||v>=i)throw new Error("Something wrong with HUF_ENCSIZE");const x=new Array(i),b=new Array(n);!function(e){for(let t=0;t<n;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(b);if(h(e,r,a-(r.value-g),y,v,x),w>8*(a-(r.value-g)))throw new Error("Something wrong with hufUncompress");!function(e,t,i,n){for(;t<=i;t++){const i=u(e[t]),r=c(e[t]);if(i>>r)throw new Error("Invalid table entry");if(r>s){const e=n[i>>r-s];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let s=0;s<e.lit-1;++s)e.p[s]=t[s]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(r){let e=0;for(let a=1<<s-r;a>0;a--){const a=n[(i<<s-r)+e];if(a.len||a.p)throw new Error("Invalid table entry");a.len=r,a.lit=t,e++}}}}(x,y,v,b),function(e,t,i,n,r,a,o,l,h){let g=0,y=0;const v=o,w=Math.trunc(n.value+(r+7)/8);for(;n.value<w;)for(d(g,y,i,n),g=p.c,y=p.lc;y>=s;){const r=t[g>>y-s&16383];if(r.len)y-=r.len,f(r.lit,a,g,y,i,n,l,h,v),g=m.c,y=m.lc;else{if(!r.p)throw new Error("hufDecode issues");let t;for(t=0;t<r.lit;t++){const s=c(e[r.p[t]]);for(;y<s&&n.value<w;)d(g,y,i,n),g=p.c,y=p.lc;if(y>=s&&u(e[r.p[t]])==(g>>y-s&(1<<s)-1)){y-=s,f(r.p[t],a,g,y,i,n,l,h,v),g=m.c,y=m.lc;break}}if(t==r.lit)throw new Error("hufDecode issues")}}const x=8-r&7;for(g>>=x,y-=x;y>0;){const e=t[g<<s-y&16383];if(!e.len)throw new Error("hufDecode issues");y-=e.len,f(e.lit,a,g,y,i,n,l,h,v),g=m.c,y=m.lc}}(x,b,e,r,w,v,l,o,{value:0})}function A(e){for(let t=1;t<e.length;t++){const s=e[t-1]+e[t]-128;e[t]=s}}function T(e,t){let s=0,i=Math.floor((e.length+1)/2),n=0;const r=e.length-1;for(;!(n>r||(t[n++]=e[s++],n>r));)t[n++]=e[i++]}function S(e){let t=e.byteLength;const s=new Array;let i=0;const n=new DataView(e);for(;t>0;){const e=n.getInt8(i++);if(e<0){const r=-e;t-=r+1;for(let e=0;e<r;e++)s.push(n.getUint8(i++))}else{const r=e;t-=2;const a=n.getUint8(i++);for(let e=0;e<r+1;e++)s.push(a)}}return s}function R(e,t,s){let i,n=1;for(;n<64;)i=t[e.value],65280==i?n=64:i>>8==255?n+=255&i:(s[n]=i,n++),e.value++}function k(e,t){t[0]=q(e[0]),t[1]=q(e[1]),t[2]=q(e[5]),t[3]=q(e[6]),t[4]=q(e[14]),t[5]=q(e[15]),t[6]=q(e[27]),t[7]=q(e[28]),t[8]=q(e[2]),t[9]=q(e[4]),t[10]=q(e[7]),t[11]=q(e[13]),t[12]=q(e[16]),t[13]=q(e[26]),t[14]=q(e[29]),t[15]=q(e[42]),t[16]=q(e[3]),t[17]=q(e[8]),t[18]=q(e[12]),t[19]=q(e[17]),t[20]=q(e[25]),t[21]=q(e[30]),t[22]=q(e[41]),t[23]=q(e[43]),t[24]=q(e[9]),t[25]=q(e[11]),t[26]=q(e[18]),t[27]=q(e[24]),t[28]=q(e[31]),t[29]=q(e[40]),t[30]=q(e[44]),t[31]=q(e[53]),t[32]=q(e[10]),t[33]=q(e[19]),t[34]=q(e[23]),t[35]=q(e[32]),t[36]=q(e[39]),t[37]=q(e[45]),t[38]=q(e[52]),t[39]=q(e[54]),t[40]=q(e[20]),t[41]=q(e[22]),t[42]=q(e[33]),t[43]=q(e[38]),t[44]=q(e[46]),t[45]=q(e[51]),t[46]=q(e[55]),t[47]=q(e[60]),t[48]=q(e[21]),t[49]=q(e[34]),t[50]=q(e[37]),t[51]=q(e[47]),t[52]=q(e[50]),t[53]=q(e[56]),t[54]=q(e[59]),t[55]=q(e[61]),t[56]=q(e[35]),t[57]=q(e[36]),t[58]=q(e[48]),t[59]=q(e[49]),t[60]=q(e[57]),t[61]=q(e[58]),t[62]=q(e[62]),t[63]=q(e[63])}function C(e){const t=.5*Math.cos(.7853975),s=.5*Math.cos(3.14159/16),i=.5*Math.cos(3.14159/8),n=.5*Math.cos(3*3.14159/16),r=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),u=new Array(4);for(let p=0;p<8;++p){const d=8*p;l[0]=i*e[d+2],l[1]=a*e[d+2],l[2]=i*e[d+6],l[3]=a*e[d+6],h[0]=s*e[d+1]+n*e[d+3]+r*e[d+5]+o*e[d+7],h[1]=n*e[d+1]-o*e[d+3]-s*e[d+5]-r*e[d+7],h[2]=r*e[d+1]-s*e[d+3]+o*e[d+5]+n*e[d+7],h[3]=o*e[d+1]-r*e[d+3]+n*e[d+5]-s*e[d+7],c[0]=t*(e[d+0]+e[d+4]),c[3]=t*(e[d+0]-e[d+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],e[d+0]=u[0]+h[0],e[d+1]=u[1]+h[1],e[d+2]=u[2]+h[2],e[d+3]=u[3]+h[3],e[d+4]=u[3]-h[3],e[d+5]=u[2]-h[2],e[d+6]=u[1]-h[1],e[d+7]=u[0]-h[0]}for(let p=0;p<8;++p)l[0]=i*e[16+p],l[1]=a*e[16+p],l[2]=i*e[48+p],l[3]=a*e[48+p],h[0]=s*e[8+p]+n*e[24+p]+r*e[40+p]+o*e[56+p],h[1]=n*e[8+p]-o*e[24+p]-s*e[40+p]-r*e[56+p],h[2]=r*e[8+p]-s*e[24+p]+o*e[40+p]+n*e[56+p],h[3]=o*e[8+p]-r*e[24+p]+n*e[40+p]-s*e[56+p],c[0]=t*(e[p]+e[32+p]),c[3]=t*(e[p]-e[32+p]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],e[0+p]=u[0]+h[0],e[8+p]=u[1]+h[1],e[16+p]=u[2]+h[2],e[24+p]=u[3]+h[3],e[32+p]=u[3]-h[3],e[40+p]=u[2]-h[2],e[48+p]=u[1]-h[1],e[56+p]=u[0]-h[0]}function I(e){for(let t=0;t<64;++t){const s=e[0][t],i=e[1][t],n=e[2][t];e[0][t]=s+1.5747*n,e[1][t]=s-.1873*i-.4682*n,e[2][t]=s+1.8556*i}}function E(e,t,s){for(let i=0;i<64;++i)t[s+i]=At.toHalfFloat(P(e[i]))}function P(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(r,Math.abs(e)-1)}function _(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function L(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),s=new Uint8Array(S(t)),i=new Uint8Array(s.length);return A(s),T(s,i),new DataView(i.buffer)}function D(e){const t=Qr(e.array.slice(e.offset.value,e.offset.value+e.size)),s=new Uint8Array(t.length);return A(t),T(t,s),new DataView(s.buffer)}function z(e){const s=e.viewer,i={value:e.offset.value},n=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),r=new Uint8Array(8192);let a=0;const o=new Array(e.channels);for(let t=0;t<e.channels;t++)o[t]={},o[t].start=a,o[t].end=o[t].start,o[t].nx=e.width,o[t].ny=e.lines,o[t].size=e.type,a+=o[t].nx*o[t].ny*o[t].size;const l=X(s,i),h=X(s,i);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let e=0;e<h-l+1;e++)r[e+l]=H(s,i);const c=new Uint16Array(t),u=function(e,s){let i=0;for(let n=0;n<t;++n)(0==n||e[n>>3]&1<<(7&n))&&(s[i++]=n);const n=i-1;for(;i<t;)s[i++]=0;return n}(r,c),p=U(s,i);M(e.array,s,i,p,n,a);for(let t=0;t<e.channels;++t){const e=o[t];for(let s=0;s<o[t].size;++s)b(n,e.start+s,e.nx,e.size,e.ny,e.nx*e.size,u)}!function(e,t,s){for(let i=0;i<s;++i)t[i]=e[t[i]]}(c,n,a);let d=0;const m=new Uint8Array(n.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){const e=o[t],s=e.nx*e.size,i=new Uint8Array(n.buffer,2*e.end,2*s);m.set(i,d),d+=2*s,e.end+=s}return new DataView(m.buffer)}function O(e){const t=Qr(e.array.slice(e.offset.value,e.offset.value+e.size)),s=e.lines*e.channels*e.width,i=1==e.type?new Uint16Array(s):new Uint32Array(s);let n=0,r=0;const a=new Array(4);for(let s=0;s<e.lines;s++)for(let s=0;s<e.channels;s++){let s=0;switch(e.type){case 1:a[0]=n,a[1]=a[0]+e.width,n=a[1]+e.width;for(let n=0;n<e.width;++n){s+=t[a[0]++]<<8|t[a[1]++],i[r]=s,r++}break;case 2:a[0]=n,a[1]=a[0]+e.width,a[2]=a[1]+e.width,n=a[2]+e.width;for(let n=0;n<e.width;++n){s+=t[a[0]++]<<24|t[a[1]++]<<16|t[a[2]++]<<8,i[r]=s,r++}}}return new DataView(i.buffer)}function F(e){const t=e.viewer,s={value:e.offset.value},i=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),n={version:j(t,s),unknownUncompressedSize:j(t,s),unknownCompressedSize:j(t,s),acCompressedSize:j(t,s),dcCompressedSize:j(t,s),rleCompressedSize:j(t,s),rleUncompressedSize:j(t,s),rleRawSize:j(t,s),totalAcUncompressedCount:j(t,s),totalDcUncompressedCount:j(t,s),acCompression:j(t,s)};if(n.version<2)throw new Error("EXRLoader.parse: "+$.compression+" version "+n.version+" is unsupported");const r=new Array;let a=X(t,s)-2;for(;a>0;){const e=N(t.buffer,s),i=H(t,s),n=i>>2&3,o=new Int8Array([(i>>4)-1])[0],l=H(t,s);r.push({name:e,index:o,type:l,compression:n}),a-=e.length+3}const o=$.channels,l=new Array(e.channels);for(let t=0;t<e.channels;++t){const s=l[t]={},i=o[t];s.name=i.name,s.compression=0,s.decoded=!1,s.type=i.pixelType,s.pLinear=i.pLinear,s.width=e.width,s.height=e.lines}const h={idx:new Array(3)};for(let t=0;t<e.channels;++t){const e=l[t];for(let s=0;s<r.length;++s){const i=r[s];e.name==i.name&&(e.compression=i.compression,i.index>=0&&(h.idx[i.index]=t),e.offset=t)}}let c,u,p;if(n.acCompressedSize>0)switch(n.acCompression){case 0:c=new Uint16Array(n.totalAcUncompressedCount),M(e.array,t,s,n.acCompressedSize,c,n.totalAcUncompressedCount);break;case 1:const i=Qr(e.array.slice(s.value,s.value+n.totalAcUncompressedCount));c=new Uint16Array(i.buffer),s.value+=n.totalAcUncompressedCount}if(n.dcCompressedSize>0){const t={array:e.array,offset:s,size:n.dcCompressedSize};u=new Uint16Array(D(t).buffer),s.value+=n.dcCompressedSize}if(n.rleRawSize>0){p=S(Qr(e.array.slice(s.value,s.value+n.rleCompressedSize)).buffer),s.value+=n.rleCompressedSize}let d=0;const m=new Array(l.length);for(let e=0;e<m.length;++e)m[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<l.length;++t)m[t].push(d),d+=l[t].width*e.type*2;!function(e,t,s,i,n,r){let a=new DataView(r.buffer);const o=s[e.idx[0]].width,l=s[e.idx[0]].height,h=Math.floor(o/8),c=Math.ceil(o/8),u=Math.ceil(l/8),p=o-8*(c-1),d=l-8*(u-1),m={value:0},f=new Array(3),g=new Array(3),y=new Array(3),v=new Array(3),w=new Array(3);for(let s=0;s<3;++s)w[s]=t[e.idx[s]],f[s]=s<1?0:f[s-1]+c*u,g[s]=new Float32Array(64),y[s]=new Uint16Array(64),v[s]=new Uint16Array(64*c);for(let t=0;t<u;++t){let r=8;t==u-1&&(r=d);let o=8;for(let e=0;e<c;++e){e==c-1&&(o=p);for(let e=0;e<3;++e)y[e].fill(0),y[e][0]=n[f[e]++],R(m,i,y[e]),k(y[e],g[e]),C(g[e]);I(g);for(let t=0;t<3;++t)E(g[t],v[t],64*e)}let l=0;for(let i=0;i<3;++i){const n=s[e.idx[i]].type;for(let e=8*t;e<8*t+r;++e){l=w[i][e];for(let t=0;t<h;++t){const s=64*t+8*(7&e);a.setUint16(l+0*n,v[i][s+0],!0),a.setUint16(l+2*n,v[i][s+1],!0),a.setUint16(l+4*n,v[i][s+2],!0),a.setUint16(l+6*n,v[i][s+3],!0),a.setUint16(l+8*n,v[i][s+4],!0),a.setUint16(l+10*n,v[i][s+5],!0),a.setUint16(l+12*n,v[i][s+6],!0),a.setUint16(l+14*n,v[i][s+7],!0),l+=16*n}}if(h!=c)for(let e=8*t;e<8*t+r;++e){const t=w[i][e]+8*h*2*n,s=64*h+8*(7&e);for(let e=0;e<o;++e)a.setUint16(t+2*e*n,v[i][s+e],!0)}}}const x=new Uint16Array(o);a=new DataView(r.buffer);for(let t=0;t<3;++t){s[e.idx[t]].decoded=!0;const i=s[e.idx[t]].type;if(2==s[t].type)for(let e=0;e<l;++e){const s=w[t][e];for(let e=0;e<o;++e)x[e]=a.getUint16(s+2*e*i,!0);for(let e=0;e<o;++e)a.setFloat32(s+2*e*i,q(x[e]),!0)}}}(h,m,l,c,u,i);for(let t=0;t<l.length;++t){const s=l[t];if(!s.decoded)switch(s.compression){case 2:let n=0,r=0;for(let a=0;a<e.lines;++a){let e=m[t][n];for(let t=0;t<s.width;++t){for(let t=0;t<2*s.type;++t)i[e++]=p[r+t*s.width*s.height];r++}n++}break;case 1:default:throw new Error("EXRLoader.parse: unsupported channel compression")}}return new DataView(i.buffer)}function N(e,t){const s=new Uint8Array(e);let i=0;for(;0!=s[t.value+i];)i+=1;const n=(new TextDecoder).decode(s.slice(t.value,t.value+i));return t.value=t.value+i+1,n}function B(e,t){const s=e.getInt32(t.value,!0);return t.value=t.value+4,s}function U(e,t){const s=e.getUint32(t.value,!0);return t.value=t.value+4,s}function V(e,t){const s=e[t.value];return t.value=t.value+1,s}function H(e,t){const s=e.getUint8(t.value);return t.value=t.value+1,s}const j=function(e,t){let s;return s="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,s};function G(e,t){const s=e.getFloat32(t.value,!0);return t.value+=4,s}function W(e,t){return At.toHalfFloat(G(e,t))}function q(e){const t=(31744&e)>>10,s=1023&e;return(e>>15?-1:1)*(t?31===t?s?NaN:1/0:Math.pow(2,t-15)*(1+s/1024):s/1024*6103515625e-14)}function X(e,t){const s=e.getUint16(t.value,!0);return t.value+=2,s}function K(e,t){return q(X(e,t))}function Z(e,t,s,i,n){return"string"===i||"stringvector"===i||"iccProfile"===i?function(e,t,s){const i=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+s));return t.value=t.value+s,i}(t,s,n):"chlist"===i?function(e,t,s,i){const n=s.value,r=[];for(;s.value<n+i-1;){const i=N(t,s),n=B(e,s),a=H(e,s);s.value+=3;const o=B(e,s),l=B(e,s);r.push({name:i,pixelType:n,pLinear:a,xSampling:o,ySampling:l})}return s.value+=1,r}(e,t,s,n):"chromaticities"===i?function(e,t){return{redX:G(e,t),redY:G(e,t),greenX:G(e,t),greenY:G(e,t),blueX:G(e,t),blueY:G(e,t),whiteX:G(e,t),whiteY:G(e,t)}}(e,s):"compression"===i?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][H(e,t)]}(e,s):"box2i"===i?function(e,t){return{xMin:U(e,t),yMin:U(e,t),xMax:U(e,t),yMax:U(e,t)}}(e,s):"lineOrder"===i?function(e,t){return["INCREASING_Y"][H(e,t)]}(e,s):"float"===i?G(e,s):"v2f"===i?function(e,t){return[G(e,t),G(e,t)]}(e,s):"v3f"===i?function(e,t){return[G(e,t),G(e,t),G(e,t)]}(e,s):"int"===i?B(e,s):"rational"===i?function(e,t){return[B(e,t),U(e,t)]}(e,s):"timecode"===i?function(e,t){return[U(e,t),U(e,t)]}(e,s):"preview"===i?(s.value+=n,"skipped"):void(s.value+=n)}const Y=new DataView(e),Q=new Uint8Array(e),J={value:0},$=function(e,t,s){const i={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.");i.version=e.getUint8(4);const n=e.getUint8(5);i.spec={singleTile:!!(2&n),longName:!!(4&n),deepFormat:!!(8&n),multiPart:!!(16&n)},s.value=8;let r=!0;for(;r;){const n=N(t,s);if(0==n)r=!1;else{const r=N(t,s),a=Z(e,t,s,r,U(e,s));void 0===a?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${r}'.`):i[n]=a}}if(0!=(-5&n))throw console.error("EXRHeader:",i),new Error("THREE.EXRLoader: provided file is currently unsupported.");return i}(Y,e,J),ee=function(e,t,s,i,n){const r={size:0,viewer:t,array:s,offset:i,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,colorSpace:Ge};switch(e.compression){case"NO_COMPRESSION":r.lines=1,r.uncompress=_;break;case"RLE_COMPRESSION":r.lines=1,r.uncompress=L;break;case"ZIPS_COMPRESSION":r.lines=1,r.uncompress=D;break;case"ZIP_COMPRESSION":r.lines=16,r.uncompress=D;break;case"PIZ_COMPRESSION":r.lines=32,r.uncompress=z;break;case"PXR24_COMPRESSION":r.lines=16,r.uncompress=O;break;case"DWAA_COMPRESSION":r.lines=32,r.uncompress=F;break;case"DWAB_COMPRESSION":r.lines=256,r.uncompress=F;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}if(r.scanlineBlockSize=r.lines,1==r.type)switch(n){case Mt:r.getter=K,r.inputSize=2;break;case bt:r.getter=X,r.inputSize=2}else{if(2!=r.type)throw new Error("EXRLoader.parse: unsupported pixelType "+r.type+" for "+e.compression+".");switch(n){case Mt:r.getter=G,r.inputSize=4;break;case bt:r.getter=W,r.inputSize=4}}r.blockCount=(e.dataWindow.yMax+1)/r.scanlineBlockSize;for(let e=0;e<r.blockCount;e++)j(t,i);r.outputChannels=3==r.channels?4:r.channels;const a=r.width*r.height*r.outputChannels;switch(n){case Mt:r.byteArray=new Float32Array(a),r.channels<r.outputChannels&&r.byteArray.fill(1,0,a);break;case bt:r.byteArray=new Uint16Array(a),r.channels<r.outputChannels&&r.byteArray.fill(15360,0,a);break;default:console.error("THREE.EXRLoader: unsupported type: ",n)}return r.bytesPerLine=r.width*r.inputSize*r.channels,4==r.outputChannels?(r.format=Le,r.colorSpace=Ge):(r.format=Tt,r.colorSpace=_e),r}($,Y,Q,J,this.type),te={value:0},se={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<ee.height/ee.scanlineBlockSize;e++){const t=U(Y,J);ee.size=U(Y,J),ee.lines=t+ee.scanlineBlockSize>ee.height?ee.height-t:ee.scanlineBlockSize;const s=ee.size<ee.lines*ee.bytesPerLine?ee.uncompress(ee):_(ee);J.value+=ee.size;for(let t=0;t<ee.scanlineBlockSize;t++){const i=t+e*ee.scanlineBlockSize;if(i>=ee.height)break;for(let e=0;e<ee.channels;e++){const n=se[$.channels[e].name];for(let r=0;r<ee.width;r++){te.value=(t*(ee.channels*ee.width)+e*ee.width+r)*ee.inputSize;const a=(ee.height-1-i)*(ee.width*ee.outputChannels)+r*ee.outputChannels+n;ee.byteArray[a]=ee.getter(s,te)}}}}return{header:$,width:ee.width,height:ee.height,data:ee.byteArray,format:ee.format,colorSpace:ee.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,t,s,i){return super.load(e,(function(e,s){e.colorSpace=s.colorSpace,e.minFilter=Ne,e.magFilter=Ne,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,s)}),s,i)}}var ka=function(){var e,t=0x10000000000000000,s=4294967295,i=2147483647,n=2147483648,r=16777216;function a(e){var t=[];return t[e-1]=void 0,t}function o(e,t){return h(e[0]+t[0],e[1]+t[1])}function l(e,t){var s,i;return e[0]==t[0]&&e[1]==t[1]?0:(s=0>e[1],i=0>t[1],s&&!i?-1:!s&&i?1:function(e,t){return h(e[0]-t[0],e[1]-t[1])}(e,t)[1]<0?-1:1)}function h(e,i){var n,r;for(e%=t,i=(i%=t)-(n=i%N)+(r=Math.floor(e/N)*N),e=e-r+n;0>e;)e+=N,i-=N;for(;e>s;)e-=N,i+=N;for(i%=t;i>0x7fffffff00000000;)i-=t;for(;-t>i;)i+=t;return[e,i]}function c(e){return e>=0?[e,0]:[e+N,-N]}function u(e){return e[0]>=n?~~Math.max(Math.min(e[0]-N,i),-n):~~Math.max(Math.min(e[0],i),-n)}function p(e){return e.cb>=e.O?-1:255&e.ab[e.cb++]}function d(e){var t=e.ab;return t.length=e.O,t}function m(e,t,i){var n,r,a,o,l="",h=[];for(r=0;5>r;++r){if(-1==(a=p(t)))throw Error("truncated input");h[r]=a<<24>>24}if(!function(e,t){var s,i,n,r,a,o,l;if(5>t.length)return 0;for(l=255&t[0],n=l%9,r=(o=~~(l/9))%5,a=~~(o/5),s=0,i=0;4>i;++i)s+=(255&t[1+i])<<8*i;return s>99999999||!function(e,t,s,i){if(t>8||s>4||i>4)return 0;R(e.k,s,t);var n=1<<i;return M(e.C,n),M(e.o,n),e.P=n-1,1}(e,n,r,a)?0:function(e,t){return 0>t?0:(e.z!=t&&(e.z=t,e.m=Math.max(e.z,1),g(e.b,Math.max(e.m,4096))),1)}(e,s)}(n=b({}),h))throw Error("corrupted input");for(r=0;64>r;r+=8){if(-1==(a=p(t)))throw Error("truncated input");1==(a=a.toString(16)).length&&(a="0"+a),l=a+""+l}/^0+$|^f+$/i.test(l)?e.N=B:(o=parseInt(l,16),e.N=o>s?B:c(o)),e.Q=function(e,t,s,i){return e.a.K=t,w(e.b),e.b.V=s,function(e){e.b.w=0,e.b.D=0,_(e.q),_(e.n),_(e.E),_(e.s),_(e.u),_(e.r),_(e.J),function(e){var t,s;for(s=1<<e.g+e.y,t=0;s>t;++t)_(e.F[t].v)}(e.k);for(var t=0;4>t;++t)_(e.j[t].B);S(e.C),S(e.o),_(e.t.B),function(e){e.p=0,e.i=-1;for(var t=0;5>t;++t)e.p=e.p<<8|p(e.K)}(e.a)}(e),e.f=0,e.l=0,e.T=0,e.R=0,e._=0,e.U=i,e.d=U,e.I=0,function(e,t){return e.h=t,e.bb=null,e.X=1,e}({},e)}(n,t,i,e.N)}function f(e,t){return e.S=function(e){return e.ab=a(32),e.O=0,e}({}),m(e,function(e,t){return e.ab=t,e.cb=0,e.O=t.length,e}({},t),e.S),e}function g(e,t){(null==e.x||e.c!=t)&&(e.x=a(t)),e.c=t,e.D=0,e.w=0}function y(e){var t=e.D-e.w;t&&(function(e,t,s,i){(function(e,t,s,i,n){for(var r=0;n>r;++r)s[i+r]=e[t+r]})(t,s,e.ab,e.O,i),e.O+=i}(e.V,e.x,e.w,t),e.D>=e.c&&(e.D=0),e.w=e.D)}function v(e,t){var s=e.D-t-1;return 0>s&&(s+=e.c),e.x[s]}function w(e){y(e),e.V=null}function x(e){if(!e.X)throw Error("bad state");if(e.bb)throw Error("No encoding");return function(e){var t=function(e){var t,s,i,n,r,a;if(a=u(e.d)&e.P,E(e.a,e.q,(e.f<<4)+a)){if(E(e.a,e.E,e.f))i=0,E(e.a,e.s,e.f)?(E(e.a,e.u,e.f)?(E(e.a,e.r,e.f)?(s=e._,e._=e.R):s=e.R,e.R=e.T):s=e.T,e.T=e.l,e.l=s):E(e.a,e.n,(e.f<<4)+a)||(e.f=7>e.f?9:11,i=1),i||(i=A(e.o,e.a,a)+2,e.f=7>e.f?8:11);else if(e._=e.R,e.R=e.T,e.T=e.l,i=2+A(e.C,e.a,a),e.f=7>e.f?7:10,(r=I(e.j[function(e){return 4>(e-=2)?e:3}(i)],e.a))>=4){if(n=(r>>1)-1,e.l=(2|1&r)<<n,14>r)e.l+=function(e,t,s,i){var n,r,a=1,o=0;for(r=0;i>r;++r)n=E(s,e,t+a),a<<=1,a+=n,o|=n<<r;return o}(e.J,e.l-r-1,e.a,n);else if(e.l+=P(e.a,n-4)<<4,e.l+=function(e,t){var s,i,n=1,r=0;for(i=0;e.A>i;++i)s=E(t,e.B,n),n<<=1,n+=s,r|=s<<i;return r}(e.t,e.a),0>e.l)return-1==e.l?1:-1}else e.l=r;if(l(c(e.l),e.d)>=0||e.l>=e.m)return-1;(function(e,t,s){var i=e.D-t-1;for(0>i&&(i+=e.c);0!=s;--s)i>=e.c&&(i=0),e.x[e.D++]=e.x[i++],e.D>=e.c&&y(e)})(e.b,e.l,i),e.d=o(e.d,c(i)),e.I=v(e.b,0)}else t=function(e,t,s){return e.F[((t&e.Y)<<e.g)+((255&s)>>>8-e.g)]}(e.k,u(e.d),e.I),e.I=7>e.f?function(e,t){var s=1;do{s=s<<1|E(t,e.v,s)}while(256>s);return s<<24>>24}(t,e.a):function(e,t,s){var i,n,r=1;do{if(n=s>>7&1,s<<=1,i=E(t,e.v,(1+n<<8)+r),r=r<<1|i,n!=i){for(;256>r;)r=r<<1|E(t,e.v,r);break}}while(256>r);return r<<24>>24}(t,e.a,v(e.b,e.l)),function(e,t){e.x[e.D++]=t,e.D>=e.c&&y(e)}(e.b,e.I),e.f=function(e){return 4>e?0:10>e?e-3:e-6}(e.f),e.d=o(e.d,V);return 0}(e.h);if(-1==t)throw Error("corrupted input");e.$=B,e.Z=e.h.d,(t||l(e.h.U,U)>=0&&l(e.h.d,e.h.U)>=0)&&(y(e.h.b),w(e.h.b),e.h.a.K=null,e.X=0)}(e),e.X}function b(e){e.b={},e.a={},e.q=a(192),e.E=a(12),e.s=a(12),e.u=a(12),e.r=a(12),e.n=a(192),e.j=a(4),e.J=a(114),e.t=C({},4),e.C=T({}),e.o=T({}),e.k={};for(var t=0;4>t;++t)e.j[t]=C({},6);return e}function M(e,t){for(;t>e.e;++e.e)e.G[e.e]=C({},3),e.H[e.e]=C({},3)}function A(e,t,s){return E(t,e.M,0)?8+(E(t,e.M,1)?8+I(e.L,t):I(e.H[s],t)):I(e.G[s],t)}function T(e){return e.M=a(2),e.G=a(16),e.H=a(16),e.L=C({},8),e.e=0,e}function S(e){_(e.M);for(var t=0;e.e>t;++t)_(e.G[t].B),_(e.H[t].B);_(e.L.B)}function R(e,t,s){var i,n;if(null==e.F||e.g!=s||e.y!=t)for(e.y=t,e.Y=(1<<t)-1,e.g=s,n=1<<e.g+e.y,e.F=a(n),i=0;n>i;++i)e.F[i]=k({})}function k(e){return e.v=a(768),e}function C(e,t){return e.A=t,e.B=a(1<<t),e}function I(e,t){var s,i=1;for(s=e.A;0!=s;--s)i=(i<<1)+E(t,e.B,i);return i-(1<<e.A)}function E(e,t,s){var i,a=t[s];return i=(e.i>>>11)*a,(-n^i)>(-n^e.p)?(e.i=i,t[s]=a+(2048-a>>>5)<<16>>16,-r&e.i||(e.p=e.p<<8|p(e.K),e.i<<=8),0):(e.i-=i,e.p-=i,t[s]=a-(a>>>5)<<16>>16,-r&e.i||(e.p=e.p<<8|p(e.K),e.i<<=8),1)}function P(e,t){var s,i,n=0;for(s=t;0!=s;--s)e.i>>>=1,i=e.p-e.i>>>31,e.p-=e.i&i-1,n=n<<1|1-i,-r&e.i||(e.p=e.p<<8|p(e.K),e.i<<=8);return n}function _(e){for(var t=e.length-1;t>=0;--t)e[t]=1024}function L(e){for(var t,s,i,n=0,r=0,a=e.length,o=[],l=[];a>n;++n,++r){if(128&(t=255&e[n]))if(192==(224&t)){if(n+1>=a)return e;if(128!=(192&(s=255&e[++n])))return e;l[r]=(31&t)<<6|63&s}else{if(224!=(240&t))return e;if(n+2>=a)return e;if(128!=(192&(s=255&e[++n])))return e;if(128!=(192&(i=255&e[++n])))return e;l[r]=(15&t)<<12|(63&s)<<6|63&i}else{if(!t)return e;l[r]=t}16383==r&&(o.push(String.fromCharCode.apply(String,l)),r=-1)}return r>0&&(l.length=r,o.push(String.fromCharCode.apply(String,l))),o.join("")}function D(e){return e[1]+e[0]}var z=2,O=3,F="function"==typeof setImmediate?setImmediate:setTimeout,N=4294967296,B=[s,-N],U=[0,0],V=[1,0];return{decompress:function(t,s,i){var n,r,a,o,l={},h=void 0===s&&void 0===i;if("function"!=typeof s&&(r=s,s=i=0),i=i||function(t){return void 0!==r?function(t,s){e({action:O,cbn:s,result:t})}(a?t:-1,r):void 0},s=s||function(t,s){return void 0!==r?e({action:z,cbn:r,result:t,error:s}):void 0},h){for(l.d=f({},t);x(l.d.Q););return L(d(l.d.S))}try{l.d=f({},t),o=D(l.d.N),a=o>-1,i(0)}catch(e){return s(null,e)}F((function e(){try{for(var t,r=0,h=(new Date).getTime();x(l.d.Q);)if(++r%1e3==0&&(new Date).getTime()-h>200)return a&&(n=D(l.d.Q.h.d)/o,i(n)),F(e,0),0;i(1),t=L(d(l.d.S)),F(s.bind(null,t),0)}catch(e){s(null,e)}}),0)}}}();const Ca={decompress:(e,t)=>{ka.decompress(new Uint8Array(e),t)}};let Ia=!0,Ea=!1,Pa=null;const _a=new Map,La={renderMode:{value:0},fogMode:{value:1},depthPacking:{value:1},time:{value:0},shadow:{value:.5},shadowGamma:{value:.25},shadowLuma:{value:0},shadowContrast:{value:1},lightSizeUV:{value:1},nearPlane:{value:1},rings:{value:4},nSample:{value:16},noiseIntensity:{value:1},softness:{value:1.6},noiseMap:{value:null},useNoiseMap:{value:0}};class Da{get renderer(){return Pa}set renderer(e){Pa=e}static setGl2(e){Ia=e}static getGl2(e){return Ia}static setting(){return La}static getRandomUv(){return Na}static addParsFragment(e,t){e.fragmentShader=e.fragmentShader.replace("#include <clipping_planes_pars_fragment>","#include <clipping_planes_pars_fragment>"+t)}static init(e={}){const t="PCSS"===e.shadowType;if(w.tonemapping_pars_fragment=w.tonemapping_pars_fragment.replace("vec3 CustomToneMapping( vec3 color ) { return color; }","#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\n            float toneMappingWhitePoint = 1.0;\n            vec3 CustomToneMapping( vec3 color ) {\n                color *= toneMappingExposure;\n                return saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n            }"),!t)return;let s;this.up(e),t&&(s=w.shadowmap_pars_fragment,s=s.replace("#ifdef USE_SHADOWMAP",Fa),s=s.replace("shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );","\n                return PCSS( shadowMap, shadowCoord );\n            "),w.shadowmap_pars_fragment=s),s=w.common,s=s.replace("#define EPSILON 1e-6","\n        \t#define EPSILON 1e-6\n        \tuniform float shadow;\n            uniform float shadowLuma;\n            uniform float shadowContrast;\n            uniform float shadowGamma;\n\n            uniform int renderMode;\n            uniform int fogMode;\n            uniform int depthPacking;\n\n            varying vec2 vZW;\n            varying vec3 rayDir;\n            varying vec3 rayDir2;\n            varying vec3 rayOri;\n            //varying float fDist;\n\n            float shadowValue = 1.0;\n            float shadowTmp = 1.0;\n            vec3 shadowColor = vec3(1.0);\n            \n            float color_distance( vec3 a, vec3 b){\n                vec3 s = vec3( a - b );\n                float dist = sqrt( s.r * s.r + s.g * s.g + s.b * s.b );\n                return clamp(dist, 0.0, 1.0);\n            }\n\n            vec3 adjustContrast(vec3 color, float value) {\n                const vec3 zero = vec3(0.);\n                return max(zero, 0.5 + value * (color - 0.5));\n            }\n\n            vec3 hsv2rgb(vec3 c){\n                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n            }\n\n            vec3 rgb2hsv(vec3 rgb) {\n                float Cmax = max(rgb.r, max(rgb.g, rgb.b));\n                float Cmin = min(rgb.r, min(rgb.g, rgb.b));\n                float delta = Cmax - Cmin;\n                vec3 hsv = vec3(0., 0., Cmax);\n                if (Cmax > Cmin) {\n                    hsv.y = delta / Cmax;\n                    if (rgb.r == Cmax) hsv.x = (rgb.g - rgb.b) / delta;\n                    else {\n                        if (rgb.g == Cmax) hsv.x = 2. + (rgb.b - rgb.r) / delta;\n                        else hsv.x = 4. + (rgb.r - rgb.g) / delta;\n                    }\n                    hsv.x = fract(hsv.x / 6.);\n                }\n                return hsv;\n            }\n\n            /*\n            vec3 rgb2hsv(vec3 c){\n                vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n                vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n                vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\n                float d = q.x - min(q.w, q.y);\n                float e = 1.0e-10;\n                return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n            }\n\n            vec3 brightnessContrastCorrection(vec3 value, float brightness, float contrast){\n                return (value - 0.5) * contrast + 0.5 + brightness;\n            }\n\n            vec3 GammaCorrection(vec3 value, float param){\n                return vec3(pow(abs(value.r), param),pow(abs(value.g), param),pow(abs(value.b), param));\n            }\n            */\n            \n\n        "),w.common=s,w.clipping_planes_vertex="\n            #if NUM_CLIPPING_PLANES > 0\n                vClipPosition = - mvPosition.xyz;\n            #endif\n            vZW = gl_Position.zw;\n        ",s=w.lights_fragment_begin,s=s.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),s=s.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),s=s.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),w.lights_fragment_begin=s,w.fog_vertex=za,w.fog_fragment=Oa,s=w.opaque_fragment,s=s.replace("gl_FragColor = vec4( outgoingLight, diffuseColor.a );","\n\n            gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        \t#if defined( USE_SHADOWMAP )\n\n            shadowValue = (shadowValue - 0.5) * shadowContrast + 0.5 + shadowLuma;\n            shadowValue = pow(abs(shadowValue), shadowGamma );\n            shadowValue = clamp( shadowValue, 0.0, 1.0 );\n\n            shadowColor = vec3( shadowValue );\n\n            ///shadowColor = vec3( 0.0,0.0,1.0-shadowValue );\n\n            //vec3 sColor = vec3( 0.1, 0.1, 0.8 );\n            //shadowColor.b += 1.0-shadowValue ;\n\n\n\n            // TODO find better shadow variation\n\n            vec3 invert = vec3( 1.0 - gl_FragColor.rgb );\n            vec3 dd = vec3(0.38,0.42,0.63);\n            float gray = ((gl_FragColor.r + gl_FragColor.g + gl_FragColor.b) / 3.0);\n            vec3 invColor = gray * dd;\n            invColor = invColor * mix( invColor, invert, 1.0-gray*0.5 );\n\n\n\n\n                    \n\n\n            //gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * shadowColor, (1.0-shadowValue) * shadow );\n\n            //gl_FragColor.rgb *= ((1.0-shadowValue) * (1.0-shadow)) + shadowColor;\n\n            //gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * invColor, (1.0-shadowValue) * shadow );\n\n            gl_FragColor.rgb = mix( gl_FragColor.rgb, invColor, (1.0-shadowValue) * shadow );\n\n            //gl_FragColor.rgb = invColor;\n\n            //gl_FragColor.rgb = gl_FragColor.rgb * shadowColor;\n\n            //gl_FragColor.rgb *= ((1.0-shadowValue) * shadow) * invColor;\n\n\n        \t#endif\n            \n        "),w.opaque_fragment=s,s=w.dithering_fragment,s=s.replace("#endif","\n\n            #endif\n\n            #ifdef STANDARD\n\n            if( renderMode == 1 ){ \n                float fz = 0.5 * vZW[0] / vZW[1] + 0.5;\n                gl_FragColor = depthPacking == 1 ? packDepthToRGBA( fz ) : vec4( vec3( 1.0 - fz ), opacity );// depth render\n            }\n            if( renderMode == 2 ) gl_FragColor = vec4(  packNormalToRGB( normal ), opacity );// normal render\n            if( renderMode == 3 ) gl_FragColor = vec4(  shadowColor, opacity );// normal render\n\n            #else\n\n            if( renderMode != 0 ) discard;\n\n            #endif\n\n        "),w.dithering_fragment=s,s=w.color_vertex,s=s.replace("vColor.xyz *= instanceColor.xyz;","vColor.xyz = instanceColor.xyz;"),w.color_vertex=s,Ea=!0}static add(e,t=null){if(!Ea)return;if(!e)return;let s=e.name;_a.has(s)?console.log("already add",s):(_a.set(s,!0),null===e.shadowSide&&(e.shadowSide=I),e.onBeforeCompile=function(e){Da.modify(e),t&&t(e)})}static refresh(){}static setDefines(e){}static modify(e){if(Ea)for(let t in La)e.uniforms[t]=La[t]}static up(e){for(let t in e)La[t]&&(La[t].value.isColor?La[t].value.setHex(e[t]):La[t].value=e[t])}static reset(){_a.clear()}}const za="\n#ifdef USE_FOG\n\n    vFogDepth = - mvPosition.z;\n\n    rayDir2 = normalize( worldPosition.xyz - cameraPosition );\n    rayDir = normalize( mvPosition.xyz );\n    rayOri = cameraPosition.xyz;\n\n    //rayOri = worldPosition.xyz; //( cameraPosition-worldPosition.xyz  );\n    //vec3 tt = vec3(cameraPosition-mvPosition);\n    //float fDist = sqrt(tt.x*tt.x+tt.y*tt.y+tt.z*tt.z);\n    //fDist = distance(cameraPosition.xyz, mvPosition.xyz);\n\n#endif\n",Oa="\n#ifdef USE_FOG\n\n    #ifdef FOG_EXP2\n\n        float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\n    #else\n\n        float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n        float fogDensity = 0.01;\n\n    #endif\n\n    \n\n    /*vec4 CCF = vec4(fogColor, 1.0);\n    #if defined( TONE_MAPPING )\n        CCF.rgb = toneMapping( CCF.rgb );\n        //CCF = linearToOutputTexel( CCF );\n    #endif*/\n\n    if( fogMode == 0 ){\n\n        gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n    } \n\n    if( fogMode == 1 ){\n\n        vec3 fcolor = fogColor;\n\n        #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n            float aa = fogDensity * fogDensity * 1.0;\n            float bb = fogDensity * fogDensity * 12.0;\n            //bb = pow(bb, 0.8);\n            float distance = vFogDepth * vFogDepth;\n\n            fogFactor = 1.0 - exp( -distance*bb );\n            fogFactor = (aa/bb) * exp(-rayOri.y*bb) * (1.0-exp( -distance*rayDir2.y*bb ))/rayDir2.y;\n            fogFactor = clamp( fogFactor, 0.0, 1.0 );\n\n            vec3 sunDir = normalize( directionalLights[ 0 ].direction );\n            vec3 sunColor = directionalLights[ 0 ].color;\n            // sunColor = vec3(1,0,0);\n            float sunAmount = max( dot( rayDir, sunDir ), 0.0 );\n            //float sunAdd = clamp( pow(sunAmount, 60.0), 0.0, 1.0 );\n            float sunAdd = pow(sunAmount, 16.0);\n            fcolor = mix( fogColor, sunColor, sunAdd ); // 8.0\n\n        #endif\n\n        gl_FragColor.rgb = gl_FragColor.rgb * (1.0-fogFactor) + fcolor * fogFactor;\n\n    }\n\n#endif\n",Fa="\n#ifdef USE_SHADOWMAP\n\nuniform float lightSizeUV;\nuniform float nearPlane;\nuniform float rings;\nuniform int nSample;\nuniform float noiseIntensity;\nuniform float softness;\n\n//#define LIGHT_WORLD_SIZE 0.005\n//#define LIGHT_FRUSTUM_WIDTH 3.75\n//#define LIGHT_SIZE_UV (LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH)\n//#define NEAR_PLANE 9.5\n\n#define SAMPLE 16\n#define RINGS 4\n\nvec2 poissonDisk[32];\n\nvoid initPoissonSamples( const in vec2 randomSeed ) {\n\n    float ANGLE_STEP = PI2 * float(rings) / float( nSample );\n    float INV_NUM_SAMPLES = 1.0 / float( nSample );\n\n    // jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/\n    float angle = rand( randomSeed ) * PI2;\n    float radius = INV_NUM_SAMPLES;\n    float radiusStep = radius;\n\n    for( int i = 0; i < nSample; i ++ ) {\n        poissonDisk[i] = vec2( cos( angle ), sin( angle ) ) * pow( radius, 0.75 );\n        radius += radiusStep;\n        angle += ANGLE_STEP;\n    }\n}\n\nfloat penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation\n    return (zReceiver - zBlocker) / zBlocker;\n}\n\nfloat findBlocker( sampler2D shadowMap, const in vec2 uv, const in float zReceiver, float ls ) {\n\n    // This uses similar triangles to compute what\n    // area of the shadow map we should search\n    float searchRadius = ls * ( zReceiver - nearPlane ) / zReceiver;\n    float blockerDepthSum = 0.0;\n    int numBlockers = 0;\n    float shadowMapDepth = 0.0;\n\n    for( int i = 0; i < nSample; i++ ) {\n        shadowMapDepth = unpackRGBAToDepth(texture2D(shadowMap, uv + poissonDisk[i] * searchRadius));\n        if ( shadowMapDepth < zReceiver ) {\n            blockerDepthSum += shadowMapDepth;\n            numBlockers ++;\n        }\n    }\n\n    if( numBlockers == 0 ) return -1.0;\n\n    return blockerDepthSum / float( numBlockers );\n\n}\n\nfloat PCF_Filter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius ) {\n    \n    /*\n    int numSample = nSample;\n    float sum = 0.0;\n    float depth;\n    #pragma unroll_loop_start\n    for( int i = 0; i < nSample; i ++ ) {\n        depth = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n        if( zReceiver <= depth ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    #pragma unroll_loop_start\n    for( int i = 0; i < nSample; i ++ ) {\n        depth = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n        if( zReceiver <= depth ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    return sum / ( 2.0 * float( nSample ) );\n    */\n\n    \n    float sum = 0.0;\n    float top = 0.0;\n    float low = 0.0;\n    #pragma unroll_loop_start\n    for( int i = 0; i < 16; i ++ ) {\n        top = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n        low = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n        if( zReceiver <= top ) sum += 1.0;\n        if( zReceiver <= low ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    return sum / ( 2.0 * float( nSample ) );\n}\n\nfloat PCSS ( sampler2D shadowMap, vec4 coords ) {\n\n    vec2 uv = coords.xy;\n    float zReceiver = coords.z; // Assumed to be eye-space z in this code\n    //float lightSizeUV = LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH;\n\n    float ls = lightSizeUV * 0.001;\n\n    initPoissonSamples( uv );\n    // STEP 1: blocker search\n    float avgBlockerDepth = findBlocker( shadowMap, uv, zReceiver, ls );\n\n    //There are no occluders so early out (this saves filtering)\n    if( avgBlockerDepth == -1.0 ) return 1.0;\n\n    // STEP 2: penumbra size\n    float penumbraRatio = penumbraSize( zReceiver, avgBlockerDepth );\n    float filterRadius = penumbraRatio * ls * nearPlane / zReceiver;\n\n    // STEP 3: filtering\n    //return avgBlockerDepth;\n    return PCF_Filter( shadowMap, uv, zReceiver, filterRadius * softness );\n}\n",Na="\n\nuniform sampler2D noiseMap;\nuniform float useNoiseMap;\n\nfloat directNoise(vec2 p){\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u*u*(3.0-2.0*u);\n    \n    float res = mix(\n        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),\n        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);\n    return res*res;\n}\n\nfloat sum( vec4 v ) { return v.x+v.y+v.z; }\n\nvec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n    // sample variation pattern\n    float k = 0.0;\n    if( useNoiseMap == 1.0 ) k = texture2D( noiseMap, 0.005*uv ).x;\n    else k = directNoise( uv );\n    \n    // compute index    \n    float index = k*8.0;\n    float f = fract( index );\n\n    float ia = floor( index );\n    float ib = ia + 1.0;\n    // or\n    //float ia = floor(index+0.5); // suslik's method (see comments)\n    //float ib = floor(index);\n    //f = min(f, 1.0-f)*2.0;\n\n    // offsets for the different virtual patterns    \n    vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n    vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n    // compute derivatives for mip-mapping    \n    vec2 dx = dFdx(uv);\n    vec2 dy = dFdy(uv);\n    \n    // sample the two closest virtual patterns    \n    vec4 cola = textureGrad( mapper, uv + offa, dx, dy );\n    vec4 colb = textureGrad( mapper, uv + offb, dx, dy );\n\n    // interpolate between the two virtual patterns    \n    return mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) );\n\n}\n",Ba={getMesh:(e,t)=>{let s={};return e.traverse((e=>{e.isMesh&&(s[e.name]=e)})),s},keepMaterial:e=>{let t,s={};e.traverse((e=>{e.isMesh&&(t=e.material,s[t.name]||(Da.add(t),s[t.name]=!0))}))},getGroup:(e,t,s)=>{const i={};let n=null;return s&&(n=Ba.getMaterial(e,!0)),e.traverse((e=>{e.isGroup&&(i[e.name]=t?Ba.groupToMesh(e,n):e)})),i},getMaterial:(e,t)=>{const s={},i=[];let n,r;return e.traverse((e=>{e.isMesh&&(n=e.material,s[n.name]?e.material=s[n.name]:(Da.add(n),n.vertexColors=!1,s[n.name]=n,t&&(r=Number(n.name.substring(0,n.name.lastIndexOf("_"))),i[r]=n)))})),t?i:s},groupToMesh:(e,t)=>{if(e.children[0].name!==e.name+"_1")return e;if(!e.children[0].isMesh)return e;let s,i=[],n=e.children.length,r=0;for(let t=0;t<n;t++)s=e.children[t].material.name,r=Number(s.substring(0,s.lastIndexOf("_"))),e.children[t].material.dispose(),i[t]=e.children[t].geometry,i[t].forceMatId=r;let a=new THREE.Mesh(new qs(i,!0),t);return a.name=e.name,a},symetric:e=>{e.isMesh&&(e=e.geometry);let t=e.attributes.uv.array,s=.5*t.length;for(;s--;)t[2*s]<0&&(t[2*s]*=-1);e.attributes.uv.needsUpdate=!0},uv2:e=>{e.isMesh&&(e=e.geometry),e.setAttribute("uv2",e.attributes.uv)},autoMorph:(e,t,s=!0,i=!1)=>{let n,r,a,l,h,c,u,p,d,m,f,g={},y=[];e.traverse((e=>{e.isMesh&&-1!==e.name.search("__M__")&&(g[e.name]=e.geometry,y.push(e))}));for(let e in g)if(n=e.substring(0,e.indexOf("__")),r=e.substring(e.lastIndexOf("__")+2),a=t[n],a)if(h=a.geometry,c=g[e],h.morphTargetsRelative=i,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],s&&(h.morphAttributes.normal=[]),a.morphTargetInfluences=[],a.morphTargetDictionary={}),l=h.morphAttributes.position.length,i){for(u=c.attributes.position.array.length,m=[];u--;)m[u]=c.attributes.position.array[u]-h.attributes.position.array[u];p=new o(m,3)}else p=new o(c.attributes.position.array,3);h.morphAttributes.position.push(p),s&&(d=new o(c.attributes.normal.array,3),h.morphAttributes.normal.push(d)),a.morphTargetInfluences.push(0),a.morphTargetDictionary[r]=l}else console.warn("Morph "+r+" target is no good on "+a.name);for(g={},u=y.length;u--;)f=y[u],f.parent&&f.parent.remove(f),f.material&&f.material.dispose(),f.geometry&&f.geometry.dispose()}},Ua={msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],lzma:null,dracoLoader:null,dracoLoaderType:"js",dracoPath:"./src/libs/draco/",maxAnisotropy:1,onLoad:()=>{},onEnd:()=>{},log:e=>{},materialRoot:e=>{console.log(e)},setLoadEvent:(e,t)=>{Ua.onLoad=e,Ua.onEnd=t},prefix:e=>{let t="";switch(e){case"S":case"sound":case"mp3":case"wav":case"ogg":t="S_";break;case"I":case"image":case"jpg":case"png":t="I_";break;case"E":case"hdr":case"env":t="T_";break;case"J":case"json":t="J_";break;case"JS":case"js":t="JS_";break;case"H":case"bin":case"hex":t="H_";break;case"O":case"object3d":t="O_";break;case"M":case"material":t="M_";break;case"T":case"texture":t="T_"}return t},dispose:()=>{Ua.data.forEach((function(e,t){(e.isMaterial||e.isTexture)&&(e.dispose(),Ua.data.delete(t)),e.isObject3D&&(e.traverse((function(e){e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose())})),Ua.data.delete(t))}))},createElementNS:e=>document.createElementNS("http://www.w3.org/1999/xhtml",e),exist:(e,t="")=>!!Ua.get(e,t),delete:(e,t="")=>Ua.data.delete(Ua.prefix(t)+e),get:(e,t="")=>Ua.data.get(Ua.prefix(t)+e),set:(e,t,s="",i)=>{t.isMaterial&&(s="material",t.name=e,Ua.materialRoot(t,i)),t.isTexture&&(s="texture"),t.isObject3D&&(s="object3d"),Ua.get(e,s)||Ua.data.set(Ua.prefix(s)+e,t)},getScript:e=>Ua.data.get(Ua.prefix("js")+e),getMaterials:(e,t)=>("string"==typeof e&&(e=Ua.get(e,"O")),Ba.getMaterial(e,t)),getGLB:(e,t)=>("string"==typeof e&&(e=Ua.get(e,"O")),e||console.error("Not find Model ?")),getMaterialList:(e,t)=>("string"==typeof e&&(e=Ua.get(e,"O")),e?Ba.getMesh(e,t):console.error("Not find Model ?")),getMesh:(e,t)=>("string"==typeof e&&(e=Ua.get(e,"O")),e?Ba.getMesh(e,t):console.error("Not find Model ?")),getGroup:(e,t,s)=>("string"==typeof e&&(e=Ua.get(e,"O")),Ba.getGroup(e,t,s)),applyMorph(e,t=null,s=!0,i=!0){let n;n=e.isObject3D?e:Ua.get(e,"O"),t||(t=Ua.getMesh(e)),n&&t&&Ba.autoMorph(n,t,s,i)},uv2(e){Ba.uv2(e)},symetric(e){Ba.symetric(e)},objectSpaceNormal(e){e.material.normalMapType=St},add:(e,t,s)=>{Ua.set(e,t,s),Ua.next()},getMaterial:e=>Ua.data.get("M_"+e),texture:(e={})=>{Ua.loaderMap||(Ua.loaderMap=new Ke);let t=e.name||"";return e.url&&(t=-1!==e.url.lastIndexOf(".")?e.url.substring(e.url.lastIndexOf("/")+1,e.url.lastIndexOf(".")):e.url.substring(e.url.lastIndexOf("/")+1)),-1===t.search("_c")&&-1===t.search("_l")&&-1===t.search("_u")&&-1===t.search("_d")||(e.srgb=!0),Ua.exist(t,"texture")?Ua.get(t,"texture"):Ua.exist(t,"image")?Ua.getTexture(t,e):Ua.loaderMap.load(e.url,(function(s){return Ua.setTextureOption(s,e),Ua.data.set("T_"+t,s),e.callback&&e.callback(),s}))},getTexture:(e,t={})=>{e=(t.quality?t.quality+"k_":"")+e;let s=Ua.get(e,"texture");if(!s){let i=Ua.get(e,"image");if(!i)return null;s=new ht(i),-1===e.search("_c")&&-1===e.search("_d")&&-1===e.search("_l")&&-1===e.search("_u")||(t.srgb=!0),Ua.data.set("T_"+e,s)}return Ua.setTextureOption(s,t),s},setTextureOption:(e,t={})=>{t.encoding&&(e.colorSpace=g),t.srgb&&(e.colorSpace=g),e.flipY=void 0!==(t.flipY||t.flip)&&t.flipY,e.anisotropy=void 0!==t.anisotropy?t.anisotropy:Ua.maxAnisotropy,void 0!==t.generateMipmaps&&(e.generateMipmaps=t.generateMipmaps),t.repeat&&(e.repeat.fromArray(t.repeat),e.wrapS=e.wrapT=f),t.center&&e.center.fromArray(t.center),t.offset&&e.offset.fromArray(t.offset),t.filter&&"near"===t.filter&&(e.minFilter=ze,e.magFilter=ze),t.channel&&(e.channel=t.channel),e.needsUpdate=!0},loadAsync:(e,t="",s="")=>new Promise(((i,n)=>{Ua.waiting=!0,Ua.load(e,(()=>{Ua.waiting=!1}),t,s)})),load:(e,t,s="",i="",n=0)=>{Ua.msg=i;let r=[],a=t||function(){},o=("undefined"==typeof performance?Date:performance).now();"string"==typeof e||e instanceof String?r.push(e):r=r.concat(e),Ua.tmp.push({urls:r,path:s,callback:a,start:o,quality:n}),Ua.inLoad||Ua.loadOne()},loadOne:()=>{Ua.inLoad=!0,Ua.onLoad();let e=Ua.tmp[0].path+Ua.tmp[0].urls[0],t=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),s=e.substring(e.lastIndexOf(".")+1).toLowerCase();"jpg"!==s&&"png"!==s||(t=(Ua.tmp[0].quality?Ua.tmp[0].quality+"k_":"")+t),Ua.exist(t,s)?Ua.next():Ua.loading(e,t,s)},next:()=>{Ua.tmp[0].urls.shift(),0===Ua.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-Ua.tmp[0].start),Ua.tmp[0].callback(),Ua.tmp.shift(),Ua.tmp.length>0?Ua.loadOne():(Ua.inLoad=!1,Ua.onEnd())):Ua.loadOne()},loading:(e,t,s)=>{switch(Ua.log(Ua.msg),s){case"glb":case"gltf":Ua.load_GLTF(e,t);break;case"fbx":case"FBX":Ua.load_FBX(e,t);break;case"hdr":Ua.load_RGBE(e,t);break;case"exr":Ua.load_EXR(e,t);break;default:Ua.extand(e,t,s)}},extand:(e,t,s)=>{Ua.XHTTP||(Ua.XHTTP=new XMLHttpRequest);const i=Ua.XHTTP;switch(i.open("GET",e,!0),"json"===s&&i.overrideMimeType("application/json"),s){case"bin":case"hex":case"wasm":case"mp3":case"wav":case"ogg":i.responseType="arraybuffer";break;case"jpg":case"png":i.responseType="blob";break;case"bvh":case"glsl":case"js":case"json":i.responseType="text"}i.onreadystatechange=function(){4===i.readyState&&(i.status>=300?console.log("Error, status code = "+i.status):Ua.direct(i.response,t,s))},"onprogress"in i&&(i.onprogress=function(e){}),i.send(null)},direct:(e,t,s)=>{switch(s){case"jpg":case"png":let i=Ua.createElementNS("img");i.onload=function(e){window.URL.revokeObjectURL(i.src),Ua.add(t,i,"image")},i.src=window.URL.createObjectURL(e);break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(e.slice(0),(function(e){Ua.add(t,e,"sound")}),(function(e){console.error("decodeAudioData error",e)}));break;case"hex":case"bin":Ca.decompress(e,(e=>{Ua.add(t,e,s)}));break;case"wasm":Ua.add(t,new Uint8Array(e),s);break;case"json":Ua.add(t,JSON.parse(e),s);break;case"js":Ua.add(t,e,s);break;default:Ua.add(t,e,s)}},loaderDRACO:()=>{if(Ua.dracoLoader)return Ua.dracoLoader;if(!Ua.dracoLoaderType)if(navigator.userAgentData)Ua.dracoLoaderType="wasm";else{let e=navigator.userAgent.toLowerCase();Ua.dracoLoaderType=-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"js":"wasm"}return Ua.dracoLoader=(new Tr).setDecoderPath(Ua.dracoPath),Ua.dracoLoader.setDecoderConfig({type:Ua.dracoLoaderType}),Ua.dracoLoader},loaderGLTF:()=>(Ua.GLTF||(Ua.GLTF=new kn,Ua.GLTF.setDRACOLoader(Ua.loaderDRACO())),Ua.GLTF),loaderFBX:()=>(Ua.FBX||(Ua.FBX=new aa),Ua.FBX),loaderRGBE:()=>(Ua.RGBE||(Ua.RGBE=new Sa),Ua.RGBE),loaderEXR:()=>(Ua.EXR||(Ua.EXR=new Ra),Ua.EXR),load_GLTF:(e,t)=>{Ua.loaderGLTF().load(e,(function(e){const s=e.scene;if(e.animations){const t=e.animations,i=new Rt(e.scene);s.mixer=i,s.actions={};for(let e=0;e<t.length;e++){let n=t[e];s.actions[n.name]=i.clipAction(n)}s.play=e=>{s.actions[e]&&(s.actions[e].paused=!1,s.actions[e].time=0,s.actions[e].play())},s.pause=(e,t=!0)=>{s.actions[e]&&(s.actions[e].paused=t)}}Ua.add(t,s)}))},load_FBX:(e,t)=>{Ua.loaderFBX().load(e,(function(e){Ua.add(t,e)}))},load_RGBE:(e,t)=>{Ua.loaderRGBE().load(e,(function(e){e.mapping=yt,Ua.add(t,e)}))},load_EXR:(e,t,s)=>{Ua.loaderEXR().load(e,(function(e){return s&&s(e),e}))},direct_EXR:(e,t)=>{Ua.loaderEXR().parse(url,(function(e){return Ua.add(t,e),e}))}};class Va{constructor(e,t){this.target=t||e,this.baseGeometry=e.geometry,this.geometry=this.target.geometry,this.V=[new i,new i,new i],this.X=[new ft,new ft,new te],this.M=[new i,new i,new i],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const e=this.geometry;let t=e.attributes.position.array.length;e.setAttribute("color",new o(new Array(t).fill(0),3))}resetEdge(e){let t=e.length;for(;t--;)e[t]=0}getEdge(e,t,s=!1,i=!1){let n=e.attributes.position.array;const r=e.index.array;let a,o,l,h,c,u,p,d=this.V[0],m=this.V[1],f=this.V[2],g=0;for(i&&(n=this.getMorph()),s&&(n=this.getSkinned(n)),(s||i)&&this.resetEdge(t),a=this.indexLength;a--;)o=r[g],l=r[g+1],h=r[g+2],d.fromArray(n,3*o),m.fromArray(n,3*l),f.fromArray(n,3*h),c=d.distanceTo(m),u=d.distanceTo(f),p=m.distanceTo(f),t[o]+=.5*(c+u),t[l]+=.5*(c+p),t[h]+=.5*(u+p),g+=3}isZero(e){return 0===e.x&&0===e.y&&0===e.z}getMorph(){const e=this.target.morphTargetInfluences,t=this.geometry.morphAttributes.position,s=e.length,i=this.geometry.attributes.position.array;let n,r,a,o,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],u=this.M[2],p=this.geometry.morphTargetsRelative;for(r=l;r--;){for(n=3*r,c.fromArray(i,n),h.set(0,0,0),a=s;a--;)0!=e[a]&&(o=t[a].data?t[a].data.array:t[a].array,p?h.addScaledVector(u.fromArray(o,n),e[a]):h.addScaledVector(u.fromArray(o,n).sub(c),e[a]));c.add(h),c.toArray(this.back,n)}return this.back}getSkinned(e){const t=this.target.skeleton;t.boneMatrices;const s=this.geometry,i=s.attributes.skinIndex.array,n=s.attributes.skinWeight.array,r=this.target.bindMatrix,a=this.target.bindMatrixInverse;let o,l,h,c,u,p=this.V[0],d=this.V[1],m=this.V[2],f=this.X[0],g=this.X[1],y=this.X[2];for(o=s.attributes.position.count;o--;){for(u=3*o,f.fromArray(i,4*o),g.fromArray(n,4*o),p.fromArray(e,u).applyMatrix4(r),d.set(0,0,0),l=4;l--;)c=g.getComponent(l),c>0&&(h=f.getComponent(l),y.multiplyMatrices(t.bones[h].matrixWorld,t.boneInverses[h]),d.addScaledVector(m.copy(p).applyMatrix4(y),c));d.applyMatrix4(a),d.toArray(this.back,u)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const e=this.geometry.attributes.color.array;let t,s,i,n=this.length;for(;n--;)t=this.originEdges[n],s=(t-this.targetEdges[n])/t+.5,i=3*n,e[i]=s>.5?2*(s-.5):0,e[i+1]=0,e[i+2]=s<.5?1-2*s:0;this.geometry.attributes.color.needsUpdate=!0}}class Ha extends fe{constructor(e,s){super(),this.isReady=!1,this.skeleton=s,this.bones=this.skeleton.bones,this.root=e,this.box=new u,this.mtxr=new te,this.mtx0=new te,this.mtx1=new te,this.mtx=new te,this.mtx2=new te,this.p=new i,this.s=new i,this.q=new t,this.e=new se,this.mat=new R({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){if(!this.isReady)return;let t,s,i=this.children,n=i.length;for(this.mtxr.copy(this.root.matrixWorld).invert();n--;)t=i[n],s=t.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,s.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,t.userData.decal),this.mtx.decompose(this.p,this.q,this.s),t.position.copy(this.p),t.quaternion.copy(this.q),t.updateMatrix();super.updateMatrixWorld(e)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const e=this.bones;let t,s,n,r,a,o,l,h,c,u,p,d=new i,m=new i,f=e.length;for(t=0;t<f;t++)h=null,r=e[t],s=r.name,a=r.parent,a&&(n=a.name,d.setFromMatrixPosition(a.matrixWorld),m.setFromMatrixPosition(r.matrixWorld),l=d.distanceTo(m),c=[0,0,.5*l],o=[l,1,1],u=[0,0,0],p="_C","head"===n&&"End_head"===s&&(h="box",o=[.16,.2,l],c=[0,.025,.5*-l]),"chest"===n&&"neck"===s&&(h="box",o=[.3,.28,l],c=[0,0,.5*-l]),"abdomen"===n&&(h="box",o=[.28,.24,l+.14],u[2]=0,c=[0,0,.5*-l],c[2]+=.07),"rThigh"===n&&(h="box",o=[.15,.15,l]),"lThigh"===n&&(h="box",o=[.15,.15,l]),"rShin"===n&&(h="box",o=[.12,.12,l+.1],c[2]+=.05),"lShin"===n&&(h="box",o=[.12,.12,l+.1],c[2]+=.05),"rShldr"===n&&(h="box",o=[l+.06,.12,.12],c[0]=.03-c[2],c[2]=0),"lShldr"===n&&(h="box",o=[l+.06,.12,.12],c[0]=c[2]-.03,c[2]=0),"rForeArm"===n&&(h="box",o=[l+.1,.1,.1],c[0]=-c[2]-.05,c[2]=0),"lForeArm"===n&&(h="box",o=[l+.1,.1,.1],c[0]=c[2]+.05,c[2]=0),null!==h&&this.addMesh(a,h,o,c,u,"_C"));this.isReady=!0}addMesh(e,t,s,i,n,r){this.mtx.makeTranslation(i[0],i[1],i[2]);var a=new ne(this.box,this.mat);a.scale.fromArray(s),a.userData.decal=this.mtx.clone(),a.userData.bone=e,a.userData.size=s,this.add(a)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const ja={mixRatio:0,threshold:.1,normal:.25,hair:7675906,bow:1049602,sheen:1,sheenRoughness:1,metalness:.6,roughness:.4,vertexColors:!1,alphaTest:.3,h_metal:.6,h_rough:.5,clearcoat:1,wireframe:!1,transparent:!1,opacity:1},Ga={isBreath:!1,isEyeMove:!1,haveHair:!0,haveBlink:!0,haveMorph:!0,morphNormal:!1,morphRelative:!1,haveLOD:!0,levelHigh:["body","Head","crane","eyelash","eyebrow","tear","eye_l","eye_r","eye_l_s","eye_r_s"],levelHair:["hair","hair_man"],levelLow:["body_low"],skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_t.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg","avatar_ao.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:ja,materialRef:"skin",materials:{skin:{type:"Sss",map:"avatar_c",normalMap:"avatar_n",roughness:.54,metalness:.14,normalScale:new M(ja.normal,-ja.normal),wireframe:ja.wireframe,aoMap:"avatar_ao",aoMapIntensity:.5,ior:1.4,vertexColors:!1,sssMap:"avatar_t",sssColor:new v(15606563),sssAmbient:.5,sssDistortion:.6,sssAttenuation:.1,sssScale:6},mouth:{type:"Standard",map:"mouth_c",roughness:.6,metalness:.6,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n"},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:1,blending:_,clearcoat:1,transparent:!0,envMapIntensity:0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new M(2,-2),clearcoat:.25},hair:{type:"Standard",map:"hair",color:ja.hair,roughness:ja.h_rough,metalness:ja.h_metal,alphaMap:"hair_a",alphaTest:ja.alphaTest,side:I,opacity:1,transparent:!0,blending:kt,blendDst:U,blendDstAlpha:G,alphaToCoverage:!0},hair_man:{type:"Standard",map:"hair_man",color:ja.hair,roughness:ja.h_rough,metalness:ja.h_metal,alphaMap:"hair_man_a",alphaTest:ja.alphaTest,side:I,opacity:1,transparent:!0,blending:kt,blendDst:U,blendDstAlpha:G,alphaToCoverage:!0},eyelash:{type:"Standard",color:ja.hair,map:"eyelash_c",alphaMap:"eyelash_a",transparent:!0,opacity:1,side:I,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Standard",map:"eyelash_c",roughness:0,metalness:1,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic"}},changeMaterial:(e={},t=!1)=>{if(!Ua.getMaterial(Ga.materialRef))return;const s=Ga.setting,i=Ga.materials;let n,r=!1;for(let t in e)void 0!==s[t]&&s[t]!==e[t]&&(s[t]=e[t],r=!0);if(r)for(let s in i){n=Ua.getMaterial(s);for(let r in e)void 0!==n[r]&&(t&&i[s][r]?n[r]=i[s][r]:n[r]=e[r])}},applyMaterial:(e,t)=>{const s=!0,i=Ua.getMaterial("skin");//!Human.haveLOD;
e.traverse((e=>{if(e.isMesh)switch(e.name){case"body":e.material=i,e.receiveShadow=!0,e.castShadow=!0,e.visible=s;break;case"body_low":e.material=i,e.receiveShadow=!0,e.castShadow=!0,e.visible=!1;break;case"Head":e.material=i,e.receiveShadow=!0,e.castShadow=!0,e.visible=s;break;case"crane":e.material=i,e.receiveShadow=!0,e.castShadow=!1,e.visible=!Ga.haveHair;break;case"mouth":e.material=Ua.getMaterial("mouth")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"eyelash":case"eyebrow":e.material=Ua.getMaterial("eyelash")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"tear":e.material=Ua.getMaterial("tear")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"eye_l":case"eye_r":e.material=Ua.getMaterial("eye")||i,e.receiveShadow=!1,e.castShadow=!1;break;case"eye_l_s":case"eye_r_s":e.material=Ua.getMaterial("sub_eye")||i,e.receiveShadow=!1,e.castShadow=!1,e.visible=s;break;case"hair":e.material=Ua.getMaterial("hair")||i,e.receiveShadow=!1,e.castShadow=!0,e.matrixWorldAutoUpdate=!1,e.visible=!!Ga.haveHair&&s;break;case"hair_man":e.material=Ua.getMaterial("hair_man")||i,e.receiveShadow=!1,e.castShadow=!0,e.matrixWorldAutoUpdate=!1,e.visible=!!Ga.haveHair&&s}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,5]},{name:"rShldr",values:[-20,-2,-5]},{name:"lForeArm",values:[0,0,10]},{name:"rForeArm",values:[0,0,-10]},{name:"lHand",values:[0,15,10]},{name:"rHand",values:[0,-15,-10]},{name:"lThumb2",values:[0,25,10]},{name:"rThumb2",values:[0,-25,-10]}]},Wa={wireframe:!1,normal:.3},qa={isBreath:!1,isEyeMove:!1,haveMorph:!0,skeletonRef:"body_low",fullMorph:["MUSCLE","LOW","BIG"],textureQuality:1,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:Wa,materialRef:"skin_low",materials:{skin_low:{type:"Physical",map:"avatar_c",normalMap:"avatar_n",normalScale:new M(Wa.normal,-Wa.normal),envMapIntensity:.3,roughness:.54,metalness:.14,reflectivity:.05,wireframe:Wa.wireframe,vertexColors:!1}},changeMaterial:(e={},t=!1)=>{if(!Ua.getMaterial(qa.materialRef))return;const s=Lee.materials;let i;for(let n in s){i=Ua.getMaterial(n);for(let r in e)void 0!==i[r]&&(t&&s[n][r]?i[r]=s[n][r]:i[r]=e[r])}},applyMaterial:(e,t)=>{const s=Ua.getMaterial(qa.materialRef);e.traverse((e=>{if(e.isMesh)switch(e.name){case"body_low":e.material=s,e.receiveShadow=!0,e.castShadow=!0}}))},adjustment:()=>[{name:"neck",values:[-5,0,0]},{name:"chest",values:[5,0,0]},{name:"lCollar",values:[0,0,-10]},{name:"rCollar",values:[0,0,10]},{name:"lShldr",values:[-20,2,0]},{name:"rShldr",values:[-20,-2,0]}]},Xa={metalness:.33,roughness:.11,clearcoat:0,wireframe:!1},Ka={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg","eva_ao.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:Xa,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:Xa.roughness,metalness:Xa.metalness,wireframe:Xa.wireframe,clearcoat:Xa.clearcoat,aoMap:"eva_ao"},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:Xa.roughness,metalness:Xa.metalness,wireframe:Xa.wireframe,clearcoat:Xa.clearcoat,aoMap:"eva_ao"},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:Xa.roughness,metalness:Xa.metalness,wireframe:Xa.wireframe,clearcoat:Xa.clearcoat,aoMap:"eva_ao"}},changeMaterial:(e,t=!1)=>{if(!Ua.getMaterial(Ka.materialRef))return;const s=Ka.materials;let i;for(let n in s){i=Ua.getMaterial(n);for(let r in e)void 0!==i[r]&&(t&&s[n][r]?i[r]=s[n][r]:i[r]=e[r]);i.needsUpdate=!0}},applyMaterial:(e,t)=>{const s=Ua.getMaterial(t);e.traverse((e=>{if(e.isMesh)switch(e.material=s,e.receiveShadow=!0,e.castShadow=!0,e.name){case"eva_2_head":case"eva_2_mach":e.visible="eva02"===t;break;case"eva_L_COLLAR":case"eva_R_COLLAR":e.visible="eva00"!==t;break;case"eva_HEAD":case"eva_MACHOIR":e.visible="eva01"===t;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":e.visible="eva00"===t;break;case"eva_0_CHEST2":e.visible="eva01"!==t}}))}},Za={metalness:.2,roughness:.8,wireframe:!1},Ya={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:Za,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:Za.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:(e,t=!1)=>{if(!Ua.getMaterial(Ya.materialRef))return;const s=Ya.materials;let i;for(let n in s){i=Ua.getMaterial(n);for(let r in e)void 0!==i[r]&&(t&&s[n][r]?i[r]=s[n][r]:i[r]=e[r])}},applyMaterial:(e,t)=>{const s=Ua.getMaterial("lee_material");e.traverse((e=>{e.isMesh&&(e.material=s,e.receiveShadow=!0,e.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},Qa=Math.PI/180,Ja=180/Math.PI,$a=new i,eo={tmp:[],model:[],avatar:null,callback:()=>{},add:(e,t)=>{eo.tmp=[...e],eo.callback=t,eo.tmp.length&&eo.loadOne()},loadOne:()=>{let e=eo.tmp[0];eo.avatar=new to({type:e,callback:eo.next,morph:!0,isPreload:!0})},next:e=>{eo.avatar.dispose(),eo.tmp.shift(),0===eo.tmp.length?eo.callback():eo.loadOne()}};class to extends it{constructor(e={}){switch(super(),this.isPreload=e.isPreload||!1,this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.rootPath=e.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",Ua.dracoPath=this.rootPath+"src/libs/draco/",this.callback=e.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.randomMorph=e.randomMorph||!1,this.model=e.type||"man",this.startAnimation=e.anim||"idle",this.ref=null,this.model){case"lee":this.ref=Ya;break;case"man":case"woman":this.ref=Ga;break;case"man_low":case"woman_low":this.ref=qa;break;case"eva00":case"eva01":case"eva02":this.ref=Ka}this.compact=void 0===e.compact||e.compact,this.haveMorph=void 0!==e.morph&&e.morph,this.fullMaterial=void 0===e.material||e.material,this.size=e.size||1,this.fullMorph=this.ref.fullMorph||[],this.randomMorph&&this.fullMorph.length&&(this.haveMorph=!0),this.textureQuality=this.ref.textureQuality||0,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.haveBlink=this.ref.haveBlink||!1,this.haveLOD=this.ref.haveLOD||!1,e.noLOD&&(this.ref.haveLOD=!1,this.haveLOD=!1),this.lod=-1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new t).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new i,this.eyeTarget=new it,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new te,this.tmpQ=new t,this.setting={},this.root=Ua.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=Sn(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}load(){if(this.ref.textures&&this.ref.textures.length)if(this.skin=Ua.getTexture(this.ref.textureRef,{quality:this.textureQuality}),this.skin)this.loadModels();else{const e=this.rootPath+this.ref.texturePath+(this.textureQuality?this.textureQuality+"k/":"");Ua.load(this.ref.textures,this.loadModels.bind(this),e,"loading images...",this.textureQuality)}else this.loadModels()}loadModels(){const e=this.ref.forceModel?this.ref.forceModel:this.model,t=[e+".glb"],s=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&t.push(e+"_morph.glb"),Ua.load(t,this.init.bind(this),s,"loading models...")}update(e){this.done&&this.mixer&&(this.mixer.update(e),this.haveBlink&&this.eyeBlink(),this.isClone||(this.look(10*e),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),window.gui&&window.gui.updateTimeBarre&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax))}eyeBlink(){const e=this.n++;let t=0;e<=10&&(t=.1*e),e>10&&e<=20&&(t=1-.1*(e-10)),this.n>500&&(this.n=0),this.setMorph("EyeBlink",t)}look(e){if(!this.isEyeMove)return;if(this.isPause)return;const t=window.mouse||{x:0,y:0};e>1&&(e=1),this.headBoneLook.lerp({x:-20*t.y*Qa,y:0,z:-20*t.x*Qa},e),this.eyeTarget.position.lerp({x:.5*t.x,y:1,z:.25*-t.y},e);let s=this.headBoneLook;this.tmpQ.setFromEuler({_x:s.x,_y:s.y,_z:s.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let i=this.bones.ER,n=this.bones.EL,r={x:0,y:0,z:1};this.tmpMtx.lookAt(n.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),r),n.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(i.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),r),i.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let e=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,e),this.lerp(1,1.04,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,e),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,e),this.lerp(1.04,1,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,e),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(e,t,s){this.position.set(e,t,s),this.updateMatrix()}setRotation(e,t,s,i){let n=this.lerp(this.rotation.y,t,i);this.rotation.set(e,n,s),this.updateMatrix()}lerp(e,t,s){return(1-s)*e+s*t}onReady(){}initMaterial(){if(Ua.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void Ua.set(this.ref.materialRef,new A);let e,t,s;for(const i in this.ref.materials){s={...this.ref.materials[i]},t=s.type,delete s.type;for(const e in s)"envMapIntensity"!==e&&"normalMapType"!==e&&"aoMapIntensity"!==e&&"aoMapIntensity"!==e&&("map"!==e&&-1===e.search("Map")||(s[e]=Ua.getTexture(s[e],{quality:this.textureQuality})));"Basic"===t?e=new R(s):"Standard"===t?e=new A(s):"Physical"===t?e=new y(s):"Sss"===t&&(e=new rs(s)),e.name=i,Ua.set(i,e)}this.setting=this.ref.setting}setMaterial(e,t){}getMaterial(e){return Ua.getMaterial(e)}init(){this.initMaterial(),this.isClone||(this.root=Ua.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.ref.applyMaterial(this.root,this.model)),this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.root.traverse(function(e){e.raycast=function(){},e.isMesh&&(e.name===this.ref.skeletonRef&&(e.matrixAutoUpdate=!1,this.skeleton=e.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling()),this.mesh[e.name]=e),e.isBone&&(this.bones[e.name]=e)}.bind(this)),this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let e in this.mesh)this.mesh[e].isSkinnedMesh&&e!==this.ref.skeletonRef&&(this.mesh[e].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&Ua.applyMorph(this.model+"_morph",this.mesh,this.ref.morphNormal,this.ref.morphRelative),Ua.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new Rt(this),0===Ua.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let e=Ua.clip.length;for(;e--;)this.addAction(Ua.clip[e]);this.start()}}setSize(e){this.size=e,this.root.scale.set(1,1,1).multiplyScalar(this.size)}addTensionMap(){this.tension1=new Va(this.mesh.body),this.tension2=new Va(this.mesh.Head)}setBounding(e){for(let t in this.mesh)this.mesh[t].isMesh&&(this.mesh[t].geometry.boundingSphere.radius=e)}setLevel(e){this.haveLOD&&this.lod!==e&&(this.lod=e,this.hideAll(),0===this.lod?this.setVisible(this.ref.levelLow,!0):(this.setVisible(this.ref.levelHigh,!0),this.ref.haveHair&&(this.mesh.body.visible=!1,this.setVisible(this.ref.levelHair,!0))))}hideAll(){for(let e in this.mesh)this.mesh[e].visible=!1}setVisible(e,t){"string"==typeof e&&(e=[e]);let s,i=e.length;for(;i--;)s=e[i],this.mesh[s]&&(this.mesh[s].visible=t)}setMorph(e,t){this.haveMorph&&(this.morpher("eyelash",e,t),this.morpher("eyebrow",e,t),this.morpher("tear",e,t),this.morpher("mouth",e,t),this.morpher("body",e,t),this.morpher("Head",e,t),this.morpher("body_low",e,t))}morpher(e,t,s){this.mesh[e]&&this.mesh[e].morphTargetInfluences&&void 0!==this.mesh[e].morphTargetDictionary[t]&&(this.mesh[e].morphTargetInfluences[this.mesh[e].morphTargetDictionary[t]]=s)}lerp(e,t,s){return(1-s)*e+s*t}clone(e){return new this.constructor({type:e.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent&&this.parent.remove(this),this.isClone}start(){if(this.isPreload)this.callback();else if(!this.done){if(this.done=!0,this.onReady(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment(),!0),this.randomMorph){let e=this.fullMorph.length;for(;e--;)this.setMorph(this.fullMorph[e],.62*Math.random());this.setSize(.1*Math.random()-.05+1)}setTimeout(function(){this.add(this.root),this.callback()}.bind(this),100)}}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new Ct(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new Ha(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(e,t){e.matrix=t.matrixWorld,e.matrixAutoUpdate=!1}loadAnimationJson(e,t){const s=new XMLHttpRequest;s.open("GET",e,!0),s.onreadystatechange=function(){if(4===s.readyState&&(200===s.status||0===s.status)){let e=JSON.parse(s.responseText);this.urls=[];for(let t in e)"main"===t?this.urls.push(...e[t]):this.urls.push(...e[t].map((e=>t+"/"+e)));this.endCallback=t||function(){},this.loadOne()}}.bind(this),s.send()}loadOne(){let e=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+e+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(e="./assets/models/animations.bin"){var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer";const s={animations:[]},i=this;t.onload=function(){Ca.decompress(t.response,(e=>{const t=JSON.parse(e);for(let e in t)s.animations.push(at.parse(t[e]));i.applydAnimation(s),i.start()}))},t.send()}loadAnimationGlb(e,t){let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));Ua.loaderGLTF().load(e,function(e){this.applydAnimation(e,s),t&&t()}.bind(this),null,t)}directGlb(e,t){Ua.loaderGLTF().parse(e,"",function(e){this.stop(),this.applydAnimation(e,t)}.bind(this))}loadAnimationFbx(e,t){let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));Ua.loaderFBX().load(e,function(e){this.convertFbx(s,e.animations[0]),t&&t()}.bind(this),null,t)}directFbx(e,t){try{let s=Ua.loaderFBX().parse(e,"");this.convertFbx(t,s.animations[0],!0)}catch(e){console.error("bug",e)}}applydAnimation(e,t){let s=e.animations.length,i=!1;for(1===s&&(t&&(e.animations[0].name=t),i=!0);s--;)this.addClip(e.animations[s]),this.addAction(e.animations[s],i)}addClip(e,t=!1){t&&It.makeClipAdditive(e);let s=Ua.clip.length,i=-1;for(;s--;)Ua.clip[s].name===e.name&&(i=s);-1!==i&&Ua.clip.slice(i,1),Ua.clip.push(e)}addAction(e,t){const s=this.mixer.clipAction(e);s.frameMax=Math.round(30*e.duration),s.play(),s.enabled=!0,-1!==e.name.search("idle")&&(s.enabled=!0),"Jumping Up"===e.name&&(s.loop=LoopPingPong),this.actions.set(e.name,s),-1!==e.name.search("walk")&&this.clipsToesFix.push(e.name),-1!==e.name.search("run")&&this.clipsToesFix.push(e.name),-1!==e.name.search("strafe")&&this.clipsToesFix.push(e.name),-1!==e.name.search("jog")&&this.clipsToesFix.push(e.name),-1!==e.name.search("RUN")&&this.clipsToesFix.push(e.name),window.gui&&window.gui.getAnimation&&window.gui.getAnimation()}getAnimation(e=!1,t=!1){let s=[],i=0;if(t){let t=Ua.clip.length;for(;t--;)s[i]=e?Ua.clip[i].toJSON():Ua.clip[i],i++}else this.actions.forEach((function(t,n){s[i]=e?t._clip.toJSON():t._clip,i++}));return s}exportAnimationLzma(e){this.lzma||(this.lzma=new Ca(this.lzmaPath));const t=this.getAnimation(!0);this.lzma.compress(JSON.stringify(t),2,(function(t){if(e)e({name:"animations",data:new Uint8Array(t),type:"bin"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"application/octet-stream"})),e.download="animations.bin",e.click()}}))}exportGLB(e){this.exporter||(this.exporter=new _i);const t=this.getAnimation();this.exporter.parse(this.root,(function(t){if(e)e({name:"model",data:t,type:"glb"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([t],{type:"application/octet-stream"})),e.download="model.glb",e.click()}}),null,{animations:t,binary:!0,onlyVisible:!0})}armAngle(){}autoToes(){if(!this.fixToe)return;let e=this.getRot("rFoot"),t=this.getRot("lFoot"),s=this.getWorldPos("hip"),i=this.getWorldPos("rToes"),n=this.getWorldPos("lToes");e[0]>0&&i.z-s.z<0?this.setRot("rToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("rToes",0,0,0),t[0]>0&&n.z-s.z<0?this.setRot("lToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(e,s,n){const r=Math.PI/180;let a=new i,o=new t,l=(new t).setFromAxisAngle({x:1,y:0,z:0},90*r);const h=s.tracks,c=[];let u,p,d,m,f=h.length,g=0;for(;f--;){if(d=h[g],m=d.name.substring(0,d.name.lastIndexOf(".")),"hip.position"===d.name){let e=[];for(u=d.values.length/3;u--;)p=3*u,a.set(d.values[p],d.values[p+1],0).multiplyScalar(.01),a.toArray(e,p);c.push(new ct(d.name,d.times,e))}else{let e=[];for(u=d.values.length/4;u--;)p=4*u,"hip"===m?o.set(d.values[p],d.values[p+1],d.values[p+2],d.values[p+3]).multiply(l):o.set(d.values[p],d.values[p+2],-d.values[p+1],d.values[p+3]),o.toArray(e,p);c.push(new pt(d.name,d.times,e))}g++}let y=new at(e,-1,c);y.duration=s.duration,this.stop(),this.addClip(y),this.addAction(y,n)}makePoseTrack(e,s,i=!1){const n=Math.PI/180;let r=new t;const a=s,o=[];let l,h,c,u,p=a.length,d=0;for(;p--;){u=a[p],u.name;let e=[],t=[];for(d=0,l=3;l--;)h=0,c=4*d,t.push(.03333333507180214*d),r.setFromEuler({_x:u.values[0]*n,_y:u.values[1]*n,_z:u.values[2]*n,_order:"XYZ"}),r.toArray(e,c),d++;o.push(new pt(u.name+".quaternion",t,e))}let m=new at(e,-1,o,i?Et:Pt);m.duration=.10000000521540642;const f=this.mixer.clipAction(m);f.enabled=!0,f.setEffectiveTimeScale(1),f.setEffectiveWeight(1),f.play()}prepareCrossFade(e,t,s){this.isPause=!1,this.unPause(),"idle"!==t._clip.name?this.executeCrossFade(e,t,s):this.synchronizeCrossFade(e,t,s)}synchronizeCrossFade(e,t,s){this.mixer.addEventListener("loop",(function n(r){r.action===e&&(i.mixer.removeEventListener("loop",n),i.executeCrossFade(e,t,s))}));const i=this}executeCrossFade(e,t,s,i=!0){this.setWeight(t,1),t.time=0,e.crossFadeTo(t,s,!0)}pause(){this.actions.forEach((function(e){e.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(e){e.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(e){e.play()}))}setTimescale(e){this.actions.forEach((function(t){t.setEffectiveTimeScale(e)}))}syncro(e){let t=this.getAction(e);if(!t)return;let s=t.time;this.actions.forEach((function(e){e.time=s}))}setWeight(e,t){e.enabled=!0,t<0&&(t=0),t>1&&(t=1),e.setEffectiveWeight(t)}getAnimInfo(e){let t=this.getAction(e);if(t)return{name:e,time:t.time,frame:Math.round(30*t.time),frameMax:t.frameMax,timeScale:t.timeScale}}getAction(e){return this.actions.get(e)}play(e,t=.5){let s=this.getAction(e);if(!s)return!1;if(this.current){if(this.current!==s){this.old=this.current,this.current=s;let i="idle"!==this.current.getClip().name;-1!==this.clipsToesFix.indexOf(e)?this.fixToe=!0:this.resetToes();const n=this.current.getClip().duration/this.old.getClip().duration;this.current.reset(),i||(this.current.time=this.old.time*n),this.fixWeight?(this.current.weight=1,this.current.stopFading(),this.old.stopFading(),this.old._scheduleFading(t,this.old.getEffectiveWeight(),0),this.current._scheduleFading(t,this.current.getEffectiveWeight(),1)):this.executeCrossFade(this.old,this.current,t)}}else this.stop(),this.current=s,s.setEffectiveWeight(1);return this.isPause=!1,!0}playFrame(e,t,s=1){let i=this.getAction(e);i&&(i.time=.03333333333333333*t,i.setEffectiveWeight(s),i.play(),i.paused=!0,this.isPause=!0)}playOne(e,t=1){this.current&&(this.current.time=.03333333333333333*e,this.current.setEffectiveWeight(t),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(e){e.setEffectiveWeight(0)}))}setRot(e,t,s,i){let n=this.bones[e];n&&(n.rotation.set(t*Qa,s*Qa,i*Qa,"XYZ"),n.updateMatrix())}setRot2(e,s,i,n){let r=this.bones[e];if(!r)return;let a=(new t).setFromEuler({_x:s*Ja,_y:i*Ja,_z:n*Ja,_order:"XYZ"}).invert();r.quaternion.premultiply(a),r.updateMatrix()}getRot(e){let t=this.bones[e];if(!t)return;let s=t.rotation.toArray();return[Math.round(s[0]*Ja),Math.round(s[1]*Ja),Math.round(s[2]*Ja)]}getWorldPos(e){let t=this.bones[e];if(t)return $a.set(0,0,0),t.localToWorld($a),{x:$a.x,y:$a.y,z:$a.z}}bodyMask(e={arm:!0,leg:!0,foot:!0,chest:!0}){let t=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const s=this.canvas.getContext("2d");s.fillStyle="#FFFFFF",s.fillRect(0,0,256,256),s.fillStyle="black",e.arm&&s.fillRect(196,112,59,46.5),e.leg&&s.fillRect(128,183.5,71.75,72.5),e.foot&&s.fillRect(817*t,205.5,51.5,50),e.chest&&(s.fillRect(120,144,75,40),s.fillRect(553*t,116.5,57,27.5),s.fillRect(533*t,531*t,5,45*t));let i=new Image;i.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new ht(i),this.mask.flipY=!1,this.mask.needsUpdate=!0;const n=Ua.getMaterial("skin");n.alphaTest=.9,n.alphaMap=this.mask}zeroColor(e){e.isMesh&&(e=e.geometry);let t=e.attributes.position.array.length;e.setAttribute("color",new o(new Array(t).fill(0),3))}}const so=new te,io=new i,no=new t,ro=new i;class ao extends fe{constructor(e){super(),this.prefix=e.name||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=e.model.skeleton.bones,this.model=e.model.root,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==Zt.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.init()}setMode(e){if(e===this.mode)return;this.mode=e;const t=[];let s,i="follow"===this.mode,n=this.nodes.length;for(;n--;)s=this.nodes[n],t.push({name:s.name,kinematic:i}),s.kinematic=i,s.bone.isPhysics=!i;Zt.motor.change(t)}freeBone(e){e.kinematic&&(e.cc++,20===e.cc&&(e.cc=0,e.kinematic=!1,e.bone.isPhysics=!0,Zt.motor.change({name:e.name,kinematic:!1})))}isVisible(e){let t=this.nameList.length;for(;t--;)Yt.byName(this.nameList[t]).visible=e;let s=[];for(t=this.jointList.length;t--;)s.push({name:this.jointList[t],visible:e});Zt.motor.change(s)}init(){this.useSolver&&(this.solver=Zt.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0}));const e=[];let s,n,r,a,o,l,h,c,u,p,d,m,f,g=new i,y=new i,v=new t,w=new se,x=new te,b=new te,M=new te,A=new i,T=new i,S=this.bones.length;for(s=0;s<S;s++)if(u=null,a=this.bones[s],n=a.name,o=a.parent,o&&(r=o.name,A.setFromMatrixPosition(o.matrixWorld),T.setFromMatrixPosition(a.matrixWorld),h=A.distanceTo(T),d=[0,0,.5*h],l=[h,1,1],c=null,p=!0,f=!1,"hip"===r&&"abdomen"===n&&(u="capsule",l=[1.8*h,.08],d=[0,0,.5*-h],c=[0,0,90]),"abdomen"===r&&"chest"===n&&(u="capsule",l=[.7*h,.08],d=[0,0,.5*-h-.06],c=[90,0,0]),"chest"===r&&"neck"===n&&(u="capsule",l=[.4*h,.04],d=[0,0,.5*-h-.02],c=[0,0,90]),"neck"===r&&"head"===n&&(u="capsule",l=[.06,h],d=[0,0,.5*-h],c=[90,0,0]),"head"===r&&"End_head"===n&&(u="capsule",l=[.1,h-.17],d=[0,.02,.5*-h+.02],c=[90,0,0]),"chest"===r&&"rBreast"===n&&"HAVOK"!==Zt.engine&&(r="rBreast",o=a,u="sphere",l=[.065],d=[.065,0,0],this.breast=!0,f=!0),"chest"===r&&"lBreast"===n&&"HAVOK"!==Zt.engine&&(r="lBreast",o=a,u="sphere",l=[.065],d=[.065,0,0],this.breast=!0,f=!0),"lCollar"===r&&"lShldr"===n&&(u="capsule",l=[.05,.3*h],d=[.6*h,0,0],c=[0,0,90]),"lShldr"===r&&"lForeArm"===n&&(u="capsule",l=[.05,h],d=[.5*h,0,0],c=[0,0,90]),"lForeArm"===r&&"lHand"===n&&(u="capsule",l=[.04,h],d=[.5*h,0,0],c=[0,0,90]),"lHand"===r&&"lMid1"===n&&(u="box",l=[2*h,.09,.05],d=[h,0,0]),"rCollar"===r&&"rShldr"===n&&(u="capsule",l=[.05,.3*h],d=[.6*-h,0,0],c=[0,0,90]),"rShldr"===r&&"rForeArm"===n&&(u="capsule",l=[.05,h],d=[.5*-h,0,0],c=[0,0,90]),"rForeArm"===r&&"rHand"===n&&(u="capsule",l=[.04,h],d=[.5*-h,0,0],c=[0,0,90]),"rHand"===r&&"rMid1"===n&&(u="box",l=[2*h,.09,.05],d=[-h,0,0]),"lThigh"===r&&(u="capsule",l=[.08,h],c=[90,0,0]),"lShin"===r&&(u="capsule",l=[.065,h],c=[90,0,0]),"lFoot"===r&&(u="capsule",l=[.05,h],d=[0,.5*h-.025,.04]),"rThigh"===r&&(u="capsule",l=[.08,h],c=[90,0,0]),"rShin"===r&&(u="capsule",l=[.065,h],c=[90,0,0]),"rFoot"===r&&(u="capsule",l=[.05,h],d=[0,.5*h-.025,.04]),this.withFinger&&("lHand"===r&&"lMid1"===n&&(u="box",l=[h,.09,.05],d=[.5*h,0,0]),"rHand"===r&&"rMid1"===n&&(u="box",l=[h,.09,.05],d=[.5*-h,0,0]),"rThumb1"===r&&"rThumb2"===n&&(u="capsule",l=[.02,h],c=[0,0,90]),"rThumb2"===r&&"rThumb3"===n&&(u="capsule",l=[.02,h],c=[0,0,90]),"rHand"===r&&"rMid1"===n&&(u="capsule",l=[.02,h],c=[0,0,90],d=[.6*-h,0,0]),"rMid1"===r&&"rMid2"===n&&(u="capsule",l=[.02,h],c=[0,0,90],d=[.6*-h,0,0]),"rMid2"===r&&"rMid3"===n&&(u="capsule",l=[.02,h],c=[0,0,90],d=[.6*-h,0,0])),null!==u)){m=this.prefix+"_bone_"+r,b.makeTranslation(d[0],d[1],d[2]),c&&(M.makeRotationFromEuler(w.set(c[0]*Dt,c[1]*Dt,c[2]*Dt)),b.multiply(M)),x.copy(o.matrixWorld),x.decompose(g,v,y),this.posRef[m]=g.toArray(),"lForeArm"!==r&&"rForeArm"!==r||(no.setFromAxisAngle({x:0,y:1,z:0},-90*Dt),v.multiply(no)),this.quatRef[m]=v.toArray(),x.multiplyMatrices(o.matrixWorld,b),x.decompose(g,v,y);let t={name:m,density:1,type:u,size:Bt.scaleArray(l,1,3),pos:g.toArray(),quat:v.toArray(),kinematic:true,friction:.5,restitution:.1,group:1,mask:3,material:"bones2",shadow:!1,neverSleep:!0,helper:!0,hcolor:[.87,.76,.65],hcolor2:[.9,.77,.64]};e.push(t),this.nameList.push(m),this.nodes.push({name:m,kinematic:true,motion:f,bone:o,decal:b.clone(),decalinv:b.clone().invert(),quat:v.toArray(),pos:g.toArray(),cc:0})}Zt.motor.add(e),this.addLink(),this.ready=!0}addLink(){let e=[.05,1,0];"PHYSX"===Zt.engine&&(e=[50,10,0,.5]);let t=this.prefix+"_bone_",s=[],i={type:"joint",mode:"d6",visible:!1,lm:[["ry",-180,180,...e],["rz",-180,180,...e]],collision:!1,helperSize:.05,autoDrive:!0},n=[-.001,.001,100,.2,.5];s.push({...i,b1:t+"hip",b2:t+"abdomen",worldPos:this.posRef[t+"abdomen"],worldQuat:this.quatRef[t+"hip"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),s.push({...i,b1:t+"abdomen",b2:t+"chest",worldPos:this.posRef[t+"chest"],worldQuat:this.quatRef[t+"chest"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),s.push({...i,b1:t+"chest",b2:t+"neck",worldPos:this.posRef[t+"neck"],worldQuat:this.quatRef[t+"neck"],lm:[["rx",-60,60,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),s.push({...i,b1:t+"neck",b2:t+"head",worldPos:this.posRef[t+"head"],worldQuat:this.quatRef[t+"head"],lm:[["rx",-60,60,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),s.push({...i,b1:t+"chest",b2:t+"rCollar",worldPos:this.posRef[t+"rCollar"],worldQuat:this.quatRef[t+"rCollar"],lm:[["rx",-10,10,...e],["ry",-10,10,...e],["rz",-10,10,...e]]}),s.push({...i,b1:t+"chest",b2:t+"lCollar",worldPos:this.posRef[t+"lCollar"],worldQuat:this.quatRef[t+"lCollar"],lm:[["rx",-10,10,...e],["ry",-10,10,...e],["rz",-10,10,...e]]}),s.push({...i,b1:t+"rCollar",b2:t+"rShldr",worldPos:this.posRef[t+"rShldr"],worldQuat:this.quatRef[t+"rShldr"]}),s.push({...i,b1:t+"lCollar",b2:t+"lShldr",worldPos:this.posRef[t+"lShldr"],worldQuat:this.quatRef[t+"lShldr"]}),s.push({...i,b1:t+"rShldr",b2:t+"rForeArm",worldPos:this.posRef[t+"rForeArm"],worldQuat:this.quatRef[t+"rForeArm"],lm:[["rx",0,160,...e]]}),s.push({...i,b1:t+"lShldr",b2:t+"lForeArm",worldPos:this.posRef[t+"lForeArm"],worldQuat:this.quatRef[t+"lForeArm"],lm:[["rx",0,160,...e]]}),s.push({...i,b1:t+"rForeArm",b2:t+"rHand",worldPos:this.posRef[t+"rHand"],worldQuat:this.quatRef[t+"rHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),s.push({...i,b1:t+"lForeArm",b2:t+"lHand",worldPos:this.posRef[t+"lHand"],worldQuat:this.quatRef[t+"lHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),s.push({...i,b1:t+"hip",b2:t+"rThigh",worldPos:this.posRef[t+"rThigh"],worldQuat:this.quatRef[t+"rThigh"]}),s.push({...i,b1:t+"hip",b2:t+"lThigh",worldPos:this.posRef[t+"lThigh"],worldQuat:this.quatRef[t+"lThigh"]}),s.push({...i,b1:t+"rThigh",b2:t+"rShin",worldPos:this.posRef[t+"rShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[t+"rShin"]}),s.push({...i,b1:t+"lThigh",b2:t+"lShin",worldPos:this.posRef[t+"lShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[t+"lShin"]}),s.push({...i,b1:t+"rShin",b2:t+"rFoot",worldPos:this.posRef[t+"rFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[t+"rFoot"]}),s.push({...i,b1:t+"lShin",b2:t+"lFoot",worldPos:this.posRef[t+"lFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[t+"lFoot"]}),this.breast&&(s.push({...i,b1:t+"chest",b2:t+"rBreast",worldPos:this.posRef[t+"rBreast"],worldQuat:this.quatRef[t+"rBreast"],lm:[["x",...n],["y",...n],["z",...n]]}),s.push({...i,b1:t+"chest",b2:t+"lBreast",worldPos:this.posRef[t+"lBreast"],worldQuat:this.quatRef[t+"lBreast"],lm:[["x",...n],["y",...n],["z",...n]]}));let r=0;for(let e in s)s[e].name=this.prefix+"_joint_"+r,this.nameList.push(s[e].name),this.jointList.push(s[e].name),r++;Zt.motor.add(s)}updateMatrixWorld(e){if(!this.ready)return;let t=[];const s=this.nodes;let i,n,r,a=s.length;for(;a--;)i=s[a],n=i.bone,i.kinematic?(so.multiplyMatrices(n.matrixWorld,i.decal),so.decompose(io,no,ro),i.pos=io.toArray(),i.quat=no.toArray(),t.push({name:i.name,pos:i.pos,quat:i.quat}),i.motion&&this.freeBone(i)):(r=Yt.byName(i.name),r&&(so.copy(r.matrixWorld).multiply(i.decalinv),n.phyMtx.copy(so),n.isPhysics=!0));0!==t.length&&Zt.motor.change(t,!0)}dispose(){Zt.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}class oo extends Cs{constructor(){super(),this.Utils=Yt,this.type="character",this.num=Xt[this.type]}step(){const e=Zt.Ar,t=Zt.ArPos[this.type];let s,i,n=this.list.length;for(;n--;)i=this.list[n],s=t+n*this.num,i.step(e,s)}add(e={}){this.setName(e);return new lo(e)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}class lo extends Gs{constructor(e={}){super(),e.radius=void 0!==e.radius?e.radius:.3,e.height=void 0!==e.height?e.height:1.8;this.option={debug:!1,capsuleHalfHeight:.5*e.height,capsuleRadius:e.radius,floatHeight:.3,characterInitDir:0,camInitDis:-5,camMaxDis:-7,camMinDis:-.7,maxVelLimit:2.5,turnVelMultiplier:.2,turnSpeed:15,sprintMult:2,jumpVel:4,jumpForceToGroundMult:5,slopJumpMult:.25,sprintJumpMult:1.2,airDragMultiplier:.2,dragDampingC:.15,accDeltaTime:8,rejectVelMult:4,moveImpulsePointY:.5,camFollowMult:11,fallingGravityScale:2.5,fallingMaxVel:-20,wakeUpDelay:200,rayOriginOffest:{x:0,y:.5*-e.height,z:0},rayHitForgiveness:.1,rayLength:e.radius+2,rayDir:{x:0,y:-1,z:0},floatingDis:e.radius+.3,springK:1.2,dampingC:.08,showSlopeRayOrigin:!1,slopeMaxAngle:1,slopeRayOriginOffest:e.radius-.03,slopeRayLength:e.radius+3,slopeRayDir:{x:0,y:-1,z:0},slopeUpExtraForce:.1,slopeDownExtraForce:.2,autoBalance:!0,autoBalanceSpringK:.3,autoBalanceDampingC:.03,autoBalanceSpringOnY:.3,autoBalanceDampingOnY:.02,animated:!1},this.v={movingObjectVelocityInCharacterDir:new i,pivotPosition:new i,modelEuler:new se,modelQuat:new t,moveImpulse:new i,impulseCenter:new i,movingDirection:new i,moveAccNeeded:new i,jumpVelocityVec:new i,jumpDirection:new i,currentVel:new i,currentPos:new i,dragForce:new i,dragAngForce:new i,wantToMoveVel:new i,rejectVel:new i,springDirVec:new i,characterMassForce:new i,slopeAngle:null,actualSlopeAngle:null,actualSlopeNormal:new i,actualSlopeNormalVec:new i,floorNormal:new i(0,1,0),slopeRayorigin:new i,canJump:!1,run:!1,isOnMovingObject:!1},this.useImpulse=!1,this.fixWeight=void 0===e.fixWeight||e.fixWeight,this.type="character",this.name=e.name||"hero",e.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.moving=!1,this.radius=e.radius||.3,this.height=e.height||1.8,delete e.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-this.height,this.maxRayDistance=this.height,this.contact=!1,this.tmpV1=new i,this.tmpV2=new i,this.ease=new i,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.timeScale=1.25,this.angle=(e.angle||0)*Dt,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=e.ray||!1,this.callback=e.callback||function(){},e.callback&&delete e.callback,this.init(e)}init(e){e.size||(e.size=[this.radius,this.height-2*this.radius]),e.pos||(e.pos=[0,.5*this.height,0]),this.py=.5*-this.height,this.globalRay&&Zt.items.body.geometry({...e,type:"capsule",ray:!0},this,Ts.get("hide")),e.type="character",e.shapeType=e.shapeType||"capsule",e.density=e.density||1,e.friction=.5,e.angularFactor=[0,0,0],e.group=16,e.regular=!0,e.filter=[1,-1,[1,3,4,5,9],0],e.noGravity=!0,e.volume=Bt.getVolume("capsule",e.size),Zt.items.character.addToWorld(this,e.id),Zt.post({m:"add",o:e}),this.ray=Zt.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name}),e.gender?this.addModel(e):this.showHelper(!0)}selfRay(e){e.hit?(this.distance=Bt.toFixed(e.distance-this.radius),this.rayAngle=e.angle):(this.distance=this.maxRayDistance,this.rayAngle=0)}hit(e){this.contact=e}showHelper(e){e?this.helper||(this.helper=new fi(this.radius,this.height,!0,Ts.get("line"),[1,.6,0],[.6,.2,0]),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=e)}addSkeleton(){this.skeletonBody||(this.skeletonBody=new ao(this),Zt.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(e){this.skeletonBody&&this.skeletonBody.isVisible(e),this.model&&this.model.setMaterial({wireframe:e,transparent:e,opacity:e?.3:1},!e),this.showHelper(e)}setMode(e){this.skeletonBody&&this.skeletonBody.setMode(e)}addModel(e){this.model=new to({type:e.gender,anim:void 0!==e.anim?e.anim:"idle",compact:!0,material:!e.noMat,morph:e.morph||!1,randomMorph:e.randomMorph||!1,callback:this.callback,fixWeight:this.fixWeight,noLOD:e.noLOD||!1}),this.add(this.model),this.model.setPosition(0,this.py+this.model.decalY,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(e,t){this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.velocity.fromArray(e,t+8),this.angular.fromArray(e,t+11),this.fall=this.position.y<this.oy,this.floor=Bt.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.updateMatrix(),this.model&&(this.model.update(Zt.delta),this.getDistanceToCamera())}getDistanceToCamera(){if(!this.model)return;if(!this.model.haveLOD)return;const e=Zt.motor.getCamera();this.tmpV1.copy(Zt.motor.getCurrentCharacterPosition()),this.tmpV2.copy(this.position);let t=this.tmpV1.distanceTo(this.tmpV2)/e.zoom>3?0:1;this.model.setLevel(t)}set(e){e.morph&&this.model&&this.model.setMorph(e.morph,e.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper(),super.dispose()}onFrame(e,t){this.v,this.option}autoBalance(){const e=this.v,t=this.option,s=this.rotation;e.dragAngForce.set(-t.autoBalanceSpringK*s.x-this.angular.x*t.autoBalanceDampingC,-t.autoBalanceSpringK*s.y-this.angular.y*t.autoBalanceDampingOnY,-t.autoBalanceSpringK*s.z-this.angular.z*t.autoBalanceDampingC)}moveImpulse(){const e=this.v,t=this.option,s=Zt.motor.getKey();Zt.motor.getAzimut(),Zt.delta,e.run=0!==s[7],e.actualSlopeAngle<1&&Math.abs(e.slopeAngle)>.2&&Math.abs(e.slopeAngle)<1?e.movingDirection.set(0,Math.sin(e.slopeAngle),Math.cos(e.slopeAngle)):e.actualSlopeAngle>=1?e.movingDirection.set(0,Math.sin(e.slopeAngle)>0?0:Math.sin(e.slopeAngle),Math.sin(e.slopeAngle)>0?.1:1):e.movingDirection.set(0,0,1),this.model&&e.movingDirection.applyQuaternion(this.model.quaternion),e.movingObjectVelocityInCharacterDir.copy(e.movingObjectVelocity).projectOnVector(e.movingDirection).multiply(e.movingDirection);const i=e.movingObjectVelocity.angleTo(e.movingDirection),n=e.currentVel.dot(e.movingDirection);e.wantToMoveVel.set(e.movingDirection.x*n,0,e.movingDirection.z*n),e.rejectVel.copy(e.currentVel).sub(e.wantToMoveVel),e.moveAccNeeded.set((e.movingDirection.x*(t.maxVelLimit*(e.run?t.sprintMult:1)+e.movingObjectVelocityInCharacterDir.x)-(e.currentVel.x-e.movingObjectVelocity.x*Math.sin(i)+e.rejectVel.x*(e.isOnMovingObject?0:t.rejectVelMult)))/t.accDeltaTime,0,(e.movingDirection.z*(t.maxVelLimit*(e.run?t.sprintMult:1)+e.movingObjectVelocityInCharacterDir.z)-(e.currentVel.z-e.movingObjectVelocity.z*Math.sin(i)+e.rejectVel.z*(e.isOnMovingObject?0:t.rejectVelMult)))/t.accDeltaTime);const r=e.moveAccNeeded.multiplyScalar(this.mass);Math.sin(this.rotation.y).toFixed(3)==Math.sin(e.modelEuler.y).toFixed(3)?e.moveImpulse.set(r.x*(e.canJump?1:t.airDragMultiplier),null===e.slopeAngle||0==e.slopeAngle?0:e.movingDirection.y*(e.movingDirection.y>0?t.slopeUpExtraForce:t.slopeDownExtraForce)*(e.run?t.sprintMult:1),r.z*(e.canJump?1:t.airDragMultiplier)):e.moveImpulse.set(r.x*t.turnVelMultiplier*(e.canJump?1:t.airDragMultiplier),null===e.slopeAngle||0==e.slopeAngle?0:e.movingDirection.y*t.turnVelMultiplier*(e.movingDirection.y>0?t.slopeUpExtraForce:t.slopeDownExtraForce)*(e.run?t.sprintMult:1),r.z*t.turnVelMultiplier*(e.canJump?1:t.airDragMultiplier)),e.impulseCenter.set(e.currentPos.x,e.currentPos.y+t.moveImpulsePointY,e.currentPos.z),e.currentVel.copy(this.velocity)}move(){this.v;const e=Zt.motor.getKey(),t=Zt.motor.getAzimut(),s=Zt.delta;let i=0!==e[7]?"run":"walk";0===e[0]&&0===e[1]&&(i="idle");let n=0!==e[0]&&0!==e[1]?this.diagonal:1;e[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===e[5]&&(this.toggle=!0),"walk"!==i&&"run"!==i||!this.crouch||(i="crouch"),1===e[6]&&(i="fight"),!this.jump&&e[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let r="idle";switch(i){case"idle":r=this.crouch?"Crouch Idle":"idle";break;case"walk":r="Jog Forward";break;case"run":r="Standard Run";break;case"crouch":r="Crouch Walk";break;case"fight":r="Attack"}let a=1*this.speed[i];0!==e[0]||0!==e[1]?(this.moving=!0,this.tmpAcc+=4*s,this.rs=e[0]*a,this.ts=e[1]*a):this.moving=!1,0===e[0]&&0===e[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*n);let o=Bt.unwrapRad(Math.atan2(this.ease.x,this.ease.z)+t);this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let l=this.vy-9.81;if(this.ease.y=l,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},t),this.tmpV2.set(0,0,0),this.useImpulse?Zt.motor.change({name:this.name,impulse:this.v.moveImpulse.toArray(),impulseCenter:this.v.impulseCenter.toArray()}):Zt.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray()}),this.helper&&(this.helper.cone.rotation.y=t,"idle"!==i&&this.helper.setDirection(o)),this.model&&(this.jump?this.model.play("Jump",0):this.model.play(r,.5),"idle"!==i)){let e=Bt.unwrapRad(this.model.rotation.y),s=Bt.nearAngle(o,e),n=Math.abs(Math.floor((e-s)*math.todeg)/180);this.model.rotation.y="fight"===i?t+Math.PI:Bt.lerp(e,s,.2-.1*n),this.model.updateMatrix()}}}const ho={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),toFixed:(e,t=3)=>1*e.toFixed(t),int:e=>Math.floor(e),lerp:(e,t,s)=>(1-s)*e+s*t,clamp:(e,t,s)=>Math.max(t,Math.min(s,e)),nearEquals:(e,t,s)=>Math.abs(e-t)<=s,lerpAr:(e,t,s,i)=>{let n=e.length;for(;n--;)e[n]=ho.lerp(t[n],s[n],i)},unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),scaleArray:(e,t)=>{for(var s=e.length;s--;)e[s]*=t;return e},addArray:(e,t)=>{for(var s=[],i=e.length;i--;)s[i]=e[i]+t[i];return s},angleDistance:(e,t)=>{var s=(e-t+180)%360-180;return s<-180?s+360:s},tmpE:new se,tmpM:new te,tmpM2:new te,tmpV:new i,tmpQ:new t,fromTransformToQ:(e,t,s)=>(s=s||!1,ho.tmpM.compose(ho.tmpV.fromArray(e),ho.tmpQ.fromArray(t),{x:1,y:1,z:1}),ho.tmpM.decompose(ho.tmpV,ho.tmpQ,{x:1,y:1,z:1}),s&&ho.tmpQ.invert(),ho.tmpQ.toArray()),fromTransform:(e,t,s,i,n)=>(n=n||!1,i=i||[0,0,0,1],ho.tmpM.compose(ho.tmpV.fromArray(e),ho.tmpQ.fromArray(t),{x:1,y:1,z:1}),ho.tmpM2.compose(ho.tmpV.fromArray(s),ho.tmpQ.fromArray(i),{x:1,y:1,z:1}),n?(ho.tmpM.invert(),ho.tmpM.multiply(ho.tmpM2)):ho.tmpM.multiply(ho.tmpM2),ho.tmpM.decompose(ho.tmpV,ho.tmpQ,{x:1,y:1,z:1}),ho.tmpV.toArray()),arCopy:(e,t)=>{},axisToQuatArray:(e,t)=>(t=t||!1,ho.tmpQ.setFromAxisAngle(ho.tmpV.fromArray(e,1),t?e[0]*ho.torad:e[0]).normalize().toArray()),toQuatArray:e=>ho.tmpQ.setFromEuler(ho.tmpE.fromArray(ho.vectorad(e))).toArray(),vectorad:e=>{let t=3,s=[];for(;t--;)s[t]=e[t]*ho.torad;return s[3]=e[3],s},rgbToHex:e=>"0x"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]<<0).toString(16)).slice(-6),hexToRgb:e=>[((e=Math.floor(e))>>16&255)/255,(e>>8&255)/255,(255&e)/255],htmlToHex:e=>e.toUpperCase().replace("#","0x"),hexToHtml:e=>"#"+("000000"+(e=void 0===e?0:e).toString(16)).substr(-6),rgbToHtml:e=>"#"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]<<0).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==ho.perlin&&(ho.perlin=null)},noise:(e,t)=>{null===ho.perlin&&(ho.perlin=new co);let s,i,n=(t=t||{}).level||[1,.2,.05],r=t.frequency||[.016,.05,.2],a=0,o=0;for(s=0;s<n.length;s++)i=r[s],a+=n[s]*(.5+.5*ho.perlin.noise3d(e.x*i,e.y*i,e.z*i)),o+=n[s];return a/=o,a}};class co{constructor(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,s){return e[0]*t+e[1]*s}dot3(e,t,s,i){return e[0]*t+e[1]*s+e[2]*i}dot4(e,t,s,i,n){return e[0]*t+e[1]*s+e[2]*i+e[3]*n}noise(e,t){var s,i,n=(e+t)*(.5*(Math.sqrt(3)-1)),r=Math.floor(e+n),a=Math.floor(t+n),o=(3-Math.sqrt(3))/6,l=(r+a)*o,h=e-(r-l),c=t-(a-l);h>c?(s=1,i=0):(s=0,i=1);var u=h-s+o,p=c-i+o,d=h-1+2*o,m=c-1+2*o,f=255&r,g=255&a,y=this.perm[f+this.perm[g]]%12,v=this.perm[f+s+this.perm[g+i]]%12,w=this.perm[f+1+this.perm[g+1]]%12,x=.5-h*h-c*c,b=.5-u*u-p*p,M=.5-d*d-m*m;return 70*((x<0?0:(x*=x)*x*this.dot(this.grad3[y],h,c))+(b<0?0:(b*=b)*b*this.dot(this.grad3[v],u,p))+(M<0?0:(M*=M)*M*this.dot(this.grad3[w],d,m)))}noise3d(e,t,s){var i,n,r,a,o,l,h=(e+t+s)*(1/3),c=Math.floor(e+h),u=Math.floor(t+h),p=Math.floor(s+h),d=1/6,m=(c+u+p)*d,f=e-(c-m),g=t-(u-m),y=s-(p-m);f>=g?g>=y?(i=1,n=0,r=0,a=1,o=1,l=0):f>=y?(i=1,n=0,r=0,a=1,o=0,l=1):(i=0,n=0,r=1,a=1,o=0,l=1):g<y?(i=0,n=0,r=1,a=0,o=1,l=1):f<y?(i=0,n=1,r=0,a=0,o=1,l=1):(i=0,n=1,r=0,a=1,o=1,l=0);var v=f-i+d,w=g-n+d,x=y-r+d,b=f-a+2*d,M=g-o+2*d,A=y-l+2*d,T=f-1+.5,S=g-1+.5,R=y-1+.5,k=255&c,C=255&u,I=255&p,E=this.perm[k+this.perm[C+this.perm[I]]]%12,P=this.perm[k+i+this.perm[C+n+this.perm[I+r]]]%12,_=this.perm[k+a+this.perm[C+o+this.perm[I+l]]]%12,L=this.perm[k+1+this.perm[C+1+this.perm[I+1]]]%12,D=.6-f*f-g*g-y*y,z=.6-v*v-w*w-x*x,O=.6-b*b-M*M-A*A,F=.6-T*T-S*S-R*R;return 32*((D<0?0:(D*=D)*D*this.dot3(this.grad3[E],f,g,y))+(z<0?0:(z*=z)*z*this.dot3(this.grad3[P],v,w,x))+(O<0?0:(O*=O)*O*this.dot3(this.grad3[_],b,M,A))+(F<0?0:(F*=F)*F*this.dot3(this.grad3[L],T,S,R)))}noise4d(e,t,s,i){var n,r,a,o,l,h,c,u,p,d,m,f,g=this.grad4,y=this.simplex,v=this.perm,w=(Math.sqrt(5)-1)/4,x=(5-Math.sqrt(5))/20,b=(e+t+s+i)*w,M=Math.floor(e+b),A=Math.floor(t+b),T=Math.floor(s+b),S=Math.floor(i+b),R=(M+A+T+S)*x,k=e-(M-R),C=t-(A-R),I=s-(T-R),E=i-(S-R),P=(k>C?32:0)+(k>I?16:0)+(C>I?8:0)+(k>E?4:0)+(C>E?2:0)+(I>E?1:0),_=k-(n=y[P][0]>=3?1:0)+x,L=C-(r=y[P][1]>=3?1:0)+x,D=I-(a=y[P][2]>=3?1:0)+x,z=E-(o=y[P][3]>=3?1:0)+x,O=k-(l=y[P][0]>=2?1:0)+2*x,F=C-(h=y[P][1]>=2?1:0)+2*x,N=I-(c=y[P][2]>=2?1:0)+2*x,B=E-(u=y[P][3]>=2?1:0)+2*x,U=k-(p=y[P][0]>=1?1:0)+3*x,V=C-(d=y[P][1]>=1?1:0)+3*x,H=I-(m=y[P][2]>=1?1:0)+3*x,j=E-(f=y[P][3]>=1?1:0)+3*x,G=k-1+4*x,W=C-1+4*x,q=I-1+4*x,X=E-1+4*x,K=255&M,Z=255&A,Y=255&T,Q=255&S,J=v[K+v[Z+v[Y+v[Q]]]]%32,$=v[K+n+v[Z+r+v[Y+a+v[Q+o]]]]%32,ee=v[K+l+v[Z+h+v[Y+c+v[Q+u]]]]%32,te=v[K+p+v[Z+d+v[Y+m+v[Q+f]]]]%32,se=v[K+1+v[Z+1+v[Y+1+v[Q+1]]]]%32,ie=.6-k*k-C*C-I*I-E*E,ne=.6-_*_-L*L-D*D-z*z,re=.6-O*O-F*F-N*N-B*B,ae=.6-U*U-V*V-H*H-j*j,oe=.6-G*G-W*W-q*q-X*X;return 27*((ie<0?0:(ie*=ie)*ie*this.dot4(g[J],k,C,I,E))+(ne<0?0:(ne*=ne)*ne*this.dot4(g[$],_,L,D,z))+(re<0?0:(re*=re)*re*this.dot4(g[ee],O,F,N,B))+(ae<0?0:(ae*=ae)*ae*this.dot4(g[te],U,V,H,j))+(oe<0?0:(oe*=oe)*oe*this.dot4(g[se],G,W,q,X)))}}class uo extends ne{constructor(e={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=e.name,this.folder=e.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=e.terrainType||"terrain",this.callback=e.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[e.uv||18,e.uv||18],this.sample=null==e.sample?[128,128]:e.sample,this.size=void 0===e.size?[100,30,100]:e.size;let s=this.sample[0]-1,n=this.sample[1]-1;this.rx=s/this.size[0],this.rz=n/this.size[2],this.zone=e.zone||1;let r=[this.size[0]/s,this.size[2]/n];this.sampleZ=[e.sample[0]*this.zone,e.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*r[0],e.size[1],(this.sampleZ[1]-1)*r[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:e.level||[1,.2,.05],frequency:e.frequency||[.016,.05,.2],expo:e.expo||1},this.isWater=e.water||!1,this.isIsland=e.island||!1,this.isBorder=!1,this.wantBorder=e.border||!1,this.isBottom=!1,this.wantBottom=e.bottom||!1,this.wantBorder=e.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=e.maxSpeed||.1,this.acc=null==e.acc?.01:e.acc,this.dec=null==e.dec?.01:e.dec,this.deep=null==e.deep?0:e.deep,this.ease=new M,this.complexity=null==e.complexity?30:e.complexity,this.complexity2=null==e.complexity2?null:e.complexity2,this.local=new i,e.local&&this.local.fromArray(e.local),this.pp=new i,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=e.is64||!1,this.isTurn=e.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=e.isAbsolute||!1,this.isTurned=e.isTurned||!1,this.isReverse=e.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new p(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-ho.PI90),this.geometry.setAttribute("color",new a(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var o=new t(.5,.5,.1,.2);e.maplevels&&o.fromArray(e.maplevels);var l,h=po,c=e.maps||["sand","grass3","rock"],u={};this.isWater&&(c=["water"]);for(let t in c)l=c[t],u[l+"_c"]=Ua.texture({url:this.folder+l+"_c.jpg",flip:!1,repeat:this.uvx,encoding:e.encoding||!0,callback:this.mapcallback.bind(this)}),u[l+"_n"]=Ua.texture({url:this.folder+l+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});u.noise=Ua.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=u,this.material=new y({name:"terrain",vertexColors:!0,color:16777215,map:u[c[0]+"_c"],normalMap:u[c[0]+"_n"]}),void 0!==e.envmap&&(this.material.envMap=e.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=e.opacity||.4,this.material.side=I,this.material.alphaMap=u[c[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=0,this.material.metalness=e.metalness||0,this.material.roughness=e.roughness||.3);var d=e.nScale||.5;if(this.material.normalScale.set(d,-d),this.isWater)this.material.onBeforeCompile=function(e){var t=e.fragmentShader;t=t.replace("#include <alphamap_fragment>",h.alphamap),e.fragmentShader=t};else{let e=this;this.material.onBeforeCompile=function(t){let s=t.uniforms;s.clevels={value:o},s.map1={value:u[c[1]+"_c"]},s.map2={value:u[c[2]+"_c"]},s.randomUv={value:1},s.normalMap1={value:u[c[1]+"_n"]},s.normalMap2={value:u[c[2]+"_n"]},s.noiseMap={value:u.noise},s.useNoiseMap={value:1},t.uniforms=s,Da.addParsFragment(t,Da.getRandomUv()+h.fragmentAdd);let i=t.fragmentShader;i=i.replace("#include <map_fragment>",h.map),i=i.replace("#include <normal_fragment_maps>",h.normal),i=i.replace("#include <color_fragment>",""),t.fragmentShader=i,e.material.userData.shader=t,Da.modify(t)},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(e){this.userData.shader.uniforms.randomUv.value=e?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(e){this.userData.shader.uniforms.map1.value=e}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(e){this.userData.shader.uniforms.map2.value=e}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(e){this.userData.shader.uniforms.normalMap1.value=e}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(e){this.userData.shader.uniforms.normalMap2.value=e}})}e.debug&&this.debugZone(e),this.wantBorder&&this.addBorder(e),this.wantBottom&&this.addBottom(e),e.pos&&this.position.fromArray(e.pos),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=ho.toQuatArray(e.rot),delete e.rot),this.quaternion.fromArray(e.quat),e.decal&&(this.position.y+=e.decal),this.castShadow=!0,this.receiveShadow=!0,Ua.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let e=.5*(this.sample[0]-this.sampleZ[0]),t=.5*(this.sample[1]-this.sampleZ[1]),s=this.sample[0]*t+e,i=0;for(let t=0;t<this.lngZ;t++)i=Math.floor(t/this.sampleZ[0]),this.zid[s+t+i*(2*e)]=t}debugZone(e){this.geometryZ=new p(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-ho.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const t=new ne(this.geometryZ,new R({color:0,wireframe:!0,transparent:!0,opacity:.1}));this.add(t)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(e){var t=new p(this.size[0],this.size[2],1,1);t.rotateX(ho.PI90),this.bottomMesh=new ne(t,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(e){this.borderMaterial=new A({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?e.opacity||.8:1,envMap:e.envmap||null});var t=new p(this.size[0],2,this.sample[0]-1,1),s=new p(this.size[0],2,this.sample[0]-1,1),i=new p(this.size[2],2,this.sample[1]-1,1),n=new p(this.size[2],2,this.sample[1]-1,1);t.translate(0,1,.5*this.size[2]),s.rotateY(-ho.Pi),s.translate(0,1,.5*-this.size[2]),i.rotateY(-ho.PI90),i.translate(.5*-this.size[0],1,0),n.rotateY(ho.PI90),n.translate(.5*this.size[0],1,0),this.borderGeometry=Ks(qs([t,s,i,n])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new a(this.borderColors,3)),this.borderMesh=new ne(this.borderGeometry,this.borderMaterial);for(var r,o,l=this.lng2;l--;)r=3*l,o=this.borderVertices[r+1]>0?this.findPoint(this.borderVertices[r],this.borderVertices[r+2]):-1,this.list[l]=o;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let e in this.txt)this.txt[e].dispose()}easing(e,t,s){if(0!==e[0]||0!==e[1]){var i=t||0;e[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=e[1]*this.acc,this.ease.x+=e[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,e[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),e[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(i)*this.ease.x+Math.cos(i)*this.ease.y,this.local.x+=Math.cos(i)*this.ease.x-Math.sin(i)*this.ease.y,this.update(s))}}getTri(){return this.geometry}getHeight(e,t){return e*=this.rx,t*=this.rz,e+=.5*this.sample[0],t+=.5*this.sample[1],e=Math.floor(e),t=Math.floor(t),(this.isTurn?this.height[this.findId2(e,t)]:this.height[this.findId(e,t)])*this.size[1]+this.position.y}findIdZ(e,t){return e+t*this.sampleZ[1]}findId(e,t){return e+t*this.sample[1]}findId2(e,t){return t+-e*this.sample[0]||1}findPoint(e,t){for(var s,i=this.lng;i--;)if(s=3*i,this.vertices[s]===e&&this.vertices[s+2]===t)return i;return-1}getReverseID(){this.invId=[];let e,t,s=this.lngZ;const i=this.sampleZ[1]-1;for(this.sampleZ[0];s--;)e=s%this.sampleZ[0],t=Math.floor(s*this.ratioZ),this.isReverse&&(t=i-t),this.invId[s]=this.isTurned?this.lngZ-1-this.findIdZ(t,e):this.findIdZ(e,t)}set(e){e.ease&&this.easing(e.key,e.azimut),e.decal&&this.decal(e.decal,!0)}decal(e,t){this.local.x+=e[0],this.local.y+=e[1],this.local.z+=e[2],this.update(t)}updateUv(){if(this.isWater)this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001;else{let e={x:this.local.x*this.ruvx,y:this.local.z*this.ruvy};this.material.map&&this.material.map.offset.copy(e),this.material.normalMap&&this.material.normalMap.offset.copy(e)}}distance(e,t){const s=e.x-t.x,i=e.y-t.y;return Math.sqrt(s*s+i*i)}clamp(e,t=0,s=1){return e=(e=e<t?t:e)>s?s:e}update(e){let t,s,i,n,r,a,o,l,h,c,u,p=this.pp,d=[1,1,1],m=this.lng;for(;m--;){if(t=3*m,s=m%this.sample[0],i=Math.floor(m*this.ratio),p.set(s+this.local.x*this.rx,this.local.y,i+this.local.z*this.rz),n=ho.noise(p,this.data),this.isIsland){let e=1-this.distance({x:s,y:i},{x:.5*(this.sample[0]-1),y:.5*(this.sample[1]-1)})/(.5*(this.sample[0]-1));e*=4,e=this.clamp(e),n*=e}n=Math.pow(n,this.data.expo),n=this.clamp(n),"road"===this.ttype&&(l===i?n=1===s||2===s||29===s||30===s?h+.1:h:(l=i,h=n)),this.height[m]=n,c=n*this.size[1]+this.deep,this.vertices[t+1]=c,a=this.isAbsolute?n:n*this.size[1],void 0!==this.zid[m]&&(o=this.zid[m],r=this.changeId?this.invId[o]:o,this.heightData[r]=a,this.verticesZ&&(this.verticesZ[3*o+1]=c)),d=this.isWater?[n*this.colorBase.r,n*this.colorBase.g,n*this.colorBase.b]:[n,0,0],u=d[0],this.colors[t]=u,this.colors[t+1]=u,this.colors[t+2]=u}if(this.isBorder){let e,s=this.lng2;for(;s--;)t=3*s,-1!==this.list[s]?(e=this.height[this.list[s]],this.borderVertices[t+1]=e*this.size[1]+this.deep,u=ho.clamp(e+.25,.25,1),this.borderColors[t]=u,this.borderColors[t+1]=u,this.borderColors[t+2]=u):(this.borderColors[t]=this.colorBase.r,this.borderColors[t+1]=this.colorBase.g,this.borderColors[t+2]=this.colorBase.b)}e?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(e){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const po={fragmentAdd:"\n        uniform vec4 clevels;\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.x) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (slope == 0.0 ) cc = sands;\n            //if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            //if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n\n            float d = level.y;\n            float rx = 1.0/level.y;\n\n            if (( slope < level.x + d ) && (slope > level.x)) cc = mix( grasss , rocks, ( slope - (level.x) ) * rx );\n\n            d = level.w;\n            rx = 1.0/level.w;\n            if (( slope < level.z + d ) && (slope > level.z )) cc = mix( sands , grasss, ( slope - (level.z) ) * rx );\n\n            //cc = mix( grasss, cc, smoothstep(0.0,1.0, slope)*20.0 );\n            return cc;\n        }\n    ",rough:"\n        float roughnessFactor = roughness;\n        float metalnessFactor = metalness;\n        #ifdef USE_ROUGHNESSMAP\n\n            vec4 sandR = textureMAP( roughnessMap, vRoughnessMapUv );\n            vec4 grassR = textureMAP( roughnessMap1, vRoughnessMapUv );\n            vec4 rockR = textureMAP( roughnessMap2, vRoughnessMapUv );\n\n            vec4 baseColorR = MappingMix( vColor.r, clevels, rockR, grassR, sandR );\n            // reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n            float ambientOcclusion =( baseColorR.r - 1.0 ) * aoMapIntensity + 1.0;\n            roughnessFactor *= baseColorR.g;\n            metalnessFactor *= baseColorR.b;\n        #endif\n    ",ao:"\n        reflectedLight.indirectDiffuse *= ambientOcclusion;\n        #if defined( USE_ENVMAP ) && defined( STANDARD )\n            float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n            reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n        #endif\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 sampledDiffuseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n\n            diffuseColor *= sampledDiffuseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",normal2:"\n\n        #ifdef OBJECTSPACE_NORMALMAP\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( TANGENTSPACE_NORMALMAP )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            //vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n            mapN.xy *= normalScale;\n\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "};class mo extends Cs{constructor(){super(),this.Utils=Yt,this.type="terrain",this.num=Xt[this.type]}step(){Zt.Ar,Zt.ArPos[this.type];let e,t=this.list.length;for(;t--;)e=this.list[t],e.step()}add(e={}){this.setName(e),"JOLT"===Zt.engine&&(e.isAbsolute=!0,e.isTurned=!1),"PHYSX"===Zt.engine&&(e.isAbsolute=!0,e.isTurned=!0),"HAVOK"===Zt.engine&&(e.isAbsolute=!0,e.isTurned=!0,e.isReverse=!1),"OIMO"!==Zt.engine&&(e.zone=e.zone||.25);const t=new uo(e);return Ts.extendShader(t.material,t.material.onBeforeCompile),t.physicsUpdate=(e,t)=>{Zt.flow.tmp.push({name:e,heightData:t})},this.addToWorld(t,e.id),Zt.post({m:"add",o:fo(t)}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}const fo=function(e){const t={name:e.name,type:e.type,pos:e.position.toArray(),quat:"PHYSX"===Zt.engine?[0,0,0,1]:e.quaternion.toArray()};return"PHYSX"===Zt.engine||"AMMO"===Zt.engine||"HAVOK"===Zt.engine||"JOLT"===Zt.engine?(t.type="terrain",t.size=e.sizeZ,t.sample=e.sampleZ,t.zone=e.zone,t.heightData=e.heightData):(t.type="mesh",t.v=Bt.getVertex(e.geometry,"OIMO"===Zt.engine),t.index="OIMO"===Zt.engine?null:Bt.getIndex(e.geometry)),t};class go extends Cs{constructor(){super(),this.Utils=Yt,this.type="solver"}step(){const e=Zt.Ar,t=Zt.ArPos[this.type];let s,i=this.list.length;for(;i--;)s=t+i*Xt[this.type],this.list[i].update(e,s)}add(e={}){this.setName(e);let t=new yo(e);return this.addToWorld(t,e.id),Zt.post({m:"add",o:e}),t}set(e={}){}}class yo{constructor(e){this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.joints=[],this.jid=0,this.speed=1}update(e,t){if(!this.needData)return;let s,i,n=this.joints.length;for(;n--;)i=t+7*n,s=this.joints[n],s.data.target.x=e[i+0],s.data.target.y=e[i+1],s.data.target.z=e[i+2],s.data.target.rx=Math.round(e[i+3]),s.data.target.ry=Math.round(e[i+4]),s.data.target.rz=Math.round(e[i+5]),s.data.target.count=e[i+6]}start(){Zt.post({m:"startArticulation",o:{name:this.name}})}stop(){Zt.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){Zt.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(e){this.jid=this.joints.length,e.name=e.name||this.name+"_Joint_"+this.jid,e.solver=this.name,void 0!==e.rot1&&(e.quat1=Bt.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=Bt.quatFromEuler(e.rot2),delete e.rot2),"fixe"!==e.type&&this.joints.push(new vo(e,this)),Zt.post({m:"addSolverJoint",o:e})}driveJoints(e){let t,s,i=!1,n=this.joints.length,r=[];for(;n--;)t=this.joints[n],t.update(e),s=t.isDrive,s&&r.push(t.nup),i=!!s||i;i?Zt.motor.change(r):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(e,t){if(!e)return;let s=this.joints.length;for(;s--;)this.joints[s].pose(void 0!==e[s]?e[s]:0,void 0!==t?t:this.speed);return new Promise((e=>this.resolve=e))}}class vo{constructor(e,t){if(this.name=e.name,this.solver=t,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},e.limits&&(this.driveType=e.limits[0][0],this.min=e.limits[0][1],this.max=e.limits[0][2]),e.position){let t,s=e.position.length;for(;s--;)t=e.position[s],this.data.target[t[0]]=t[1]}}start(){}pose(e,t){this.target=Bt.clamp(e,this.min,this.max),this.current=Bt.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=t,this.isDrive=!0)}update(e){if(this.isDrive){this.tmp+=e;let t=this.tmp/this.time;t=t>1?1:t;let s=Bt.lerp(this.start,this.target,t);this.nup={name:this.name,drivesTarget:[[this.driveType,s]]},1===t&&(this.isDrive=!1)}}}class wo extends ne{constructor(e={}){super(new p,new R({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=e.nam||"text",this.canvas=null,this.w=e.w||0,this.h=e.h||0,this.weight=e.weight??700,this.font=e.font??"'Mulish', sans-serif",this.fontSize=e.fontSize??32,this.backgroundColor=e.backgroundColor??"#00000000",this.fontColor=e.fontColor??"#FFFFFF",this.material.alphaTest=.5,this.set(e.text),e.pos&&this.position.fromArray(e.pos),e.rot&&this.quaternion.fromArray(Bt.quatFromEuler(e.rot))}set(e){this.canvas||(this.canvas=document.createElement("canvas"));let t,s,i,n=this.canvas.getContext("2d");n.font=this.weight+" "+this.fontSize+"px "+this.font;let r=n.measureText(e);t=2**Math.ceil(Math.log2(r.width)),s=2**Math.ceil(Math.log2(n.measureText("M").width)),this.canvas.width=t,this.canvas.height=s,n.fillStyle=this.backgroundColor,n.fillRect(0,0,t,s),n.fillStyle=this.fontColor,n.font=this.weight+" "+this.fontSize+"px "+this.font,n.textAlign="center",n.textBaseline="middle",n.fillText(e,.5*t,.5*s),this.material.map=new d(this.canvas),0!==this.h?(i=this.h/s,this.scale.set(t*i,this.h,0)):0!==this.w?(i=this.w/s,this.scale.set(this.w,s*i,0)):this.scale.set(.025*t,.025*s,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let xo=0;class bo{constructor(e={}){this.down=!1,this.time=e.time||250,this.p=e.pos||[0,0,0],this.type=e.type||"box",this.name=e.name||"button"+xo++,this.pos=e.pos||[0,0,0],this.size=e.size||[1,1,1],this.radius=e.radius||0,this.axe=void 0!==e.axe?e.axe:1,this.fontSize=e.fontSize||.8,this.fontScale=e.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let t=this.size[this.axe]-2*this.radius;this.range=[this.origin-t,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},e.callback&&(this.callback=e.callback,delete e.callback),e.button=!0,e.pos=this.pos,e.material||(e.material="button"),e.kinematic=!0,e.mask=1,this.timeout=null,this.b=Zt.motor.add(e),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),this.b.userData.direct=this.callback.bind(this),e.text&&this.addText(e.text)}addText(e,t){this.fontSize="box"===this.type?.8*this.size[this.axe]:.8*this.size[0],this.fontSize*=this.fontScale;let s={text:e,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize};2===this.axe&&(s={text:e,pos:[0,0,.5*this.size[2]],rot:[0,0,0],h:this.fontSize}),this.txt=new wo(s),this.b.add(this.txt)}action(e){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&Zt.motor.explosion(e||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&Zt.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=Bt.lerp(this.value,this.target,this.speed),Bt.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,Zt.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}class Mo{constructor(e={}){this.isCompound=!0,this.remplace=e.remplace||!1,this.init(e)}init(e={}){let t=e.size||[5,3,8],s=e.pos||[0,2,0],i=e.wall||.1;e.size[3]&&(i=e.size[3]);let n=.5*i,r=2*i;e.face||(e.face={});let a={up:1,down:1,left:1,right:1,front:1,back:1,...e.face};delete e.face;const o=[];1===a.up&&o.push({pos:[0,.5*t[1]-n,0],size:[t[0],i,t[2]]}),1===a.down&&o.push({pos:[0,n-.5*t[1],0],size:[t[0],i,t[2]]}),1===a.left&&o.push({pos:[n-.5*t[0],0,0],size:[i,t[1]-r,t[2]]}),1===a.right&&o.push({pos:[.5*t[0]-n,0,0],size:[i,t[1]-r,t[2]]}),1===a.back&&o.push({pos:[0,0,n-.5*t[2]],size:[t[0]-r,t[1]-r,i]}),1===a.front&&o.push({pos:[0,0,.5*t[2]-n],size:[t[0]-r,t[1]-r,i]});const l=[];let h,c,u=o.length,p=0;for(;u--;)c=o[p],h=this.isCompound?c.pos:Bt.addArray(s,c.pos),l.push({type:"box",size:c.size,pos:h,material:e.material}),p++;if(this.isCompound){let s=null;this.remplace&&(s=new ne(new ei(t[0],t[1],t[2],e.radius||n))),Zt.motor.add({...e,mesh:s,shapes:l,type:"compound"})}else Zt.motor.add(l)}}class Ao{constructor(e,t="drag"){this.needRay=!1,this.moveDirect=!1,this.moveDeep=!1,this.mode=t,this.option={},this.overObj=null,this.controler=e,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.release=!1,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new i,this.tmpPos=new i,this.tmpD=new i,this.mouse=new M,this.oldMouse=new M,this.raycast=new _t,this.raycast.far=1e3,this.button=0,this.pos=new i,this.velocity=new i,this.angle=0,this.helper=null,this.dragPlane=null,this.overLock=!1,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.helper=new To,this.dragPlane=new ne(new p(1,1),Ts.get("hide")),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),Zt.scenePlus.add(this.helper),Zt.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(Zt.scenePlus.remove(this.dragPlane),Zt.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(e,t={}){e!==this.mode&&(this.mode=e,this.option=t,"blast"===this.mode&&this.option.visible&&Zt.motor.initParticle())}activeDragMouse(e){e?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("change",this.controleChange.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("change",this.controleChange.bind(this)),this.isActive=!1)}controleEnd(e){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleChange(e){-1!==this.controler.getState()&&(this.raycastTest=!1)}getMouse(e){Zt.viewSize?(this.mouse.x=e.offsetX/Zt.viewSize.w*2-1,this.mouse.y=-e.offsetY/Zt.viewSize.h*2+1):(this.mouse.x=e.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-e.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==e.pointerType?e.button:0}contextmenu(e){}mousedown(e){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(e),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast();break;case"build":this.build()}}mouseup(e){this.release=!0,document.body.style.cursor="auto",this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,Zt.mouseDown=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(e){switch(this.mode){case"drag":this.getMouse(e),this.needRay=!0}}castray(){let e,t,s,i,n,r="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObject(this.dragPlane),e.length&&this.mouseDown&&this.moveSelect(e[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObjects(Zt.scene.children,!0),this.tmpSelected=null,e.length>0?(s=e[0].object,n=e[0].instanceId,void 0!==n?t=Zt.motor.byName(s.name+n):s.parent!==Zt.scene?(i=s.parent,t=i.parent!==Zt.scene?i.parent:i):t=s,this.mouseDown2&&t.extra&&t.extra(t.name),r=t.isButton?this.actionButton(t,e[0]):this.select(t,e[0].point)):(this.resetOver(),this.controler.enableRotate=!0,this.controler.enablePan=!0),this.release&&(this.release=!1,this.controler.enableRotate=!0,this.controler.enablePan=!0,r="auto",this.resetOver()),document.body.style.cursor=r}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,Zt.mouseDown=!0,this.needRay=!0}blast(){let e=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let t=this.raycast.intersectObjects(Zt.scene.children,!0);t.length>0?t[0].object.isButton?t[0].object.parent.userData.direct():e=t[0]:(t=this.raycast.intersectObjects(Zt.scenePlus.children,!0),t.length>0&&(e=t[0]));const s=this.option;e&&(Zt.motor.explosion(e.point,s.radius||3,s.power||.1),s.visible&&Zt.motor.addParticle({name:"blast",type:"cube",position:e.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(60),Zt.motor.add({name:"bullet_"+this.numBullet,type:"sphere",density:20,size:[.2],material:"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(e,t){if(this.buttonRef?this.buttonRef.name!==e.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=e):this.mouseDown&&(this.buttonRef=e),this.mouseDown&&this.buttonRef.userData.action){let e=t.point;this.buttonRef.userData.action(e)}return"pointer"}setOver(e){e&&(this.overObj&&e.name!==this.overObj.name&&this.resetOver(),this.overObj=e,this.overObj.over&&this.overObj.over(!0))}resetOver(){this.overObj&&(this.overObj.over&&this.overObj.over(!1),this.overObj=null)}select(e,t){if(this.mouseDown||this.setOver(e),!this.mouseDown||this.selected===e)return"grab";this.pz=0;let s=t,i=[0,0,0,1];this.selected=e,this.decal.copy(s).sub(this.selected.position),this.tmpPos.copy(s).sub(this.decal),this.angle=this.controler.getAzimuthalAngle();let n=this.selected.quaternion;i=[n._x,n._y,n._z,n._w],this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(s),this.dragPlane.position.y=0,this.helper.position.copy(s);let r=s.toArray(),a=!1;if(Zt.motor.change({name:this.selected.name,neverSleep:!0,wake:!0}),this.moveDirect)Zt.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let e=[-.1,.1,60,1],t=[-.1,.1,60,1],s="OIMO"===Zt.engine||"RAPIER"===Zt.engine||"JOLT"===Zt.engine,n=0===this.selected.link?"fixe":"d6";"JOLT"===Zt.engine&&(n="fixe");let o=[["x",...e],["y",...e],["z",...e],["rx",...t],["ry",...t],["rz",...t]];"HAVOK"===Zt.engine&&(o=[["x",...e],["y",...e],["z",...e]]),"OIMO"===Zt.engine&&(a=!0,n=0===this.selected.link?"fixe":"spherical",o=[["x",...e],["y",...e],["z",...e]]),"HAVOK"===Zt.engine&&(a=!0,n=0===this.selected.link?"fixe":"spherical",o=[-180,180,.1,.1]),Zt.motor.add([{name:"mouse",type:"null",pos:r,quat:i,kinematic:!s},{name:"mouseJoint",type:"joint",mode:n,lm:o,sd:[4,1],autoDrive:!0,b1:a?this.selected.name:"mouse",b2:a?"mouse":this.selected.name,worldAnchor:r,visible:!1}])}return"grabbing"}moveSelect(e){if(null===this.selected)return;if(e&&this.tmpPos.copy(e).sub(this.decal),this.moveDeep){let e=this.selected.position.y,t=e-this.tmpPos.y;this.tmpPos.y=e,this.tmpD.set(0,0,t).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let t=this.tmpPos.toArray();this.moveDirect?Zt.motor.change({name:this.selected.name,pos:t,reset:!0}):Zt.motor.change({name:"mouse",pos:e.toArray(),lockPos:!0},!0)}unSelect(){null!==this.selected&&(this.resetOver(),this.clearDrag(),this.moveDirect?Zt.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(Zt.motor.remove(["mouseJoint","mouse"]),Zt.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let e=Zt.flow.key;if(0!==e[1]){let t=.1*e[1];this.dragPlane.translateZ(t),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class To extends J{constructor(e={}){super(new r,Ts.get("line"));let t=.75;const s=[t,t,t,0,0,0];this.geometry.setAttribute("position",new o([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new o(s,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}const So=new i;class Ro{constructor(e=1.4,t=1e-4){this.minSizeForBreak=e,this.smallDelta=t,this.tempLine1=new pe,this.tempPlane1=new de,this.tempPlane2=new de,this.tempPlane_Cut=new de,this.tempCM1=new i,this.tempCM2=new i,this.tempVector3=new i,this.tempVector3_2=new i,this.tempVector3_3=new i,this.tempVector3_P0=new i,this.tempVector3_P1=new i,this.tempVector3_P2=new i,this.tempVector3_N0=new i,this.tempVector3_N1=new i,this.tempVector3_AB=new i,this.tempVector3_CB=new i,this.tempResultObjects={object1:null,object2:null},this.box1=new ue,this.box2=new ue,this.sph1=new dt,this.sph2=new dt,this.tt=new i,this.s1=new i,this.s2=new i,this.segments=[];for(let e=0;e<900;e++)this.segments[e]=!1}prepareBreakableObject(e,t,s,i,n){const r=e.userData;r.mass=t,r.velocity=s.clone(),r.angularVelocity=i.clone(),r.breakable=n}subdivideByImpact(e,t,s,i,n){const r=[],a=this.tempPlane1,o=this.tempPlane2;this.tempVector3.addVectors(t,s),a.setFromCoplanarPoints(t,e.position,this.tempVector3);const l=n+i,h=this;return function n(c,u,p,d){if(Math.random()<.05*d||d>l)return void r.push(c);let m=Math.PI;0===d?(o.normal.copy(a.normal),o.constant=a.constant):d<=i?(m=(p-u)*(.2+.6*Math.random())+u,h.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(s,m).add(t),o.setFromCoplanarPoints(t,h.tempVector3,h.tempVector3_2)):(m=(.5*(1&d)+.2*(2-Math.random()))*Math.PI,h.tempVector3_2.copy(t).sub(c.position).applyAxisAngle(s,m).add(c.position),h.tempVector3_3.copy(s).add(c.position),o.setFromCoplanarPoints(c.position,h.tempVector3_3,h.tempVector3_2)),h.cutByPlane(c,o,h.tempResultObjects);const f=h.tempResultObjects.object1,g=h.tempResultObjects.object2;f&&n(f,u,m,d+1),g&&n(g,m,p,d+1)}(e,0,2*Math.PI,0),r}cutByPlane(e,t,s){let n;const r=e.geometry,a=r.attributes.position.array,o=r.attributes.normal.array,l=a.length/3;let h=l/3,c=r.getIndex();function u(e,t){const s=3*e+t;return c?c[s]:s}c&&(c=c.array,h=c.length/3);const p=[],d=[],m=this.smallDelta,f=l*l;for(let e=0;e<f;e++)this.segments[e]=!1;const g=this.tempVector3_P0,y=this.tempVector3_P1,v=this.tempVector3_N0,w=this.tempVector3_N1;for(let e=0;e<h-1;e++){const t=u(e,0),s=u(e,1),i=u(e,2);v.set(o[t],o[t]+1,o[t]+2);for(let n=e+1;n<h;n++){const e=u(n,0),r=u(n,1),a=u(n,2);w.set(o[e],o[e]+1,o[e]+2);1-v.dot(w)<m&&(t===e||t===r||t===a?s===e||s===r||s===a?(this.segments[t*l+s]=!0,this.segments[s*l+t]=!0):(this.segments[i*l+t]=!0,this.segments[t*l+i]=!0):s!==e&&s!==r&&s!==a||(this.segments[i*l+s]=!0,this.segments[s*l+i]=!0))}}const x=this.tempPlane_Cut;e.updateMatrix(),Ro.transformPlaneToLocalSpace(t,e.matrix,x);for(let e=0;e<h;e++){const t=u(e,0),n=u(e,1),r=u(e,2);for(let e=0;e<3;e++){const o=0===e?t:1===e?n:r,h=0===e?n:1===e?r:t;if(this.segments[o*l+h])continue;this.segments[o*l+h]=!0,this.segments[h*l+o]=!0,g.set(a[3*o],a[3*o+1],a[3*o+2]),y.set(a[3*h],a[3*h+1],a[3*h+2]);let c=0,u=x.distanceToPoint(g);u>m?(c=2,d.push(g.clone())):u<-m?(c=1,p.push(g.clone())):(c=3,p.push(g.clone()),d.push(g.clone()));let f=0;if(u=x.distanceToPoint(y),u>m?(f=2,d.push(y.clone())):u<-m?(f=1,p.push(y.clone())):(f=3,p.push(y.clone()),d.push(y.clone())),1===c&&2===f||2===c&&1===f){this.tempLine1.start.copy(g),this.tempLine1.end.copy(y);let e=new i;if(e=x.intersectLine(this.tempLine1,e),null===e)return console.error("Internal error: segment does not intersect plane."),s.segmentedObject1=null,s.segmentedObject2=null,0;p.push(e),d.push(e.clone())}}}e.userData.mass;let b=this.box1,M=this.box2,A=p.length,T=d.length;for(b.makeEmpty(),M.makeEmpty(),n=A;n--;)b.expandByPoint(p[n]);for(n=T;n--;)M.expandByPoint(d[n]);for(b.getBoundingSphere(this.sph1),M.getBoundingSphere(this.sph2),this.tempCM1.copy(this.sph1.center),this.tempCM2.copy(this.sph2.center),n=A;n--;)p[n].sub(this.tempCM1);for(n=T;n--;)d[n].sub(this.tempCM2);this.tempCM1.add(e.position),this.tempCM2.add(e.position),b.getSize(this.s1),M.getSize(this.s2),2*this.sph1.radius<this.minSizeForBreak&&(A=0),2*this.sph2.radius<this.minSizeForBreak&&(T=0),this.testSize(this.s1)&&(A=0),this.testSize(this.s2)&&(T=0);let S=null,R=null,k=0;return A>4&&(S=new ne(new mi(p),e.material),S.position.copy(this.tempCM1),S.quaternion.copy(e.quaternion),k++),T>4&&(R=new ne(new mi(d),e.material),R.position.copy(this.tempCM2),R.quaternion.copy(e.quaternion),k++),s.object1=S,s.object2=R,k}testSize(e){let t=0;return e.x<.01&&t++,e.y<.01&&t++,e.z<.01&&t++,t>1}static transformFreeVector(e,t){const s=e.x,i=e.y,n=e.z,r=t.elements;return e.x=r[0]*s+r[4]*i+r[8]*n,e.y=r[1]*s+r[5]*i+r[9]*n,e.z=r[2]*s+r[6]*i+r[10]*n,e}static transformFreeVectorInverse(e,t){const s=e.x,i=e.y,n=e.z,r=t.elements;return e.x=r[0]*s+r[1]*i+r[2]*n,e.y=r[4]*s+r[5]*i+r[6]*n,e.z=r[8]*s+r[9]*i+r[10]*n,e}static transformTiedVectorInverse(e,t){const s=e.x,i=e.y,n=e.z,r=t.elements;return e.x=r[0]*s+r[1]*i+r[2]*n-r[12],e.y=r[4]*s+r[5]*i+r[6]*n-r[13],e.z=r[8]*s+r[9]*i+r[10]*n-r[14],e}static transformPlaneToLocalSpace(e,t,s){s.normal.copy(e.normal),s.constant=e.constant;const i=Ro.transformTiedVectorInverse(e.coplanarPoint(So),t);Ro.transformFreeVectorInverse(s.normal,t),s.constant=-i.dot(s.normal)}}class ko{constructor(){this.convexBreaker=new Ro,this.tmpI=new THREE.Vector3,this.tpos=new THREE.Vector3,this.tnormal=new THREE.Vector3,this.nDebris=0,this.maxDebris=300,this.tt=null}step(){let e;for(let t in Zt.reflow.point)e=Zt.reflow.point[t],0!==e.distance&&(this.makeBreak(e.b1,e.pos,e.normal,e.impulse,e.v1),this.makeBreak(e.b2,e.pos,e.normal,e.impulse,e.v2))}makeBreak(e,t,s,i,n){let r=Yt.byName(e);if(!r)return;if(!r.breakable)return;let a=r.breakOption;if(i<a[0])return;let o=this.convexBreaker.subdivideByImpact(r,this.tpos.fromArray(t),this.tnormal.fromArray(s),a[1],a[2]);if(o.length<1)return;a[3]-=1;const l={material:r.material,linearVelocity:[n[0],n[1],n[2]],angularVelocity:[n[3],n[4],n[5]],density:r.density};let h=[],c=o.length,u=0;for(;c--;)h.push(this.addDebris(o[u],a,l)),u++;this.tt=setTimeout((()=>{Zt.motor.remove(e),Zt.motor.add(h)}),0)}addDebris(e,t,s){let i=t[3]>0,n={...s,name:"debris_"+this.nDebris++,type:"convex",shape:e.geometry,pos:e.position.toArray(),quat:e.quaternion.toArray(),breakable:i,breakOption:t};return this.nDebris>this.maxDebris&&(this.nDebris=0),n}}new i;const Co=new i,Io=new i,Eo=new i,Po=new i,_o=new i;class Lo{constructor(e={}){this.name=e.name||"ppp",this.particles=[],this.density=.01,this.smoothingRadius=.2,this.speedOfSound=.1,this.viscosity=.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[],this.tv=new i,this.tv2=new i}add(e){let t=Zt.motor.add({instance:this.name,type:"particle",flags:"noQuery",size:[.1],pSize:.03,pos:e,inertia:[0,0,0],mass:.001,restitution:0,friction:.5,damping:[.1,.1],material:"hide"});t.force=new i,this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(e){let t=e.length;console.log(t);let s,i,n,r=[],a=0;for(;t--;)s=e[t],this.name,s[0],this.name,s[1],i=this.particles[s[0]].position,n=this.particles[s[1]].position,a=this.tv.copy(i).distanceTo(n),this.tv.copy(n).sub(i),r.push({type:"distance",helperSize:.03,b1:this.name+s[0],b2:this.name+s[1],limit:[.5*a,a],spring:[20,1],friction:0});Zt.motor.add(r)}getPosition(){let e,t,s=[],i=this.particles.length;for(;i--;)t=3*i,e=this.particles[i],s[t]=e.position.x,s[t+1]=e.position.y,s[t+2]=e.position.z;return s}getNeighbors(e,t){const s=this.particles.length,i=e.id,n=this.smoothingRadius*this.smoothingRadius;let r=0;for(let a=0;a!==s;a++){const s=this.particles[a];r=this.distance(s,e),i!==s.id&&r<n&&t.push(s)}}distance(e,t){const s=e.position.x-t.position.x,i=e.position.y-t.position.y,n=e.position.z-t.position.z;return s*s+i*i+n*n}w(e){const t=this.smoothingRadius;return 315/(64*Math.PI*t**9)*(t*t-e*e)**3}gradw(e,t){const s=e.length(),i=this.smoothingRadius;t.copy(e).multiplyScalar(945/(32*Math.PI*i**9)*(i*i-s*s)**2)}nablaw(e){const t=this.smoothingRadius;return 945/(32*Math.PI*t**9)*(t*t-e*e)*(7*e*e-3*t*t)}update(){const e=[],t=this.particles.length,s=this.speedOfSound,i=this.eps;let n,r=t;for(;r--;){const e=this.particles[r];e.force.set(0,0,0);const t=this.neighbors[r];t.length=0,this.getNeighbors(e,t),t.push(this.particles[r]);let i=0;for(n=t.length;n--;){const s=this.w(this.distance(e,t[n]));i+=t[n].mass*s}this.densities[r]=i,this.pressures[r]=s*s*(this.densities[r]-this.density)}const a=Co,o=Io,l=Eo,h=Po,c=_o;for(r=t;r--;){const t=this.particles[r];let s,u;a.set(0,0,0),o.set(0,0,0);const p=this.neighbors[r];for(n=p.length;n--;){const e=p[n];h.copy(t.position).sub(e.position);const d=h.length();s=-e.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[n]/(this.densities[n]*this.densities[n]+i)),this.gradw(h,l),l.multiplyScalar(s),a.add(l),c.copy(e.velocity).sub(t.velocity),c.multiplyScalar(1/(1e-4+this.densities[r]*this.densities[n])*this.viscosity*e.mass),u=this.nablaw(d),c.multiplyScalar(u),o.add(c)}o.multiplyScalar(t.mass),a.multiplyScalar(t.mass),t.force.add(o),t.force.add(a),e.push({name:t.name,force:t.force.toArray()})}Zt.motor.change(e)}}const Do=Math.PI/180,zo=[new i(1,0,0),new i(0,1,0),new i(0,0,1)],Oo=new i,Fo=new i,No=new i,Bo=new i,Uo=[],Vo=[],Ho=new i,jo=new i,Go=new i;new te;class Wo{constructor(e){this.chassisBody=e.chassis,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:0,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:2,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:1,this.wheelMeshes=[],this.brakeMeshs=null,this.localWheel=!1}addWheel(e={}){let t=new Ko(e),s=this.wheelInfos.length-1;t.chassisBody=this.chassisBody;let i=t.suspensionRestLength+t.radius;return t.ray=Zt.motor.add({type:"ray",name:this.chassisBody.name+"_wheel_"+s,begin:t.chassisConnectionPointLocal.toArray(),end:[t.chassisConnectionPointLocal.x,-i,t.chassisConnectionPointLocal.z],callback:function(e){t.castRay(e)},visible:!1,parent:this.chassisBody}),this.wheelInfos.push(t),s}setWheels(e,t){let s,i=this.wheelInfos.length;for(;i--;)s=this.wheelInfos[i],s[e]&&(s[e]=t)}setSteeringValue(e,t){this.wheelInfos[t].steering=e}applyEngineForce(e,t){this.wheelInfos[t].engineForce=e}setBrake(e,t){this.wheelInfos[t].brake=e}getVehicleAxisWorld(e,t){return t.set(0===e?1:0,1===e?1:0,2===e?1:0),al(t,el(this.chassisBody,new te),t),t}updateVehicle(e){let t=this.wheelInfos,s=t.length,n=this.chassisBody,r=s;for(;r--;)this.updateWheelTransform(r);const a=$o(n,new i),o=ol(a,el(n,new te).invert(),new i);this.currentVehicleSpeedKmHour=o.z;let l=new i;this.getVehicleAxisWorld(this.indexForwardAxis,l),l.dot(n.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),this.updateSuspension(e);let h=new i;for(new i,r=0;r<s;r++){let s=t[r],i=s.suspensionForce;i>s.maxSuspensionForce&&(i=s.maxSuspensionForce),h.copy(s.raycastResult.hitNormalWorld).multiplyScalar(i*e),sl(n,h,s.raycastResult.hitPointWorld)}this.updateFriction(e);let c=new i,u=new i,p=new i;for(r=0;r<s;r++){let s=t[r];il(n,s.chassisConnectionPointWorld,p);let i=1;switch(this.indexUpAxis){case 1:i=-1}if(s.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);let t=nl(u,s.raycastResult.hitNormalWorld);c.copy(s.raycastResult.hitNormalWorld).multiplyScalar(t),u.sub(c);let n=nl(u,p);s.deltaRotation=i*n*e/s.radius}!s.sliding&&s.isInContact||0===s.engineForce||!s.useCustomSlidingRotationalSpeed||(s.deltaRotation=(s.engineForce>0?1:-1)*s.customSlidingRotationalSpeed*e),Math.abs(s.brake)>Math.abs(s.engineForce)&&(s.deltaRotation=0),s.rotation-=s.deltaRotation,s.deltaRotation*=.99}}updateSuspension(e){let t=this.chassisBody,s=Yo(t),i=this.wheelInfos,n=i.length;for(let e=0;e<n;e++){let t=i[e];if(t.isInContact){let e,i=t.suspensionRestLength-t.suspensionLength;e=t.suspensionStiffness*i*t.clippedInvContactDotSuspension;let n,r=t.suspensionRelativeVelocity;n=r<0?t.dampingCompression:t.dampingRelaxation,e-=n*r,t.suspensionForce=e*s,t.suspensionForce<0&&(t.suspensionForce=0)}else t.suspensionForce=0}}updateFriction(e){let t,s,n,r=Bo,a=this.wheelInfos,o=a.length,l=this.chassisBody,h=Uo,c=Vo;for(t=0;t<o;t++)if(s=a[t],n=s.raycastResult.body,s.sideImpulse=0,s.forwardImpulse=0,h[t]||(h[t]=new i),c[t]||(c[t]=new i),n){let e=c[t],i=this.getWheelTransformWorld(t);ol(zo[this.indexRightAxis],i,e);let a=s.raycastResult.hitNormalWorld,o=nl(e,a);r.copy(a).multiplyScalar(o),e.sub(r).normalize(),rl(a,e,h[t]),h[t].normalize(),s.sideImpulse=vl(l,s.raycastResult.hitPointWorld,n,s.raycastResult.hitPointWorld,e),s.sideImpulse*=1}for(this.sliding=!1,t=0;t<o;t++){s=a[t],n=s.raycastResult.body;let i=0;if(s.slipInfo=1,n){let r=0,a=s.brake?s.brake:r;i=hl(l,n,s.raycastResult.hitPointWorld,h[t],a),i+=s.engineForce*e;let o=a/i;s.slipInfo*=o}if(s.forwardImpulse=0,s.skidInfo=1,n){s.skidInfo=1;let t=s.suspensionForce*e*s.frictionSlip,n=t*t;s.forwardImpulse=i;let r=.5*s.forwardImpulse/s.forwardAcceleration,a=1*s.sideImpulse/s.sideAcceleration,o=r*r+a*a;if(s.sliding=!1,o>n){this.sliding=!0,s.sliding=!0;let e=t/Math.sqrt(o);s.skidInfo*=e}}}if(this.sliding)for(let e=0;e<o;e++)s=a[e],0!==s.sideImpulse&&s.skidInfo<1&&(s.forwardImpulse*=s.skidInfo,s.sideImpulse*=s.skidInfo);for(t=0;t<o;t++){s=a[t];let e=new i;if(e.copy(s.raycastResult.hitPointWorld).sub(Jo(l,new i)),0!==s.forwardImpulse){let e=new i;e.copy(h[t]).multiplyScalar(s.forwardImpulse),sl(l,e,s.raycastResult.hitPointWorld)}if(0!==s.sideImpulse){n=s.raycastResult.body,(new i).copy(s.raycastResult.hitPointWorld).sub(Jo(n,new i));let r=new i;r.copy(c[t]).multiplyScalar(s.sideImpulse),ol(e,el(l,new te).invert(),e),e["xyz"[this.indexUpAxis]]*=s.rollInfluence,ol(e,el(l,new te),e),sl(l,r,Jo(l,new i).add(e)),r.multiplyScalar(-1),sl(n,r,s.raycastResult.hitPointWorld)}}}updateWheelTransformWorld(e){const t=this.chassisBody.matrixWorld;al(e.chassisConnectionPointLocal,t,e.chassisConnectionPointWorld),ol(e.directionLocal,t,e.directionWorld)}updateWheelTransform(e){let s=Ho,i=jo,n=Go,r=this.wheelInfos[e];this.updateWheelTransformWorld(r),s.copy(r.directionLocal).multiplyScalar(-1),i.copy(r.axleLocal),rl(s,i,n),n.normalize(),i.normalize();let a=r.steering,o=new t;ll(s,a,o);let l=new t;ll(i,r.rotation,l);let h=r.quaternion;tl(this.chassisBody,h),h.multiply(o).multiply(l).normalize();let c=r.position;c.copy(r.directionWorld),c.multiplyScalar(r.suspensionLength);let u=c.clone();c.add(r.chassisConnectionPointWorld),r.matrix.compose(r.position,r.quaternion,{x:1,y:1,z:1}),this.localWheel?(u.add(r.chassisConnectionPointLocal),this.wheelMeshes[e].quaternion.copy(o).multiply(l).normalize(),this.wheelMeshes[e].position.copy(u),this.brakeMeshs&&(2!==e&&3!==e||this.brakeMeshs[e].quaternion.copy(o).normalize(),this.brakeMeshs[e].position.copy(u),this.brakeMeshs[e].updateMatrix())):(this.wheelMeshes[e].position.copy(r.position),this.wheelMeshes[e].quaternion.copy(r.quaternion),this.wheelMeshes[e].updateMatrix())}getWheelTransformWorld(e){return this.wheelInfos[e].matrix}}var qo=new i,Xo=new i;class Ko{constructor(e){e=((e,t)=>{for(var s in e=e||{},t)s in e||(e[s]=t[s]);return e})(e,{chassisConnectionPointLocal:new i,chassisConnectionPointWorld:new i,directionLocal:new i,directionWorld:new i,axleLocal:new i,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,forwardAcceleration:1,sideAcceleration:1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointLocal.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionLocal.clone(),this.axleLocal=e.axleLocal.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.forwardAcceleration=e.forwardAcceleration,this.sideAcceleration=e.sideAcceleration,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new Zo,this.position=(new i).copy(this.chassisConnectionPointLocal),this.quaternion=new t,this.isInContact=!1,this.chassisBody=null,this.ray=null,this.matrix=new te}castRay(e){if(e.hit){this.isInContact=!0;let s=e.distance;this.raycastResult.hitPointWorld.fromArray(e.point),this.raycastResult.hitNormalWorld.fromArray(e.normal),this.raycastResult.body=Zt.motor.byName(e.body),this.suspensionLength=s-this.radius;let i=this.suspensionRestLength-this.maxSuspensionTravel,n=this.suspensionRestLength+this.maxSuspensionTravel;this.suspensionLength<i&&(this.suspensionLength=i),this.suspensionLength>n&&(this.suspensionLength=n,this.raycastResult.reset());let r=nl(this.raycastResult.hitNormalWorld,this.directionWorld);il(this.chassisBody,this.raycastResult.hitPointWorld,qo);var t=nl(this.raycastResult.hitNormalWorld,qo);if(r>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/r;this.suspensionRelativeVelocity=t*e,this.clippedInvContactDotSuspension=e}}else this.isInContact=!1,this.suspensionLength=this.suspensionRestLength+0*this.maxSuspensionTravel,this.suspensionRelativeVelocity=0,this.raycastResult.hitNormalWorld.copy(this.directionWorld).multiplyScalar(-1),this.clippedInvContactDotSuspension=1}updateWheel(e){let t=this.raycastResult;if(this.isInContact){let s=t.hitNormalWorld.dot(t.directionWorld);Xo.copy(t.hitPointWorld).sub(e.position),il(e,Xo,qo);let i=t.hitNormalWorld.dot(qo);if(s>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{let e=-1/s;this.suspensionRelativeVelocity=i*e,this.clippedInvContactDotSuspension=e}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.hitNormalWorld.copy(t.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1}}class Zo{constructor(){this.body=null,this.hitPointWorld=new i,this.hitNormalWorld=new i,this.directionWorld=new i}reset(){this.body=null,this.hitPointWorld=new i,this.hitNormalWorld=new i,this.directionWorld=new i}}const Yo=e=>e.mass,Qo=e=>e.mass>0?1/e.mass:0,Jo=(e,t)=>t.copy(e.position),$o=(e,t)=>t.copy(e.velocity),el=(e,t)=>t.copy(e.matrixWorld),tl=(e,t)=>t.copy(e.quaternion),sl=(e,t,s)=>{Zt.motor.change({name:e.name,impulse:t.toArray(),impulseCenter:s.toArray()})},il=(e,t,s)=>(s.copy(t).sub(e.position),s.crossVectors(e.angular,s),s.add(e.velocity),s),nl=(e,t)=>e.x*t.x+e.y*t.y+e.z*t.z,rl=(e,t,s)=>{const i=e.y*t.z-e.z*t.y,n=e.z*t.x-e.x*t.z,r=e.x*t.y-e.y*t.x;return s.set(i,n,r),s},al=(e,t,s)=>{const i=e.x,n=e.y,r=e.z,a=t.elements,o=i*a[0]+n*a[4]+r*a[8]+a[12],l=i*a[1]+n*a[5]+r*a[9]+a[13],h=i*a[2]+n*a[6]+r*a[10]+a[14],c=1/(i*a[3]+n*a[7]+r*a[11]+a[15]);return s.x=o*c,s.y=l*c,s.z=h*c,s},ol=(e,t,s)=>{const i=e.x,n=e.y,r=e.z,a=t.elements;return s.x=i*a[0]+n*a[4]+r*a[8],s.y=i*a[1]+n*a[5]+r*a[9],s.z=i*a[2]+n*a[6]+r*a[10],s},ll=(e,t,s)=>{const i=Math.sin(t/2);return e.normalize(),s.w=Math.cos(t/2),s.x=e.x*i,s.y=e.y*i,s.z=e.z*i,s};function hl(e,t,s,i,n){var r=0,a=s,o=Oo,l=Fo,h=No;il(e,a,o),il(t,a,l),h.copy(o).sub(l);return n<(r=-nl(i,h)*(1/(ml(e,s,i)+ml(t,s,i))))&&(r=n),r<-n&&(r=-n),r}var cl=new i,ul=new i,pl=new i,dl=new i;function ml(e,t,s){var n=cl,r=ul,a=pl,o=dl;return n.copy(t).sub(Jo(e,new i)),rl(n,s,r),o.copy(((e,t)=>(t.copy(e.inertia),ol(t,e.matrixWorld,t),t.x=t.x>0?1/t.x:0,t.y=t.y>0?1/t.y:0,t.z=t.z>0?1/t.z:0,t))(e,new i)).multiply(r),rl(o,n,a),Qo(e)+nl(s,a)}var fl=new i,gl=new i,yl=new i;function vl(e,t,s,i,n){if(n.lengthSq()>1.1)return 0;let r=fl,a=gl,o=yl;il(e,t,r),il(s,i,a),o.copy(r).sub(a);return-.1*nl(n,o)*(1/(Qo(e)+Qo(s)))}const wl=new te,xl=new te;new i;let bl=rt.prototype;bl.byName=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return this.bones[t];return null},bl.getId=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return t;return null},bl.setExtraRotation=function(e,t,s,i){(e.isBone?e:this.byName(e))&&ee.DEG2RAD},bl.setScalling=function(e,t,s,n){let r=e.isBone?e:this.byName(e);r&&(r.scalling=new i(t,s,n))},bl.resetScalling=function(e){this.pose(),this.scalled=!0;for(let e=0,t=this.bones.length;e<t;e++)this.bones[e].isPhysics=!1,this.bones[e].phyMtx=new te;e||this.applyScalling()},bl.childScale=function(e,t){if(!this.scalled)return;e.scalling&&t.scale(e.scalling);let s,i=e.children.length;for(;i--;)s=e.children[i],s.isBone,s.matrixWorld.multiplyMatrices(t,s.matrix)},bl.applyScalling=function(e){let t,s,i,n=this.bones.length;for(s=0;s<n;s++)t=this.bones[s],i=t.parent||null,null!==i&&i.scalling&&"root"!==t.name&&(t.position.multiply(i.scalling),t.updateMatrixWorld(!0));this.calculateInverses()},bl.update=function(){const e=this.bones,t=this.boneInverses,s=this.boneMatrices,i=this.boneTexture;let n,r=e.length,a=0;for(;r--;){n=e[a];const i=n?n.isPhysics?n.phyMtx:n.matrixWorld:xl;n.isPhysics&&(this.scalled=!0),this.childScale(n,i),wl.multiplyMatrices(i,t[a]),wl.toArray(s,16*a),a++}null!==i&&(i.needsUpdate=!0)};const Ml={OIMO:"1.2.4",AMMO:"3.0",PHYSX:"5.03.01",RAPIER:"0.11.2",HAVOK:"1.3.0",JOLT:"0.16.0"},Al={};let Tl=null,Sl=null,Rl=null,kl=!1,Cl=!1,Il=!1,El=!0,Pl=!1,_l=null,Ll=!1,Dl={t1:0,t2:0,t3:0,t4:0},zl=null,Ol=null,Fl=null,Nl=!1,Bl=!0,Ul=null,Vl=null,Hl=0,jl=0;const Gl=new class{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new ks(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(e){this.keyDown(e)}.bind(this),!1),document.addEventListener("keyup",function(e){this.keyUp(e)}.bind(this),!1)}setKey(e,t){this.key[e]=t}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=-1,s[0]=1;break;case 68:case 39:t[0]=1,s[1]=1;break;case 87:case 90:case 38:t[1]=-1;break;case 83:case 40:t[1]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}else switch(e.which){case 65:case 81:t[0]=-1,s[0]=1;break;case 68:t[0]=1,s[1]=1;break;case 87:case 90:t[1]=-1;break;case 83:t[1]=1;break;case 37:t[2]=-1,s[0]=1;break;case 39:t[2]=1,s[1]=1;break;case 38:t[3]=-1;break;case 40:t[3]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}this.gamepad.reset()}keyUp(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:case 39:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:case 38:t[1]=t[1]<0?0:t[1];break;case 83:case 40:t[1]=t[1]>0?0:t[1];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}else switch(e.which){case 65:case 81:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:t[1]=t[1]<0?0:t[1];break;case 83:t[1]=t[1]>0?0:t[1];break;case 37:t[2]=t[2]<0?0:t[2],s[0]=0;break;case 39:t[2]=t[2]>0?0:t[2],s[1]=0;break;case 38:t[3]=t[3]<0?0:t[3];break;case 40:t[3]=t[3]>0?0:t[3];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}}},Wl=new Rs(60),ql={start:0,end:0,startTime:""};let Xl=()=>0,Kl=()=>{},Zl=()=>{},Yl=()=>{},Ql=[],Jl=[],$l=[];const eh={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};class th{static math=Bt;static RayCar=class{constructor(e={}){this.extra={},this.tmp={forwardForce:0,steerValue:0,steerDirection:0,brakeForce:0},this.localWheel=!0,this.maxSpeed=70,this.maxForce=1500,this.maxBrakeForce=45,this.maxSteer=.4,this.steeringIncrement=.15,this.steerRecover=.15,this.name=e.name||"car",this.mass=e.mass||1e3,this.size=e.size||[1.5,.7,3.8],this.pos=e.pos||[0,4,0],this.rot=e.rot||[0,0,0],this.friction=e.friction||.2,this.restitution=e.restitution||.3,this.massCenter=e.massCenter||[0,0,0],this.driveWheel=e.driveWheel||null;let t=[{type:"box",pos:this.massCenter,size:this.size,radius:.02}];e.shapeMesh&&(t=[{type:"convex",shape:e.shapeMesh.geometry,pos:e.shapePos||[0,0,0]}]),this.body=Zt.motor.add({type:"compound",shapes:t,name:this.name,pos:this.pos,rot:this.rot,friction:this.friction,restitution:this.restitution,mass:this.mass,mesh:e.bodyMesh||null,meshPos:e.meshPos||[0,-1.1,0],material:e.material,damping:[.05,.05],debug:!1}),this.body.inertia.set(283.33331298828125,333.33331298828125,83.33332824707031),this.vehicle=new Wo({chassis:this.body});let s=e.wheelPosition||[.61,0,1.2];const n=[new i(-s[0],s[1],-s[2]),new i(s[0],s[1],-s[2]),new i(-s[0],s[1],s[2]),new i(s[0],s[1],s[2])],r={radius:e.wheelRadius||.31,directionLocal:new i(0,-1,0),suspensionStiffness:100,suspensionRestLength:.5,suspensionMaxLength:1,maxSuspensionTravel:.3,frictionSlip:4,dampingRelaxation:2.3,dampingCompression:4.4,maxSuspensionForce:1e5,rollInfluence:.001,axleLocal:new i(1,0,0),chassisConnectionPointLocal:new i(1,1,0)};let a,o,l;this.addParametre("frictionSlip",4),this.addParametre("maxSuspensionTravel",.3),this.addParametre("suspensionRestLength",.5),this.addParametre("suspensionMaxLength",1),n.forEach((e=>{r.chassisConnectionPointLocal.copy(e),this.vehicle.addWheel(r)}));let h=Zt.motor.getMat("debug");if(e.wheelMesh?(o=e.wheelMesh,l=e.wheelMesh2?e.wheelMesh2:null,e.material&&(h=e.material||h,o.material=h,l&&(l.material=h))):(a=new c(r.radius,r.radius,e.wheelDepth||.2),a.rotateZ(.5*Math.PI),o=new ne(a,h),l=null),this.vehicle.localWheel=this.localWheel,this.localWheel){this.vehicle.wheelMeshes=[l||o.clone(),o,l?l.clone():o.clone(),o.clone()];let e=this.vehicle.wheelMeshes.length,t=0;for(;e--;)this.body.add(this.vehicle.wheelMeshes[t++])}else m.matrixAutoUpdate=!1,l&&(l.matrixAutoUpdate=!1),this.vehicle.wheelMeshes=[Zt.motor.add(l||m.clone()),Zt.motor.add(m),Zt.motor.add(l?l.clone():m.clone()),Zt.motor.add(m.clone())]}step(){this.tmp.forwardForce=0,this.tmp.brakeForce=0,this.tmp.steerDirection=0;let e=Zt.motor.getDelta();Zt.motor.getAzimut();let t=Zt.motor.getKey();this.tmp.forwardForce=t[1],this.tmp.steerDirection=-1*t[0],this.tmp.brakeForce=1===t[4]?this.maxBrakeForce:0,this.tmp.steerValue+=this.tmp.steerDirection*this.steeringIncrement,this.tmp.steerValue=Math.min(Math.max(this.tmp.steerValue,-this.maxSteer),this.maxSteer),this.tmp.steerValue*=1-(1-Math.abs(this.tmp.steerDirection))*this.steerRecover;let s=Math.abs(this.vehicle.currentVehicleSpeedKmHour);s=Math.min(s,this.maxSpeed),this.maxSpeed;const i=1*this.tmp.forwardForce*this.maxForce;this.vehicle.applyEngineForce(i,0),this.vehicle.applyEngineForce(i,1),this.vehicle.applyEngineForce(i,2),this.vehicle.applyEngineForce(i,3),this.vehicle.setSteeringValue(this.tmp.steerValue,2),this.vehicle.setSteeringValue(this.tmp.steerValue,3),this.vehicle.setBrake(this.tmp.brakeForce,0),this.vehicle.setBrake(this.tmp.brakeForce,1),this.vehicle.setBrake(0,2),this.vehicle.setBrake(0,3),this.vehicle.wheelInfos[0].frictionSlip=8,this.vehicle.wheelInfos[1].frictionSlip=8,this.vehicle.wheelInfos[2].frictionSlip=8,this.vehicle.wheelInfos[3].frictionSlip=8,this.vehicle.updateVehicle(e),this.driveWheel&&(this.driveWheel.rotation.y=180*this.tmp.steerValue*Do)}addParametre(e,t){this.extra[e]=t,Object.defineProperty(this,e,{get:()=>this.extra[e],set:t=>{this.extra[e]=t,this.vehicle&&this.vehicle.setWheels(e,this.extra[e])}})}};static debugMode(e){th.setDebugMode(e)}static setDebugMode(e){console.log("debugMode is",e),Zt.debug=e}static useRealLight(e){Ts.useRealLight(e)}static getSetting(){return eh}static setGravity(e){e&&(eh.gravity=e),Zt.post({m:"setGravity",o:{gravity:eh.gravity}})}static set(e={}){eh.fixe=void 0===e.fixe||e.fixe,eh.full=void 0!==e.full&&e.full,eh.gravity=e.gravity?e.gravity:[0,-9.81,0],eh.substep=e.substep?e.substep:2,eh.fps=e.fps?e.fps:60,e.key&&Yl(),Al.body.setFull(eh.full),th.initArray(eh.full),jl=0,Il=kl,El=!Il,Zt.jointVisible=e.jointVisible||!1,El&&Wl.setFramerate(eh.fps);const t={...eh,ArPos:Zt.ArPos,isTimeout:Il,outsideStep:El};Zt.post({m:"set",o:t})}static activeMouse(e,t){zl||(zl=new Ao(e,t))}static mouseMode(e,t){zl&&zl.setMode(e,t)}static getTime(){return Rs.now()}static readTime(e){return Rs.format_time(e)}static startTime(){return ql.startTime}static getTimeTest(){return Dl}static setMaxFps(e){}static getMouse(){return zl?zl.mouse:null}static setMaxAnisotropy(e){Ua.maxAnisotropy=e}static setAddControl(e){Yl=e}static setPrevUpdate(e){}static setPostUpdate(e){Zl=null!==e?e:()=>{}}static setAzimut(e){Xl=e}static setKey(e,t){return Gl.setKey(e,t)}static getKey(){return Gl.key}static getKey2(){return Gl.key2}static getAzimut(){return Xl()}static setContent(e){Ll||(e.add(Zt.scene),e.add(Zt.scenePlus),Ll=!0)}static message(e){let t=e.data;t.Ar&&(Zt.Ar=t.Ar),t.reflow&&(Zt.reflow=t.reflow,Zt.reflow.stat.delta&&(jl+=Zt.reflow.stat.delta)),th[t.m](t.o)}static post(e,t=null,s=!1){kl?(e.o&&("solver"===e.o.type&&(s=!0),void 0!==e.o.solver&&(s=!0)),s?Rl.postMessage(e,t):"add"===e.m?Zt.flow.add.push(e.o):"remove"===e.m?Zt.flow.remove.push(e.o):Rl.postMessage(e,t)):Ol({data:e})}static makeView(){}static getScene(){return Zt.scene}static resize(e){Zt.viewSize=e}static init(e={}){ql.start=Rs.now();const t=e.compact||!1;let s=document.location.href.replace(/\/[^/]*$/,"/");var i=s.split("/");s=i[0]+"//"+i[2]+"/","https://lo-th.github.io/"===s&&(s="https://lo-th.github.io/phy/");let n=e.path||"build/";e.useMin;const r={};let a=e.type||"PHYSX",o=a.toLowerCase(),l=o.charAt(0).toUpperCase()+o.slice(1);if(Zt.engine=a,th.initItems(),Ua.materialRoot=Ts.set,e.callback&&(Sl=e.callback,delete e.callback),kl=e.worker||!1,Zt.scene=new it,Zt.scene.name="phy_scene",Zt.scenePlus=new it,Zt.scenePlus.name="phy_scenePlus",e.scene&&(th.setContent(e.scene),delete e.scene),Zt.post=th.post,Zt.motor=th,t)n=e.path||"compact/",Ua.load(s+n+l+".hex",(function(){th.onCompactDone(e)}));else if(kl){r[l]&&(e.blob=s+r[l]),Rl=new Worker(s+n+l+".min.js"),Rl.postMessage=Rl.webkitPostMessage||Rl.postMessage,Rl.onmessage=th.message;let t=new ArrayBuffer(1);Rl.postMessage({m:"test",ab:t},[t]),Cl=!t.byteLength,e.isBuffer=Cl,th.initPhysics(e)}else r[l]?th.loadWasmDirect(r[l],e,l,s):e.devMode?th.preLoad(l,e,s):th.preLoadMin(l,e,s)}static onCompactDone(e){let t=Zt.engine.toLowerCase(),s=t.charAt(0).toUpperCase()+t.slice(1),i=Ua.get(s,"H");if(kl){let t;try{t=new Blob([i],{type:"application/javascript"})}catch(e){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,t=new BlobBuilder,t.append(i),t=t.getBlob()}Rl=new Worker(URL.createObjectURL(t)),Rl.postMessage=Rl.webkitPostMessage||Rl.postMessage,Rl.onmessage=th.message;let s=new ArrayBuffer(1);Rl.postMessage({m:"test",ab:s},[s]),Cl=!s.byteLength,e.isBuffer=Cl,th.initPhysics(e)}else{let s=t.toUpperCase();"RAPIER"===s&&(s="RAPIER3D");let n=document.createElement("script");n.language="javascript",n.type="text/javascript",n.charset="utf-8",n.async=!0,n.innerHTML=i,document.getElementsByTagName("head")[0].appendChild(n),Ol=window[s].engine.message,e.message=th.message,th.initPhysics(e)}}static loadWasmDirect(e,t,s,i){let n=document.createElement("script");n.src=i+e,document.body.appendChild(n),n.onload=()=>{th.preLoad(s,t,i)}}static preLoadMin(e,t,s){let i=s+"build/"+e+".min.js",n=e.toUpperCase();"RAPIER"===n&&(n="RAPIER3D");var r=new XMLHttpRequest;r.open("GET",i),r.overrideMimeType("text/javascript"),r.onreadystatechange=function(){if(4===r.readyState)if(200===r.status||0===r.status){let e=document.createElement("script");e.language="javascript",e.type="text/javascript",e.charset="utf-8",e.async=!0,e.innerHTML=r.responseText,document.getElementsByTagName("head")[0].appendChild(e),Ol=window[n].engine.message,t.message=th.message,th.initPhysics(t)}else console.error("Couldn't load ["+e+"] ["+r.status+"]")}.bind(this),r.send(null)}static async preLoad(e,t,s){let i=s+"build/"+e+".module.js";t.devMode&&(i=s+"src/"+e+".js");let n=await import(i);Ol=n.engine.message,t.message=th.message,th.initPhysics(t)}static initPhysics(e){Zt.post({m:"init",o:e}),Pl=!0}static getPause(){return Nl}static pause(e){e!==Nl&&(Nl=e,Nl?th.pausetimout():th.playtimout(),Zt.post({m:"pause",o:{value:Nl}}))}static flowReset(){Zt.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}}static reset(e){if(Bl)return Bl=!1,void e();Ql=[],th.clearText(),th.clearParticleSolver(),th.cleartimout(),Tl=null,Fl&&Fl.resetAll(),zl&&zl.unSelect(),Kl=e,Zl=function(){},th.flowReset(),th.clearInstance(),th.resetItems(),is(),Ts.dispose(),Zt.disposeTmp(),null!==_l&&(_l=null),Zt.tmpTex=[],Zt.scenePlus.children=[],Zt.scene.children=[],Zt.post({m:"reset"})}static resetCallback(){Kl()}static dispose(){th.reset((()=>{Rl&&(Rl.terminate(),Rl=null),Ll&&(Zt.scene.parent.remove(Zt.scene),Zt.scenePlus.parent.remove(Zt.scenePlus),Ll=!1)}))}static ready(){ql.end=Rs.now(),ql.startTime=Rs.format_time(ql.end-ql.start),console.log("%c"+Zt.engine+" %c"+Ml[Zt.engine]+"%c | "+(kl?"Worker":"Direct")+" "+ql.startTime,"font-size:16px","font-size:12px","font-size:12px"),Sl&&Sl()}static start(e={}){Zt.post({m:"start",o:e})}static morph(e,t,s){Yt.morph(e,t,s)}static getFps(){return Zt.reflow.stat.fps}static getDelta2(){return Zt.delta}static getElapsedTime2(){return jl}static getDelta(){return Wl.delta}static getElapsedTime(){return Wl.elapsedTime}static doStep(e){Pl&&El&&Wl.up(e)&&Zt.post({m:"step",o:e})}static step(){Zt.delta=Zt.reflow.stat.delta,th.stepItems(),Zt.flow.key=Gl.update(),Zt.flow.current=null!==Tl?Tl.name:"",null!==_l&&_l.step(),null!==Tl&&Tl.move(),zl&&zl.step(),Zl(Wl.delta),th.changes(Zt.flow.tmp),Cl?Zt.post({m:"poststep",flow:Zt.flow,Ar:Zt.Ar},[Zt.Ar.buffer]):Zt.post({m:"poststep",flow:Zt.flow}),th.flowReset()}static initArray(e=!1){Zt.ArPos=function(e,t=!1){let s={},i={body:Ut*(t?Xt.bodyFull:Xt.body),joint:Vt*Xt.joint,ray:jt*Xt.ray,contact:Ht*Xt.contact,character:Gt*Xt.character};"PHYSX"!==e&&"AMMO"!==e||(i.vehicle=Wt*Xt.vehicle),"PHYSX"===e&&(i.solver=qt*Xt.solver),"HAVOK"!==e&&"RAPIER"!==e&&"JOLT"!==e||(Xt.joint=0);let n=0;for(let e in i)s[e]=n,n+=i[e];return s.total=n,s}(Zt.engine,e)}static control(e=null){null!==Tl?null===e?Tl=null:e!==Tl.name&&(Tl=th.byName(e)):Tl=th.byName(e)}static byName(e){return Yt.byName(e)}static getAllBody(e){return Al.body.list}static initItems(){Al.body=new gi,Al.ray=new Is,Al.joint=new bi,Al.solid=new sh,Al.contact=new Mi,Al.terrain=new mo,Al.character=new oo,"PHYSX"!==Zt.engine&&"AMMO"!==Zt.engine||(Al.vehicle=new Ti),"PHYSX"===Zt.engine&&(Al.solver=new go),Zt.items=Al}static getBodyRef(){return Al.body}static clearBody(){Al.body.reset()}static resetItems(){Object.values(Al).forEach((e=>e.reset()))}static stepItems(){Object.values(Al).forEach((e=>e.step())),th.upInstance(),th.upButton()}static upInstance(){Object.values(Zt.instanceMesh).forEach((e=>e.update()))}static clearInstance(){Object.values(Zt.instanceMesh).forEach((e=>e.dispose())),Zt.instanceMesh={}}static addDirect(e){return Zt.scenePlus.add(e),Zt.tmpMesh.push(e),e}static adds(e=[],t){let s=e.length,i=0;for(;s--;)th.add(e[i++],t)}static add(e={},t=!1){if(e.isObject3D)return th.addDirect(e);if(e.constructor===Array)return th.adds(e,t);if("container"===e.type)return new Mo(e);void 0!==e.bounce&&(e.restitution=e.bounce),void 0===e.type&&(e.type="box"),void 0!==e.mode&&(e.type="joint");let s=function(e){switch(e.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return e.mass||e.density||e.kinematic?"body":"solid";case"fixe":case"generic":case"universal":case"dof":case"d6":case"hinge":case"revolute":case"prismatic":case"cylindrical":case"slider":case"spherical":case"ragdoll":case"distance":return"joint";default:return e.type}}(e);return"joint"===s&&void 0===e.mode&&(e.mode=e.type,e.type="joint"),Al[s].add(e)}static removes(e=[],t){let s=e.length,i=0;for(;s--;)th.remove(e[i++],t)}static remove(e,t=!1){if(e.constructor===Array)return th.removes(e,t);let s=th.byName(e);null!==s&&(Al[s.type].clear(s),Zt.post({m:"remove",o:{name:e,type:s.type}},null,t))}static changes(e=[],t=!1){let s=e.length,i=0;for(;s--;)th.changeOne(e[i++],t)}static change(e,t=!1){t?e instanceof Array?th.changes(e,!0):th.changeOne(e,!0):e instanceof Array?Zt.flow.tmp.push(...e):Zt.flow.tmp.push(e)}static changeOne(e={},t=!1){if(e.heightData)return;let s=th.byName(e.name);if(null===s)return null;let i=s.type;switch(e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=Bt.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot),void 0!==e.rot&&(e.quat=Bt.quatFromEuler(e.rot),delete e.rot),void 0!==e.localRot&&(e.quat=Bt.toLocalQuatArray(e.localRot,s),delete e.localRot),i){case"terrain":s=Al.terrain.set(e,s),t=!1;break;case"ray":s=Al.ray.set(e,s),t=!1;break;case"character":s=Al.character.set(e,s);break;case"solid":s=Al.solid.set(e,s);break;case"joint":s=Al.joint.set(e,s);break;case"body":s.isKinematic&&Al.body.set(e,s)}t&&Zt.post({m:"change",o:e},null,t)}static setControl(e){Fl=e,Xl=Fl.getAzimuthalAngle}static getCurrentCharacterPosition(){return Fl.followGroup.position}static getCamera(e={}){return Fl.object}static setCamera(e={}){Fl.moveCam(e)}static follow(e="",t={}){let s=null;"string"==typeof e||e instanceof String?s=""===e?null:th.byName(e):e.isObject3D&&(s=e),null===s?Fl.resetFollow():Fl.startFollow(s,t)}static setTimeout(e,t=0,s=!1){s?Ul=setTimeout(e,t):(Vl=e,Hl=t,Ul=setTimeout(Vl,Hl))}static playtimout(){null!==Vl&&(Ul=setTimeout(Vl,Hl))}static pausetimout(){null!==Ul&&clearTimeout(Ul)}static cleartimout(e,t){null!==Ul&&(Vl=null,Hl=0,clearTimeout(Ul),Ul=null)}static texture(e={}){return Ua.texture(e)}static getMatRef(){return Ts}static material(e={}){return Ts.create(e)}static setExtendShader(e){Ts.extendShader=e}static getMaterialList(){return Ts.getList()}static addMaterial(e,t){Ts.set(e,t)}static setEnvmapIntensity(e){Ts.setEnvmapIntensity(e)}static getMat(e){return Ts.get(e)}static getMaterial(e){return Ts.get(e)}static preload(e,t){eo.add(e,t)}static load(e,t,s="",i=""){Ua.load(e,t,s,i)}static async loadAsync(e,t="",s=""){await Ua.loadAsync(e,t,s)}static applyMorph(e,t=null,s=!0,i=!0){Ua.applyMorph(e,null,!0,!0)}static getMesh(e,t){if(t){let t=Ua.getMaterials(e);for(let e in t)th.addMaterial(t[e])}return Ua.getMesh(e,t)}static getGroup(e,t,s){return Ua.getGroup(e,t,s)}static getGlb(e,t){return Ua.getGLB(e,t)}static getGlbMaterial(e){let t=Ua.getMaterials(e);return Ts.addToMat(t),t}static getScript(e){return Ua.getScript(e)}static get(e,t){return Ua.get(e,t)}static poolDispose(){return Ua.dispose()}static setDracoPath(e){return Ua.dracoPath=e}static initParticle(){}static addParticle(){}static getParticle(){}static addParticleSolver(e){let t=new Lo(e);return $l.push(t),t}static updateParticleSolver(){let e=$l.length;for(;e--;)$l[e].update()}static clearParticleSolver(){$l.length,$l=[]}static addButton(e){let t=new bo(e);return Ql.push(t),t}static upButton(e){for(const e in Ql)Ql[e].update()}static addText(e){let t=new wo(e);return e.parent?e.parent.add(t):Zt.scenePlus.add(t),Jl.push(t),t}static clearText(){let e=Jl.length;for(;e--;)Jl[e].dispose();Jl=[]}static addBreaker(){null===_l&&(_l=new ko)}static explosion(e=[0,0,0],t=10,s=1){let n=[],r=new i;e&&(e.isVector3?r.copy(e):r.fromArray(e));let a,o,l=new i,h=Al.body.list.length;for(;h--;)a=Al.body.list[h],l.copy(a.position).sub(r),o=1-l.length()/t,a.isKinematic||o<0||(l.setLength(o),l.multiplyScalar(s),n.push({name:a.name,impulse:l.toArray(),wake:!0}));th.change(n)}}class sh extends gi{constructor(){super(),this.type="solid"}step(){}}const ih=th;export{ih as phy};